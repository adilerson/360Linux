(self.webpackChunkapp=self.webpackChunkapp||[]).push([[8789],{8789:(ke,Ie,Te)=>{"use strict";Te.r(Ie),Te.d(Ie,{CapacitorVideoPlayerWeb:()=>b});var Z=Te(5861),Oe=Te(7423),W=Te(2070),B=Te.n(W);class A{constructor(D,_,I,P,x,S,g,L,y,T){this.pipMode=!1,this._videoType=null,this._videoContainer=null,this._firstReadyToPlay=!0,this._isEnded=!1,this._videoRate=1,this._videoExitOnEnd=!0,this._videoLoopOnEnd=!1,this._url=_,this._container=g,this._mode=D,this._width=y||320,this._height=T||180,this._mode=D,this._videoRate=P,this._zIndex=L||1,this._playerId=I,this._videoExitOnEnd=x,this._videoLoopOnEnd=S}initialize(){var D=this;return(0,Z.Z)(function*(){if(D._getVideoType()){"fullscreen"===D._mode&&(D._container.style.position="absolute",D._container.style.width="100vw",D._container.style.height="100vh"),"embedded"===D._mode&&(D._container.style.position="relative",D._container.style.width=D._width.toString()+"px",D._container.style.height=D._height.toString()+"px"),D._container.style.left="0",D._container.style.top="0",D._container.style.display="flex",D._container.style.alignItems="center",D._container.style.justifyContent="center",D._container.style.backgroundColor="#000000",D._container.style.zIndex=D._zIndex.toString();const I="fullscreen"===D._mode?window.innerWidth:D._width,P="fullscreen"===D._mode?window.innerHeight:D._height,x="http://www.w3.org/2000/svg",S=document.createElementNS(x,"svg");S.setAttributeNS(null,"width",I.toString()),S.setAttributeNS(null,"height",P.toString());const g="0 0 "+I.toString()+" "+P.toString();S.setAttributeNS(null,"viewBox",g),S.style.zIndex=(D._zIndex+1).toString();const L=document.createElementNS(x,"rect");L.setAttributeNS(null,"x","0"),L.setAttributeNS(null,"y","0"),L.setAttributeNS(null,"width",I.toString()),L.setAttributeNS(null,"height",P.toString()),L.setAttributeNS(null,"fill","#000000"),S.appendChild(L),D._container.appendChild(S);const y=I*D._height/D._width;D._videoContainer=document.createElement("div"),D._videoContainer.style.position="absolute",D._videoContainer.style.left="0",D._videoContainer.style.width=I.toString()+"px",D._videoContainer.style.height=y.toString()+"px",D._videoContainer.style.zIndex=(D._zIndex+2).toString(),D._container.appendChild(D._videoContainer),(yield D.createVideoElement(I,y))||D._createEvent("Exit",D._playerId,"Video Error: failed to create the Video Element")}else D._createEvent("Exit",D._playerId,"Url Error: type not supported")})()}createVideoElement(D,_){var I=this;return(0,Z.Z)(function*(){I.videoEl=document.createElement("video"),I.videoEl.controls=!0,I.videoEl.style.zIndex=(I._zIndex+3).toString(),I.videoEl.style.width=`${D.toString()}px`,I.videoEl.style.height=`${_.toString()}px`,I.videoEl.playbackRate=I._videoRate,I._videoContainer.appendChild(I.videoEl);const P=yield I._setPlayer();if(P&&(I.videoEl.onended=(0,Z.Z)(function*(){I._isEnded=!0,I.isPlaying=!1,I.videoEl&&(I.videoEl.currentTime=0),I._videoExitOnEnd?("fullscreen"===I._mode&&I._closeFullscreen(),I._createEvent("Ended",I._playerId)):I._videoLoopOnEnd&&null!=I.videoEl&&(yield I.videoEl.play())}),I.videoEl.oncanplay=(0,Z.Z)(function*(){I._firstReadyToPlay&&(I._createEvent("Ready",I._playerId),null!=I.videoEl&&(I.videoEl.muted=!1,"fullscreen"===I._mode&&(yield I.videoEl.play()),I._firstReadyToPlay=!1))}),I.videoEl.onplay=()=>{I.isPlaying=!0,I._firstReadyToPlay&&(I._firstReadyToPlay=!1),I._createEvent("Play",I._playerId)},I.videoEl.onplaying=()=>{I._createEvent("Playing",I._playerId)},I.videoEl.onpause=()=>{I.isPlaying=!1,I._createEvent("Pause",I._playerId)},"fullscreen"===I._mode)){const x=document.createElement("button");x.textContent="X",x.style.position="absolute",x.style.left="1%",x.style.top="5%",x.style.width="5vmin",x.style.padding="0.5%",x.style.fontSize="1.2rem",x.style.background="rgba(51,51,51,.4)",x.style.color="#fff",x.style.visibility="hidden",x.style.zIndex=(I._zIndex+4).toString(),x.style.border="1px solid rgba(51,51,51,.4)",x.style.borderRadius="20px",I._videoContainer.onclick=(0,Z.Z)(function*(){I._initial=yield I._doHide(x,3e3)}),I._videoContainer.ontouchstart=(0,Z.Z)(function*(){I._initial=yield I._doHide(x,3e3)}),I._videoContainer.onmousemove=(0,Z.Z)(function*(){I._initial=yield I._doHide(x,3e3)}),x.onclick=()=>{I._createEvent("Exit",I._playerId)},x.ontouchstart=()=>{I._createEvent("Exit",I._playerId)},I._videoContainer.appendChild(x),I._initial=yield I._doHide(x,3e3),I._goFullscreen()}return P})()}_goFullscreen(){var D=this;return(0,Z.Z)(function*(){D._container.mozRequestFullScreen?D._container.mozRequestFullScreen():D._container.webkitRequestFullscreen?D._container.webkitRequestFullscreen():D._container.msRequestFullscreen?D._container.msRequestFullscreen():D._container.requestFullscreen&&D._container.requestFullscreen()})()}_setPlayer(){var D=this;return(0,Z.Z)(function*(){return new Promise(_=>{if(null!=D.videoEl){if(B().isSupported()&&"application/x-mpegURL"===D._videoType){const I=new(B());I.loadSource(D._url),I.attachMedia(D.videoEl),I.on(B().Events.MANIFEST_PARSED,()=>{null!=D.videoEl?(D.videoEl.muted=!0,D.videoEl.crossOrigin="anonymous",_(!0)):_(!1)})}else"video/mp4"===D._videoType?(D.videoEl.src=D._url,"https"!=D._url.substring(0,5)&&"http"===D._url.substring(0,4)&&(D.videoEl.crossOrigin="anonymous"),("https"===D._url.substring(0,5)||"http"===D._url.substring(0,4))&&(D.videoEl.muted=!0),_(!0)):_(!1);D.videoEl.addEventListener("enterpictureinpicture",I=>{D.pipWindow=I.pictureInPictureWindow,console.log(" Enter PiP Mode ",D.pipWindow),D.pipMode=!0,D._closeFullscreen()}),D.videoEl.addEventListener("leavepictureinpicture",()=>{console.log(" Exit PiP Mode "),D.pipMode=!1,D._isEnded||(D._goFullscreen(),null!=D.videoEl&&D.videoEl.play())})}else _(!1)})})()}_getVideoType(){let D=!1,_="";const I=this._url?this._url:"";if(null!=I&&I.length>0)try{if(null==I.substring(I.lastIndexOf("/")).match(/(.*)\.(.*)/))_="";else{const x=I.match(/(.*)\.(.*)/);_=null!=x?x[2].split("?")[0]:""}switch(_){case"mp4":case"":case"webm":case"cmaf":case"cmfv":case"cmfa":this._videoType="video/mp4";break;case"m3u8":this._videoType="application/x-mpegURL";break;default:this._videoType=null}D=!0}catch(P){D=!1}return D}_doHide(D,_){var I=this;return(0,Z.Z)(function*(){return clearTimeout(I._initial),D.style.visibility="visible",setTimeout(()=>{D.style.visibility="hidden"},_)})()}_createEvent(D,_,I){const P=I||null;let x;x=null!=P?new CustomEvent(`videoPlayer${D}`,{detail:{fromPlayerId:_,message:P}}):new CustomEvent(`videoPlayer${D}`,{detail:{fromPlayerId:_,currentTime:this.videoEl?this.videoEl.currentTime:0}}),this._container.dispatchEvent(x)}_closeFullscreen(){const D=document;(D.fullscreenElement&&null!==D.fullscreenElement||D.webkitFullscreenElement&&null!==D.webkitFullscreenElement||D.mozFullScreenElement&&null!==D.mozFullScreenElement||D.msFullscreenElement&&null!==D.msFullscreenElement)&&(D.mozCancelFullScreen?D.mozCancelFullScreen():D.webkitExitFullscreen?D.webkitExitFullscreen():D.msExitFullscreen?D.msExitFullscreen():D.exitFullscreen&&D.exitFullscreen())}}class b extends Oe.Uw{constructor(){super(...arguments),this._players=[]}echo(D){return(0,Z.Z)(function*(){return console.log("ECHO",D),Promise.resolve({result:!0,method:"echo",value:D})})()}initPlayer(D){var _=this;return(0,Z.Z)(function*(){if(null==D)return Promise.resolve({result:!1,method:"initPlayer",message:"Must provide a capVideoPlayerOptions object"});const I=D.mode?D.mode:"";if(null==I||0===I.length)return Promise.resolve({result:!1,method:"initPlayer",message:"Must provide a Mode (fullscreen/embedded)"});if("fullscreen"===I||"embedded"===I){const P=D.url?D.url:"";if(null==P||0===P.length)return Promise.resolve({result:!1,method:"initPlayer",message:"Must provide a Video Url"});if("internal"==P)return Promise.resolve({result:!1,method:"initPlayer",message:"Internal Videos not supported on Web Platform"});const x=D.playerId?D.playerId:"";if(null==x||0===x.length)return Promise.resolve({result:!1,method:"initPlayer",message:"Must provide a Player Id"});const S=D.rate?D.rate:1;let g=!0;if(Object.keys(D).includes("exitOnEnd")){const f=D.exitOnEnd;g=null==f||f}let L=!1;if(Object.keys(D).includes("loopOnEnd")&&!g){const f=D.loopOnEnd;L=null!=f&&f}const y=D.componentTag?D.componentTag:"";if(null==y||0===y.length)return Promise.resolve({result:!1,method:"initPlayer",message:"Must provide a Component Tag"});let T=null;"embedded"===I&&(T=_.checkSize(D));const p=yield _._initializeVideoPlayer(P,x,I,S,g,L,y,T);return Promise.resolve({result:p})}return Promise.resolve({result:!1,method:"initPlayer",message:"Must provide a Mode either fullscreen or embedded)"})})()}isPlaying(D){var _=this;return(0,Z.Z)(function*(){if(null==D)return Promise.resolve({result:!1,method:"isPlaying",message:"Must provide a capVideoPlayerIdOptions object"});let I=D.playerId?D.playerId:"";return(null==I||0===I.length)&&(I="fullscreen"),Promise.resolve(_._players[I]?{method:"isPlaying",result:!0,value:_._players[I].isPlaying}:{method:"isPlaying",result:!1,message:"Given PlayerId does not exist)"})})()}play(D){var _=this;return(0,Z.Z)(function*(){if(null==D)return Promise.resolve({result:!1,method:"play",message:"Must provide a capVideoPlayerIdOptions object"});let I=D.playerId?D.playerId:"";return(null==I||0===I.length)&&(I="fullscreen"),_._players[I]?(yield _._players[I].videoEl.play(),Promise.resolve({method:"play",result:!0,value:!0})):Promise.resolve({method:"play",result:!1,message:"Given PlayerId does not exist)"})})()}pause(D){var _=this;return(0,Z.Z)(function*(){if(null==D)return Promise.resolve({result:!1,method:"pause",message:"Must provide a capVideoPlayerIdOptions object"});let I=D.playerId?D.playerId:"";return(null==I||0===I.length)&&(I="fullscreen"),_._players[I]?(_._players[I].isPlaying&&(yield _._players[I].videoEl.pause()),Promise.resolve({method:"pause",result:!0,value:!0})):Promise.resolve({method:"pause",result:!1,message:"Given PlayerId does not exist)"})})()}getDuration(D){var _=this;return(0,Z.Z)(function*(){if(null==D)return Promise.resolve({result:!1,method:"getDuration",message:"Must provide a capVideoPlayerIdOptions object"});let I=D.playerId?D.playerId:"";return(null==I||0===I.length)&&(I="fullscreen"),Promise.resolve(_._players[I]?{method:"getDuration",result:!0,value:_._players[I].videoEl.duration}:{method:"getDuration",result:!1,message:"Given PlayerId does not exist)"})})()}setRate(D){var _=this;return(0,Z.Z)(function*(){if(null==D)return Promise.resolve({result:!1,method:"setRate",message:"Must provide a capVideoRateOptions object"});let I=D.playerId?D.playerId:"";(null==I||0===I.length)&&(I="fullscreen"),console.log(`>>> in plugin options.rate: ${D.rate}`);const x=D.rate&&[.25,.5,.75,1,2,4].includes(D.rate)?D.rate:1;return console.log(`>>> in plugin rate: ${x}`),_._players[I]?(_._players[I].videoEl.playbackRate=x,Promise.resolve({method:"setRate",result:!0,value:x})):Promise.resolve({method:"setRate",result:!1,message:"Given PlayerId does not exist)"})})()}getRate(D){var _=this;return(0,Z.Z)(function*(){if(null==D)return Promise.resolve({result:!1,method:"getRate",message:"Must provide a capVideoPlayerIdOptions object"});let I=D.playerId?D.playerId:"";return(null==I||0===I.length)&&(I="fullscreen"),Promise.resolve(_._players[I]?{method:"getRate",result:!0,value:_._players[I].videoEl.playbackRate}:{method:"getRate",result:!1,message:"Given PlayerId does not exist)"})})()}setVolume(D){var _=this;return(0,Z.Z)(function*(){if(null==D)return Promise.resolve({result:!1,method:"setVolume",message:"Must provide a capVideoVolumeOptions object"});let I=D.playerId?D.playerId:"";(null==I||0===I.length)&&(I="fullscreen");const P=D.volume?D.volume:.5;return _._players[I]?(_._players[I].videoEl.volume=P,Promise.resolve({method:"setVolume",result:!0,value:P})):Promise.resolve({method:"setVolume",result:!1,message:"Given PlayerId does not exist)"})})()}getVolume(D){var _=this;return(0,Z.Z)(function*(){if(null==D)return Promise.resolve({result:!1,method:"getVolume",message:"Must provide a capVideoPlayerIdOptions object"});let I=D.playerId?D.playerId:"";return(null==I||0===I.length)&&(I="fullscreen"),Promise.resolve(_._players[I]?{method:"getVolume",result:!0,value:_._players[I].videoEl.volume}:{method:"getVolume",result:!1,message:"Given PlayerId does not exist)"})})()}setMuted(D){var _=this;return(0,Z.Z)(function*(){if(null==D)return Promise.resolve({result:!1,method:"setMuted",message:"Must provide a capVideoMutedOptions object"});let I=D.playerId?D.playerId:"";(null==I||0===I.length)&&(I="fullscreen");const P=!!D.muted&&D.muted;return _._players[I]?(_._players[I].videoEl.muted=P,Promise.resolve({method:"setMuted",result:!0,value:P})):Promise.resolve({method:"setMuted",result:!1,message:"Given PlayerId does not exist)"})})()}getMuted(D){var _=this;return(0,Z.Z)(function*(){if(null==D)return Promise.resolve({result:!1,method:"getMuted",message:"Must provide a capVideoPlayerIdOptions object"});let I=D.playerId?D.playerId:"";return(null==I||0===I.length)&&(I="fullscreen"),Promise.resolve(_._players[I]?{method:"getMuted",result:!0,value:_._players[I].videoEl.muted}:{method:"getMuted",result:!1,message:"Given PlayerId does not exist)"})})()}setCurrentTime(D){var _=this;return(0,Z.Z)(function*(){if(null==D)return Promise.resolve({result:!1,method:"setCurrentTime",message:"Must provide a capVideoTimeOptions object"});let I=D.playerId?D.playerId:"";(null==I||0===I.length)&&(I="fullscreen");let P=D.seektime?D.seektime:0;if(_._players[I]){const x=_._players[I].videoEl.duration;return P=P<=x&&P>=0?P:x/2,_._players[I].videoEl.currentTime=P,Promise.resolve({method:"setCurrentTime",result:!0,value:P})}return Promise.resolve({method:"setCurrentTime",result:!1,message:"Given PlayerId does not exist)"})})()}getCurrentTime(D){var _=this;return(0,Z.Z)(function*(){if(null==D)return Promise.resolve({result:!1,method:"getCurrentTime",message:"Must provide a capVideoPlayerIdOptions object"});let I=D.playerId?D.playerId:"";return(null==I||0===I.length)&&(I="fullscreen"),Promise.resolve(_._players[I]?{method:"getCurrentTime",result:!0,value:_._players[I].videoEl.currentTime}:{method:"getCurrentTime",result:!1,message:"Given PlayerId does not exist)"})})()}stopAllPlayers(){var D=this;return(0,Z.Z)(function*(){for(const _ in D._players){if(D._players[_].pipMode){const I=document;I.pictureInPictureElement&&(yield I.exitPictureInPicture())}D._players[_].videoEl.paused||D._players[_].videoEl.pause()}return Promise.resolve({method:"stopAllPlayers",result:!0,value:!0})})()}checkSize(D){const _={width:D.width?D.width:320,height:D.height?D.height:180},I=_.height/_.width;return _.width>window.innerWidth&&(_.width=window.innerWidth,_.height=Math.floor(_.width*I)),_.height>window.innerHeight&&(_.height=window.innerHeight,_.width=Math.floor(_.height/I)),_}_initializeVideoPlayer(D,_,I,P,x,S,g,L){var y=this;return(0,Z.Z)(function*(){const T=D?-1==D.indexOf("%2F")?encodeURI(D):D:null;if(null===T)return Promise.resolve(!1);const p=yield y._getContainerElement(_,g);if(null===p)return Promise.resolve({method:"initPlayer",result:!1,message:"componentTag or divContainerElement must be provided"});if("embedded"===I&&null==L)return Promise.resolve({method:"initPlayer",result:!1,message:"playerSize must be defined in embedded mode"});if(p.addEventListener("videoPlayerPlay",f=>{y.handlePlayerPlay(f.detail)}),p.addEventListener("videoPlayerPause",f=>{y.handlePlayerPause(f.detail)}),p.addEventListener("videoPlayerEnded",f=>{"fullscreen"===I&&p.remove(),y.handlePlayerEnded(f.detail)}),p.addEventListener("videoPlayerReady",f=>{y.handlePlayerReady(f.detail)}),p.addEventListener("videoPlayerExit",()=>{"fullscreen"===I&&p.remove(),y.handlePlayerExit()}),"embedded"===I)y._players[_]=new A("embedded",T,_,P,x,S,p,2,L.width,L.height),yield y._players[_].initialize();else{if("fullscreen"!==I)return Promise.resolve({method:"initPlayer",result:!1,message:"mode not supported"});y._players.fullscreen=new A("fullscreen",T,"fullscreen",P,x,S,p,99995),yield y._players.fullscreen.initialize()}return Promise.resolve({method:"initPlayer",result:!0,value:!0})})()}_getContainerElement(D,_){return(0,Z.Z)(function*(){const I=document.createElement("div");if(I.id=`vc_${D}`,null!=_&&_.length>0){const P=document.querySelector(`${_}`);if(null===P)return Promise.resolve(null);let x=null;const S=P.shadowRoot?P.shadowRoot:null;return x=null!=S?S.querySelector(`[id='${D}']`):P.querySelector(`[id='${D}']`),null!=x&&x.appendChild(I),Promise.resolve(I)}return Promise.resolve(null)})()}handlePlayerPlay(D){this.notifyListeners("jeepCapVideoPlayerPlay",D)}handlePlayerPause(D){this.notifyListeners("jeepCapVideoPlayerPause",D)}handlePlayerEnded(D){this.notifyListeners("jeepCapVideoPlayerEnded",D)}handlePlayerExit(){this.notifyListeners("jeepCapVideoPlayerExit",{dismiss:!0})}handlePlayerReady(D){this.notifyListeners("jeepCapVideoPlayerReady",D)}}},2070:function(ke){var Z;"undefined"!=typeof window&&(Z=()=>(()=>{var Ie={"./src/config.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{enableStreamingMode:()=>v,hlsDefaultConfig:()=>l,mergeConfig:()=>e});var b=A("./src/controller/abr-controller.ts"),R=A("./src/controller/audio-stream-controller.ts"),D=A("./src/controller/audio-track-controller.ts"),_=A("./src/controller/subtitle-stream-controller.ts"),I=A("./src/controller/subtitle-track-controller.ts"),P=A("./src/controller/buffer-controller.ts"),x=A("./src/controller/timeline-controller.ts"),S=A("./src/controller/cap-level-controller.ts"),g=A("./src/controller/fps-controller.ts"),L=A("./src/controller/eme-controller.ts"),y=A("./src/controller/cmcd-controller.ts"),T=A("./src/utils/xhr-loader.ts"),p=A("./src/utils/fetch-loader.ts"),f=A("./src/utils/cues.ts"),r=A("./src/utils/mediakeys-helper.ts"),t=A("./src/utils/logger.ts");function d(){return d=Object.assign?Object.assign.bind():function(s){for(var h=1;h<arguments.length;h++){var u=arguments[h];for(var a in u)Object.prototype.hasOwnProperty.call(u,a)&&(s[a]=u[a])}return s},d.apply(this,arguments)}function c(s,h){var u=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);h&&(a=a.filter(function(m){return Object.getOwnPropertyDescriptor(s,m).enumerable})),u.push.apply(u,a)}return u}function n(s){for(var h=1;h<arguments.length;h++){var u=null!=arguments[h]?arguments[h]:{};h%2?c(Object(u),!0).forEach(function(a){i(s,a,u[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(u)):c(Object(u)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(u,a))})}return s}function i(s,h,u){return h in s?Object.defineProperty(s,h,{value:u,enumerable:!0,configurable:!0,writable:!0}):s[h]=u,s}var l=n(n({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,enableSoftwareAES:!0,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,startLevel:void 0,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:T.default,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:b.default,bufferController:P.default,capLevelController:S.default,fpsController:g.default,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystemOptions:{},requestMediaKeySystemAccessFunc:r.requestMediaKeySystemAccess,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0},function o(){return{cueHandler:f.default,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}()),{},{subtitleStreamController:_.SubtitleStreamController,subtitleTrackController:I.default,timelineController:x.TimelineController,audioStreamController:R.default,audioTrackController:D.default,emeController:L.default,cmcdController:y.default});function e(s,h){if((h.liveSyncDurationCount||h.liveMaxLatencyDurationCount)&&(h.liveSyncDuration||h.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==h.liveMaxLatencyDurationCount&&(void 0===h.liveSyncDurationCount||h.liveMaxLatencyDurationCount<=h.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==h.liveMaxLatencyDuration&&(void 0===h.liveSyncDuration||h.liveMaxLatencyDuration<=h.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');return d({},s,h)}function v(s){var h=s.loader;h!==p.default&&h!==T.default?(t.logger.log("[config]: Custom loader detected, cannot enable progressive streaming"),s.progressive=!1):(0,p.fetchSupported)()&&(s.loader=p.default,s.progressive=!0,s.enableSoftwareAES=!0,t.logger.log("[config]: Progressive streaming enabled, using FetchLoader"))}},"./src/controller/abr-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>L});var b=A("./src/polyfills/number.ts"),R=A("./src/utils/ewma-bandwidth-estimator.ts"),D=A("./src/events.ts"),_=A("./src/errors.ts"),I=A("./src/types/loader.ts"),P=A("./src/utils/logger.ts");function x(y,T){for(var p=0;p<T.length;p++){var f=T[p];f.enumerable=f.enumerable||!1,f.configurable=!0,"value"in f&&(f.writable=!0),Object.defineProperty(y,f.key,f)}}const L=function(){function y(p){this.hls=void 0,this.lastLoadedFragLevel=0,this._nextAutoLevel=-1,this.timer=void 0,this.onCheck=this._abandonRulesCheck.bind(this),this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this.hls=p;var f=p.config;this.bwEstimator=new R.default(f.abrEwmaSlowVoD,f.abrEwmaFastVoD,f.abrEwmaDefaultEstimate),this.registerListeners()}var T=y.prototype;return T.registerListeners=function(){var f=this.hls;f.on(D.Events.FRAG_LOADING,this.onFragLoading,this),f.on(D.Events.FRAG_LOADED,this.onFragLoaded,this),f.on(D.Events.FRAG_BUFFERED,this.onFragBuffered,this),f.on(D.Events.LEVEL_LOADED,this.onLevelLoaded,this),f.on(D.Events.ERROR,this.onError,this)},T.unregisterListeners=function(){var f=this.hls;f.off(D.Events.FRAG_LOADING,this.onFragLoading,this),f.off(D.Events.FRAG_LOADED,this.onFragLoaded,this),f.off(D.Events.FRAG_BUFFERED,this.onFragBuffered,this),f.off(D.Events.LEVEL_LOADED,this.onLevelLoaded,this),f.off(D.Events.ERROR,this.onError,this)},T.destroy=function(){this.unregisterListeners(),this.clearTimer(),this.hls=this.onCheck=null,this.fragCurrent=this.partCurrent=null},T.onFragLoading=function(f,r){var d,t=r.frag;t.type!==I.PlaylistLevelType.MAIN||this.timer||(this.fragCurrent=t,this.partCurrent=null!=(d=r.part)?d:null,this.timer=self.setInterval(this.onCheck,100))},T.onLevelLoaded=function(f,r){var t=this.hls.config;r.details.live?this.bwEstimator.update(t.abrEwmaSlowLive,t.abrEwmaFastLive):this.bwEstimator.update(t.abrEwmaSlowVoD,t.abrEwmaFastVoD)},T._abandonRulesCheck=function(){var f=this.fragCurrent,r=this.partCurrent,t=this.hls,d=t.autoLevelEnabled,n=t.media;if(f&&n){var i=r?r.stats:f.stats,l=r?r.duration:f.duration;if(i.aborted||i.loaded&&i.loaded===i.total||0===f.level)return this.clearTimer(),void(this._nextAutoLevel=-1);if(d&&!n.paused&&n.playbackRate&&n.readyState){var o=t.mainForwardBufferInfo;if(null!==o){var e=performance.now()-i.loading.start,v=Math.abs(n.playbackRate);if(!(e<=500*l/v)){var s=i.loaded&&i.loading.first,h=this.bwEstimator.getEstimate(),u=t.levels,a=t.minAutoLevel,E=i.total||Math.max(i.loaded,Math.round(l*u[f.level].maxBitrate/8)),O=s?1e3*i.loaded/e:0,M=O?(E-i.loaded)/O:8*E/h,C=o.len/v;if(!(M<=C)){var U,F=Number.POSITIVE_INFINITY;for(U=f.level-1;U>a;U--){var k=u[U].maxBitrate;if((F=O?l*k/(6.4*O):l*k/h)<C)break}F>=M||(P.logger.warn("Fragment "+f.sn+(r?" part "+r.index:"")+" of level "+f.level+" is loading too slowly and will cause an underbuffer; aborting and switching to level "+U+"\n      Current BW estimate: "+((0,b.isFiniteNumber)(h)?(h/1024).toFixed(3):"Unknown")+" Kb/s\n      Estimated load time for current fragment: "+M.toFixed(3)+" s\n      Estimated load time for the next fragment: "+F.toFixed(3)+" s\n      Time to underbuffer: "+C.toFixed(3)+" s"),t.nextLoadLevel=U,s&&this.bwEstimator.sample(e,i.loaded),this.clearTimer(),f.loader&&(this.fragCurrent=this.partCurrent=null,f.loader.abort()),t.trigger(D.Events.FRAG_LOAD_EMERGENCY_ABORTED,{frag:f,part:r,stats:i}))}}}}}},T.onFragLoaded=function(f,r){var t=r.frag,d=r.part;if(t.type===I.PlaylistLevelType.MAIN&&(0,b.isFiniteNumber)(t.sn)){var c=d?d.stats:t.stats,n=d?d.duration:t.duration;if(this.clearTimer(),this.lastLoadedFragLevel=t.level,this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){var i=this.hls.levels[t.level],l=(i.loaded?i.loaded.bytes:0)+c.loaded,o=(i.loaded?i.loaded.duration:0)+n;i.loaded={bytes:l,duration:o},i.realBitrate=Math.round(8*l/o)}t.bitrateTest&&this.onFragBuffered(D.Events.FRAG_BUFFERED,{stats:c,frag:t,part:d,id:t.type})}},T.onFragBuffered=function(f,r){var t=r.frag,d=r.part,c=d?d.stats:t.stats;if(!c.aborted&&t.type===I.PlaylistLevelType.MAIN&&"initSegment"!==t.sn){var n=c.parsing.end-c.loading.start;this.bwEstimator.sample(n,c.loaded),c.bwEstimate=this.bwEstimator.getEstimate(),this.bitrateTestDelay=t.bitrateTest?n/1e3:0}},T.onError=function(f,r){switch(r.details){case _.ErrorDetails.FRAG_LOAD_ERROR:case _.ErrorDetails.FRAG_LOAD_TIMEOUT:this.clearTimer()}},T.clearTimer=function(){self.clearInterval(this.timer),this.timer=void 0},T.getNextABRAutoLevel=function(){var f=this.fragCurrent,r=this.partCurrent,t=this.hls,d=t.maxAutoLevel,c=t.config,n=t.minAutoLevel,i=t.media,l=r?r.duration:f?f.duration:0,e=i&&0!==i.playbackRate?Math.abs(i.playbackRate):1,v=this.bwEstimator?this.bwEstimator.getEstimate():c.abrEwmaDefaultEstimate,s=t.mainForwardBufferInfo,h=(s?s.len:0)/e,u=this.findBestLevel(v,n,d,h,c.abrBandWidthFactor,c.abrBandWidthUpFactor);if(u>=0)return u;P.logger.trace((h?"rebuffering expected":"buffer is empty")+", finding optimal quality level");var a=l?Math.min(l,c.maxStarvationDelay):c.maxStarvationDelay,m=c.abrBandWidthFactor,E=c.abrBandWidthUpFactor;if(!h){var O=this.bitrateTestDelay;O&&(a=(l?Math.min(l,c.maxLoadingDelay):c.maxLoadingDelay)-O,P.logger.trace("bitrate test took "+Math.round(1e3*O)+"ms, set first fragment max fetchDuration to "+Math.round(1e3*a)+" ms"),m=E=1)}return u=this.findBestLevel(v,n,d,h+a,m,E),Math.max(u,0)},T.findBestLevel=function(f,r,t,d,c,n){for(var i,l=this.fragCurrent,o=this.partCurrent,e=this.lastLoadedFragLevel,v=this.hls.levels,s=v[e],h=!(null==s||null===(i=s.details)||void 0===i||!i.live),u=null==s?void 0:s.codecSet,a=o?o.duration:l?l.duration:0,m=t;m>=r;m--){var E=v[m];if(E&&(!u||E.codecSet===u)){var C,O=E.details,M=(o?null==O?void 0:O.partTarget:null==O?void 0:O.averagetargetduration)||a,F=v[m].maxBitrate,U=F*M/(C=m<=e?c*f:n*f);if(P.logger.trace("level/adjustedbw/bitrate/avgDuration/maxFetchDuration/fetchDuration: "+m+"/"+Math.round(C)+"/"+F+"/"+M+"/"+d+"/"+U),C>F&&(0===U||!(0,b.isFiniteNumber)(U)||h&&!this.bitrateTestDelay||U<d))return m}}return-1},function S(y,T,p){T&&x(y.prototype,T),p&&x(y,p),Object.defineProperty(y,"prototype",{writable:!1})}(y,[{key:"nextAutoLevel",get:function(){var f=this._nextAutoLevel;if(-1!==f&&!this.bwEstimator.canEstimate())return f;var t=this.getNextABRAutoLevel();return-1!==f&&this.hls.levels[t].loadError?f:(-1!==f&&(t=Math.min(f,t)),t)},set:function(f){this._nextAutoLevel=f}}]),y}()},"./src/controller/audio-stream-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>i});var b=A("./src/polyfills/number.ts"),R=A("./src/controller/base-stream-controller.ts"),D=A("./src/events.ts"),_=A("./src/utils/buffer-helper.ts"),I=A("./src/controller/fragment-tracker.ts"),P=A("./src/types/level.ts"),x=A("./src/types/loader.ts"),S=A("./src/loader/fragment.ts"),g=A("./src/demux/chunk-cache.ts"),L=A("./src/demux/transmuxer-interface.ts"),y=A("./src/types/transmuxer.ts"),T=A("./src/controller/fragment-finders.ts"),p=A("./src/utils/discontinuities.ts"),f=A("./src/errors.ts");function r(){return r=Object.assign?Object.assign.bind():function(l){for(var o=1;o<arguments.length;o++){var e=arguments[o];for(var v in e)Object.prototype.hasOwnProperty.call(e,v)&&(l[v]=e[v])}return l},r.apply(this,arguments)}function d(l,o){return(d=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(v,s){return v.__proto__=s,v})(l,o)}const i=function(l){function o(v,s){var h;return(h=l.call(this,v,s,"[audio-stream-controller]")||this).videoBuffer=null,h.videoTrackCC=-1,h.waitingVideoCC=-1,h.audioSwitch=!1,h.trackId=-1,h.waitingData=null,h.mainDetails=null,h.bufferFlushed=!1,h.cachedTrackLoadedData=null,h._registerListeners(),h}!function t(l,o){l.prototype=Object.create(o.prototype),l.prototype.constructor=l,d(l,o)}(o,l);var e=o.prototype;return e.onHandlerDestroying=function(){this._unregisterListeners(),this.mainDetails=null},e._registerListeners=function(){var s=this.hls;s.on(D.Events.MEDIA_ATTACHED,this.onMediaAttached,this),s.on(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),s.on(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),s.on(D.Events.LEVEL_LOADED,this.onLevelLoaded,this),s.on(D.Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),s.on(D.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),s.on(D.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),s.on(D.Events.ERROR,this.onError,this),s.on(D.Events.BUFFER_RESET,this.onBufferReset,this),s.on(D.Events.BUFFER_CREATED,this.onBufferCreated,this),s.on(D.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),s.on(D.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),s.on(D.Events.FRAG_BUFFERED,this.onFragBuffered,this)},e._unregisterListeners=function(){var s=this.hls;s.off(D.Events.MEDIA_ATTACHED,this.onMediaAttached,this),s.off(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),s.off(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),s.off(D.Events.LEVEL_LOADED,this.onLevelLoaded,this),s.off(D.Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),s.off(D.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),s.off(D.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),s.off(D.Events.ERROR,this.onError,this),s.off(D.Events.BUFFER_RESET,this.onBufferReset,this),s.off(D.Events.BUFFER_CREATED,this.onBufferCreated,this),s.off(D.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),s.off(D.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),s.off(D.Events.FRAG_BUFFERED,this.onFragBuffered,this)},e.onInitPtsFound=function(s,h){var u=h.frag,m=h.initPTS;if("main"===h.id){var E=u.cc;this.initPTS[u.cc]=m,this.log("InitPTS for cc: "+E+" found from main: "+m),this.videoTrackCC=E,this.state===R.State.WAITING_INIT_PTS&&this.tick()}},e.startLoad=function(s){if(!this.levels)return this.startPosition=s,void(this.state=R.State.STOPPED);var h=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),this.fragLoadError=0,h>0&&-1===s?(this.log("Override startPosition with lastCurrentTime @"+h.toFixed(3)),s=h,this.state=R.State.IDLE):(this.loadedmetadata=!1,this.state=R.State.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=s,this.tick()},e.doTick=function(){switch(this.state){case R.State.IDLE:this.doTickIdle();break;case R.State.WAITING_TRACK:var s,h=this.levels,a=null==h||null===(s=h[this.trackId])||void 0===s?void 0:s.details;if(a){if(this.waitForCdnTuneIn(a))break;this.state=R.State.WAITING_INIT_PTS}break;case R.State.FRAG_LOADING_WAITING_RETRY:var m,E=performance.now(),O=this.retryDate;(!O||E>=O||null!==(m=this.media)&&void 0!==m&&m.seeking)&&(this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(this.trackId),this.state=R.State.IDLE);break;case R.State.WAITING_INIT_PTS:var M=this.waitingData;if(M){var C=M.frag,F=M.part,U=M.cache,k=M.complete;if(void 0!==this.initPTS[C.cc]){this.waitingData=null,this.waitingVideoCC=-1,this.state=R.State.FRAG_LOADING;var w={frag:C,part:F,payload:U.flush(),networkDetails:null};this._handleFragmentLoadProgress(w),k&&l.prototype._handleFragmentLoadComplete.call(this,w)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log("Waiting fragment cc ("+C.cc+") cancelled because video is at cc "+this.videoTrackCC),this.clearWaitingFragment();else{var K=this.getLoadPosition(),G=_.BufferHelper.bufferInfo(this.mediaBuffer,K,this.config.maxBufferHole);(0,T.fragmentWithinToleranceTest)(G.end,this.config.maxFragLookUpTolerance,C)<0&&(this.log("Waiting fragment cc ("+C.cc+") @ "+C.start+" cancelled because another fragment at "+G.end+" is needed"),this.clearWaitingFragment())}}else this.state=R.State.IDLE}this.onTickEnd()},e.clearWaitingFragment=function(){var s=this.waitingData;s&&(this.fragmentTracker.removeFragment(s.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=R.State.IDLE)},e.resetLoadingState=function(){this.clearWaitingFragment(),l.prototype.resetLoadingState.call(this)},e.onTickEnd=function(){var s=this.media;!s||!s.readyState||(this.lastCurrentTime=s.currentTime)},e.doTickIdle=function(){var s,h,u=this.hls,a=this.levels,m=this.media,E=this.trackId;if(a&&a[E]&&(m||!this.startFragRequested&&u.config.startFragPrefetch)){var C=a[E].details;if(!C||C.live&&this.levelLastLoaded!==E||this.waitForCdnTuneIn(C))return void(this.state=R.State.WAITING_TRACK);var F=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&F&&(this.bufferFlushed=!1,this.afterBufferFlushed(F,S.ElementaryStreamTypes.AUDIO,x.PlaylistLevelType.AUDIO));var U=this.getFwdBufferInfo(F,x.PlaylistLevelType.AUDIO);if(null!==U){var k=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,x.PlaylistLevelType.MAIN),N=U.len,w=this.getMaxBufferLength(null==k?void 0:k.len),K=this.audioSwitch;if(!(N>=w)||K){if(!K&&this._streamEnded(U,C))return u.trigger(D.Events.BUFFER_EOS,{type:"audio"}),void(this.state=R.State.ENDED);var H=C.fragments[0].start,V=U.end;if(K&&m){var X=this.getLoadPosition();V=X,C.PTSKnown&&X<H&&(U.end>H||U.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),m.currentTime=H+.05)}if(!(k&&V>k.end+C.targetduration)&&(k&&k.len||!U.len)){var Y=this.getNextFragment(V,C);if(!Y)return void(this.bufferFlushed=!0);"identity"!==(null===(s=Y.decryptdata)||void 0===s?void 0:s.keyFormat)||null!==(h=Y.decryptdata)&&void 0!==h&&h.key?this.loadFragment(Y,C,V):this.loadKey(Y,C)}}}}},e.getMaxBufferLength=function(s){var h=l.prototype.getMaxBufferLength.call(this);return s?Math.max(h,s):h},e.onMediaDetaching=function(){this.videoBuffer=null,l.prototype.onMediaDetaching.call(this)},e.onAudioTracksUpdated=function(s,h){var u=h.audioTracks;this.resetTransmuxer(),this.levels=u.map(function(a){return new P.Level(a)})},e.onAudioTrackSwitching=function(s,h){var u=!!h.url;this.trackId=h.id;var a=this.fragCurrent;null!=a&&a.loader&&a.loader.abort(),this.fragCurrent=null,this.clearWaitingFragment(),u?this.setInterval(100):this.resetTransmuxer(),u?(this.audioSwitch=!0,this.state=R.State.IDLE):this.state=R.State.STOPPED,this.tick()},e.onManifestLoading=function(){this.mainDetails=null,this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=!1},e.onLevelLoaded=function(s,h){this.mainDetails=h.details,null!==this.cachedTrackLoadedData&&(this.hls.trigger(D.Events.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)},e.onAudioTrackLoaded=function(s,h){var u;if(null!=this.mainDetails){var a=this.levels,m=h.details,E=h.id;if(a){this.log("Track "+E+" loaded ["+m.startSN+","+m.endSN+"],duration:"+m.totalduration);var O=a[E],M=0;if(m.live||null!==(u=O.details)&&void 0!==u&&u.live){var C=this.mainDetails;if(m.fragments[0]||(m.deltaUpdateFailed=!0),m.deltaUpdateFailed||!C)return;!O.details&&m.hasProgramDateTime&&C.hasProgramDateTime?((0,p.alignMediaPlaylistByPDT)(m,C),M=m.fragments[0].start):M=this.alignPlaylists(m,O.details)}O.details=m,this.levelLastLoaded=E,!this.startFragRequested&&(this.mainDetails||!m.live)&&this.setStartPosition(O.details,M),this.state===R.State.WAITING_TRACK&&!this.waitForCdnTuneIn(m)&&(this.state=R.State.IDLE),this.tick()}else this.warn("Audio tracks were reset while loading level "+E)}else this.cachedTrackLoadedData=h},e._handleFragmentLoadProgress=function(s){var h,u=s.frag,a=s.part,m=s.payload,E=this.config,O=this.trackId,M=this.levels;if(M){var C=M[O];console.assert(C,"Audio track is defined on fragment load progress");var F=C.details;console.assert(F,"Audio track details are defined on fragment load progress");var U=E.defaultAudioCodec||C.audioCodec||"mp4a.40.2",k=this.transmuxer;k||(k=this.transmuxer=new L.default(this.hls,x.PlaylistLevelType.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));var N=this.initPTS[u.cc],w=null===(h=u.initSegment)||void 0===h?void 0:h.data;if(void 0!==N){var G=a?a.index:-1,V=new y.ChunkMetadata(u.level,u.sn,u.stats.chunkCount,m.byteLength,G,-1!==G);k.push(m,w,U,"",u,a,F.totalduration,!1,V,N)}else this.log("Unknown video PTS for cc "+u.cc+", waiting for video PTS before demuxing audio frag "+u.sn+" of ["+F.startSN+" ,"+F.endSN+"],track "+O),(this.waitingData=this.waitingData||{frag:u,part:a,cache:new g.default,complete:!1}).cache.push(new Uint8Array(m)),this.waitingVideoCC=this.videoTrackCC,this.state=R.State.WAITING_INIT_PTS}else this.warn("Audio tracks were reset while fragment load was in progress. Fragment "+u.sn+" of level "+u.level+" will not be buffered")},e._handleFragmentLoadComplete=function(s){this.waitingData?this.waitingData.complete=!0:l.prototype._handleFragmentLoadComplete.call(this,s)},e.onBufferReset=function(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1},e.onBufferCreated=function(s,h){var u=h.tracks.audio;u&&(this.mediaBuffer=u.buffer||null),h.tracks.video&&(this.videoBuffer=h.tracks.video.buffer||null)},e.onFragBuffered=function(s,h){var m,u=h.frag,a=h.part;u.type===x.PlaylistLevelType.AUDIO?this.fragContextChanged(u)?this.warn("Fragment "+u.sn+(a?" p: "+a.index:"")+" of level "+u.level+" finished buffering, but was aborted. state: "+this.state+", audioSwitch: "+this.audioSwitch):("initSegment"!==u.sn&&(this.fragPrevious=u,this.audioSwitch&&(this.audioSwitch=!1,this.hls.trigger(D.Events.AUDIO_TRACK_SWITCHED,{id:this.trackId}))),this.fragBufferedComplete(u,a)):this.loadedmetadata||u.type!==x.PlaylistLevelType.MAIN||null!==(m=this.videoBuffer||this.media)&&void 0!==m&&m.buffered.length&&(this.loadedmetadata=!0)},e.onError=function(s,h){switch(h.details){case f.ErrorDetails.FRAG_LOAD_ERROR:case f.ErrorDetails.FRAG_LOAD_TIMEOUT:case f.ErrorDetails.KEY_LOAD_ERROR:case f.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(x.PlaylistLevelType.AUDIO,h);break;case f.ErrorDetails.AUDIO_TRACK_LOAD_ERROR:case f.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:this.state!==R.State.ERROR&&this.state!==R.State.STOPPED&&(this.state=h.fatal?R.State.ERROR:R.State.IDLE,this.warn(h.details+" while loading frag, switching to "+this.state+" state"));break;case f.ErrorDetails.BUFFER_FULL_ERROR:if("audio"===h.parent&&(this.state===R.State.PARSING||this.state===R.State.PARSED)){var u=!0,a=this.getFwdBufferInfo(this.mediaBuffer,x.PlaylistLevelType.AUDIO);a&&a.len>.5&&(u=!this.reduceMaxBufferLength(a.len)),u&&(this.warn("Buffer full error also media.currentTime is not buffered, flush audio buffer"),this.fragCurrent=null,l.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio")),this.resetLoadingState()}}},e.onBufferFlushed=function(s,h){h.type===S.ElementaryStreamTypes.AUDIO&&(this.bufferFlushed=!0)},e._handleTransmuxComplete=function(s){var h,u="audio",a=this.hls,m=s.remuxResult,E=s.chunkMeta,O=this.getCurrentContext(E);if(!O)return this.warn("The loading context changed while buffering fragment "+E.sn+" of level "+E.level+". This chunk will not be buffered."),void this.resetStartWhenNotLoaded(E.level);var M=O.frag,C=O.part,F=O.level.details,U=m.audio,k=m.text,N=m.id3,w=m.initSegment;if(!this.fragContextChanged(M)&&F){if(this.state=R.State.PARSING,this.audioSwitch&&U&&this.completeAudioSwitch(),null!=w&&w.tracks&&(this._bufferInitSegment(w.tracks,M,E),a.trigger(D.Events.FRAG_PARSING_INIT_SEGMENT,{frag:M,id:u,tracks:w.tracks})),U){var K=U.startPTS,G=U.endPTS,H=U.startDTS,V=U.endDTS;C&&(C.elementaryStreams[S.ElementaryStreamTypes.AUDIO]={startPTS:K,endPTS:G,startDTS:H,endDTS:V}),M.setElementaryStreamInfo(S.ElementaryStreamTypes.AUDIO,K,G,H,V),this.bufferFragmentData(U,M,C,E)}if(null!=N&&null!==(h=N.samples)&&void 0!==h&&h.length){var X=r({id:u,frag:M,details:F},N);a.trigger(D.Events.FRAG_PARSING_METADATA,X)}if(k){var Y=r({id:u,frag:M,details:F},k);a.trigger(D.Events.FRAG_PARSING_USERDATA,Y)}}},e._bufferInitSegment=function(s,h,u){if(this.state===R.State.PARSING){s.video&&delete s.video;var a=s.audio;if(a){a.levelCodec=a.codec,a.id="audio",this.log("Init audio buffer, container:"+a.container+", codecs[parsed]=["+a.codec+"]"),this.hls.trigger(D.Events.BUFFER_CODECS,s);var m=a.initSegment;null!=m&&m.byteLength&&this.hls.trigger(D.Events.BUFFER_APPENDING,{type:"audio",frag:h,part:null,chunkMeta:u,parent:h.type,data:m}),this.tick()}}},e.loadFragment=function(s,h,u){var a=this.fragmentTracker.getState(s);this.fragCurrent=s,(this.audioSwitch||a===I.FragmentState.NOT_LOADED||a===I.FragmentState.PARTIAL)&&("initSegment"===s.sn?this._loadInitSegment(s):h.live&&!(0,b.isFiniteNumber)(this.initPTS[s.cc])?(this.log("Waiting for video PTS in continuity counter "+s.cc+" of live stream before loading audio fragment "+s.sn+" of level "+this.trackId),this.state=R.State.WAITING_INIT_PTS):(this.startFragRequested=!0,l.prototype.loadFragment.call(this,s,h,u)))},e.completeAudioSwitch=function(){var s=this.hls,u=this.trackId;this.media&&(this.log("Switching audio track : flushing all audio"),l.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio")),this.audioSwitch=!1,s.trigger(D.Events.AUDIO_TRACK_SWITCHED,{id:u})},o}(R.default)},"./src/controller/audio-track-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>L});var b=A("./src/events.ts"),R=A("./src/errors.ts"),D=A("./src/controller/base-playlist-controller.ts"),_=A("./src/types/loader.ts");function I(y,T){for(var p=0;p<T.length;p++){var f=T[p];f.enumerable=f.enumerable||!1,f.configurable=!0,"value"in f&&(f.writable=!0),Object.defineProperty(y,f.key,f)}}function S(y,T){return(S=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(f,r){return f.__proto__=r,f})(y,T)}const L=function(y){function T(f){var r;return(r=y.call(this,f,"[audio-track-controller]")||this).tracks=[],r.groupId=null,r.tracksInGroup=[],r.trackId=-1,r.trackName="",r.selectDefaultTrack=!0,r.registerListeners(),r}!function x(y,T){y.prototype=Object.create(T.prototype),y.prototype.constructor=y,S(y,T)}(T,y);var p=T.prototype;return p.registerListeners=function(){var r=this.hls;r.on(b.Events.MANIFEST_LOADING,this.onManifestLoading,this),r.on(b.Events.MANIFEST_PARSED,this.onManifestParsed,this),r.on(b.Events.LEVEL_LOADING,this.onLevelLoading,this),r.on(b.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),r.on(b.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),r.on(b.Events.ERROR,this.onError,this)},p.unregisterListeners=function(){var r=this.hls;r.off(b.Events.MANIFEST_LOADING,this.onManifestLoading,this),r.off(b.Events.MANIFEST_PARSED,this.onManifestParsed,this),r.off(b.Events.LEVEL_LOADING,this.onLevelLoading,this),r.off(b.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),r.off(b.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),r.off(b.Events.ERROR,this.onError,this)},p.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,y.prototype.destroy.call(this)},p.onManifestLoading=function(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.trackName="",this.selectDefaultTrack=!0},p.onManifestParsed=function(r,t){this.tracks=t.audioTracks||[]},p.onAudioTrackLoaded=function(r,t){var d=t.id,c=t.details,n=this.tracksInGroup[d];if(n){var i=n.details;n.details=t.details,this.log("audioTrack "+d+" loaded ["+c.startSN+"-"+c.endSN+"]"),d===this.trackId&&(this.retryCount=0,this.playlistLoaded(d,t,i))}else this.warn("Invalid audio track id "+d)},p.onLevelLoading=function(r,t){this.switchLevel(t.level)},p.onLevelSwitching=function(r,t){this.switchLevel(t.level)},p.switchLevel=function(r){var t=this.hls.levels[r];if(null!=t&&t.audioGroupIds){var d=t.audioGroupIds[t.urlId];if(this.groupId!==d){this.groupId=d;var c=this.tracks.filter(function(i){return!d||i.groupId===d});this.selectDefaultTrack&&!c.some(function(i){return i.default})&&(this.selectDefaultTrack=!1),this.tracksInGroup=c;var n={audioTracks:c};this.log("Updating audio tracks, "+c.length+' track(s) found in "'+d+'" group-id'),this.hls.trigger(b.Events.AUDIO_TRACKS_UPDATED,n),this.selectInitialTrack()}}},p.onError=function(r,t){y.prototype.onError.call(this,r,t),!t.fatal&&t.context&&t.context.type===_.PlaylistContextType.AUDIO_TRACK&&t.context.id===this.trackId&&t.context.groupId===this.groupId&&this.retryLoadingOrFail(t)},p.setAudioTrack=function(r){var t=this.tracksInGroup;if(r<0||r>=t.length)this.warn("Invalid id passed to audio-track controller");else{this.clearTimer();var d=t[this.trackId];this.log("Now switching to audio-track index "+r);var c=t[r],n=c.id,i=c.groupId,l=void 0===i?"":i,o=c.name,e=c.type,v=c.url;if(this.trackId=r,this.trackName=o,this.selectDefaultTrack=!1,this.hls.trigger(b.Events.AUDIO_TRACK_SWITCHING,{id:n,groupId:l,name:o,type:e,url:v}),!c.details||c.details.live){var s=this.switchParams(c.url,null==d?void 0:d.details);this.loadPlaylist(s)}}},p.selectInitialTrack=function(){console.assert(this.tracksInGroup.length,"Initial audio track should be selected when tracks are known");var d=this.findTrackId(this.trackName)||this.findTrackId();-1!==d?this.setAudioTrack(d):(this.warn("No track found for running audio group-ID: "+this.groupId),this.hls.trigger(b.Events.ERROR,{type:R.ErrorTypes.MEDIA_ERROR,details:R.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,fatal:!0}))},p.findTrackId=function(r){for(var t=this.tracksInGroup,d=0;d<t.length;d++){var c=t[d];if((!this.selectDefaultTrack||c.default)&&(!r||r===c.name))return c.id}return-1},p.loadPlaylist=function(r){var t=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(t)){var d=t.id,c=t.groupId,n=t.url;if(r)try{n=r.addDirectives(n)}catch(i){this.warn("Could not construct new URL with HLS Delivery Directives: "+i)}this.log("loading audio-track playlist for id: "+d),this.clearTimer(),this.hls.trigger(b.Events.AUDIO_TRACK_LOADING,{url:n,id:d,groupId:c,deliveryDirectives:r||null})}},function P(y,T,p){T&&I(y.prototype,T),p&&I(y,p),Object.defineProperty(y,"prototype",{writable:!1})}(T,[{key:"audioTracks",get:function(){return this.tracksInGroup}},{key:"audioTrack",get:function(){return this.trackId},set:function(r){this.selectDefaultTrack=!1,this.setAudioTrack(r)}}]),T}(D.default)},"./src/controller/base-playlist-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>P});var b=A("./src/polyfills/number.ts"),R=A("./src/types/level.ts"),D=A("./src/controller/level-helper.ts"),_=A("./src/utils/logger.ts"),I=A("./src/errors.ts"),P=function(){function x(g,L){this.hls=void 0,this.timer=-1,this.canLoad=!1,this.retryCount=0,this.log=void 0,this.warn=void 0,this.log=_.logger.log.bind(_.logger,L+":"),this.warn=_.logger.warn.bind(_.logger,L+":"),this.hls=g}var S=x.prototype;return S.destroy=function(){this.clearTimer(),this.hls=this.log=this.warn=null},S.onError=function(L,y){y.fatal&&y.type===I.ErrorTypes.NETWORK_ERROR&&this.clearTimer()},S.clearTimer=function(){clearTimeout(this.timer),this.timer=-1},S.startLoad=function(){this.canLoad=!0,this.retryCount=0,this.loadPlaylist()},S.stopLoad=function(){this.canLoad=!1,this.clearTimer()},S.switchParams=function(L,y){var T=null==y?void 0:y.renditionReports;if(T)for(var p=0;p<T.length;p++){var f=T[p],r=""+f.URI;if(r===L.slice(-r.length)){var t=parseInt(f["LAST-MSN"]),d=parseInt(f["LAST-PART"]);if(y&&this.hls.config.lowLatencyMode){var c=Math.min(y.age-y.partTarget,y.targetduration);void 0!==d&&c>y.partTarget&&(d+=1)}if((0,b.isFiniteNumber)(t))return new R.HlsUrlParameters(t,(0,b.isFiniteNumber)(d)?d:void 0,R.HlsSkip.No)}}},S.loadPlaylist=function(L){},S.shouldLoadTrack=function(L){return this.canLoad&&L&&!!L.url&&(!L.details||L.details.live)},S.playlistLoaded=function(L,y,T){var p=this,f=y.details,r=y.stats,t=r.loading.end?Math.max(0,self.performance.now()-r.loading.end):0;if(f.advancedDateTime=Date.now()-t,f.live||null!=T&&T.live){if(f.reloaded(T),T&&this.log("live playlist "+L+" "+(f.advanced?"REFRESHED "+f.lastPartSn+"-"+f.lastPartIndex:"MISSED")),T&&f.fragments.length>0&&(0,D.mergeDetails)(T,f),!this.canLoad||!f.live)return;var d,c=void 0,n=void 0;if(f.canBlockReload&&f.endSN&&f.advanced){var i=this.hls.config.lowLatencyMode,l=f.lastPartSn,o=f.endSN,e=f.lastPartIndex,s=l===o;-1!==e?(c=s?o+1:l,n=s?i?0:e:e+1):c=o+1;var u=f.age,m=Math.min(u+f.ageHeader-f.partTarget,1.5*f.targetduration);if(m>0){if(T&&m>T.tuneInGoal)this.warn("CDN Tune-in goal increased from: "+T.tuneInGoal+" to: "+m+" with playlist age: "+f.age),m=0;else{var E=Math.floor(m/f.targetduration);c+=E,void 0!==n&&(n+=Math.round(m%f.targetduration/f.partTarget)),this.log("CDN Tune-in age: "+f.ageHeader+"s last advanced "+u.toFixed(2)+"s goal: "+m+" skip sn "+E+" to part "+n)}f.tuneInGoal=m}if(d=this.getDeliveryDirectives(f,y.deliveryDirectives,c,n),i||!s)return void this.loadPlaylist(d)}else d=this.getDeliveryDirectives(f,y.deliveryDirectives,c,n);var M=(0,D.computeReloadInterval)(f,r);void 0!==c&&f.canBlockReload&&(M-=f.partTarget||1),this.log("reload live playlist "+L+" in "+Math.round(M)+" ms"),this.timer=self.setTimeout(function(){return p.loadPlaylist(d)},M)}else this.clearTimer()},S.getDeliveryDirectives=function(L,y,T,p){var f=(0,R.getSkipValue)(L,T);return null!=y&&y.skip&&L.deltaUpdateFailed&&(T=y.msn,p=y.part,f=R.HlsSkip.No),new R.HlsUrlParameters(T,p,f)},S.retryLoadingOrFail=function(L){var f,y=this,T=this.hls.config,p=this.retryCount<T.levelLoadingMaxRetry;if(p)if(this.retryCount++,L.details.indexOf("LoadTimeOut")>-1&&null!==(f=L.context)&&void 0!==f&&f.deliveryDirectives)this.warn("retry playlist loading #"+this.retryCount+' after "'+L.details+'"'),this.loadPlaylist();else{var r=Math.min(Math.pow(2,this.retryCount)*T.levelLoadingRetryDelay,T.levelLoadingMaxRetryTimeout);this.timer=self.setTimeout(function(){return y.loadPlaylist()},r),this.warn("retry playlist loading #"+this.retryCount+" in "+r+' ms after "'+L.details+'"')}else this.warn('cannot recover from error "'+L.details+'"'),this.clearTimer(),L.fatal=!0;return p},x}()},"./src/controller/base-stream-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{State:()=>o,default:()=>e});var b=A("./src/polyfills/number.ts"),R=A("./src/task-loop.ts"),D=A("./src/controller/fragment-tracker.ts"),_=A("./src/utils/buffer-helper.ts"),I=A("./src/utils/logger.ts"),P=A("./src/events.ts"),x=A("./src/errors.ts"),S=A("./src/types/transmuxer.ts"),g=A("./src/utils/mp4-tools.ts"),L=A("./src/utils/discontinuities.ts"),y=A("./src/controller/fragment-finders.ts"),T=A("./src/controller/level-helper.ts"),p=A("./src/loader/fragment-loader.ts"),f=A("./src/crypt/decrypter.ts"),r=A("./src/utils/time-ranges.ts"),t=A("./src/types/loader.ts");function d(v,s){for(var h=0;h<s.length;h++){var u=s[h];u.enumerable=u.enumerable||!1,u.configurable=!0,"value"in u&&(u.writable=!0),Object.defineProperty(v,u.key,u)}}function n(v){if(void 0===v)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return v}function l(v,s){return(l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(u,a){return u.__proto__=a,u})(v,s)}var o={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"},e=function(v){function s(u,a,m){var E;return(E=v.call(this)||this).hls=void 0,E.fragPrevious=null,E.fragCurrent=null,E.fragmentTracker=void 0,E.transmuxer=null,E._state=o.STOPPED,E.media=null,E.mediaBuffer=null,E.config=void 0,E.bitrateTest=!1,E.lastCurrentTime=0,E.nextLoadPosition=0,E.startPosition=0,E.loadedmetadata=!1,E.fragLoadError=0,E.retryDate=0,E.levels=null,E.fragmentLoader=void 0,E.levelLastLoaded=null,E.startFragRequested=!1,E.decrypter=void 0,E.initPTS=[],E.onvseeking=null,E.onvended=null,E.logPrefix="",E.log=void 0,E.warn=void 0,E.logPrefix=m,E.log=I.logger.log.bind(I.logger,m+":"),E.warn=I.logger.warn.bind(I.logger,m+":"),E.hls=u,E.fragmentLoader=new p.default(u.config),E.fragmentTracker=a,E.config=u.config,E.decrypter=new f.default(u,u.config),u.on(P.Events.KEY_LOADED,E.onKeyLoaded,n(E)),u.on(P.Events.LEVEL_SWITCHING,E.onLevelSwitching,n(E)),E}!function i(v,s){v.prototype=Object.create(s.prototype),v.prototype.constructor=v,l(v,s)}(s,v);var h=s.prototype;return h.doTick=function(){this.onTickEnd()},h.onTickEnd=function(){},h.startLoad=function(a){},h.stopLoad=function(){this.fragmentLoader.abort();var a=this.fragCurrent;a&&this.fragmentTracker.removeFragment(a),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=o.STOPPED},h._streamEnded=function(a,m){var E=this.fragCurrent,O=this.fragmentTracker;if(!m.live&&E&&this.media&&E.sn>=m.endSN&&!a.nextStart){var M=m.partList;if(null!=M&&M.length){var C=M[M.length-1];return _.BufferHelper.isBuffered(this.media,C.start+C.duration/2)}var U=O.getState(E);return U===D.FragmentState.PARTIAL||U===D.FragmentState.OK}return!1},h.onMediaAttached=function(a,m){var E=this.media=this.mediaBuffer=m.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),E.addEventListener("seeking",this.onvseeking),E.addEventListener("ended",this.onvended);var O=this.config;this.levels&&O.autoStartLoad&&this.state===o.STOPPED&&this.startLoad(O.startPosition)},h.onMediaDetaching=function(){var a=this.media;null!=a&&a.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),a&&this.onvseeking&&this.onvended&&(a.removeEventListener("seeking",this.onvseeking),a.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()},h.onMediaSeeking=function(){var a=this.config,m=this.fragCurrent,E=this.media,M=this.state,C=E?E.currentTime:0,F=_.BufferHelper.bufferInfo(this.mediaBuffer||E,C,a.maxBufferHole);if(this.log("media seeking to "+((0,b.isFiniteNumber)(C)?C.toFixed(3):C)+", state: "+M),M===o.ENDED)this.resetLoadingState();else if(m){var U=a.maxFragLookUpTolerance,k=m.start-U,N=m.start+m.duration+U;if(!F.len||N<F.start||k>F.end){var w=C>N;(C<k||w)&&(w&&m.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),m.loader.abort()),this.resetLoadingState())}}E&&(this.lastCurrentTime=C),!this.loadedmetadata&&!F.len&&(this.nextLoadPosition=this.startPosition=C),this.tickImmediate()},h.onMediaEnded=function(){this.startPosition=this.lastCurrentTime=0},h.onKeyLoaded=function(a,m){if(this.state===o.KEY_LOADING&&m.frag===this.fragCurrent&&this.levels){this.state=o.IDLE;var E=this.levels[m.frag.level].details;E&&this.loadFragment(m.frag,E,m.frag.start)}},h.onLevelSwitching=function(a,m){this.fragLoadError=0},h.onHandlerDestroying=function(){this.stopLoad(),v.prototype.onHandlerDestroying.call(this)},h.onHandlerDestroyed=function(){this.state=o.STOPPED,this.hls.off(P.Events.KEY_LOADED,this.onKeyLoaded,this),this.hls.off(P.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),this.fragmentLoader&&this.fragmentLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.fragmentLoader=this.fragmentTracker=null,v.prototype.onHandlerDestroyed.call(this)},h.loadKey=function(a,m){this.log("Loading key for "+a.sn+" of ["+m.startSN+"-"+m.endSN+"], "+("[stream-controller]"===this.logPrefix?"level":"track")+" "+a.level),this.state=o.KEY_LOADING,this.fragCurrent=a,this.hls.trigger(P.Events.KEY_LOADING,{frag:a})},h.loadFragment=function(a,m,E){this._loadFragForPlayback(a,m,E)},h._loadFragForPlayback=function(a,m,E){var O=this;this._doFragLoad(a,m,E,function(F){if(O.fragContextChanged(a))return O.warn("Fragment "+a.sn+(F.part?" p: "+F.part.index:"")+" of level "+a.level+" was dropped during download."),void O.fragmentTracker.removeFragment(a);a.stats.chunkCount++,O._handleFragmentLoadProgress(F)}).then(function(C){if(C){O.fragLoadError=0;var F=O.state;if(O.fragContextChanged(a))return void((F===o.FRAG_LOADING||!O.fragCurrent&&F===o.PARSING)&&(O.fragmentTracker.removeFragment(a),O.state=o.IDLE));"payload"in C&&(O.log("Loaded fragment "+a.sn+" of level "+a.level),O.hls.trigger(P.Events.FRAG_LOADED,C)),O._handleFragmentLoadComplete(C)}}).catch(function(C){O.state===o.STOPPED||O.state===o.ERROR||(O.warn(C),O.resetFragmentLoading(a))})},h.flushMainBuffer=function(a,m,E){if(void 0===E&&(E=null),a-m){var O={startOffset:a,endOffset:m,type:E};this.fragLoadError=0,this.hls.trigger(P.Events.BUFFER_FLUSHING,O)}},h._loadInitSegment=function(a){var m=this;this._doFragLoad(a).then(function(E){if(!E||m.fragContextChanged(a)||!m.levels)throw new Error("init load aborted");return E}).then(function(E){var O=m.hls,M=E.payload,C=a.decryptdata;if(M&&M.byteLength>0&&C&&C.key&&C.iv&&"AES-128"===C.method){var F=self.performance.now();return m.decrypter.webCryptoDecrypt(new Uint8Array(M),C.key.buffer,C.iv.buffer).then(function(U){var k=self.performance.now();return O.trigger(P.Events.FRAG_DECRYPTED,{frag:a,payload:U,stats:{tstart:F,tdecrypt:k}}),E.payload=U,E})}return E}).then(function(E){var O=m.fragCurrent,M=m.hls,C=m.levels;if(!C)throw new Error("init load aborted, missing levels");console.assert(C[a.level].details,"Level details are defined when init segment is loaded");var U=a.stats;m.state=o.IDLE,m.fragLoadError=0,a.data=new Uint8Array(E.payload),U.parsing.start=U.buffering.start=self.performance.now(),U.parsing.end=U.buffering.end=self.performance.now(),E.frag===O&&M.trigger(P.Events.FRAG_BUFFERED,{stats:U,frag:O,part:null,id:a.type}),m.tick()}).catch(function(E){m.state===o.STOPPED||m.state===o.ERROR||(m.warn(E),m.resetFragmentLoading(a))})},h.fragContextChanged=function(a){var m=this.fragCurrent;return!a||!m||a.level!==m.level||a.sn!==m.sn||a.urlId!==m.urlId},h.fragBufferedComplete=function(a,m){var E,O,M=this.mediaBuffer?this.mediaBuffer:this.media;this.log("Buffered "+a.type+" sn: "+a.sn+(m?" part: "+m.index:"")+" of "+("[stream-controller]"===this.logPrefix?"level":"track")+" "+a.level+" "+(M?r.default.toString(_.BufferHelper.getBuffered(M)):"(detached)")),this.state=o.IDLE,M&&(!this.loadedmetadata&&a.type==t.PlaylistLevelType.MAIN&&M.buffered.length&&(null===(E=this.fragCurrent)||void 0===E?void 0:E.sn)===(null===(O=this.fragPrevious)||void 0===O?void 0:O.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())},h.seekToStartPos=function(){},h._handleFragmentLoadComplete=function(a){var m=this.transmuxer;if(m){var E=a.frag,O=a.part,M=a.partsLoaded,C=!M||0===M.length||M.some(function(U){return!U}),F=new S.ChunkMetadata(E.level,E.sn,E.stats.chunkCount+1,0,O?O.index:-1,!C);m.flush(F)}},h._handleFragmentLoadProgress=function(a){},h._doFragLoad=function(a,m,E,O){var M=this;if(void 0===E&&(E=null),!this.levels)throw new Error("frag load aborted, missing levels");if(E=Math.max(a.start,E||0),this.config.lowLatencyMode&&m){var C=m.partList;if(C&&O){E>a.end&&m.fragmentHint&&(a=m.fragmentHint);var F=this.getNextPart(C,a,E);if(F>-1){var U=C[F];return this.log("Loading part sn: "+a.sn+" p: "+U.index+" cc: "+a.cc+" of playlist ["+m.startSN+"-"+m.endSN+"] parts [0-"+F+"-"+(C.length-1)+"] "+("[stream-controller]"===this.logPrefix?"level":"track")+": "+a.level+", target: "+parseFloat(E.toFixed(3))),this.nextLoadPosition=U.start+U.duration,this.state=o.FRAG_LOADING,this.hls.trigger(P.Events.FRAG_LOADING,{frag:a,part:C[F],targetBufferTime:E}),this.doFragPartsLoad(a,C,F,O).catch(function(k){return M.handleFragLoadError(k)})}if(!a.url||this.loadedEndOfParts(C,E))return Promise.resolve(null)}}return this.log("Loading fragment "+a.sn+" cc: "+a.cc+" "+(m?"of ["+m.startSN+"-"+m.endSN+"] ":"")+("[stream-controller]"===this.logPrefix?"level":"track")+": "+a.level+", target: "+parseFloat(E.toFixed(3))),(0,b.isFiniteNumber)(a.sn)&&!this.bitrateTest&&(this.nextLoadPosition=a.start+a.duration),this.state=o.FRAG_LOADING,this.hls.trigger(P.Events.FRAG_LOADING,{frag:a,targetBufferTime:E}),this.fragmentLoader.load(a,O).catch(function(k){return M.handleFragLoadError(k)})},h.doFragPartsLoad=function(a,m,E,O){var M=this;return new Promise(function(C,F){var U=[];!function N(w){var K=m[w];M.fragmentLoader.loadPart(a,K,O).then(function(G){U[K.index]=G;var H=G.part;M.hls.trigger(P.Events.FRAG_LOADED,G);var V=m[w+1];if(!V||V.fragment!==a)return C({frag:a,part:H,partsLoaded:U});N(w+1)}).catch(F)}(E)})},h.handleFragLoadError=function(a){var m=a.data;return m&&m.details===x.ErrorDetails.INTERNAL_ABORTED?this.handleFragLoadAborted(m.frag,m.part):this.hls.trigger(P.Events.ERROR,m),null},h._handleTransmuxerFlush=function(a){var m=this.getCurrentContext(a);if(m&&this.state===o.PARSING){var E=m.frag,O=m.part,M=m.level,C=self.performance.now();E.stats.parsing.end=C,O&&(O.stats.parsing.end=C),this.updateLevelTiming(E,O,M,a.partial)}else this.fragCurrent||(this.state=o.IDLE)},h.getCurrentContext=function(a){var m=this.levels,E=a.level,O=a.sn,M=a.part;if(!m||!m[E])return this.warn("Levels object was unset while buffering fragment "+O+" of level "+E+". The current chunk will not be buffered."),null;var C=m[E],F=M>-1?(0,T.getPartWith)(C,O,M):null,U=F?F.fragment:(0,T.getFragmentWithSN)(C,O,this.fragCurrent);return U?{frag:U,part:F,level:C}:null},h.bufferFragmentData=function(a,m,E,O){if(a&&this.state===o.PARSING){var M=a.data1,C=a.data2,F=M;M&&C&&(F=(0,g.appendUint8Array)(M,C)),F&&F.length&&(this.hls.trigger(P.Events.BUFFER_APPENDING,{type:a.type,frag:m,part:E,chunkMeta:O,parent:m.type,data:F}),a.dropped&&a.independent&&!E&&this.flushBufferGap(m))}},h.flushBufferGap=function(a){var m=this.media;if(m){if(!_.BufferHelper.isBuffered(m,m.currentTime))return void this.flushMainBuffer(0,a.start);var E=m.currentTime,O=_.BufferHelper.bufferInfo(m,E,0),C=Math.min(2*this.config.maxFragLookUpTolerance,.25*a.duration),F=Math.max(Math.min(a.start-C,O.end-C),E+C);a.start-F>C&&this.flushMainBuffer(F,a.start)}},h.getFwdBufferInfo=function(a,m){var E=this.config,O=this.getLoadPosition();if(!(0,b.isFiniteNumber)(O))return null;var M=_.BufferHelper.bufferInfo(a,O,E.maxBufferHole);if(0===M.len&&void 0!==M.nextStart){var C=this.fragmentTracker.getBufferedFrag(O,m);if(C&&M.nextStart<C.end)return _.BufferHelper.bufferInfo(a,O,Math.max(M.nextStart,E.maxBufferHole))}return M},h.getMaxBufferLength=function(a){var E,m=this.config;return E=a?Math.max(8*m.maxBufferSize/a,m.maxBufferLength):m.maxBufferLength,Math.min(E,m.maxMaxBufferLength)},h.reduceMaxBufferLength=function(a){var m=this.config;return m.maxMaxBufferLength>=(a||m.maxBufferLength)&&(m.maxMaxBufferLength/=2,this.warn("Reduce max buffer length to "+m.maxMaxBufferLength+"s"),!0)},h.getNextFragment=function(a,m){var E=m.fragments,O=E.length;if(!O)return null;var F,M=this.config,C=E[0].start;if(m.live){var U=M.initialLiveManifestSize;if(O<U)return this.warn("Not enough fragments to start playback (have: "+O+", need: "+U+")"),null;!m.PTSKnown&&!this.startFragRequested&&-1===this.startPosition&&(F=this.getInitialLiveFragment(m,E),this.startPosition=F?this.hls.liveSyncPosition||F.start:a)}else a<=C&&(F=E[0]);return F||(F=this.getFragmentAtPosition(a,M.lowLatencyMode?m.partEnd:m.fragmentEnd,m)),this.mapToInitFragWhenRequired(F)},h.mapToInitFragWhenRequired=function(a){return null==a||!a.initSegment||null!=a&&a.initSegment.data||this.bitrateTest?a:a.initSegment},h.getNextPart=function(a,m,E){for(var O=-1,M=!1,C=!0,F=0,U=a.length;F<U;F++){var k=a[F];if(C=C&&!k.independent,O>-1&&E<k.start)break;var N=k.loaded;!N&&(M||k.independent||C)&&k.fragment===m&&(O=F),M=N}return O},h.loadedEndOfParts=function(a,m){var E=a[a.length-1];return E&&m>E.start&&E.loaded},h.getInitialLiveFragment=function(a,m){var E=this.fragPrevious,O=null;if(E){if(a.hasProgramDateTime&&(this.log("Live playlist, switching playlist, load frag with same PDT: "+E.programDateTime),O=(0,y.findFragmentByPDT)(m,E.endProgramDateTime,this.config.maxFragLookUpTolerance)),!O){var M=E.sn+1;if(M>=a.startSN&&M<=a.endSN){var C=m[M-a.startSN];E.cc===C.cc&&this.log("Live playlist, switching playlist, load frag with next SN: "+(O=C).sn)}O||(O=(0,y.findFragWithCC)(m,E.cc))&&this.log("Live playlist, switching playlist, load frag with same CC: "+O.sn)}}else{var F=this.hls.liveSyncPosition;null!==F&&(O=this.getFragmentAtPosition(F,this.bitrateTest?a.fragmentEnd:a.edge,a))}return O},h.getFragmentAtPosition=function(a,m,E){var w,O=this.config,M=this.fragPrevious,C=E.fragments,F=E.endSN,U=E.fragmentHint,k=O.maxFragLookUpTolerance,N=!!(O.lowLatencyMode&&E.partList&&U);if(N&&U&&!this.bitrateTest&&(C=C.concat(U),F=U.sn),w=a<m?(0,y.findFragmentByPTS)(M,C,a,a>m-k?0:k):C[C.length-1]){var G=w.sn-E.startSN;if(this.fragmentTracker.getState(w)===D.FragmentState.OK&&(M=w),M&&w.sn===M.sn&&!N&&M&&w.level===M.level){var V=C[G+1];w.sn<F&&this.fragmentTracker.getState(V)!==D.FragmentState.OK?(this.log("SN "+w.sn+" just loaded, load next one: "+V.sn),w=V):w=null}}return w},h.synchronizeToLiveEdge=function(a){var m=this.config,E=this.media;if(E){var O=this.hls.liveSyncPosition,M=E.currentTime,F=a.edge,U=M>=a.fragments[0].start-m.maxFragLookUpTolerance&&M<=F;null!==O&&E.duration>O&&(M<O||!U)&&(!U&&E.readyState<4||M<F-(void 0!==m.liveMaxLatencyDuration?m.liveMaxLatencyDuration:m.liveMaxLatencyDurationCount*a.targetduration))&&(this.loadedmetadata||(this.nextLoadPosition=O),E.readyState&&(this.warn("Playback: "+M.toFixed(3)+" is located too far from the end of live sliding playlist: "+F+", reset currentTime to : "+O.toFixed(3)),E.currentTime=O))}},h.alignPlaylists=function(a,m){var O=this.levelLastLoaded,M=this.fragPrevious,C=null!==O?this.levels[O]:null,F=a.fragments.length;if(!F)return this.warn("No fragments in live playlist"),0;var U=a.fragments[0].start,k=!m,N=a.alignedSliding&&(0,b.isFiniteNumber)(U);if(k||!N&&!U){(0,L.alignStream)(M,C,a);var w=a.fragments[0].start;return this.log("Live playlist sliding: "+w.toFixed(2)+" start-sn: "+(m?m.startSN:"na")+"->"+a.startSN+" prev-sn: "+(M?M.sn:"na")+" fragments: "+F),w}return U},h.waitForCdnTuneIn=function(a){return a.live&&a.canBlockReload&&a.partTarget&&a.tuneInGoal>Math.max(a.partHoldBack,3*a.partTarget)},h.setStartPosition=function(a,m){var E=this.startPosition;if(E<m&&(E=-1),-1===E||-1===this.lastCurrentTime){var O=a.startTimeOffset;(0,b.isFiniteNumber)(O)?(E=m+O,O<0&&(E+=a.totalduration),E=Math.min(Math.max(m,E),m+a.totalduration),this.log("Start time offset "+O+" found in playlist, adjust startPosition to "+E),this.startPosition=E):a.live?E=this.hls.liveSyncPosition||m:this.startPosition=E=0,this.lastCurrentTime=E}this.nextLoadPosition=E},h.getLoadPosition=function(){var a=this.media,m=0;return this.loadedmetadata&&a?m=a.currentTime:this.nextLoadPosition&&(m=this.nextLoadPosition),m},h.handleFragLoadAborted=function(a,m){this.transmuxer&&"initSegment"!==a.sn&&a.stats.aborted&&(this.warn("Fragment "+a.sn+(m?" part"+m.index:"")+" of level "+a.level+" was aborted"),this.resetFragmentLoading(a))},h.resetFragmentLoading=function(a){(!this.fragCurrent||!this.fragContextChanged(a)&&this.state!==o.FRAG_LOADING_WAITING_RETRY)&&(this.state=o.IDLE)},h.onFragmentOrKeyLoadError=function(a,m){if(!m.fatal){var E=m.frag;if(E&&E.type===a){var O=this.fragCurrent;console.assert(O&&E.sn===O.sn&&E.level===O.level&&E.urlId===O.urlId,"Frag load error must match current frag to retry");var M=this.config;if(this.fragLoadError+1<=M.fragLoadingMaxRetry){this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition);var C=Math.min(Math.pow(2,this.fragLoadError)*M.fragLoadingRetryDelay,M.fragLoadingMaxRetryTimeout);this.warn("Fragment "+E.sn+" of "+a+" "+E.level+" failed to load, retrying in "+C+"ms"),this.retryDate=self.performance.now()+C,this.fragLoadError++,this.state=o.FRAG_LOADING_WAITING_RETRY}else m.levelRetry?(a===t.PlaylistLevelType.AUDIO&&(this.fragCurrent=null),this.fragLoadError=0,this.state=o.IDLE):(I.logger.error(m.details+" reaches max retry, redispatch as fatal ..."),m.fatal=!0,this.hls.stopLoad(),this.state=o.ERROR)}}},h.afterBufferFlushed=function(a,m,E){if(a){var O=_.BufferHelper.getBuffered(a);this.fragmentTracker.detectEvictedFragments(m,O,E),this.state===o.ENDED&&this.resetLoadingState()}},h.resetLoadingState=function(){this.fragCurrent=null,this.fragPrevious=null,this.state=o.IDLE},h.resetStartWhenNotLoaded=function(a){if(!this.loadedmetadata){this.startFragRequested=!1;var m=this.levels?this.levels[a].details:null;null!=m&&m.live?(this.startPosition=-1,this.setStartPosition(m,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}},h.updateLevelTiming=function(a,m,E,O){var M=this,C=E.details;console.assert(!!C,"level.details must be defined"),Object.keys(a.elementaryStreams).reduce(function(U,k){var N=a.elementaryStreams[k];if(N){var w=N.endPTS-N.startPTS;if(w<=0)return M.warn("Could not parse fragment "+a.sn+" "+k+" duration reliably ("+w+")"),U||!1;var K=O?0:(0,T.updateFragPTSDTS)(C,a,N.startPTS,N.endPTS,N.startDTS,N.endDTS);return M.hls.trigger(P.Events.LEVEL_PTS_UPDATED,{details:C,level:E,drift:K,type:k,frag:a,start:N.startPTS,end:N.endPTS}),!0}return U},!1)||(this.warn("Found no media in fragment "+a.sn+" of level "+E.id+" resetting transmuxer to fallback to playlist timing"),this.resetTransmuxer()),this.state=o.PARSED,this.hls.trigger(P.Events.FRAG_PARSED,{frag:a,part:m})},h.resetTransmuxer=function(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)},function c(v,s,h){s&&d(v.prototype,s),h&&d(v,h),Object.defineProperty(v,"prototype",{writable:!1})}(s,[{key:"state",get:function(){return this._state},set:function(a){var m=this._state;m!==a&&(this._state=a,this.log(m+"->"+a))}}]),s}(R.default)},"./src/controller/buffer-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>y});var b=A("./src/polyfills/number.ts"),R=A("./src/events.ts"),D=A("./src/utils/logger.ts"),_=A("./src/errors.ts"),I=A("./src/utils/buffer-helper.ts"),P=A("./src/utils/mediasource-helper.ts"),x=A("./src/loader/fragment.ts"),S=A("./src/controller/buffer-operation-queue.ts"),g=(0,P.getMediaSource)(),L=/([ha]vc.)(?:\.[^.,]+)+/,y=function(){function T(f){var r=this;this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.appendError=0,this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this._onMediaSourceOpen=function(){var t=r.hls,d=r.media,c=r.mediaSource;D.logger.log("[buffer-controller]: Media source opened"),d&&(r.updateMediaElementDuration(),t.trigger(R.Events.MEDIA_ATTACHED,{media:d})),c&&c.removeEventListener("sourceopen",r._onMediaSourceOpen),r.checkPendingTracks()},this._onMediaSourceClose=function(){D.logger.log("[buffer-controller]: Media source closed")},this._onMediaSourceEnded=function(){D.logger.log("[buffer-controller]: Media source ended")},this.hls=f,this._initSourceBuffer(),this.registerListeners()}var p=T.prototype;return p.hasSourceTypes=function(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0},p.destroy=function(){this.unregisterListeners(),this.details=null},p.registerListeners=function(){var r=this.hls;r.on(R.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),r.on(R.Events.MEDIA_DETACHING,this.onMediaDetaching,this),r.on(R.Events.MANIFEST_PARSED,this.onManifestParsed,this),r.on(R.Events.BUFFER_RESET,this.onBufferReset,this),r.on(R.Events.BUFFER_APPENDING,this.onBufferAppending,this),r.on(R.Events.BUFFER_CODECS,this.onBufferCodecs,this),r.on(R.Events.BUFFER_EOS,this.onBufferEos,this),r.on(R.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),r.on(R.Events.LEVEL_UPDATED,this.onLevelUpdated,this),r.on(R.Events.FRAG_PARSED,this.onFragParsed,this),r.on(R.Events.FRAG_CHANGED,this.onFragChanged,this)},p.unregisterListeners=function(){var r=this.hls;r.off(R.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),r.off(R.Events.MEDIA_DETACHING,this.onMediaDetaching,this),r.off(R.Events.MANIFEST_PARSED,this.onManifestParsed,this),r.off(R.Events.BUFFER_RESET,this.onBufferReset,this),r.off(R.Events.BUFFER_APPENDING,this.onBufferAppending,this),r.off(R.Events.BUFFER_CODECS,this.onBufferCodecs,this),r.off(R.Events.BUFFER_EOS,this.onBufferEos,this),r.off(R.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),r.off(R.Events.LEVEL_UPDATED,this.onLevelUpdated,this),r.off(R.Events.FRAG_PARSED,this.onFragParsed,this),r.off(R.Events.FRAG_CHANGED,this.onFragChanged,this)},p._initSourceBuffer=function(){this.sourceBuffer={},this.operationQueue=new S.default(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]}},p.onManifestParsed=function(r,t){var d=2;(t.audio&&!t.video||!t.altAudio)&&(d=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=d,this.details=null,D.logger.log(this.bufferCodecEventsExpected+" bufferCodec event(s) expected")},p.onMediaAttaching=function(r,t){var d=this.media=t.media;if(d&&g){var c=this.mediaSource=new g;c.addEventListener("sourceopen",this._onMediaSourceOpen),c.addEventListener("sourceended",this._onMediaSourceEnded),c.addEventListener("sourceclose",this._onMediaSourceClose),d.src=self.URL.createObjectURL(c),this._objectUrl=d.src}},p.onMediaDetaching=function(){var r=this.media,t=this.mediaSource,d=this._objectUrl;if(t){if(D.logger.log("[buffer-controller]: media source detaching"),"open"===t.readyState)try{t.endOfStream()}catch(c){D.logger.warn("[buffer-controller]: onMediaDetaching: "+c.message+" while calling endOfStream")}this.onBufferReset(),t.removeEventListener("sourceopen",this._onMediaSourceOpen),t.removeEventListener("sourceended",this._onMediaSourceEnded),t.removeEventListener("sourceclose",this._onMediaSourceClose),r&&(d&&self.URL.revokeObjectURL(d),r.src===d?(r.removeAttribute("src"),r.load()):D.logger.warn("[buffer-controller]: media.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(R.Events.MEDIA_DETACHED,void 0)},p.onBufferReset=function(){var r=this;this.getSourceBufferTypes().forEach(function(t){var d=r.sourceBuffer[t];try{d&&(r.removeBufferListeners(t),r.mediaSource&&r.mediaSource.removeSourceBuffer(d),r.sourceBuffer[t]=void 0)}catch(c){D.logger.warn("[buffer-controller]: Failed to reset the "+t+" buffer",c)}}),this._initSourceBuffer()},p.onBufferCodecs=function(r,t){var d=this,c=this.getSourceBufferTypes().length;Object.keys(t).forEach(function(n){if(c){var i=d.tracks[n];if(i&&"function"==typeof i.buffer.changeType){var l=t[n],o=l.id,e=l.codec,v=l.levelCodec,s=l.container,h=l.metadata,u=(i.levelCodec||i.codec).replace(L,"$1"),a=(v||e).replace(L,"$1");u!==a&&(d.appendChangeType(n,s+";codecs="+(v||e)),D.logger.log("[buffer-controller]: switching codec "+u+" to "+a),d.tracks[n]={buffer:i.buffer,codec:e,container:s,levelCodec:v,metadata:h,id:o})}}else d.pendingTracks[n]=t[n]}),!c&&(this.bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks())},p.appendChangeType=function(r,t){var d=this,c=this.operationQueue,n={execute:function(){var l=d.sourceBuffer[r];l&&(D.logger.log("[buffer-controller]: changing "+r+" sourceBuffer type to "+t),l.changeType(t)),c.shiftAndExecuteNext(r)},onStart:function(){},onComplete:function(){},onError:function(l){D.logger.warn("[buffer-controller]: Failed to change "+r+" SourceBuffer type",l)}};c.append(n,r)},p.onBufferAppending=function(r,t){var d=this,c=this.hls,n=this.operationQueue,i=this.tracks,l=t.data,o=t.type,e=t.frag,v=t.part,s=t.chunkMeta,h=s.buffering[o],u=self.performance.now();h.start=u;var a=e.stats.buffering,m=v?v.stats.buffering:null;0===a.start&&(a.start=u),m&&0===m.start&&(m.start=u);var E=i.audio,O="audio"===o&&1===s.id&&"audio/mpeg"===(null==E?void 0:E.container);n.append({execute:function(){if(h.executeStart=self.performance.now(),O){var F=d.sourceBuffer[o];if(F){var U=e.start-F.timestampOffset;Math.abs(U)>=.1&&(D.logger.log("[buffer-controller]: Updating audio SourceBuffer timestampOffset to "+e.start+" (delta: "+U+") sn: "+e.sn+")"),F.timestampOffset=e.start)}}d.appendExecutor(l,o)},onStart:function(){},onComplete:function(){var F=self.performance.now();h.executeEnd=h.end=F,0===a.first&&(a.first=F),m&&0===m.first&&(m.first=F);var U=d.sourceBuffer,k={};for(var N in U)k[N]=I.BufferHelper.getBuffered(U[N]);d.appendError=0,d.hls.trigger(R.Events.BUFFER_APPENDED,{type:o,frag:e,part:v,chunkMeta:s,parent:e.type,timeRanges:k})},onError:function(F){D.logger.error("[buffer-controller]: Error encountered while trying to append to the "+o+" SourceBuffer",F);var U={type:_.ErrorTypes.MEDIA_ERROR,parent:e.type,details:_.ErrorDetails.BUFFER_APPEND_ERROR,err:F,fatal:!1};F.code===DOMException.QUOTA_EXCEEDED_ERR?U.details=_.ErrorDetails.BUFFER_FULL_ERROR:(d.appendError++,U.details=_.ErrorDetails.BUFFER_APPEND_ERROR,d.appendError>c.config.appendErrorMaxRetry&&(D.logger.error("[buffer-controller]: Failed "+c.config.appendErrorMaxRetry+" times to append segment in sourceBuffer"),U.fatal=!0,c.stopLoad())),c.trigger(R.Events.ERROR,U)}},o)},p.onBufferFlushing=function(r,t){var d=this,c=this.operationQueue,n=function(l){return{execute:d.removeExecutor.bind(d,l,t.startOffset,t.endOffset),onStart:function(){},onComplete:function(){d.hls.trigger(R.Events.BUFFER_FLUSHED,{type:l})},onError:function(e){D.logger.warn("[buffer-controller]: Failed to remove from "+l+" SourceBuffer",e)}}};t.type?c.append(n(t.type),t.type):this.getSourceBufferTypes().forEach(function(i){c.append(n(i),i)})},p.onFragParsed=function(r,t){var d=this,c=t.frag,n=t.part,i=[],l=n?n.elementaryStreams:c.elementaryStreams;l[x.ElementaryStreamTypes.AUDIOVIDEO]?i.push("audiovideo"):(l[x.ElementaryStreamTypes.AUDIO]&&i.push("audio"),l[x.ElementaryStreamTypes.VIDEO]&&i.push("video")),0===i.length&&D.logger.warn("Fragments must have at least one ElementaryStreamType set. type: "+c.type+" level: "+c.level+" sn: "+c.sn),this.blockBuffers(function(){var v=self.performance.now();c.stats.buffering.end=v,n&&(n.stats.buffering.end=v),d.hls.trigger(R.Events.FRAG_BUFFERED,{frag:c,part:n,stats:n?n.stats:c.stats,id:c.type})},i)},p.onFragChanged=function(r,t){this.flushBackBuffer()},p.onBufferEos=function(r,t){var d=this;this.getSourceBufferTypes().reduce(function(n,i){var l=d.sourceBuffer[i];return(!t.type||t.type===i)&&l&&!l.ended&&(l.ended=!0,D.logger.log("[buffer-controller]: "+i+" sourceBuffer now EOS")),n&&!(l&&!l.ended)},!0)&&this.blockBuffers(function(){var n=d.mediaSource;!n||"open"!==n.readyState||n.endOfStream()})},p.onLevelUpdated=function(r,t){var d=t.details;!d.fragments.length||(this.details=d,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())},p.flushBackBuffer=function(){var r=this.hls,t=this.details,d=this.media,c=this.sourceBuffer;if(d&&null!==t){var n=this.getSourceBufferTypes();if(n.length){var i=t.live&&null!==r.config.liveBackBufferLength?r.config.liveBackBufferLength:r.config.backBufferLength;if((0,b.isFiniteNumber)(i)&&!(i<0)){var l=d.currentTime,o=t.levelTargetDuration,e=Math.max(i,o),v=Math.floor(l/o)*o-e;n.forEach(function(s){var h=c[s];if(h){var u=I.BufferHelper.getBuffered(h);u.length>0&&v>u.start(0)&&(r.trigger(R.Events.BACK_BUFFER_REACHED,{bufferEnd:v}),t.live&&r.trigger(R.Events.LIVE_BACK_BUFFER_REACHED,{bufferEnd:v}),r.trigger(R.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:v,type:s}))}})}}}},p.updateMediaElementDuration=function(){if(this.details&&this.media&&this.mediaSource&&"open"===this.mediaSource.readyState){var r=this.details,t=this.hls,c=this.mediaSource,n=r.fragments[0].start+r.totalduration,i=this.media.duration,l=(0,b.isFiniteNumber)(c.duration)?c.duration:0;r.live&&t.config.liveDurationInfinity?(D.logger.log("[buffer-controller]: Media Source duration is set to Infinity"),c.duration=1/0,this.updateSeekableRange(r)):(n>l&&n>i||!(0,b.isFiniteNumber)(i))&&(D.logger.log("[buffer-controller]: Updating Media Source duration to "+n.toFixed(3)),c.duration=n)}},p.updateSeekableRange=function(r){var t=this.mediaSource,d=r.fragments;if(d.length&&r.live&&null!=t&&t.setLiveSeekableRange){var n=Math.max(0,d[0].start),i=Math.max(n,n+r.totalduration);t.setLiveSeekableRange(n,i)}},p.checkPendingTracks=function(){var r=this.bufferCodecEventsExpected,t=this.operationQueue,d=this.pendingTracks,c=Object.keys(d).length;if(c&&!r||2===c){this.createSourceBuffers(d),this.pendingTracks={};var n=this.getSourceBufferTypes();if(0===n.length)return void this.hls.trigger(R.Events.ERROR,{type:_.ErrorTypes.MEDIA_ERROR,details:_.ErrorDetails.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,reason:"could not create source buffer for media codec(s)"});n.forEach(function(i){t.executeNext(i)})}},p.createSourceBuffers=function(r){var t=this.sourceBuffer,d=this.mediaSource;if(!d)throw Error("createSourceBuffers called when mediaSource was null");var c=0;for(var n in r)if(!t[n]){var i=r[n];if(!i)throw Error("source buffer exists for track "+n+", however track does not");var l=i.levelCodec||i.codec,o=i.container+";codecs="+l;D.logger.log("[buffer-controller]: creating sourceBuffer("+o+")");try{var e=t[n]=d.addSourceBuffer(o),v=n;this.addBufferListener(v,"updatestart",this._onSBUpdateStart),this.addBufferListener(v,"updateend",this._onSBUpdateEnd),this.addBufferListener(v,"error",this._onSBUpdateError),this.tracks[n]={buffer:e,codec:l,container:i.container,levelCodec:i.levelCodec,metadata:i.metadata,id:i.id},c++}catch(s){D.logger.error("[buffer-controller]: error while trying to add sourceBuffer: "+s.message),this.hls.trigger(R.Events.ERROR,{type:_.ErrorTypes.MEDIA_ERROR,details:_.ErrorDetails.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:s,mimeType:o})}}c&&this.hls.trigger(R.Events.BUFFER_CREATED,{tracks:this.tracks})},p._onSBUpdateStart=function(r){this.operationQueue.current(r).onStart()},p._onSBUpdateEnd=function(r){var t=this.operationQueue;t.current(r).onComplete(),t.shiftAndExecuteNext(r)},p._onSBUpdateError=function(r,t){D.logger.error("[buffer-controller]: "+r+" SourceBuffer error",t),this.hls.trigger(R.Events.ERROR,{type:_.ErrorTypes.MEDIA_ERROR,details:_.ErrorDetails.BUFFER_APPENDING_ERROR,fatal:!1});var d=this.operationQueue.current(r);d&&d.onError(t)},p.removeExecutor=function(r,t,d){var c=this.media,n=this.mediaSource,i=this.operationQueue,o=this.sourceBuffer[r];if(!c||!n||!o)return D.logger.warn("[buffer-controller]: Attempting to remove from the "+r+" SourceBuffer, but it does not exist"),void i.shiftAndExecuteNext(r);var e=(0,b.isFiniteNumber)(c.duration)?c.duration:1/0,v=(0,b.isFiniteNumber)(n.duration)?n.duration:1/0,s=Math.max(0,t),h=Math.min(d,e,v);h>s?(D.logger.log("[buffer-controller]: Removing ["+s+","+h+"] from the "+r+" SourceBuffer"),console.assert(!o.updating,r+" sourceBuffer must not be updating"),o.remove(s,h)):i.shiftAndExecuteNext(r)},p.appendExecutor=function(r,t){var d=this.operationQueue,n=this.sourceBuffer[t];if(!n)return D.logger.warn("[buffer-controller]: Attempting to append to the "+t+" SourceBuffer, but it does not exist"),void d.shiftAndExecuteNext(t);n.ended=!1,console.assert(!n.updating,t+" sourceBuffer must not be updating"),n.appendBuffer(r)},p.blockBuffers=function(r,t){var d=this;if(void 0===t&&(t=this.getSourceBufferTypes()),!t.length)return D.logger.log("[buffer-controller]: Blocking operation requested, but no SourceBuffers exist"),void Promise.resolve().then(r);var c=this.operationQueue,n=t.map(function(i){return c.appendBlocker(i)});Promise.all(n).then(function(){r(),t.forEach(function(i){var l=d.sourceBuffer[i];(!l||!l.updating)&&c.shiftAndExecuteNext(i)})})},p.getSourceBufferTypes=function(){return Object.keys(this.sourceBuffer)},p.addBufferListener=function(r,t,d){var c=this.sourceBuffer[r];if(c){var n=d.bind(this,r);this.listeners[r].push({event:t,listener:n}),c.addEventListener(t,n)}},p.removeBufferListeners=function(r){var t=this.sourceBuffer[r];!t||this.listeners[r].forEach(function(d){t.removeEventListener(d.event,d.listener)})},T}()},"./src/controller/buffer-operation-queue.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>R});var b=A("./src/utils/logger.ts"),R=function(){function D(I){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=I}var _=D.prototype;return _.append=function(P,x){var S=this.queues[x];S.push(P),1===S.length&&this.buffers[x]&&this.executeNext(x)},_.insertAbort=function(P,x){this.queues[x].unshift(P),this.executeNext(x)},_.appendBlocker=function(P){var x,S=new Promise(function(L){x=L});return this.append({execute:x,onStart:function(){},onComplete:function(){},onError:function(){}},P),S},_.executeNext=function(P){var g=this.buffers[P],L=this.queues[P];if(L.length){var y=L[0];try{y.execute()}catch(T){b.logger.warn("[buffer-operation-queue]: Unhandled exception executing the current operation"),y.onError(T),(!g||!g.updating)&&(L.shift(),this.executeNext(P))}}},_.shiftAndExecuteNext=function(P){this.queues[P].shift(),this.executeNext(P)},_.current=function(P){return this.queues[P][0]},D}()},"./src/controller/cap-level-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>I});var b=A("./src/events.ts");function R(P,x){for(var S=0;S<x.length;S++){var g=x[S];g.enumerable=g.enumerable||!1,g.configurable=!0,"value"in g&&(g.writable=!0),Object.defineProperty(P,g.key,g)}}const I=function(){function P(S){this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.hls=void 0,this.streamController=void 0,this.clientRect=void 0,this.hls=S,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}var x=P.prototype;return x.setStreamController=function(g){this.streamController=g},x.destroy=function(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null},x.registerListeners=function(){var g=this.hls;g.on(b.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),g.on(b.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),g.on(b.Events.MANIFEST_PARSED,this.onManifestParsed,this),g.on(b.Events.BUFFER_CODECS,this.onBufferCodecs,this),g.on(b.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},x.unregisterListener=function(){var g=this.hls;g.off(b.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),g.off(b.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),g.off(b.Events.MANIFEST_PARSED,this.onManifestParsed,this),g.off(b.Events.BUFFER_CODECS,this.onBufferCodecs,this),g.off(b.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},x.onFpsDropLevelCapping=function(g,L){P.isLevelAllowed(L.droppedLevel,this.restrictedLevels)&&this.restrictedLevels.push(L.droppedLevel)},x.onMediaAttaching=function(g,L){this.media=L.media instanceof HTMLVideoElement?L.media:null},x.onManifestParsed=function(g,L){var y=this.hls;this.restrictedLevels=[],this.firstLevel=L.firstLevel,y.config.capLevelToPlayerSize&&L.video&&this.startCapping()},x.onBufferCodecs=function(g,L){this.hls.config.capLevelToPlayerSize&&L.video&&this.startCapping()},x.onMediaDetaching=function(){this.stopCapping()},x.detectPlayerSize=function(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){var g=this.hls.levels;if(g.length){var L=this.hls;L.autoLevelCapping=this.getMaxLevel(g.length-1),L.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=L.autoLevelCapping}}},x.getMaxLevel=function(g){var L=this,y=this.hls.levels;if(!y.length)return-1;var T=y.filter(function(p,f){return P.isLevelAllowed(f,L.restrictedLevels)&&f<=g});return this.clientRect=null,P.getMaxLevelByMediaSize(T,this.mediaWidth,this.mediaHeight)},x.startCapping=function(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())},x.stopCapping=function(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)},x.getDimensions=function(){if(this.clientRect)return this.clientRect;var g=this.media,L={width:0,height:0};if(g){var y=g.getBoundingClientRect();L.width=y.width,L.height=y.height,!L.width&&!L.height&&(L.width=y.right-y.left||g.width||0,L.height=y.bottom-y.top||g.height||0)}return this.clientRect=L,L},P.isLevelAllowed=function(g,L){return void 0===L&&(L=[]),-1===L.indexOf(g)},P.getMaxLevelByMediaSize=function(g,L,y){if(!g||!g.length)return-1;for(var p=g.length-1,f=0;f<g.length;f+=1){var r=g[f];if((r.width>=L||r.height>=y)&&(d=r,!(c=g[f+1])||d.width!==c.width||d.height!==c.height)){p=f;break}}var d,c;return p},function D(P,x,S){x&&R(P.prototype,x),S&&R(P,S),Object.defineProperty(P,"prototype",{writable:!1})}(P,[{key:"mediaWidth",get:function(){return this.getDimensions().width*this.contentScaleFactor}},{key:"mediaHeight",get:function(){return this.getDimensions().height*this.contentScaleFactor}},{key:"contentScaleFactor",get:function(){var g=1;if(!this.hls.config.ignoreDevicePixelRatio)try{g=self.devicePixelRatio}catch(L){}return g}}]),P}()},"./src/controller/cmcd-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>y});var b=A("./src/events.ts"),R=A("./src/types/cmcd.ts"),D=A("./src/utils/buffer-helper.ts"),_=A("./src/utils/logger.ts");function I(T,p){for(var f=0;f<p.length;f++){var r=p[f];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(T,r.key,r)}}function P(T,p,f){return p&&I(T.prototype,p),f&&I(T,f),Object.defineProperty(T,"prototype",{writable:!1}),T}function x(T,p){var f="undefined"!=typeof Symbol&&T[Symbol.iterator]||T["@@iterator"];if(f)return(f=f.call(T)).next.bind(f);if(Array.isArray(T)||(f=function S(T,p){if(T){if("string"==typeof T)return g(T,p);var f=Object.prototype.toString.call(T).slice(8,-1);if("Object"===f&&T.constructor&&(f=T.constructor.name),"Map"===f||"Set"===f)return Array.from(T);if("Arguments"===f||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(f))return g(T,p)}}(T))||p&&T&&"number"==typeof T.length){f&&(T=f);var r=0;return function(){return r>=T.length?{done:!0}:{done:!1,value:T[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function g(T,p){(null==p||p>T.length)&&(p=T.length);for(var f=0,r=new Array(p);f<p;f++)r[f]=T[f];return r}function L(){return L=Object.assign?Object.assign.bind():function(T){for(var p=1;p<arguments.length;p++){var f=arguments[p];for(var r in f)Object.prototype.hasOwnProperty.call(f,r)&&(T[r]=f[r])}return T},L.apply(this,arguments)}var y=function(){function T(f){var r=this;this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=function(){r.initialized&&(r.starved=!0),r.buffering=!0},this.onPlaying=function(){r.initialized||(r.initialized=!0),r.buffering=!1},this.applyPlaylistData=function(c){try{r.apply(c,{ot:R.CMCDObjectType.MANIFEST,su:!r.initialized})}catch(n){_.logger.warn("Could not generate manifest CMCD data.",n)}},this.applyFragmentData=function(c){try{var n=c.frag,i=r.hls.levels[n.level],l=r.getObjectType(n),o={d:1e3*n.duration,ot:l};(l===R.CMCDObjectType.VIDEO||l===R.CMCDObjectType.AUDIO||l==R.CMCDObjectType.MUXED)&&(o.br=i.bitrate/1e3,o.tb=r.getTopBandwidth(l)/1e3,o.bl=r.getBufferLength(l)),r.apply(c,o)}catch(e){_.logger.warn("Could not generate segment CMCD data.",e)}},this.hls=f;var t=this.config=f.config,d=t.cmcd;null!=d&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=d.sessionId||T.uuid(),this.cid=d.contentId,this.useHeaders=!0===d.useHeaders,this.registerListeners())}var p=T.prototype;return p.registerListeners=function(){var r=this.hls;r.on(b.Events.MEDIA_ATTACHED,this.onMediaAttached,this),r.on(b.Events.MEDIA_DETACHED,this.onMediaDetached,this),r.on(b.Events.BUFFER_CREATED,this.onBufferCreated,this)},p.unregisterListeners=function(){var r=this.hls;r.off(b.Events.MEDIA_ATTACHED,this.onMediaAttached,this),r.off(b.Events.MEDIA_DETACHED,this.onMediaDetached,this),r.off(b.Events.BUFFER_CREATED,this.onBufferCreated,this),this.onMediaDetached()},p.destroy=function(){this.unregisterListeners(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null},p.onMediaAttached=function(r,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)},p.onMediaDetached=function(){!this.media||(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)},p.onBufferCreated=function(r,t){var d,c;this.audioBuffer=null===(d=t.tracks.audio)||void 0===d?void 0:d.buffer,this.videoBuffer=null===(c=t.tracks.video)||void 0===c?void 0:c.buffer},p.createData=function(){var r;return{v:R.CMCDVersion,sf:R.CMCDStreamingFormat.HLS,sid:this.sid,cid:this.cid,pr:null===(r=this.media)||void 0===r?void 0:r.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}},p.apply=function(r,t){if(void 0===t&&(t={}),L(t,this.createData()),this.starved&&(t.ot===R.CMCDObjectType.INIT||t.ot===R.CMCDObjectType.VIDEO||t.ot===R.CMCDObjectType.MUXED)&&(t.bs=!0,t.su=!0,this.starved=!1),null==t.su&&(t.su=this.buffering),this.useHeaders){var c=T.toHeaders(t);if(!Object.keys(c).length)return;r.headers||(r.headers={}),L(r.headers,c)}else{var n=T.toQuery(t);if(!n)return;r.url=T.appendQueryToUri(r.url,n)}},p.getObjectType=function(r){var t=r.type;return"subtitle"===t?R.CMCDObjectType.TIMED_TEXT:"initSegment"===r.sn?R.CMCDObjectType.INIT:"audio"===t?R.CMCDObjectType.AUDIO:"main"===t?this.hls.audioTracks.length?R.CMCDObjectType.VIDEO:R.CMCDObjectType.MUXED:void 0},p.getTopBandwidth=function(r){var d,t=0,c=this.hls;if(r===R.CMCDObjectType.AUDIO)d=c.audioTracks;else{var n=c.maxAutoLevel;d=c.levels.slice(0,n>-1?n+1:c.levels.length)}for(var o,l=x(d);!(o=l()).done;){var e=o.value;e.bitrate>t&&(t=e.bitrate)}return t>0?t:NaN},p.getBufferLength=function(r){var t=this.hls.media,d=r===R.CMCDObjectType.AUDIO?this.audioBuffer:this.videoBuffer;return d&&t?1e3*D.BufferHelper.bufferInfo(d,t.currentTime,this.config.maxBufferHole).len:NaN},p.createPlaylistLoader=function(){var t=this.applyPlaylistData,d=this.config.pLoader||this.config.loader;return function(){function c(i){this.loader=void 0,this.loader=new d(i)}var n=c.prototype;return n.destroy=function(){this.loader.destroy()},n.abort=function(){this.loader.abort()},n.load=function(l,o,e){t(l),this.loader.load(l,o,e)},P(c,[{key:"stats",get:function(){return this.loader.stats}},{key:"context",get:function(){return this.loader.context}}]),c}()},p.createFragmentLoader=function(){var t=this.applyFragmentData,d=this.config.fLoader||this.config.loader;return function(){function c(i){this.loader=void 0,this.loader=new d(i)}var n=c.prototype;return n.destroy=function(){this.loader.destroy()},n.abort=function(){this.loader.abort()},n.load=function(l,o,e){t(l),this.loader.load(l,o,e)},P(c,[{key:"stats",get:function(){return this.loader.stats}},{key:"context",get:function(){return this.loader.context}}]),c}()},T.uuid=function(){var r=URL.createObjectURL(new Blob),t=r.toString();return URL.revokeObjectURL(r),t.slice(t.lastIndexOf("/")+1)},T.serialize=function(r){for(var v,t=[],c=function(O){return Math.round(O)},n=function(O){return 100*c(O/100)},l={br:c,d:c,bl:n,dl:n,mtp:n,nor:function(O){return encodeURIComponent(O)},rtp:n,tb:c},e=x(Object.keys(r||{}).sort());!(v=e()).done;){var s=v.value,h=r[s];if(O=h,!(Number.isNaN(O)||null==O||""===O||!1===O||"v"===s&&1===h||"pr"==s&&1===h)){var u=l[s];u&&(h=u(h));var m,a=typeof h;m="ot"===s||"sf"===s||"st"===s?s+"="+h:"boolean"===a?s:"number"===a?s+"="+h:s+"="+JSON.stringify(h),t.push(m)}}var O;return t.join(",")},T.toHeaders=function(r){for(var d={},c=["Object","Request","Session","Status"],n=[{},{},{},{}],i={br:0,d:0,ot:0,tb:0,bl:1,dl:1,mtp:1,nor:1,nrr:1,su:1,cid:2,pr:2,sf:2,sid:2,st:2,v:2,bs:3,rtp:3},l=0,o=Object.keys(r);l<o.length;l++){var e=o[l];n[null!=i[e]?i[e]:1][e]=r[e]}for(var s=0;s<n.length;s++){var h=T.serialize(n[s]);h&&(d["CMCD-"+c[s]]=h)}return d},T.toQuery=function(r){return"CMCD="+encodeURIComponent(T.serialize(r))},T.appendQueryToUri=function(r,t){if(!t)return r;var d=r.includes("?")?"&":"?";return""+r+d+t},T}()},"./src/controller/eme-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>y});var b=A("./src/events.ts"),R=A("./src/errors.ts"),D=A("./src/utils/logger.ts"),_=A("./src/utils/mediakeys-helper.ts");function I(T,p){for(var f=0;f<p.length;f++){var r=p[f];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(T,r.key,r)}}const y=function(){function T(f){this.hls=void 0,this._widevineLicenseUrl=void 0,this._licenseXhrSetup=void 0,this._licenseResponseCallback=void 0,this._emeEnabled=void 0,this._requestMediaKeySystemAccess=void 0,this._drmSystemOptions=void 0,this._config=void 0,this._mediaKeysList=[],this._media=null,this._hasSetMediaKeys=!1,this._requestLicenseFailureCount=0,this.mediaKeysPromise=null,this._onMediaEncrypted=this.onMediaEncrypted.bind(this),this.hls=f,this._config=f.config,this._widevineLicenseUrl=this._config.widevineLicenseUrl,this._licenseXhrSetup=this._config.licenseXhrSetup,this._licenseResponseCallback=this._config.licenseResponseCallback,this._emeEnabled=this._config.emeEnabled,this._requestMediaKeySystemAccess=this._config.requestMediaKeySystemAccessFunc,this._drmSystemOptions=this._config.drmSystemOptions,this._registerListeners()}var p=T.prototype;return p.destroy=function(){this._unregisterListeners(),this.hls=this._onMediaEncrypted=null,this._requestMediaKeySystemAccess=null},p._registerListeners=function(){this.hls.on(b.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(b.Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(b.Events.MANIFEST_PARSED,this.onManifestParsed,this)},p._unregisterListeners=function(){this.hls.off(b.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(b.Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(b.Events.MANIFEST_PARSED,this.onManifestParsed,this)},p.getLicenseServerUrl=function(r){switch(r){case _.KeySystems.WIDEVINE:if(!this._widevineLicenseUrl)break;return this._widevineLicenseUrl}throw new Error('no license server URL configured for key-system "'+r+'"')},p._attemptKeySystemAccess=function(r,t,d){var c=this,n=function(p,f,r,t){if(p===_.KeySystems.WIDEVINE)return function(p,f,r){var t={audioCapabilities:[],videoCapabilities:[]};return p.forEach(function(d){t.audioCapabilities.push({contentType:'audio/mp4; codecs="'+d+'"',robustness:r.audioRobustness||""})}),f.forEach(function(d){t.videoCapabilities.push({contentType:'video/mp4; codecs="'+d+'"',robustness:r.videoRobustness||""})}),[t]}(f,r,t);throw new Error("Unknown key-system: "+p)}(r,t,d,this._drmSystemOptions);D.logger.log("Requesting encrypted media key-system access");var i=this.requestMediaKeySystemAccess(r,n);this.mediaKeysPromise=i.then(function(l){return c._onMediaKeySystemAccessObtained(r,l)}),i.catch(function(l){D.logger.error('Failed to obtain key-system "'+r+'" access:',l)})},p._onMediaKeySystemAccessObtained=function(r,t){var d=this;D.logger.log('Access for key-system "'+r+'" obtained');var c={mediaKeysSessionInitialized:!1,mediaKeySystemAccess:t,mediaKeySystemDomain:r};this._mediaKeysList.push(c);var n=Promise.resolve().then(function(){return t.createMediaKeys()}).then(function(i){return c.mediaKeys=i,D.logger.log('Media-keys created for key-system "'+r+'"'),d._onMediaKeysCreated(),i});return n.catch(function(i){D.logger.error("Failed to create media-keys:",i)}),n},p._onMediaKeysCreated=function(){var r=this;this._mediaKeysList.forEach(function(t){t.mediaKeysSession||(t.mediaKeysSession=t.mediaKeys.createSession(),r._onNewMediaKeySession(t.mediaKeysSession))})},p._onNewMediaKeySession=function(r){var t=this;D.logger.log("New key-system session "+r.sessionId),r.addEventListener("message",function(d){t._onKeySessionMessage(r,d.message)},!1)},p._onKeySessionMessage=function(r,t){D.logger.log("Got EME message event, creating license request"),this._requestLicense(t,function(d){D.logger.log("Received license data (length: "+(d&&d.byteLength)+"), updating key-session"),r.update(d).catch(function(c){D.logger.warn("Updating key-session failed: "+c)})})},p.onMediaEncrypted=function(r){var t=this;if(D.logger.log('Media is encrypted using "'+r.initDataType+'" init data type'),!this.mediaKeysPromise)return D.logger.error("Fatal: Media is encrypted but no CDM access or no keys have been requested"),void this.hls.trigger(b.Events.ERROR,{type:R.ErrorTypes.KEY_SYSTEM_ERROR,details:R.ErrorDetails.KEY_SYSTEM_NO_KEYS,fatal:!0});var d=function(n){!t._media||(t._attemptSetMediaKeys(n),t._generateRequestWithPreferredKeySession(r.initDataType,r.initData))};this.mediaKeysPromise.then(d).catch(d)},p._attemptSetMediaKeys=function(r){if(!this._media)throw new Error("Attempted to set mediaKeys without first attaching a media element");if(!this._hasSetMediaKeys){var t=this._mediaKeysList[0];if(!t||!t.mediaKeys)return D.logger.error("Fatal: Media is encrypted but no CDM access or no keys have been obtained yet"),void this.hls.trigger(b.Events.ERROR,{type:R.ErrorTypes.KEY_SYSTEM_ERROR,details:R.ErrorDetails.KEY_SYSTEM_NO_KEYS,fatal:!0});D.logger.log("Setting keys for encrypted media"),this._media.setMediaKeys(t.mediaKeys),this._hasSetMediaKeys=!0}},p._generateRequestWithPreferredKeySession=function(r,t){var d=this,c=this._mediaKeysList[0];if(!c)return D.logger.error("Fatal: Media is encrypted but not any key-system access has been obtained yet"),void this.hls.trigger(b.Events.ERROR,{type:R.ErrorTypes.KEY_SYSTEM_ERROR,details:R.ErrorDetails.KEY_SYSTEM_NO_ACCESS,fatal:!0});if(!c.mediaKeysSessionInitialized){var n=c.mediaKeysSession;return n?t?(D.logger.log('Generating key-session request for "'+r+'" init data type'),c.mediaKeysSessionInitialized=!0,void n.generateRequest(r,t).then(function(){D.logger.debug("Key-session generation succeeded")}).catch(function(i){D.logger.error("Error generating key-session request:",i),d.hls.trigger(b.Events.ERROR,{type:R.ErrorTypes.KEY_SYSTEM_ERROR,details:R.ErrorDetails.KEY_SYSTEM_NO_SESSION,fatal:!1})})):(D.logger.warn("Fatal: initData required for generating a key session is null"),void this.hls.trigger(b.Events.ERROR,{type:R.ErrorTypes.KEY_SYSTEM_ERROR,details:R.ErrorDetails.KEY_SYSTEM_NO_INIT_DATA,fatal:!0})):(D.logger.error("Fatal: Media is encrypted but no key-session existing"),void this.hls.trigger(b.Events.ERROR,{type:R.ErrorTypes.KEY_SYSTEM_ERROR,details:R.ErrorDetails.KEY_SYSTEM_NO_SESSION,fatal:!0}))}D.logger.warn("Key-Session already initialized but requested again")},p._createLicenseXhr=function(r,t,d){var c=new XMLHttpRequest;c.responseType="arraybuffer",c.onreadystatechange=this._onLicenseRequestReadyStageChange.bind(this,c,r,t,d);var n=this._licenseXhrSetup;if(n)try{n.call(this.hls,c,r),n=void 0}catch(i){D.logger.error(i)}try{c.readyState||c.open("POST",r,!0),n&&n.call(this.hls,c,r)}catch(i){throw new Error("issue setting up KeySystem license XHR "+i)}return c},p._onLicenseRequestReadyStageChange=function(r,t,d,c){if(4===r.readyState)if(200===r.status){this._requestLicenseFailureCount=0,D.logger.log("License request succeeded");var n=r.response,i=this._licenseResponseCallback;if(i)try{n=i.call(this.hls,r,t)}catch(o){D.logger.error(o)}c(n)}else{if(D.logger.error("License Request XHR failed ("+t+"). Status: "+r.status+" ("+r.statusText+")"),this._requestLicenseFailureCount++,this._requestLicenseFailureCount>3)return void this.hls.trigger(b.Events.ERROR,{type:R.ErrorTypes.KEY_SYSTEM_ERROR,details:R.ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0});D.logger.warn("Retrying license request, "+(3-this._requestLicenseFailureCount+1)+" attempts left"),this._requestLicense(d,c)}},p._generateLicenseRequestChallenge=function(r,t){if(r.mediaKeySystemDomain===_.KeySystems.WIDEVINE)return t;throw new Error("unsupported key-system: "+r.mediaKeySystemDomain)},p._requestLicense=function(r,t){D.logger.log("Requesting content license for key-system");var d=this._mediaKeysList[0];if(!d)return D.logger.error("Fatal error: Media is encrypted but no key-system access has been obtained yet"),void this.hls.trigger(b.Events.ERROR,{type:R.ErrorTypes.KEY_SYSTEM_ERROR,details:R.ErrorDetails.KEY_SYSTEM_NO_ACCESS,fatal:!0});try{var c=this.getLicenseServerUrl(d.mediaKeySystemDomain),n=this._createLicenseXhr(c,r,t);D.logger.log("Sending license request to URL: "+c);var i=this._generateLicenseRequestChallenge(d,r);n.send(i)}catch(l){D.logger.error("Failure requesting DRM license: "+l),this.hls.trigger(b.Events.ERROR,{type:R.ErrorTypes.KEY_SYSTEM_ERROR,details:R.ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0})}},p.onMediaAttached=function(r,t){if(this._emeEnabled){var d=t.media;this._media=d,d.addEventListener("encrypted",this._onMediaEncrypted)}},p.onMediaDetached=function(){var r=this._media,t=this._mediaKeysList;!r||(r.removeEventListener("encrypted",this._onMediaEncrypted),this._media=null,this._mediaKeysList=[],Promise.all(t.map(function(d){if(d.mediaKeysSession)return d.mediaKeysSession.close().catch(function(){})})).then(function(){return r.setMediaKeys(null)}).catch(function(){}))},p.onManifestParsed=function(r,t){if(this._emeEnabled){var d=t.levels.map(function(n){return n.audioCodec}).filter(function(n){return!!n}),c=t.levels.map(function(n){return n.videoCodec}).filter(function(n){return!!n});this._attemptKeySystemAccess(_.KeySystems.WIDEVINE,d,c)}},function P(T,p,f){p&&I(T.prototype,p),f&&I(T,f),Object.defineProperty(T,"prototype",{writable:!1})}(T,[{key:"requestMediaKeySystemAccess",get:function(){if(!this._requestMediaKeySystemAccess)throw new Error("No requestMediaKeySystemAccess function configured");return this._requestMediaKeySystemAccess}}]),T}()},"./src/controller/fps-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>_});var b=A("./src/events.ts"),R=A("./src/utils/logger.ts");const _=function(){function I(x){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=x,this.registerListeners()}var P=I.prototype;return P.setStreamController=function(S){this.streamController=S},P.registerListeners=function(){this.hls.on(b.Events.MEDIA_ATTACHING,this.onMediaAttaching,this)},P.unregisterListeners=function(){this.hls.off(b.Events.MEDIA_ATTACHING,this.onMediaAttaching)},P.destroy=function(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null},P.onMediaAttaching=function(S,g){var L=this.hls.config;if(L.capLevelOnFPSDrop){var y=g.media instanceof self.HTMLVideoElement?g.media:null;this.media=y,y&&"function"==typeof y.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),L.fpsDroppedMonitoringPeriod)}},P.checkFPS=function(S,g,L){var y=performance.now();if(g){if(this.lastTime){var p=L-this.lastDroppedFrames,f=g-this.lastDecodedFrames,r=1e3*p/(y-this.lastTime),t=this.hls;if(t.trigger(b.Events.FPS_DROP,{currentDropped:p,currentDecoded:f,totalDroppedFrames:L}),r>0&&p>t.config.fpsDroppedMonitoringThreshold*f){var d=t.currentLevel;R.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+d),d>0&&(-1===t.autoLevelCapping||t.autoLevelCapping>=d)&&(t.trigger(b.Events.FPS_DROP_LEVEL_CAPPING,{level:d-=1,droppedLevel:t.currentLevel}),t.autoLevelCapping=d,this.streamController.nextLevelSwitch())}}this.lastTime=y,this.lastDroppedFrames=L,this.lastDecodedFrames=g}},P.checkFPSInterval=function(){var S=this.media;if(S)if(this.isVideoPlaybackQualityAvailable){var g=S.getVideoPlaybackQuality();this.checkFPS(S,g.totalVideoFrames,g.droppedVideoFrames)}else this.checkFPS(S,S.webkitDecodedFrameCount,S.webkitDroppedFrameCount)},I}()},"./src/controller/fragment-finders.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{findFragWithCC:()=>x,findFragmentByPDT:()=>D,findFragmentByPTS:()=>_,fragmentWithinToleranceTest:()=>I,pdtWithinToleranceTest:()=>P});var b=A("./src/polyfills/number.ts"),R=A("./src/utils/binary-search.ts");function D(S,g,L){if(null===g||!Array.isArray(S)||!S.length||!(0,b.isFiniteNumber)(g))return null;if(g<(S[0].programDateTime||0))return null;if(g>=(S[S.length-1].endProgramDateTime||0))return null;L=L||0;for(var p=0;p<S.length;++p){var f=S[p];if(P(g,L,f))return f}return null}function _(S,g,L,y){void 0===L&&(L=0),void 0===y&&(y=0);var T=null;return S?T=g[S.sn-g[0].sn+1]||null:0===L&&0===g[0].start&&(T=g[0]),T&&0===I(L,y,T)?T:R.default.search(g,I.bind(null,L,y))||T}function I(S,g,L){void 0===S&&(S=0),void 0===g&&(g=0);var y=Math.min(g,L.duration+(L.deltaPTS?L.deltaPTS:0));return L.start+L.duration-y<=S?1:L.start-y>S&&L.start?-1:0}function P(S,g,L){var y=1e3*Math.min(g,L.duration+(L.deltaPTS?L.deltaPTS:0));return(L.endProgramDateTime||0)-y>S}function x(S,g){return R.default.search(S,function(L){return L.cc<g?1:L.cc>g?-1:0})}},"./src/controller/fragment-tracker.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{FragmentState:()=>D,FragmentTracker:()=>_});var b=A("./src/events.ts"),R=A("./src/types/loader.ts"),D=(()=>{return(x=D||(D={})).NOT_LOADED="NOT_LOADED",x.APPENDING="APPENDING",x.PARTIAL="PARTIAL",x.OK="OK",D;var x})(),_=function(){function x(g){this.activeFragment=null,this.activeParts=null,this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hls=g,this._registerListeners()}var S=x.prototype;return S._registerListeners=function(){var L=this.hls;L.on(b.Events.BUFFER_APPENDED,this.onBufferAppended,this),L.on(b.Events.FRAG_BUFFERED,this.onFragBuffered,this),L.on(b.Events.FRAG_LOADED,this.onFragLoaded,this)},S._unregisterListeners=function(){var L=this.hls;L.off(b.Events.BUFFER_APPENDED,this.onBufferAppended,this),L.off(b.Events.FRAG_BUFFERED,this.onFragBuffered,this),L.off(b.Events.FRAG_LOADED,this.onFragLoaded,this)},S.destroy=function(){this._unregisterListeners(),this.fragments=this.timeRanges=null},S.getAppendedFrag=function(L,y){if(y===R.PlaylistLevelType.MAIN){var T=this.activeFragment,p=this.activeParts;if(!T)return null;if(p)for(var f=p.length;f--;){var r=p[f],t=r?r.end:T.appendedPTS;if(r.start<=L&&void 0!==t&&L<=t)return f>9&&(this.activeParts=p.slice(f-9)),r}else if(T.start<=L&&void 0!==T.appendedPTS&&L<=T.appendedPTS)return T}return this.getBufferedFrag(L,y)},S.getBufferedFrag=function(L,y){for(var T=this.fragments,p=Object.keys(T),f=p.length;f--;){var r=T[p[f]];if((null==r?void 0:r.body.type)===y&&r.buffered){var t=r.body;if(t.start<=L&&L<=t.end)return t}}return null},S.detectEvictedFragments=function(L,y,T){var p=this;Object.keys(this.fragments).forEach(function(f){var r=p.fragments[f];if(r){if(!r.buffered)return void(r.body.type===T&&p.removeFragment(r.body));var t=r.range[L];!t||t.time.some(function(d){var c=!p.isTimeBuffered(d.startPTS,d.endPTS,y);return c&&p.removeFragment(r.body),c})}})},S.detectPartialFragments=function(L){var y=this,T=this.timeRanges,p=L.frag,f=L.part;if(T&&"initSegment"!==p.sn){var r=P(p),t=this.fragments[r];!t||(Object.keys(T).forEach(function(d){var c=p.elementaryStreams[d];c&&(t.range[d]=y.getBufferedTimes(p,f,null!==f||!0===c.partial,T[d]))}),t.loaded=null,Object.keys(t.range).length?t.buffered=!0:this.removeFragment(t.body))}},S.fragBuffered=function(L){var y=P(L),T=this.fragments[y];T&&(T.loaded=null,T.buffered=!0)},S.getBufferedTimes=function(L,y,T,p){for(var f={time:[],partial:T},r=y?y.start:L.start,t=y?y.end:L.end,d=L.minEndPTS||t,c=L.maxStartPTS||r,n=0;n<p.length;n++){var i=p.start(n)-this.bufferPadding,l=p.end(n)+this.bufferPadding;if(c>=i&&d<=l){f.time.push({startPTS:Math.max(r,p.start(n)),endPTS:Math.min(t,p.end(n))});break}if(r<l&&t>i)f.partial=!0,f.time.push({startPTS:Math.max(r,p.start(n)),endPTS:Math.min(t,p.end(n))});else if(t<=i)break}return f},S.getPartialFragment=function(L){var T,p,f,y=null,r=0,t=this.bufferPadding,d=this.fragments;return Object.keys(d).forEach(function(c){var n=d[c];!n||I(n)&&(f=n.body.end+t,L>=(p=n.body.start-t)&&L<=f&&(T=Math.min(L-p,f-L),r<=T&&(y=n.body,r=T)))}),y},S.getState=function(L){var y=P(L),T=this.fragments[y];return T?T.buffered?I(T)?D.PARTIAL:D.OK:D.APPENDING:D.NOT_LOADED},S.isTimeBuffered=function(L,y,T){for(var p,f,r=0;r<T.length;r++){if(p=T.start(r)-this.bufferPadding,f=T.end(r)+this.bufferPadding,L>=p&&y<=f)return!0;if(y<=p)return!1}return!1},S.onFragLoaded=function(L,y){var T=y.frag;if("initSegment"!==T.sn&&!T.bitrateTest&&!y.part){var f=P(T);this.fragments[f]={body:T,loaded:y,buffered:!1,range:Object.create(null)}}},S.onBufferAppended=function(L,y){var T=this,p=y.frag,f=y.part,r=y.timeRanges;if(p.type===R.PlaylistLevelType.MAIN)if(this.activeFragment=p,f){var t=this.activeParts;t||(this.activeParts=t=[]),t.push(f)}else this.activeParts=null;this.timeRanges=r,Object.keys(r).forEach(function(d){var c=r[d];if(T.detectEvictedFragments(d,c),!f)for(var n=0;n<c.length;n++)p.appendedPTS=Math.max(c.end(n),p.appendedPTS||0)})},S.onFragBuffered=function(L,y){this.detectPartialFragments(y)},S.hasFragment=function(L){var y=P(L);return!!this.fragments[y]},S.removeFragmentsInRange=function(L,y,T){var p=this;Object.keys(this.fragments).forEach(function(f){var r=p.fragments[f];if(r&&r.buffered){var t=r.body;t.type===T&&t.start<y&&t.end>L&&p.removeFragment(t)}})},S.removeFragment=function(L){var y=P(L);L.stats.loaded=0,L.clearElementaryStreamInfo(),delete this.fragments[y]},S.removeAllFragments=function(){this.fragments=Object.create(null),this.activeFragment=null,this.activeParts=null},x}();function I(x){var S,g;return x.buffered&&((null===(S=x.range.video)||void 0===S?void 0:S.partial)||(null===(g=x.range.audio)||void 0===g?void 0:g.partial))}function P(x){return x.type+"_"+x.level+"_"+x.urlId+"_"+x.sn}},"./src/controller/gap-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{MAX_START_GAP_JUMP:()=>P,SKIP_BUFFER_HOLE_STEP_SECONDS:()=>x,SKIP_BUFFER_RANGE_START:()=>S,STALL_MINIMUM_DURATION_MS:()=>I,default:()=>g});var b=A("./src/utils/buffer-helper.ts"),R=A("./src/errors.ts"),D=A("./src/events.ts"),_=A("./src/utils/logger.ts"),I=250,P=2,x=.1,S=.05,g=function(){function L(T,p,f,r){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=T,this.media=p,this.fragmentTracker=f,this.hls=r}var y=L.prototype;return y.destroy=function(){this.media=null,this.hls=this.fragmentTracker=null},y.poll=function(p,f){var r=this.config,t=this.media,d=this.stalled;if(null!==t){var c=t.currentTime,n=t.seeking,i=this.seeking&&!n,l=!this.seeking&&n;if(this.seeking=n,c!==p){if(this.moved=!0,null!==d){if(this.stallReported){var o=self.performance.now()-d;_.logger.warn("playback not stuck anymore @"+c+", after "+Math.round(o)+"ms"),this.stallReported=!1}this.stalled=null,this.nudgeRetry=0}return}if((l||i)&&(this.stalled=null),!(t.paused&&!n||t.ended||0===t.playbackRate)&&b.BufferHelper.getBuffered(t).length){var e=b.BufferHelper.bufferInfo(t,c,0),s=e.nextStart||0;if(e.len>0||s){if(n){var h=e.len>P,u=!s||f&&f.start<=c||s-c>P&&!this.fragmentTracker.getPartialFragment(c);if(h||u)return;this.moved=!1}if(!this.moved&&null!==this.stalled){var a,m=Math.max(s,e.start||0)-c,E=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,O=null==E||null===(a=E.details)||void 0===a?void 0:a.live;if(m>0&&m<=(O?2*E.details.targetduration:P))return void this._trySkipBufferHole(null)}var C=self.performance.now();if(null===d)return void(this.stalled=C);var F=C-d;if(n||!(F>=I)||(this._reportStall(e),this.media)){var U=b.BufferHelper.bufferInfo(t,c,r.maxBufferHole);this._tryFixBufferStall(U,F)}}}}},y._tryFixBufferStall=function(p,f){var r=this.config,d=this.media;if(null!==d){var n=this.fragmentTracker.getPartialFragment(d.currentTime);if(n&&(this._trySkipBufferHole(n)||!this.media))return;p.len>r.maxBufferHole&&f>1e3*r.highBufferWatchdogPeriod&&(_.logger.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}},y._reportStall=function(p){var f=this.hls,r=this.media;!this.stallReported&&r&&(this.stallReported=!0,_.logger.warn("Playback stalling at @"+r.currentTime+" due to low buffer ("+JSON.stringify(p)+")"),f.trigger(D.Events.ERROR,{type:R.ErrorTypes.MEDIA_ERROR,details:R.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!1,buffer:p.len}))},y._trySkipBufferHole=function(p){var f=this.config,r=this.hls,t=this.media;if(null===t)return 0;for(var d=t.currentTime,c=0,n=b.BufferHelper.getBuffered(t),i=0;i<n.length;i++){var l=n.start(i);if(d+f.maxBufferHole>=c&&d<l){var o=Math.max(l+S,t.currentTime+x);return _.logger.warn("skipping hole, adjusting currentTime from "+d+" to "+o),this.moved=!0,this.stalled=null,t.currentTime=o,p&&r.trigger(D.Events.ERROR,{type:R.ErrorTypes.MEDIA_ERROR,details:R.ErrorDetails.BUFFER_SEEK_OVER_HOLE,fatal:!1,reason:"fragment loaded with buffer holes, seeking from "+d+" to "+o,frag:p}),o}c=n.end(i)}return 0},y._tryNudgeBuffer=function(){var p=this.config,f=this.hls,r=this.media,t=this.nudgeRetry;if(null!==r){var d=r.currentTime;if(this.nudgeRetry++,t<p.nudgeMaxRetry){var c=d+(t+1)*p.nudgeOffset;_.logger.warn("Nudging 'currentTime' from "+d+" to "+c),r.currentTime=c,f.trigger(D.Events.ERROR,{type:R.ErrorTypes.MEDIA_ERROR,details:R.ErrorDetails.BUFFER_NUDGE_ON_STALL,fatal:!1})}else _.logger.error("Playhead still not moving while enough data buffered @"+d+" after "+p.nudgeMaxRetry+" nudges"),f.trigger(D.Events.ERROR,{type:R.ErrorTypes.MEDIA_ERROR,details:R.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!0})}},L}()},"./src/controller/id3-track-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>p});var b=A("./src/polyfills/number.ts"),R=A("./src/events.ts"),D=A("./src/utils/texttrack-utils.ts"),_=A("./src/demux/id3.ts"),I=A("./src/loader/date-range.ts"),P=A("./src/types/demuxer.ts");function S(){return self.WebKitDataCue||self.VTTCue||self.TextTrackCue}var g=function(){var f=S();try{new f(0,Number.POSITIVE_INFINITY,"")}catch(r){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY}();function L(f,r){return f.getTime()/1e3-r}function y(f){return Uint8Array.from(f.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}const p=function(){function f(t){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=t,this._registerListeners()}var r=f.prototype;return r.destroy=function(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null},r._registerListeners=function(){var d=this.hls;d.on(R.Events.MEDIA_ATTACHED,this.onMediaAttached,this),d.on(R.Events.MEDIA_DETACHING,this.onMediaDetaching,this),d.on(R.Events.MANIFEST_LOADING,this.onManifestLoading,this),d.on(R.Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),d.on(R.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),d.on(R.Events.LEVEL_UPDATED,this.onLevelUpdated,this)},r._unregisterListeners=function(){var d=this.hls;d.off(R.Events.MEDIA_ATTACHED,this.onMediaAttached,this),d.off(R.Events.MEDIA_DETACHING,this.onMediaDetaching,this),d.off(R.Events.MANIFEST_LOADING,this.onManifestLoading,this),d.off(R.Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),d.off(R.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),d.off(R.Events.LEVEL_UPDATED,this.onLevelUpdated,this)},r.onMediaAttached=function(d,c){this.media=c.media},r.onMediaDetaching=function(){!this.id3Track||((0,D.clearCurrentCues)(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})},r.onManifestLoading=function(){this.dateRangeCuesAppended={}},r.createTrack=function(d){var c=this.getID3Track(d.textTracks);return c.mode="hidden",c},r.getID3Track=function(d){if(this.media){for(var c=0;c<d.length;c++){var n=d[c];if("metadata"===n.kind&&"id3"===n.label)return(0,D.sendAddTrackEvent)(n,this.media),n}return this.media.addTextTrack("metadata","id3")}},r.onFragParsingMetadata=function(d,c){if(this.media){var n=this.hls.config,i=n.enableEmsgMetadataCues,l=n.enableID3MetadataCues;if(i||l){var e=c.samples;this.id3Track||(this.id3Track=this.createTrack(this.media));for(var s=S(),h=0;h<e.length;h++){var u=e[h].type;if((u!==P.MetadataSchema.emsg||i)&&l){var a=_.getID3Frames(e[h].data);if(a){var m=e[h].pts,E=m+e[h].duration;E>g&&(E=g),E-m<=0&&(E=m+.25);for(var M=0;M<a.length;M++){var C=a[M];if(!_.isTimeStampFrame(C)){this.updateId3CueEnds(m);var F=new s(m,E,"");F.value=C,u&&(F.type=u),this.id3Track.addCue(F)}}}}}}}},r.updateId3CueEnds=function(d){var c,n=null===(c=this.id3Track)||void 0===c?void 0:c.cues;if(n)for(var i=n.length;i--;){var l=n[i];l.startTime<d&&l.endTime===g&&(l.endTime=d)}},r.onBufferFlushing=function(d,c){var l=c.type,o=this.id3Track,e=this.hls;if(e){var v=e.config,s=v.enableEmsgMetadataCues,h=v.enableID3MetadataCues;o&&(s||h)&&(0,D.removeCuesInRange)(o,c.startOffset,c.endOffset,"audio"===l?function(m){return m.type===P.MetadataSchema.audioId3&&h}:"video"===l?function(m){return m.type===P.MetadataSchema.emsg&&s}:function(m){return m.type===P.MetadataSchema.audioId3&&h||m.type===P.MetadataSchema.emsg&&s})}},r.onLevelUpdated=function(d,c){var n=this,i=c.details;if(this.media&&i.hasProgramDateTime&&this.hls.config.enableDateRangeMetadataCues){var l=this.dateRangeCuesAppended,o=this.id3Track,e=i.dateRanges,v=Object.keys(e);if(o)for(var s=Object.keys(l).filter(function(C){return!v.includes(C)}),h=function(F){var U=s[F];Object.keys(l[U].cues).forEach(function(k){o.removeCue(l[U].cues[k])}),delete l[U]},u=s.length;u--;)h(u);var a=i.fragments[i.fragments.length-1];if(0!==v.length&&(0,b.isFiniteNumber)(null==a?void 0:a.programDateTime)){this.id3Track||(this.id3Track=this.createTrack(this.media));for(var m=a.programDateTime/1e3-a.start,E=S(),O=function(F){var U=v[F],k=e[U],N=l[U],w=(null==N?void 0:N.cues)||{},K=(null==N?void 0:N.durationKnown)||!1,G=L(k.startDate,m),H=g,V=k.endDate;if(V)H=L(V,m),K=!0;else if(k.endOnNext&&!K){var X=v.reduce(function(q,J){var ee=e[J];return ee.class===k.class&&ee.id!==J&&ee.startDate>k.startDate&&q.push(ee),q},[]).sort(function(q,J){return q.startDate.getTime()-J.startDate.getTime()})[0];X&&(H=L(X.startDate,m),K=!0)}for(var Y=Object.keys(k.attr),$=0;$<Y.length;$++){var Q=Y[$];if(Q!==I.DateRangeAttribute.ID&&Q!==I.DateRangeAttribute.CLASS&&Q!==I.DateRangeAttribute.START_DATE&&Q!==I.DateRangeAttribute.DURATION&&Q!==I.DateRangeAttribute.END_DATE&&Q!==I.DateRangeAttribute.END_ON_NEXT){var z=w[Q];if(z)K&&!N.durationKnown&&(z.endTime=H);else{var j=k.attr[Q];z=new E(G,H,""),(Q===I.DateRangeAttribute.SCTE35_OUT||Q===I.DateRangeAttribute.SCTE35_IN)&&(j=y(j)),z.value={key:Q,data:j},z.type=P.MetadataSchema.dateRange,n.id3Track.addCue(z),w[Q]=z}}}l[U]={cues:w,dateRange:k,durationKnown:K}},M=0;M<v.length;M++)O(M)}}},f}()},"./src/controller/latency-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>P});var b=A("./src/errors.ts"),R=A("./src/events.ts"),D=A("./src/utils/logger.ts");function _(x,S){for(var g=0;g<S.length;g++){var L=S[g];L.enumerable=L.enumerable||!1,L.configurable=!0,"value"in L&&(L.writable=!0),Object.defineProperty(x,L.key,L)}}var P=function(){function x(g){var L=this;this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=function(){return L.timeupdate()},this.hls=g,this.config=g.config,this.registerListeners()}var S=x.prototype;return S.destroy=function(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null},S.registerListeners=function(){this.hls.on(R.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(R.Events.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(R.Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(R.Events.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(R.Events.ERROR,this.onError,this)},S.unregisterListeners=function(){this.hls.off(R.Events.MEDIA_ATTACHED,this.onMediaAttached),this.hls.off(R.Events.MEDIA_DETACHING,this.onMediaDetaching),this.hls.off(R.Events.MANIFEST_LOADING,this.onManifestLoading),this.hls.off(R.Events.LEVEL_UPDATED,this.onLevelUpdated),this.hls.off(R.Events.ERROR,this.onError)},S.onMediaAttached=function(L,y){this.media=y.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)},S.onMediaDetaching=function(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)},S.onManifestLoading=function(){this.levelDetails=null,this._latency=null,this.stallCount=0},S.onLevelUpdated=function(L,y){var T=y.details;this.levelDetails=T,T.advanced&&this.timeupdate(),!T.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)},S.onError=function(L,y){y.details===b.ErrorDetails.BUFFER_STALLED_ERROR&&(this.stallCount++,D.logger.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))},S.timeupdate=function(){var L=this.media,y=this.levelDetails;if(L&&y){this.currentTime=L.currentTime;var T=this.computeLatency();if(null!==T){this._latency=T;var p=this.config,r=p.maxLiveSyncPlaybackRate;if(p.lowLatencyMode&&1!==r){var t=this.targetLatency;if(null!==t){var d=T-t,c=Math.min(this.maxLatency,t+y.targetduration);if(y.live&&d<c&&d>.05&&this.forwardBufferLength>1){var i=Math.min(2,Math.max(1,r)),l=Math.round(2/(1+Math.exp(-.75*d-this.edgeStalled))*20)/20;L.playbackRate=Math.min(i,Math.max(1,l))}else 1!==L.playbackRate&&0!==L.playbackRate&&(L.playbackRate=1)}}}}},S.estimateLiveEdge=function(){var L=this.levelDetails;return null===L?null:L.edge+L.age},S.computeLatency=function(){var L=this.estimateLiveEdge();return null===L?null:L-this.currentTime},function I(x,S,g){S&&_(x.prototype,S),g&&_(x,g),Object.defineProperty(x,"prototype",{writable:!1})}(x,[{key:"latency",get:function(){return this._latency||0}},{key:"maxLatency",get:function(){var L=this.config,y=this.levelDetails;return void 0!==L.liveMaxLatencyDuration?L.liveMaxLatencyDuration:y?L.liveMaxLatencyDurationCount*y.targetduration:0}},{key:"targetLatency",get:function(){var L=this.levelDetails;if(null===L)return null;var p=L.targetduration,f=this.config,r=f.liveSyncDuration,c=this.hls.userConfig,n=f.lowLatencyMode&&L.partHoldBack||L.holdBack;return(c.liveSyncDuration||c.liveSyncDurationCount||0===n)&&(n=void 0!==r?r:f.liveSyncDurationCount*p),n+Math.min(1*this.stallCount,p)}},{key:"liveSyncPosition",get:function(){var L=this.estimateLiveEdge(),y=this.targetLatency,T=this.levelDetails;if(null===L||null===y||null===T)return null;var p=T.edge,t=p-(this.config.lowLatencyMode&&T.partTarget||T.targetduration);return Math.min(Math.max(p-T.totalduration,L-y-this.edgeStalled),t)}},{key:"drift",get:function(){var L=this.levelDetails;return null===L?1:L.drift}},{key:"edgeStalled",get:function(){var L=this.levelDetails;return null===L?0:Math.max(L.age-3*(this.config.lowLatencyMode&&L.partTarget||L.targetduration),0)}},{key:"forwardBufferLength",get:function(){var L=this.media,y=this.levelDetails;if(!L||!y)return 0;var T=L.buffered.length;return(T?L.buffered.end(T-1):y.edge)-this.currentTime}}]),x}()},"./src/controller/level-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>f});var b=A("./src/types/level.ts"),R=A("./src/events.ts"),D=A("./src/errors.ts"),_=A("./src/utils/codecs.ts"),I=A("./src/controller/level-helper.ts"),P=A("./src/controller/base-playlist-controller.ts"),x=A("./src/types/loader.ts");function S(){return S=Object.assign?Object.assign.bind():function(r){for(var t=1;t<arguments.length;t++){var d=arguments[t];for(var c in d)Object.prototype.hasOwnProperty.call(d,c)&&(r[c]=d[c])}return r},S.apply(this,arguments)}function g(r,t){for(var d=0;d<t.length;d++){var c=t[d];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(r,c.key,c)}}function T(r,t){return(T=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(c,n){return c.__proto__=n,c})(r,t)}var p=/chrome|firefox/.test(navigator.userAgent.toLowerCase()),f=function(r){function t(c){var n;return(n=r.call(this,c,"[level-controller]")||this)._levels=[],n._firstLevel=-1,n._startLevel=void 0,n.currentLevelIndex=-1,n.manualLevelIndex=-1,n.onParsedComplete=void 0,n._registerListeners(),n}!function y(r,t){r.prototype=Object.create(t.prototype),r.prototype.constructor=r,T(r,t)}(t,r);var d=t.prototype;return d._registerListeners=function(){var n=this.hls;n.on(R.Events.MANIFEST_LOADED,this.onManifestLoaded,this),n.on(R.Events.LEVEL_LOADED,this.onLevelLoaded,this),n.on(R.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),n.on(R.Events.FRAG_LOADED,this.onFragLoaded,this),n.on(R.Events.ERROR,this.onError,this)},d._unregisterListeners=function(){var n=this.hls;n.off(R.Events.MANIFEST_LOADED,this.onManifestLoaded,this),n.off(R.Events.LEVEL_LOADED,this.onLevelLoaded,this),n.off(R.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),n.off(R.Events.FRAG_LOADED,this.onFragLoaded,this),n.off(R.Events.ERROR,this.onError,this)},d.destroy=function(){this._unregisterListeners(),this.manualLevelIndex=-1,this._levels.length=0,r.prototype.destroy.call(this)},d.startLoad=function(){this._levels.forEach(function(i){i.loadError=0}),r.prototype.startLoad.call(this)},d.onManifestLoaded=function(n,i){var v,h,l=[],o=[],e=[],s={},u=!1,a=!1,m=!1;if(i.levels.forEach(function(C){var F=C.attrs;u=u||!(!C.width||!C.height),a=a||!!C.videoCodec,m=m||!!C.audioCodec,p&&C.audioCodec&&-1!==C.audioCodec.indexOf("mp4a.40.34")&&(C.audioCodec=void 0);var U=C.bitrate+"-"+C.attrs.RESOLUTION+"-"+C.attrs.CODECS;(h=s[U])?h.url.push(C.url):(h=new b.Level(C),s[U]=h,l.push(h)),F&&(F.AUDIO&&(0,I.addGroupId)(h,"audio",F.AUDIO),F.SUBTITLES&&(0,I.addGroupId)(h,"text",F.SUBTITLES))}),(u||a)&&m&&(l=l.filter(function(C){return!!C.videoCodec||!(!C.width||!C.height)})),l=l.filter(function(C){var F=C.audioCodec,U=C.videoCodec;return(!F||(0,_.isCodecSupportedInMp4)(F,"audio"))&&(!U||(0,_.isCodecSupportedInMp4)(U,"video"))}),i.audioTracks&&(o=i.audioTracks.filter(function(C){return!C.audioCodec||(0,_.isCodecSupportedInMp4)(C.audioCodec,"audio")}),(0,I.assignTrackIdsByGroup)(o)),i.subtitles&&(0,I.assignTrackIdsByGroup)(e=i.subtitles),l.length>0){v=l[0].bitrate,l.sort(function(C,F){return C.bitrate-F.bitrate}),this._levels=l;for(var E=0;E<l.length;E++)if(l[E].bitrate===v){this._firstLevel=E,this.log("manifest loaded, "+l.length+" level(s) found, first bitrate: "+v);break}var M={levels:l,audioTracks:o,subtitleTracks:e,firstLevel:this._firstLevel,stats:i.stats,audio:m,video:a,altAudio:!(m&&!a)&&o.some(function(C){return!!C.url})};this.hls.trigger(R.Events.MANIFEST_PARSED,M),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}else this.hls.trigger(R.Events.ERROR,{type:D.ErrorTypes.MEDIA_ERROR,details:D.ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:i.url,reason:"no level with compatible codecs found in manifest"})},d.onError=function(n,i){var l;if(r.prototype.onError.call(this,n,i),!i.fatal){var o=i.context,e=this._levels[this.currentLevelIndex];if(o&&(o.type===x.PlaylistContextType.AUDIO_TRACK&&e.audioGroupIds&&o.groupId===e.audioGroupIds[e.urlId]||o.type===x.PlaylistContextType.SUBTITLE_TRACK&&e.textGroupIds&&o.groupId===e.textGroupIds[e.urlId]))return void this.redundantFailover(this.currentLevelIndex);var h,v=!1,s=!0;switch(i.details){case D.ErrorDetails.FRAG_LOAD_ERROR:case D.ErrorDetails.FRAG_LOAD_TIMEOUT:case D.ErrorDetails.KEY_LOAD_ERROR:case D.ErrorDetails.KEY_LOAD_TIMEOUT:if(i.frag){var u=i.frag.type===x.PlaylistLevelType.MAIN?i.frag.level:this.currentLevelIndex,a=this._levels[u];a?(a.fragmentError++,a.fragmentError>this.hls.config.fragLoadingMaxRetry&&(h=u)):h=u}break;case D.ErrorDetails.LEVEL_LOAD_ERROR:case D.ErrorDetails.LEVEL_LOAD_TIMEOUT:o&&(o.deliveryDirectives&&(s=!1),h=o.level),v=!0;break;case D.ErrorDetails.REMUX_ALLOC_ERROR:h=null!=(l=i.level)?l:this.currentLevelIndex,v=!0}void 0!==h&&this.recoverLevel(i,h,v,s)}},d.recoverLevel=function(n,i,l,o){var e=n.details,v=this._levels[i];if(v.loadError++,l){if(!this.retryLoadingOrFail(n))return void(this.currentLevelIndex=-1);n.levelRetry=!0}if(o){var h=v.url.length;if(h>1&&v.loadError<h)n.levelRetry=!0,this.redundantFailover(i);else if(-1===this.manualLevelIndex){for(var u=-1,a=this._levels,m=a.length;m--;){var E=(m+this.currentLevelIndex)%a.length;if(E!==this.currentLevelIndex&&0===a[E].loadError){u=E;break}}u>-1&&this.currentLevelIndex!==u&&(this.warn(e+": switch to "+u),n.levelRetry=!0,this.hls.nextAutoLevel=u)}}},d.redundantFailover=function(n){var i=this._levels[n],l=i.url.length;if(l>1){var o=(i.urlId+1)%l;this.warn("Switching to redundant URL-id "+o),this._levels.forEach(function(e){e.urlId=o}),this.level=n}},d.onFragLoaded=function(n,i){var l=i.frag;if(void 0!==l&&l.type===x.PlaylistLevelType.MAIN){var o=this._levels[l.level];void 0!==o&&(o.fragmentError=0,o.loadError=0)}},d.onLevelLoaded=function(n,i){var l,s,o=i.level,e=i.details,v=this._levels[o];if(!v)return this.warn("Invalid level index "+o),void(null!==(s=i.deliveryDirectives)&&void 0!==s&&s.skip&&(e.deltaUpdateFailed=!0));o===this.currentLevelIndex?(0===v.fragmentError&&(v.loadError=0,this.retryCount=0),this.playlistLoaded(o,i,v.details)):null!==(l=i.deliveryDirectives)&&void 0!==l&&l.skip&&(e.deltaUpdateFailed=!0)},d.onAudioTrackSwitched=function(n,i){var l=this.hls.levels[this.currentLevelIndex];if(l&&l.audioGroupIds){for(var o=-1,e=this.hls.audioTracks[i.id].groupId,v=0;v<l.audioGroupIds.length;v++)if(l.audioGroupIds[v]===e){o=v;break}o!==l.urlId&&(l.urlId=o,this.startLoad())}},d.loadPlaylist=function(n){var i=this.currentLevelIndex,l=this._levels[i];if(this.canLoad&&l&&l.url.length>0){var o=l.urlId,e=l.url[o];if(n)try{e=n.addDirectives(e)}catch(v){this.warn("Could not construct new URL with HLS Delivery Directives: "+v)}this.log("Attempt loading level index "+i+(n?" at sn "+n.msn+" part "+n.part:"")+" with URL-id "+o+" "+e),this.clearTimer(),this.hls.trigger(R.Events.LEVEL_LOADING,{url:e,level:i,id:o,deliveryDirectives:n||null})}},d.removeLevel=function(n,i){var l=function(v,s){return s!==i},o=this._levels.filter(function(e,v){return v!==n||e.url.length>1&&void 0!==i&&(e.url=e.url.filter(l),e.audioGroupIds&&(e.audioGroupIds=e.audioGroupIds.filter(l)),e.textGroupIds&&(e.textGroupIds=e.textGroupIds.filter(l)),e.urlId=0,!0)}).map(function(e,v){var s=e.details;return null!=s&&s.fragments&&s.fragments.forEach(function(h){h.level=v}),e});this._levels=o,this.hls.trigger(R.Events.LEVELS_UPDATED,{levels:o})},function L(r,t,d){t&&g(r.prototype,t),d&&g(r,d),Object.defineProperty(r,"prototype",{writable:!1})}(t,[{key:"levels",get:function(){return 0===this._levels.length?null:this._levels}},{key:"level",get:function(){return this.currentLevelIndex},set:function(n){var i,l=this._levels;if(0!==l.length&&(this.currentLevelIndex!==n||null===(i=l[n])||void 0===i||!i.details)){if(n<0||n>=l.length){var o=n<0;if(this.hls.trigger(R.Events.ERROR,{type:D.ErrorTypes.OTHER_ERROR,details:D.ErrorDetails.LEVEL_SWITCH_ERROR,level:n,fatal:o,reason:"invalid level idx"}),o)return;n=Math.min(n,l.length-1)}this.clearTimer();var e=this.currentLevelIndex,v=l[e],s=l[n];this.log("switching to level "+n+" from "+e),this.currentLevelIndex=n;var h=S({},s,{level:n,maxBitrate:s.maxBitrate,uri:s.uri,urlId:s.urlId});delete h._urlId,this.hls.trigger(R.Events.LEVEL_SWITCHING,h);var u=s.details;if(!u||u.live){var a=this.switchParams(s.uri,null==v?void 0:v.details);this.loadPlaylist(a)}}}},{key:"manualLevel",get:function(){return this.manualLevelIndex},set:function(n){this.manualLevelIndex=n,void 0===this._startLevel&&(this._startLevel=n),-1!==n&&(this.level=n)}},{key:"firstLevel",get:function(){return this._firstLevel},set:function(n){this._firstLevel=n}},{key:"startLevel",get:function(){if(void 0===this._startLevel){var n=this.hls.config.startLevel;return void 0!==n?n:this._firstLevel}return this._startLevel},set:function(n){this._startLevel=n}},{key:"nextLoadLevel",get:function(){return-1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel},set:function(n){this.level=n,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=n)}}]),t}(P.default)},"./src/controller/level-helper.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{addGroupId:()=>I,addSliding:()=>r,adjustSliding:()=>f,assignTrackIdsByGroup:()=>P,computeReloadInterval:()=>t,getFragmentWithSN:()=>d,getPartWith:()=>c,mapFragmentIntersection:()=>p,mapPartIntersection:()=>T,mergeDetails:()=>L,updateFragPTSDTS:()=>g,updatePTS:()=>x});var b=A("./src/polyfills/number.ts"),R=A("./src/utils/logger.ts"),D=A("./src/loader/date-range.ts");function _(){return _=Object.assign?Object.assign.bind():function(n){for(var i=1;i<arguments.length;i++){var l=arguments[i];for(var o in l)Object.prototype.hasOwnProperty.call(l,o)&&(n[o]=l[o])}return n},_.apply(this,arguments)}function I(n,i,l){switch(i){case"audio":n.audioGroupIds||(n.audioGroupIds=[]),n.audioGroupIds.push(l);break;case"text":n.textGroupIds||(n.textGroupIds=[]),n.textGroupIds.push(l)}}function P(n){var i={};n.forEach(function(l){var o=l.groupId||"";l.id=i[o]=i[o]||0,i[o]++})}function x(n,i,l){S(n[i],n[l])}function S(n,i){var l=i.startPTS;if((0,b.isFiniteNumber)(l)){var e,o=0;i.sn>n.sn?(o=l-n.start,e=n):(o=n.start-l,e=i),e.duration!==o&&(e.duration=o)}else i.start=i.sn>n.sn?n.cc===i.cc&&n.minEndPTS?n.start+(n.minEndPTS-n.start):n.start+n.duration:Math.max(n.start-i.duration,0)}function g(n,i,l,o,e,v){o-l<=0&&(R.logger.warn("Fragment should have a positive duration",i),o=l+i.duration,v=e+i.duration);var h=l,u=o,a=i.startPTS,m=i.endPTS;if((0,b.isFiniteNumber)(a)){var E=Math.abs(a-l);i.deltaPTS=(0,b.isFiniteNumber)(i.deltaPTS)?Math.max(E,i.deltaPTS):E,h=Math.max(l,a),l=Math.min(l,a),e=Math.min(e,i.startDTS),u=Math.min(o,m),o=Math.max(o,m),v=Math.max(v,i.endDTS)}i.duration=o-l;var O=l-i.start;i.appendedPTS=o,i.start=i.startPTS=l,i.maxStartPTS=h,i.startDTS=e,i.endPTS=o,i.minEndPTS=u,i.endDTS=v;var M=i.sn;if(!n||M<n.startSN||M>n.endSN)return 0;var C,F=M-n.startSN,U=n.fragments;for(U[F]=i,C=F;C>0;C--)S(U[C],U[C-1]);for(C=F;C<U.length-1;C++)S(U[C],U[C+1]);return n.fragmentHint&&S(U[U.length-1],n.fragmentHint),n.PTSKnown=n.alignedSliding=!0,O}function L(n,i){for(var l=null,o=n.fragments,e=o.length-1;e>=0;e--){var v=o[e].initSegment;if(v){l=v;break}}n.fragmentHint&&delete n.fragmentHint.endPTS;var h,s=0;if(p(n,i,function(C,F){C.relurl&&(s=C.cc-F.cc),(0,b.isFiniteNumber)(C.startPTS)&&(0,b.isFiniteNumber)(C.endPTS)&&(F.start=F.startPTS=C.startPTS,F.startDTS=C.startDTS,F.appendedPTS=C.appendedPTS,F.maxStartPTS=C.maxStartPTS,F.endPTS=C.endPTS,F.endDTS=C.endDTS,F.minEndPTS=C.minEndPTS,F.duration=C.endPTS-C.startPTS,F.duration&&(h=F),i.PTSKnown=i.alignedSliding=!0),F.elementaryStreams=C.elementaryStreams,F.loader=C.loader,F.stats=C.stats,F.urlId=C.urlId,C.initSegment&&(F.initSegment=C.initSegment,l=C.initSegment)}),l&&(i.fragmentHint?i.fragments.concat(i.fragmentHint):i.fragments).forEach(function(C){var F;(!C.initSegment||C.initSegment.relurl===(null===(F=l)||void 0===F?void 0:F.relurl))&&(C.initSegment=l)}),i.skippedSegments)if(i.deltaUpdateFailed=i.fragments.some(function(C){return!C}),i.deltaUpdateFailed){R.logger.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(var a=i.skippedSegments;a--;)i.fragments.shift();i.startSN=i.fragments[0].sn,i.startCC=i.fragments[0].cc}else i.canSkipDateRanges&&(i.dateRanges=function y(n,i,l){var o=_({},n);return l&&l.forEach(function(e){delete o[e]}),Object.keys(i).forEach(function(e){var v=new D.DateRange(i[e].attr,o[e]);v.isValid?o[e]=v:R.logger.warn('Ignoring invalid Playlist Delta Update DATERANGE tag: "'+JSON.stringify(i[e].attr)+'"')}),o}(n.dateRanges,i.dateRanges,i.recentlyRemovedDateranges));var m=i.fragments;if(s){R.logger.warn("discontinuity sliding from playlist, take drift into account");for(var E=0;E<m.length;E++)m[E].cc+=s}i.skippedSegments&&(i.startCC=i.fragments[0].cc),T(n.partList,i.partList,function(C,F){F.elementaryStreams=C.elementaryStreams,F.stats=C.stats}),h?g(i,h,h.startPTS,h.endPTS,h.startDTS,h.endDTS):f(n,i),m.length&&(i.totalduration=i.edge-m[0].start),i.driftStartTime=n.driftStartTime,i.driftStart=n.driftStart;var O=i.advancedDateTime;if(i.advanced&&O){var M=i.edge;i.driftStart||(i.driftStartTime=O,i.driftStart=M),i.driftEndTime=O,i.driftEnd=M}else i.driftEndTime=n.driftEndTime,i.driftEnd=n.driftEnd,i.advancedDateTime=n.advancedDateTime}function T(n,i,l){if(n&&i)for(var o=0,e=0,v=n.length;e<=v;e++){var s=n[e],h=i[e+o];s&&h&&s.index===h.index&&s.fragment.sn===h.fragment.sn?l(s,h):o--}}function p(n,i,l){for(var o=i.skippedSegments,e=Math.max(n.startSN,i.startSN)-i.startSN,v=(n.fragmentHint?1:0)+(o?i.endSN:Math.min(n.endSN,i.endSN))-i.startSN,s=i.startSN-n.startSN,h=i.fragmentHint?i.fragments.concat(i.fragmentHint):i.fragments,u=n.fragmentHint?n.fragments.concat(n.fragmentHint):n.fragments,a=e;a<=v;a++){var m=u[s+a],E=h[a];o&&!E&&a<o&&(E=i.fragments[a]=m),m&&E&&l(m,E)}}function f(n,i){var l=i.startSN+i.skippedSegments-n.startSN,o=n.fragments;l<0||l>=o.length||r(i,o[l].start)}function r(n,i){if(i){for(var l=n.fragments,o=n.skippedSegments;o<l.length;o++)l[o].start+=i;n.fragmentHint&&(n.fragmentHint.start+=i)}}function t(n,i){var h,l=1e3*n.levelTargetDuration,o=l/2,e=n.age,v=e>0&&e<3*l,s=i.loading.end-i.loading.start,u=n.availabilityDelay;if(!1===n.updated)if(v){var a=333*n.misses;h=Math.max(Math.min(o,2*s),a),n.availabilityDelay=(n.availabilityDelay||0)+h}else h=o;else v?(u=Math.min(u||l/2,e),n.availabilityDelay=u,h=u+l-e):h=l-s;return Math.round(h)}function d(n,i,l){if(!n||!n.details)return null;var o=n.details,e=o.fragments[i-o.startSN];return e||(e=o.fragmentHint)&&e.sn===i?e:i<o.startSN&&l&&l.sn===i?l:null}function c(n,i,l){if(!n||!n.details)return null;var o=n.details.partList;if(o)for(var e=o.length;e--;){var v=o[e];if(v.index===l&&v.fragment.sn===i)return v}return null}},"./src/controller/stream-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>c});var b=A("./src/polyfills/number.ts"),R=A("./src/controller/base-stream-controller.ts"),D=A("./src/is-supported.ts"),_=A("./src/events.ts"),I=A("./src/utils/buffer-helper.ts"),P=A("./src/controller/fragment-tracker.ts"),x=A("./src/types/loader.ts"),S=A("./src/loader/fragment.ts"),g=A("./src/demux/transmuxer-interface.ts"),L=A("./src/types/transmuxer.ts"),y=A("./src/controller/gap-controller.ts"),T=A("./src/errors.ts");function p(n,i){for(var l=0;l<i.length;l++){var o=i[l];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(n,o.key,o)}}function t(n,i){return(t=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(o,e){return o.__proto__=e,o})(n,i)}var c=function(n){function i(o,e){var v;return(v=n.call(this,o,e,"[stream-controller]")||this).audioCodecSwap=!1,v.gapController=null,v.level=-1,v._forceStartLoad=!1,v.altAudio=!1,v.audioOnly=!1,v.fragPlaying=null,v.onvplaying=null,v.onvseeked=null,v.fragLastKbps=0,v.couldBacktrack=!1,v.backtrackFragment=null,v.audioCodecSwitch=!1,v.videoBuffer=null,v._registerListeners(),v}!function r(n,i){n.prototype=Object.create(i.prototype),n.prototype.constructor=n,t(n,i)}(i,n);var l=i.prototype;return l._registerListeners=function(){var e=this.hls;e.on(_.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(_.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(_.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(_.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(_.Events.LEVEL_LOADING,this.onLevelLoading,this),e.on(_.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(_.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(_.Events.ERROR,this.onError,this),e.on(_.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(_.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(_.Events.BUFFER_CREATED,this.onBufferCreated,this),e.on(_.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(_.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(_.Events.FRAG_BUFFERED,this.onFragBuffered,this)},l._unregisterListeners=function(){var e=this.hls;e.off(_.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(_.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(_.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(_.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(_.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(_.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(_.Events.ERROR,this.onError,this),e.off(_.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(_.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(_.Events.BUFFER_CREATED,this.onBufferCreated,this),e.off(_.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(_.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(_.Events.FRAG_BUFFERED,this.onFragBuffered,this)},l.onHandlerDestroying=function(){this._unregisterListeners(),this.onMediaDetaching()},l.startLoad=function(e){if(this.levels){var v=this.lastCurrentTime,s=this.hls;if(this.stopLoad(),this.setInterval(100),this.level=-1,this.fragLoadError=0,!this.startFragRequested){var h=s.startLevel;-1===h&&(s.config.testBandwidth&&this.levels.length>1?(h=0,this.bitrateTest=!0):h=s.nextAutoLevel),this.level=s.nextLoadLevel=h,this.loadedmetadata=!1}v>0&&-1===e&&(this.log("Override startPosition with lastCurrentTime @"+v.toFixed(3)),e=v),this.state=R.State.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=R.State.STOPPED},l.stopLoad=function(){this._forceStartLoad=!1,n.prototype.stopLoad.call(this)},l.doTick=function(){switch(this.state){case R.State.IDLE:this.doTickIdle();break;case R.State.WAITING_LEVEL:var e,v=this.levels,h=null==v||null===(e=v[this.level])||void 0===e?void 0:e.details;if(h&&(!h.live||this.levelLastLoaded===this.level)){if(this.waitForCdnTuneIn(h))break;this.state=R.State.IDLE;break}break;case R.State.FRAG_LOADING_WAITING_RETRY:var u,a=self.performance.now(),m=this.retryDate;(!m||a>=m||null!==(u=this.media)&&void 0!==u&&u.seeking)&&(this.log("retryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(this.level),this.state=R.State.IDLE)}this.onTickEnd()},l.onTickEnd=function(){n.prototype.onTickEnd.call(this),this.checkBuffer(),this.checkFragmentChanged()},l.doTickIdle=function(){var e,v,s=this.hls,u=this.levels,a=this.media,E=s.nextLoadLevel;if(null!==this.levelLastLoaded&&(a||!this.startFragRequested&&s.config.startFragPrefetch)&&(!this.altAudio||!this.audioOnly)&&u&&u[E]){var O=u[E];this.level=s.nextLoadLevel=E;var M=O.details;if(!M||this.state===R.State.WAITING_LEVEL||M.live&&this.levelLastLoaded!==E)return void(this.state=R.State.WAITING_LEVEL);var C=this.getMainFwdBufferInfo();if(null!==C&&!(C.len>=this.getMaxBufferLength(O.maxBitrate))){if(this._streamEnded(C,M)){var k={};return this.altAudio&&(k.type="video"),this.hls.trigger(_.Events.BUFFER_EOS,k),void(this.state=R.State.ENDED)}this.backtrackFragment&&this.backtrackFragment.start>C.end&&(this.backtrackFragment=null);var N=this.backtrackFragment?this.backtrackFragment.start:C.end,w=this.getNextFragment(N,M);if(this.couldBacktrack&&!this.fragPrevious&&w&&"initSegment"!==w.sn&&this.fragmentTracker.getState(w)!==P.FragmentState.OK){var K,G=(null!=(K=this.backtrackFragment)?K:w).sn,V=M.fragments[G-M.startSN-1];V&&w.cc===V.cc&&(w=V,this.fragmentTracker.removeFragment(V))}else this.backtrackFragment&&C.len&&(this.backtrackFragment=null);w&&this.fragmentTracker.getState(w)===P.FragmentState.OK&&this.nextLoadPosition>N&&(a&&this.afterBufferFlushed(a,this.audioOnly&&!this.altAudio?S.ElementaryStreamTypes.AUDIO:S.ElementaryStreamTypes.VIDEO,x.PlaylistLevelType.MAIN),w=this.getNextFragment(this.nextLoadPosition,M)),!w||(w.initSegment&&!w.initSegment.data&&!this.bitrateTest&&(w=w.initSegment),"identity"!==(null===(e=w.decryptdata)||void 0===e?void 0:e.keyFormat)||null!==(v=w.decryptdata)&&void 0!==v&&v.key?this.loadFragment(w,M,N):this.loadKey(w,M))}}},l.loadFragment=function(e,v,s){var h,u=this.fragmentTracker.getState(e);this.fragCurrent=e,u===P.FragmentState.NOT_LOADED?"initSegment"===e.sn?this._loadInitSegment(e):this.bitrateTest?(this.log("Fragment "+e.sn+" of level "+e.level+" is being downloaded to test bitrate and will not be buffered"),this._loadBitrateTestFrag(e)):(this.startFragRequested=!0,n.prototype.loadFragment.call(this,e,v,s)):u===P.FragmentState.APPENDING?this.reduceMaxBufferLength(e.duration)&&this.fragmentTracker.removeFragment(e):0===(null===(h=this.media)||void 0===h?void 0:h.buffered.length)&&this.fragmentTracker.removeAllFragments()},l.getAppendedFrag=function(e){var v=this.fragmentTracker.getAppendedFrag(e,x.PlaylistLevelType.MAIN);return v&&"fragment"in v?v.fragment:v},l.getBufferedFrag=function(e){return this.fragmentTracker.getBufferedFrag(e,x.PlaylistLevelType.MAIN)},l.followingBufferedFrag=function(e){return e?this.getBufferedFrag(e.end+.5):null},l.immediateLevelSwitch=function(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)},l.nextLevelSwitch=function(){var e=this.levels,v=this.media;if(null!=v&&v.readyState){var s,h=this.getAppendedFrag(v.currentTime);if(h&&h.start>1&&this.flushMainBuffer(0,h.start-1),!v.paused&&e){var m=this.fragLastKbps;s=m&&this.fragCurrent?this.fragCurrent.duration*e[this.hls.nextLoadLevel].maxBitrate/(1e3*m)+1:0}else s=0;var E=this.getBufferedFrag(v.currentTime+s);if(E){var O=this.followingBufferedFrag(E);if(O){this.abortCurrentFrag();var C=O.duration,F=Math.max(E.end,(O.maxStartPTS?O.maxStartPTS:O.start)+Math.min(Math.max(C-this.config.maxFragLookUpTolerance,.5*C),.75*C));this.flushMainBuffer(F,Number.POSITIVE_INFINITY)}}}},l.abortCurrentFrag=function(){var e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,null!=e&&e.loader&&e.loader.abort(),this.state){case R.State.KEY_LOADING:case R.State.FRAG_LOADING:case R.State.FRAG_LOADING_WAITING_RETRY:case R.State.PARSING:case R.State.PARSED:this.state=R.State.IDLE}this.nextLoadPosition=this.getLoadPosition()},l.flushMainBuffer=function(e,v){n.prototype.flushMainBuffer.call(this,e,v,this.altAudio?"video":null)},l.onMediaAttached=function(e,v){n.prototype.onMediaAttached.call(this,e,v);var s=v.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),s.addEventListener("playing",this.onvplaying),s.addEventListener("seeked",this.onvseeked),this.gapController=new y.default(this.config,s,this.fragmentTracker,this.hls)},l.onMediaDetaching=function(){var e=this.media;e&&this.onvplaying&&this.onvseeked&&(e.removeEventListener("playing",this.onvplaying),e.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),n.prototype.onMediaDetaching.call(this)},l.onMediaPlaying=function(){this.tick()},l.onMediaSeeked=function(){var e=this.media,v=e?e.currentTime:null;(0,b.isFiniteNumber)(v)&&this.log("Media seeked to "+v.toFixed(3)),this.tick()},l.onManifestLoading=function(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(_.Events.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=0,this.fragPlaying=null,this.backtrackFragment=null},l.onManifestParsed=function(e,v){var u,s=!1,h=!1;v.levels.forEach(function(a){(u=a.audioCodec)&&(-1!==u.indexOf("mp4a.40.2")&&(s=!0),-1!==u.indexOf("mp4a.40.5")&&(h=!0))}),this.audioCodecSwitch=s&&h&&!(0,D.changeTypeSupported)(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=v.levels,this.startFragRequested=!1},l.onLevelLoading=function(e,v){var s=this.levels;if(s&&this.state===R.State.IDLE){var h=s[v.level];(!h.details||h.details.live&&this.levelLastLoaded!==v.level||this.waitForCdnTuneIn(h.details))&&(this.state=R.State.WAITING_LEVEL)}},l.onLevelLoaded=function(e,v){var s,h=this.levels,u=v.level,a=v.details;if(h){this.log("Level "+u+" loaded ["+a.startSN+","+a.endSN+"], cc ["+a.startCC+", "+a.endCC+"] duration:"+a.totalduration);var E=this.fragCurrent;E&&(this.state===R.State.FRAG_LOADING||this.state===R.State.FRAG_LOADING_WAITING_RETRY)&&E.level!==v.level&&E.loader&&(this.state=R.State.IDLE,this.backtrackFragment=null,E.loader.abort());var O=h[u],M=0;if(a.live||null!==(s=O.details)&&void 0!==s&&s.live){if(a.fragments[0]||(a.deltaUpdateFailed=!0),a.deltaUpdateFailed)return;M=this.alignPlaylists(a,O.details)}if(O.details=a,this.levelLastLoaded=u,this.hls.trigger(_.Events.LEVEL_UPDATED,{details:a,level:u}),this.state===R.State.WAITING_LEVEL){if(this.waitForCdnTuneIn(a))return;this.state=R.State.IDLE}this.startFragRequested?a.live&&this.synchronizeToLiveEdge(a):this.setStartPosition(a,M),this.tick()}else this.warn("Levels were reset while loading level "+u)},l._handleFragmentLoadProgress=function(e){var v,s=e.frag,h=e.part,u=e.payload,a=this.levels;if(a){var m=a[s.level],E=m.details;if(E){var O=m.videoCodec,M=E.PTSKnown||!E.live,C=null===(v=s.initSegment)||void 0===v?void 0:v.data,F=this._getAudioCodec(m),U=this.transmuxer=this.transmuxer||new g.default(this.hls,x.PlaylistLevelType.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),k=h?h.index:-1,w=new L.ChunkMetadata(s.level,s.sn,s.stats.chunkCount,u.byteLength,k,-1!==k);U.push(u,C,F,O,s,h,E.totalduration,M,w,this.initPTS[s.cc])}else this.warn("Dropping fragment "+s.sn+" of level "+s.level+" after level details were reset")}else this.warn("Levels were reset while fragment load was in progress. Fragment "+s.sn+" of level "+s.level+" will not be buffered")},l.onAudioTrackSwitching=function(e,v){var s=this.altAudio,u=v.id;if(!v.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;var a=this.fragCurrent;null!=a&&a.loader&&(this.log("Switching to main audio track, cancel main fragment load"),a.loader.abort()),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();var m=this.hls;s&&m.trigger(_.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:"audio"}),m.trigger(_.Events.AUDIO_TRACK_SWITCHED,{id:u})}},l.onAudioTrackSwitched=function(e,v){var h=!!this.hls.audioTracks[v.id].url;if(h){var u=this.videoBuffer;u&&this.mediaBuffer!==u&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=u)}this.altAudio=h,this.tick()},l.onBufferCreated=function(e,v){var h,u,s=v.tracks,a=!1;for(var m in s){var E=s[m];if("main"===E.id){if(u=m,h=E,"video"===m){var O=s[m];O&&(this.videoBuffer=O.buffer)}}else a=!0}a&&h?(this.log("Alternate track found, use "+u+".buffered to schedule main fragment loading"),this.mediaBuffer=h.buffer):this.mediaBuffer=this.media},l.onFragBuffered=function(e,v){var s=v.frag,h=v.part;if(!s||s.type===x.PlaylistLevelType.MAIN){if(this.fragContextChanged(s))return this.warn("Fragment "+s.sn+(h?" p: "+h.index:"")+" of level "+s.level+" finished buffering, but was aborted. state: "+this.state),void(this.state===R.State.PARSED&&(this.state=R.State.IDLE));var u=h?h.stats:s.stats;this.fragLastKbps=Math.round(8*u.total/(u.buffering.end-u.loading.first)),"initSegment"!==s.sn&&(this.fragPrevious=s),this.fragBufferedComplete(s,h)}},l.onError=function(e,v){switch(v.details){case T.ErrorDetails.FRAG_LOAD_ERROR:case T.ErrorDetails.FRAG_LOAD_TIMEOUT:case T.ErrorDetails.KEY_LOAD_ERROR:case T.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(x.PlaylistLevelType.MAIN,v);break;case T.ErrorDetails.LEVEL_LOAD_ERROR:case T.ErrorDetails.LEVEL_LOAD_TIMEOUT:this.state!==R.State.ERROR&&(v.fatal?(this.warn(""+v.details),this.state=R.State.ERROR):!v.levelRetry&&this.state===R.State.WAITING_LEVEL&&(this.state=R.State.IDLE));break;case T.ErrorDetails.BUFFER_FULL_ERROR:if("main"===v.parent&&(this.state===R.State.PARSING||this.state===R.State.PARSED)){var s=!0,h=this.getFwdBufferInfo(this.media,x.PlaylistLevelType.MAIN);h&&h.len>.5&&(s=!this.reduceMaxBufferLength(h.len)),s&&(this.warn("buffer full error also media.currentTime is not buffered, flush main"),this.immediateLevelSwitch()),this.resetLoadingState()}}},l.checkBuffer=function(){var e=this.media,v=this.gapController;e&&v&&e.readyState&&(!this.loadedmetadata&&I.BufferHelper.getBuffered(e).length||v.poll(this.lastCurrentTime,this.state!==R.State.IDLE?this.fragCurrent:null),this.lastCurrentTime=e.currentTime)},l.onFragLoadEmergencyAborted=function(){this.state=R.State.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()},l.onBufferFlushed=function(e,v){var s=v.type;(s!==S.ElementaryStreamTypes.AUDIO||this.audioOnly&&!this.altAudio)&&this.afterBufferFlushed((s===S.ElementaryStreamTypes.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media,s,x.PlaylistLevelType.MAIN)},l.onLevelsUpdated=function(e,v){this.levels=v.levels},l.swapAudioCodec=function(){this.audioCodecSwap=!this.audioCodecSwap},l.seekToStartPos=function(){var e=this.media;if(e){var v=e.currentTime,s=this.startPosition;if(s>=0&&v<s){if(e.seeking)return void this.log("could not seek to "+s+", already seeking at "+v);var h=I.BufferHelper.getBuffered(e),a=(h.length?h.start(0):0)-s;a>0&&(a<this.config.maxBufferHole||a<this.config.maxFragLookUpTolerance)&&(this.log("adjusting start position by "+a+" to match buffer start"),this.startPosition=s+=a),this.log("seek to target start position "+s+" from current time "+v),e.currentTime=s}}},l._getAudioCodec=function(e){var v=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&v&&(this.log("Swapping audio codec"),v=-1!==v.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),v},l._loadBitrateTestFrag=function(e){var v=this;e.bitrateTest=!0,this._doFragLoad(e).then(function(s){var h=v.hls;if(s&&!h.nextLoadLevel&&!v.fragContextChanged(e)){v.fragLoadError=0,v.state=R.State.IDLE,v.startFragRequested=!1,v.bitrateTest=!1;var u=e.stats;u.parsing.start=u.parsing.end=u.buffering.start=u.buffering.end=self.performance.now(),h.trigger(_.Events.FRAG_LOADED,s),e.bitrateTest=!1}})},l._handleTransmuxComplete=function(e){var v,s="main",h=this.hls,u=e.remuxResult,a=e.chunkMeta,m=this.getCurrentContext(a);if(!m)return this.warn("The loading context changed while buffering fragment "+a.sn+" of level "+a.level+". This chunk will not be buffered."),void this.resetStartWhenNotLoaded(a.level);var E=m.frag,O=m.part,M=m.level,C=u.video,F=u.text,U=u.id3,k=u.initSegment,N=M.details,w=this.altAudio?void 0:u.audio;if(!this.fragContextChanged(E)){if(this.state=R.State.PARSING,k){k.tracks&&(this._bufferInitSegment(M,k.tracks,E,a),h.trigger(_.Events.FRAG_PARSING_INIT_SEGMENT,{frag:E,id:s,tracks:k.tracks}));var K=k.initPTS,G=k.timescale;(0,b.isFiniteNumber)(K)&&(this.initPTS[E.cc]=K,h.trigger(_.Events.INIT_PTS_FOUND,{frag:E,id:s,initPTS:K,timescale:G}))}if(C&&!1!==u.independent){if(N){var H=C.startPTS,V=C.endPTS,X=C.startDTS,Y=C.endDTS;if(O)O.elementaryStreams[C.type]={startPTS:H,endPTS:V,startDTS:X,endDTS:Y};else if(C.firstKeyFrame&&C.independent&&(this.couldBacktrack=!0),C.dropped&&C.independent){var $=this.getMainFwdBufferInfo();if(($?$.end:this.getLoadPosition())+this.config.maxBufferHole<(C.firstKeyFramePTS?C.firstKeyFramePTS:H)-this.config.maxBufferHole)return void this.backtrack(E);E.setElementaryStreamInfo(C.type,E.start,V,E.start,Y,!0)}E.setElementaryStreamInfo(C.type,H,V,X,Y),this.backtrackFragment&&(this.backtrackFragment=E),this.bufferFragmentData(C,E,O,a)}}else if(!1===u.independent)return void this.backtrack(E);if(w){var j=w.startPTS,q=w.endPTS,J=w.startDTS,ee=w.endDTS;O&&(O.elementaryStreams[S.ElementaryStreamTypes.AUDIO]={startPTS:j,endPTS:q,startDTS:J,endDTS:ee}),E.setElementaryStreamInfo(S.ElementaryStreamTypes.AUDIO,j,q,J,ee),this.bufferFragmentData(w,E,O,a)}N&&null!=U&&null!==(v=U.samples)&&void 0!==v&&v.length&&h.trigger(_.Events.FRAG_PARSING_METADATA,{id:s,frag:E,details:N,samples:U.samples}),N&&F&&h.trigger(_.Events.FRAG_PARSING_USERDATA,{id:s,frag:E,details:N,samples:F.samples})}},l._bufferInitSegment=function(e,v,s,h){var u=this;if(this.state===R.State.PARSING){this.audioOnly=!!v.audio&&!v.video,this.altAudio&&!this.audioOnly&&delete v.audio;var a=v.audio,m=v.video,E=v.audiovideo;if(a){var O=e.audioCodec,M=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(O&&(O=-1!==O.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),1!==a.metadata.channelCount&&-1===M.indexOf("firefox")&&(O="mp4a.40.5")),-1!==M.indexOf("android")&&"audio/mpeg"!==a.container&&this.log("Android: force audio codec to "+(O="mp4a.40.2")),e.audioCodec&&e.audioCodec!==O&&this.log('Swapping manifest audio codec "'+e.audioCodec+'" for "'+O+'"'),a.levelCodec=O,a.id="main",this.log("Init audio buffer, container:"+a.container+", codecs[selected/level/parsed]=["+(O||"")+"/"+(e.audioCodec||"")+"/"+a.codec+"]")}m&&(m.levelCodec=e.videoCodec,m.id="main",this.log("Init video buffer, container:"+m.container+", codecs[level/parsed]=["+(e.videoCodec||"")+"/"+m.codec+"]")),E&&this.log("Init audiovideo buffer, container:"+E.container+", codecs[level/parsed]=["+(e.attrs.CODECS||"")+"/"+E.codec+"]"),this.hls.trigger(_.Events.BUFFER_CODECS,v),Object.keys(v).forEach(function(C){var U=v[C].initSegment;null!=U&&U.byteLength&&u.hls.trigger(_.Events.BUFFER_APPENDING,{type:C,data:U,frag:s,part:null,chunkMeta:h,parent:s.type})}),this.tick()}},l.getMainFwdBufferInfo=function(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,x.PlaylistLevelType.MAIN)},l.backtrack=function(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=R.State.IDLE},l.checkFragmentChanged=function(){var e=this.media,v=null;if(e&&e.readyState>1&&!1===e.seeking){var s=e.currentTime;if(I.BufferHelper.isBuffered(e,s)?v=this.getAppendedFrag(s):I.BufferHelper.isBuffered(e,s+.1)&&(v=this.getAppendedFrag(s+.1)),v){this.backtrackFragment=null;var h=this.fragPlaying,u=v.level;(!h||v.sn!==h.sn||h.level!==u||v.urlId!==h.urlId)&&(this.hls.trigger(_.Events.FRAG_CHANGED,{frag:v}),(!h||h.level!==u)&&this.hls.trigger(_.Events.LEVEL_SWITCHED,{level:u}),this.fragPlaying=v)}}},function f(n,i,l){i&&p(n.prototype,i),l&&p(n,l),Object.defineProperty(n,"prototype",{writable:!1})}(i,[{key:"nextLevel",get:function(){var e=this.nextBufferedFrag;return e?e.level:-1}},{key:"currentFrag",get:function(){var e=this.media;return e?this.fragPlaying||this.getAppendedFrag(e.currentTime):null}},{key:"currentProgramDateTime",get:function(){var e=this.media;if(e){var v=e.currentTime,s=this.currentFrag;if(s&&(0,b.isFiniteNumber)(v)&&(0,b.isFiniteNumber)(s.programDateTime))return new Date(s.programDateTime+1e3*(v-s.start))}return null}},{key:"currentLevel",get:function(){var e=this.currentFrag;return e?e.level:-1}},{key:"nextBufferedFrag",get:function(){var e=this.currentFrag;return e?this.followingBufferedFrag(e):null}},{key:"forceStartLoad",get:function(){return this._forceStartLoad}}]),i}(R.default)},"./src/controller/subtitle-stream-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{SubtitleStreamController:()=>r});var b=A("./src/events.ts"),R=A("./src/utils/buffer-helper.ts"),D=A("./src/controller/fragment-finders.ts"),_=A("./src/utils/discontinuities.ts"),I=A("./src/controller/level-helper.ts"),P=A("./src/controller/fragment-tracker.ts"),x=A("./src/controller/base-stream-controller.ts"),S=A("./src/types/loader.ts"),g=A("./src/types/level.ts");function L(d,c){for(var n=0;n<c.length;n++){var i=c[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(d,i.key,i)}}function p(d,c){return(p=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(i,l){return i.__proto__=l,i})(d,c)}var r=function(d){function c(i,l){var o;return(o=d.call(this,i,l,"[subtitle-stream-controller]")||this).levels=[],o.currentTrackId=-1,o.tracksBuffered=[],o.mainDetails=null,o._registerListeners(),o}!function T(d,c){d.prototype=Object.create(c.prototype),d.prototype.constructor=d,p(d,c)}(c,d);var n=c.prototype;return n.onHandlerDestroying=function(){this._unregisterListeners(),this.mainDetails=null},n._registerListeners=function(){var l=this.hls;l.on(b.Events.MEDIA_ATTACHED,this.onMediaAttached,this),l.on(b.Events.MEDIA_DETACHING,this.onMediaDetaching,this),l.on(b.Events.MANIFEST_LOADING,this.onManifestLoading,this),l.on(b.Events.LEVEL_LOADED,this.onLevelLoaded,this),l.on(b.Events.ERROR,this.onError,this),l.on(b.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),l.on(b.Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),l.on(b.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),l.on(b.Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),l.on(b.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),l.on(b.Events.FRAG_BUFFERED,this.onFragBuffered,this)},n._unregisterListeners=function(){var l=this.hls;l.off(b.Events.MEDIA_ATTACHED,this.onMediaAttached,this),l.off(b.Events.MEDIA_DETACHING,this.onMediaDetaching,this),l.off(b.Events.MANIFEST_LOADING,this.onManifestLoading,this),l.off(b.Events.LEVEL_LOADED,this.onLevelLoaded,this),l.off(b.Events.ERROR,this.onError,this),l.off(b.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),l.off(b.Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),l.off(b.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),l.off(b.Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),l.off(b.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),l.off(b.Events.FRAG_BUFFERED,this.onFragBuffered,this)},n.startLoad=function(l){this.stopLoad(),this.state=x.State.IDLE,this.setInterval(500),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=l,this.tick()},n.onManifestLoading=function(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()},n.onLevelLoaded=function(l,o){this.mainDetails=o.details},n.onSubtitleFragProcessed=function(l,o){var e=o.frag,v=o.success;if(this.fragPrevious=e,this.state=x.State.IDLE,v){var s=this.tracksBuffered[this.currentTrackId];if(s){for(var h,u=e.start,a=0;a<s.length;a++)if(u>=s[a].start&&u<=s[a].end){h=s[a];break}var m=e.start+e.duration;h?h.end=m:s.push(h={start:u,end:m}),this.fragmentTracker.fragBuffered(e)}}},n.onBufferFlushing=function(l,o){var e=o.startOffset,v=o.endOffset;if(0===e&&v!==Number.POSITIVE_INFINITY){var s=this.currentTrackId,h=this.levels;if(!h.length||!h[s]||!h[s].details)return;var m=v-h[s].details.targetduration;if(m<=0)return;o.endOffsetSubtitles=Math.max(0,m),this.tracksBuffered.forEach(function(E){for(var O=0;O<E.length;)if(E[O].end<=m)E.shift();else{if(!(E[O].start<m))break;E[O].start=m,O++}}),this.fragmentTracker.removeFragmentsInRange(e,m,S.PlaylistLevelType.SUBTITLE)}},n.onFragBuffered=function(l,o){var e;this.loadedmetadata||o.frag.type!==S.PlaylistLevelType.MAIN||null!==(e=this.media)&&void 0!==e&&e.buffered.length&&(this.loadedmetadata=!0)},n.onError=function(l,o){var e,v=o.frag;!v||v.type!==S.PlaylistLevelType.SUBTITLE||(null!==(e=this.fragCurrent)&&void 0!==e&&e.loader&&this.fragCurrent.loader.abort(),this.state=x.State.IDLE)},n.onSubtitleTracksUpdated=function(l,o){var e=this,v=o.subtitleTracks;this.tracksBuffered=[],this.levels=v.map(function(s){return new g.Level(s)}),this.fragmentTracker.removeAllFragments(),this.fragPrevious=null,this.levels.forEach(function(s){e.tracksBuffered[s.id]=[]}),this.mediaBuffer=null},n.onSubtitleTrackSwitch=function(l,o){if(this.currentTrackId=o.id,this.levels.length&&-1!==this.currentTrackId){var e=this.levels[this.currentTrackId];this.mediaBuffer=null!=e&&e.details?this.mediaBufferTimeRanges:null,e&&this.setInterval(500)}else this.clearInterval()},n.onSubtitleTrackLoaded=function(l,o){var e,v=o.details,s=o.id,h=this.currentTrackId,u=this.levels;if(u.length){var a=u[h];if(!(s>=u.length||s!==h)&&a){this.mediaBuffer=this.mediaBufferTimeRanges;var m=0;if(v.live||null!==(e=a.details)&&void 0!==e&&e.live){var E=this.mainDetails;if(v.deltaUpdateFailed||!E)return;var O=E.fragments[0];a.details?0===(m=this.alignPlaylists(v,a.details))&&O&&(0,I.addSliding)(v,m=O.start):v.hasProgramDateTime&&E.hasProgramDateTime?((0,_.alignMediaPlaylistByPDT)(v,E),m=v.fragments[0].start):O&&(0,I.addSliding)(v,m=O.start)}a.details=v,this.levelLastLoaded=s,!this.startFragRequested&&(this.mainDetails||!v.live)&&this.setStartPosition(a.details,m),this.tick(),v.live&&!this.fragCurrent&&this.media&&this.state===x.State.IDLE&&((0,D.findFragmentByPTS)(null,v.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),a.details=void 0))}}},n._handleFragmentLoadComplete=function(l){var o=l.frag,e=l.payload,v=o.decryptdata,s=this.hls;if(!this.fragContextChanged(o)&&e&&e.byteLength>0&&v&&v.key&&v.iv&&"AES-128"===v.method){var h=performance.now();this.decrypter.webCryptoDecrypt(new Uint8Array(e),v.key.buffer,v.iv.buffer).then(function(u){var a=performance.now();s.trigger(b.Events.FRAG_DECRYPTED,{frag:o,payload:u,stats:{tstart:h,tdecrypt:a}})})}},n.doTick=function(){if(this.media){if(this.state===x.State.IDLE){var l=this.currentTrackId,o=this.levels;if(!o.length||!o[l]||!o[l].details)return;var e=o[l].details,v=e.targetduration,s=this.config,h=this.getLoadPosition(),u=R.BufferHelper.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],h-v,s.maxBufferHole),a=u.end,m=u.len,E=this.getFwdBufferInfo(this.media,S.PlaylistLevelType.MAIN);if(m>this.getMaxBufferLength(null==E?void 0:E.len)+v)return;console.assert(e,"Subtitle track details are defined on idle subtitle stream controller tick");var U,M=e.fragments,C=M.length,k=this.fragPrevious;if(a<e.edge){var N=s.maxFragLookUpTolerance;!(U=(0,D.findFragmentByPTS)(k,M,Math.max(M[0].start,a),N))&&k&&k.start<M[0].start&&(U=M[0])}else U=M[C-1];if(!(U=this.mapToInitFragWhenRequired(U))||this.fragmentTracker.getState(U)!==P.FragmentState.NOT_LOADED)return;U.encrypted?this.loadKey(U,e):this.loadFragment(U,e,a)}}else this.state=x.State.IDLE},n.getMaxBufferLength=function(l){var o=d.prototype.getMaxBufferLength.call(this);return l?Math.max(o,l):o},n.loadFragment=function(l,o,e){this.fragCurrent=l,"initSegment"===l.sn?this._loadInitSegment(l):(this.startFragRequested=!0,d.prototype.loadFragment.call(this,l,o,e))},function y(d,c,n){c&&L(d.prototype,c),n&&L(d,n),Object.defineProperty(d,"prototype",{writable:!1})}(c,[{key:"mediaBufferTimeRanges",get:function(){return new t(this.tracksBuffered[this.currentTrackId]||[])}}]),c}(x.default),t=function(c){this.buffered=void 0;var n=function(l,o,e){if((o>>>=0)>e-1)throw new DOMException("Failed to execute '"+l+"' on 'TimeRanges': The index provided ("+o+") is greater than the maximum bound ("+e+")");return c[o][l]};this.buffered={get length(){return c.length},end:function(l){return n("end",l,c.length)},start:function(l){return n("start",l,c.length)}}}},"./src/controller/subtitle-track-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>y});var b=A("./src/events.ts"),R=A("./src/utils/texttrack-utils.ts"),D=A("./src/controller/base-playlist-controller.ts"),_=A("./src/types/loader.ts");function I(T,p){for(var f=0;f<p.length;f++){var r=p[f];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(T,r.key,r)}}function S(T,p){return(S=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,t){return r.__proto__=t,r})(T,p)}function L(T){for(var p=[],f=0;f<T.length;f++){var r=T[f];"subtitles"===r.kind&&r.label&&p.push(T[f])}return p}const y=function(T){function p(r){var t;return(t=T.call(this,r,"[subtitle-track-controller]")||this).media=null,t.tracks=[],t.groupId=null,t.tracksInGroup=[],t.trackId=-1,t.selectDefaultTrack=!0,t.queuedDefaultTrack=-1,t.trackChangeListener=function(){return t.onTextTracksChanged()},t.asyncPollTrackChange=function(){return t.pollTrackChange(0)},t.useTextTrackPolling=!1,t.subtitlePollingInterval=-1,t._subtitleDisplay=!0,t.registerListeners(),t}!function x(T,p){T.prototype=Object.create(p.prototype),T.prototype.constructor=T,S(T,p)}(p,T);var f=p.prototype;return f.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.trackChangeListener=this.asyncPollTrackChange=null,T.prototype.destroy.call(this)},f.registerListeners=function(){var t=this.hls;t.on(b.Events.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(b.Events.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(b.Events.MANIFEST_LOADING,this.onManifestLoading,this),t.on(b.Events.MANIFEST_PARSED,this.onManifestParsed,this),t.on(b.Events.LEVEL_LOADING,this.onLevelLoading,this),t.on(b.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(b.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(b.Events.ERROR,this.onError,this)},f.unregisterListeners=function(){var t=this.hls;t.off(b.Events.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(b.Events.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(b.Events.MANIFEST_LOADING,this.onManifestLoading,this),t.off(b.Events.MANIFEST_PARSED,this.onManifestParsed,this),t.off(b.Events.LEVEL_LOADING,this.onLevelLoading,this),t.off(b.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(b.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(b.Events.ERROR,this.onError,this)},f.onMediaAttached=function(t,d){this.media=d.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))},f.pollTrackChange=function(t){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.trackChangeListener,t)},f.onMediaDetaching=function(){this.media&&(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),L(this.media.textTracks).forEach(function(d){(0,R.clearCurrentCues)(d)}),this.subtitleTrack=-1,this.media=null)},f.onManifestLoading=function(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0},f.onManifestParsed=function(t,d){this.tracks=d.subtitleTracks},f.onSubtitleTrackLoaded=function(t,d){var c=d.id,n=d.details,l=this.tracksInGroup[this.trackId];if(l){var o=l.details;l.details=d.details,this.log("subtitle track "+c+" loaded ["+n.startSN+"-"+n.endSN+"]"),c===this.trackId&&(this.retryCount=0,this.playlistLoaded(c,d,o))}else this.warn("Invalid subtitle track id "+c)},f.onLevelLoading=function(t,d){this.switchLevel(d.level)},f.onLevelSwitching=function(t,d){this.switchLevel(d.level)},f.switchLevel=function(t){var d=this.hls.levels[t];if(null!=d&&d.textGroupIds){var c=d.textGroupIds[d.urlId];if(this.groupId!==c){var n=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0,i=this.tracks.filter(function(e){return!c||e.groupId===c});this.tracksInGroup=i;var l=this.findTrackId(null==n?void 0:n.name)||this.findTrackId();this.groupId=c;var o={subtitleTracks:i};this.log("Updating subtitle tracks, "+i.length+' track(s) found in "'+c+'" group-id'),this.hls.trigger(b.Events.SUBTITLE_TRACKS_UPDATED,o),-1!==l&&this.setSubtitleTrack(l,n)}}},f.findTrackId=function(t){for(var d=this.tracksInGroup,c=0;c<d.length;c++){var n=d[c];if((!this.selectDefaultTrack||n.default)&&(!t||t===n.name))return n.id}return-1},f.onError=function(t,d){T.prototype.onError.call(this,t,d),!d.fatal&&d.context&&d.context.type===_.PlaylistContextType.SUBTITLE_TRACK&&d.context.id===this.trackId&&d.context.groupId===this.groupId&&this.retryLoadingOrFail(d)},f.loadPlaylist=function(t){var d=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(d)){var c=d.id,n=d.groupId,i=d.url;if(t)try{i=t.addDirectives(i)}catch(l){this.warn("Could not construct new URL with HLS Delivery Directives: "+l)}this.log("Loading subtitle playlist for id "+c),this.hls.trigger(b.Events.SUBTITLE_TRACK_LOADING,{url:i,id:c,groupId:n,deliveryDirectives:t||null})}},f.toggleTrackModes=function(t){var d=this,c=this.media,n=this.trackId;if(c){var i=L(c.textTracks),l=i.filter(function(v){return v.groupId===d.groupId});if(-1===t)[].slice.call(i).forEach(function(v){v.mode="disabled"});else{var o=l[n];o&&(o.mode="disabled")}var e=l[t];e&&(e.mode=this.subtitleDisplay?"showing":"hidden")}},f.setSubtitleTrack=function(t,d){var c,n=this.tracksInGroup;if(this.media){if(this.trackId!==t&&this.toggleTrackModes(t),!(this.trackId===t&&(-1===t||null!==(c=n[t])&&void 0!==c&&c.details)||t<-1||t>=n.length)){this.clearTimer();var i=n[t];if(this.log("Switching to subtitle track "+t),this.trackId=t,i){var o=i.groupId;this.hls.trigger(b.Events.SUBTITLE_TRACK_SWITCH,{id:i.id,groupId:void 0===o?"":o,name:i.name,type:i.type,url:i.url});var u=this.switchParams(i.url,null==d?void 0:d.details);this.loadPlaylist(u)}else this.hls.trigger(b.Events.SUBTITLE_TRACK_SWITCH,{id:t})}}else this.queuedDefaultTrack=t},f.onTextTracksChanged=function(){if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),this.media&&this.hls.config.renderTextTracksNatively){for(var t=-1,d=L(this.media.textTracks),c=0;c<d.length;c++)if("hidden"===d[c].mode)t=c;else if("showing"===d[c].mode){t=c;break}this.subtitleTrack!==t&&(this.subtitleTrack=t)}},function P(T,p,f){p&&I(T.prototype,p),f&&I(T,f),Object.defineProperty(T,"prototype",{writable:!1})}(p,[{key:"subtitleDisplay",get:function(){return this._subtitleDisplay},set:function(t){this._subtitleDisplay=t,this.trackId>-1&&this.toggleTrackModes(this.trackId)}},{key:"subtitleTracks",get:function(){return this.tracksInGroup}},{key:"subtitleTrack",get:function(){return this.trackId},set:function(t){this.selectDefaultTrack=!1,this.setSubtitleTrack(t,this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0)}}]),p}(D.default)},"./src/controller/timeline-controller.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{TimelineController:()=>y});var b=A("./src/polyfills/number.ts"),R=A("./src/events.ts"),D=A("./src/utils/cea-608-parser.ts"),_=A("./src/utils/output-filter.ts"),I=A("./src/utils/webvtt-parser.ts"),P=A("./src/utils/texttrack-utils.ts"),x=A("./src/utils/imsc1-ttml-parser.ts"),S=A("./src/utils/mp4-tools.ts"),g=A("./src/types/loader.ts"),L=A("./src/utils/logger.ts"),y=function(){function r(d){if(this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.timescale=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this.captionsProperties=void 0,this.hls=d,this.config=d.config,this.Cues=d.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},this.config.enableCEA708Captions){var c=new _.default(this,"textTrack1"),n=new _.default(this,"textTrack2"),i=new _.default(this,"textTrack3"),l=new _.default(this,"textTrack4");this.cea608Parser1=new D.default(1,c,n),this.cea608Parser2=new D.default(3,i,l)}d.on(R.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),d.on(R.Events.MEDIA_DETACHING,this.onMediaDetaching,this),d.on(R.Events.MANIFEST_LOADING,this.onManifestLoading,this),d.on(R.Events.MANIFEST_LOADED,this.onManifestLoaded,this),d.on(R.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),d.on(R.Events.FRAG_LOADING,this.onFragLoading,this),d.on(R.Events.FRAG_LOADED,this.onFragLoaded,this),d.on(R.Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),d.on(R.Events.FRAG_DECRYPTED,this.onFragDecrypted,this),d.on(R.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),d.on(R.Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),d.on(R.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)}var t=r.prototype;return t.destroy=function(){var c=this.hls;c.off(R.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),c.off(R.Events.MEDIA_DETACHING,this.onMediaDetaching,this),c.off(R.Events.MANIFEST_LOADING,this.onManifestLoading,this),c.off(R.Events.MANIFEST_LOADED,this.onManifestLoaded,this),c.off(R.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),c.off(R.Events.FRAG_LOADING,this.onFragLoading,this),c.off(R.Events.FRAG_LOADED,this.onFragLoaded,this),c.off(R.Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),c.off(R.Events.FRAG_DECRYPTED,this.onFragDecrypted,this),c.off(R.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),c.off(R.Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),c.off(R.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.cea608Parser1=this.cea608Parser2=null},t.addCues=function(c,n,i,l,o){for(var e=!1,v=o.length;v--;){var s=o[v],h=p(s[0],s[1],n,i);if(h>=0&&(s[0]=Math.min(s[0],n),s[1]=Math.max(s[1],i),e=!0,h/(i-n)>.5))return}if(e||o.push([n,i]),this.config.renderTextTracksNatively)this.Cues.newCue(this.captionsTracks[c],n,i,l);else{var a=this.Cues.newCue(null,n,i,l);this.hls.trigger(R.Events.CUES_PARSED,{type:"captions",cues:a,track:c})}},t.onInitPtsFound=function(c,n){var i=this,l=n.frag,v=n.timescale,s=this.unparsedVttFrags;"main"===n.id&&(this.initPTS[l.cc]=n.initPTS,this.timescale[l.cc]=v),s.length&&(this.unparsedVttFrags=[],s.forEach(function(h){i.onFragLoaded(R.Events.FRAG_LOADED,h)}))},t.getExistingTrack=function(c){var n=this.media;if(n)for(var i=0;i<n.textTracks.length;i++){var l=n.textTracks[i];if(l[c])return l}return null},t.createCaptionsTrack=function(c){this.config.renderTextTracksNatively?this.createNativeTrack(c):this.createNonNativeTrack(c)},t.createNativeTrack=function(c){if(!this.captionsTracks[c]){var i=this.captionsTracks,l=this.media,o=this.captionsProperties[c],e=o.label,v=o.languageCode,s=this.getExistingTrack(c);if(s)i[c]=s,(0,P.clearCurrentCues)(i[c]),(0,P.sendAddTrackEvent)(i[c],l);else{var h=this.createTextTrack("captions",e,v);h&&(h[c]=!0,i[c]=h)}}},t.createNonNativeTrack=function(c){if(!this.nonNativeCaptionsTracks[c]){var n=this.captionsProperties[c];if(n){var l={_id:c,label:n.label,kind:"captions",default:!!n.media&&!!n.media.default,closedCaptions:n.media};this.nonNativeCaptionsTracks[c]=l,this.hls.trigger(R.Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[l]})}}},t.createTextTrack=function(c,n,i){var l=this.media;if(l)return l.addTextTrack(c,n,i)},t.onMediaAttaching=function(c,n){this.media=n.media,this._cleanTracks()},t.onMediaDetaching=function(){var c=this.captionsTracks;Object.keys(c).forEach(function(n){(0,P.clearCurrentCues)(c[n]),delete c[n]}),this.nonNativeCaptionsTracks={}},t.onManifestLoading=function(){this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=this.unparsedVttFrags||[],this.initPTS=[],this.timescale=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())},t._cleanTracks=function(){var c=this.media;if(c){var n=c.textTracks;if(n)for(var i=0;i<n.length;i++)(0,P.clearCurrentCues)(n[i])}},t.onSubtitleTracksUpdated=function(c,n){var i=this;this.textTracks=[];var l=n.subtitleTracks||[],o=l.some(function(h){return h.textCodec===x.IMSC1_CODEC});if(this.config.enableWebVTT||o&&this.config.enableIMSC1){var e=this.tracks&&l&&this.tracks.length===l.length;if(this.tracks=l||[],this.config.renderTextTracksNatively){var v=this.media?this.media.textTracks:[];this.tracks.forEach(function(h,u){var a;if(u<v.length){for(var m=null,E=0;E<v.length;E++)if(T(v[E],h)){m=v[E];break}m&&(a=m)}if(a)(0,P.clearCurrentCues)(a);else{var O=i._captionsOrSubtitlesFromCharacteristics(h);(a=i.createTextTrack(O,h.name,h.lang))&&(a.mode="disabled")}a&&(a.groupId=h.groupId,i.textTracks.push(a))})}else if(!e&&this.tracks&&this.tracks.length){var s=this.tracks.map(function(h){return{label:h.name,kind:h.type.toLowerCase(),default:h.default,subtitleTrack:h}});this.hls.trigger(R.Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:s})}}},t._captionsOrSubtitlesFromCharacteristics=function(c){var n;if(null!==(n=c.attrs)&&void 0!==n&&n.CHARACTERISTICS){var i=/transcribes-spoken-dialog/gi.test(c.attrs.CHARACTERISTICS),l=/describes-music-and-sound/gi.test(c.attrs.CHARACTERISTICS);if(i&&l)return"captions"}return"subtitles"},t.onManifestLoaded=function(c,n){var i=this;this.config.enableCEA708Captions&&n.captions&&n.captions.forEach(function(l){var o=/(?:CC|SERVICE)([1-4])/.exec(l.instreamId);if(o){var v=i.captionsProperties["textTrack"+o[1]];!v||(v.label=l.name,l.lang&&(v.languageCode=l.lang),v.media=l)}})},t.closedCaptionsForLevel=function(c){var n=this.hls.levels[c.level];return null==n?void 0:n.attrs["CLOSED-CAPTIONS"]},t.onFragLoading=function(c,n){var i=this.cea608Parser1,l=this.cea608Parser2,o=this.lastSn;if(this.enabled&&i&&l&&n.frag.type===g.PlaylistLevelType.MAIN){var v,s,h=n.frag.sn,u=null!=(v=null==n||null===(s=n.part)||void 0===s?void 0:s.index)?v:-1;h===o+1||h===o&&u===this.lastPartIndex+1||(i.reset(),l.reset()),this.lastSn=h,this.lastPartIndex=u}},t.onFragLoaded=function(c,n){var i=n.frag,l=n.payload,o=this.initPTS,e=this.unparsedVttFrags;if(i.type===g.PlaylistLevelType.SUBTITLE)if(l.byteLength){if(!(0,b.isFiniteNumber)(o[i.cc]))return e.push(n),void(o.length&&this.hls.trigger(R.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Missing initial subtitle PTS")}));var v=i.decryptdata;if(null==v||null==v.key||"AES-128"!==v.method||"stats"in n){var h=this.tracks[i.level],u=this.vttCCs;u[i.cc]||(u[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),h&&h.textCodec===x.IMSC1_CODEC?this._parseIMSC1(i,l):this._parseVTTs(i,l,u)}}else this.hls.trigger(R.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})},t._parseIMSC1=function(c,n){var i=this,l=this.hls;(0,x.parseIMSC1)(n,this.initPTS[c.cc],this.timescale[c.cc],function(o){i._appendCues(o,c.level),l.trigger(R.Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:c})},function(o){L.logger.log("Failed to parse IMSC1: "+o),l.trigger(R.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:c,error:o})})},t._parseVTTs=function(c,n,i){var l,o=this,e=this.hls,v=null!==(l=c.initSegment)&&void 0!==l&&l.data?(0,S.appendUint8Array)(c.initSegment.data,new Uint8Array(n)):n;(0,I.parseWebVTT)(v,this.initPTS[c.cc],this.timescale[c.cc],i,c.cc,c.start,function(s){o._appendCues(s,c.level),e.trigger(R.Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:c})},function(s){o._fallbackToIMSC1(c,n),L.logger.log("Failed to parse VTT cue: "+s),e.trigger(R.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:c,error:s})})},t._fallbackToIMSC1=function(c,n){var i=this,l=this.tracks[c.level];l.textCodec||(0,x.parseIMSC1)(n,this.initPTS[c.cc],this.timescale[c.cc],function(){l.textCodec=x.IMSC1_CODEC,i._parseIMSC1(c,n)},function(){l.textCodec="wvtt"})},t._appendCues=function(c,n){var i=this.hls;if(this.config.renderTextTracksNatively){var l=this.textTracks[n];if(!l||"disabled"===l.mode)return;c.forEach(function(v){return(0,P.addCueToTrack)(l,v)})}else{var o=this.tracks[n];if(!o)return;i.trigger(R.Events.CUES_PARSED,{type:"subtitles",cues:c,track:o.default?"default":"subtitles"+n})}},t.onFragDecrypted=function(c,n){var i=n.frag;if(i.type===g.PlaylistLevelType.SUBTITLE){if(!(0,b.isFiniteNumber)(this.initPTS[i.cc]))return void this.unparsedVttFrags.push(n);this.onFragLoaded(R.Events.FRAG_LOADED,n)}},t.onSubtitleTracksCleared=function(){this.tracks=[],this.captionsTracks={}},t.onFragParsingUserdata=function(c,n){var i=this.cea608Parser1,l=this.cea608Parser2;if(this.enabled&&i&&l){var o=n.frag,e=n.samples;if(o.type!==g.PlaylistLevelType.MAIN||"NONE"!==this.closedCaptionsForLevel(o))for(var v=0;v<e.length;v++){var s=e[v].bytes;if(s){var h=this.extractCea608Data(s);i.addData(e[v].pts,h[0]),l.addData(e[v].pts,h[1])}}}},t.onBufferFlushing=function(c,n){var i=n.startOffset,l=n.endOffset,o=n.endOffsetSubtitles,e=n.type,v=this.media;if(v&&!(v.currentTime<l)){if(!e||"video"===e){var s=this.captionsTracks;Object.keys(s).forEach(function(u){return(0,P.removeCuesInRange)(s[u],i,l)})}if(this.config.renderTextTracksNatively&&0===i&&void 0!==o){var h=this.textTracks;Object.keys(h).forEach(function(u){return(0,P.removeCuesInRange)(h[u],i,o)})}}},t.extractCea608Data=function(c){for(var n=[[],[]],i=31&c[0],l=2,o=0;o<i;o++){var e=c[l++],v=127&c[l++],s=127&c[l++];if((0!==v||0!==s)&&0!=(4&e)){var u=3&e;(0===u||1===u)&&(n[u].push(v),n[u].push(s))}}return n},r}();function T(r,t){return r&&r.label===t.name&&!(r.textTrack1||r.textTrack2)}function p(r,t,d,c){return Math.min(t,c)-Math.max(r,d)}},"./src/crypt/aes-crypto.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>b});var b=function(){function R(_,I){this.subtle=void 0,this.aesIV=void 0,this.subtle=_,this.aesIV=I}return R.prototype.decrypt=function(I,P){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},P,I)},R}()},"./src/crypt/aes-decryptor.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>D,removePadding:()=>R});var b=A("./src/utils/typed-array.ts");function R(_){var I=_.byteLength,P=I&&new DataView(_.buffer).getUint8(I-1);return P?(0,b.sliceUint8)(_,0,I-P):_}var D=function(){function _(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}var I=_.prototype;return I.uint8ArrayToUint32Array_=function(x){for(var S=new DataView(x),g=new Uint32Array(4),L=0;L<4;L++)g[L]=S.getUint32(4*L);return g},I.initTable=function(){var x=this.sBox,S=this.invSBox,g=this.subMix,L=g[0],y=g[1],T=g[2],p=g[3],f=this.invSubMix,r=f[0],t=f[1],d=f[2],c=f[3],n=new Uint32Array(256),i=0,l=0,o=0;for(o=0;o<256;o++)n[o]=o<128?o<<1:o<<1^283;for(o=0;o<256;o++){var e=l^l<<1^l<<2^l<<3^l<<4;x[i]=e=e>>>8^255&e^99,S[e]=i;var v=n[i],s=n[v],h=n[s],u=257*n[e]^16843008*e;L[i]=u<<24|u>>>8,y[i]=u<<16|u>>>16,T[i]=u<<8|u>>>24,p[i]=u,r[e]=(u=16843009*h^65537*s^257*v^16843008*i)<<24|u>>>8,t[e]=u<<16|u>>>16,d[e]=u<<8|u>>>24,c[e]=u,i?(i=v^n[n[n[h^v]]],l^=n[n[l]]):i=l=1}},I.expandKey=function(x){for(var S=this.uint8ArrayToUint32Array_(x),g=!0,L=0;L<S.length&&g;)g=S[L]===this.key[L],L++;if(!g){this.key=S;var y=this.keySize=S.length;if(4!==y&&6!==y&&8!==y)throw new Error("Invalid aes key size="+y);var p,f,v,s,T=this.ksRows=4*(y+6+1),r=this.keySchedule=new Uint32Array(T),t=this.invKeySchedule=new Uint32Array(T),d=this.sBox,c=this.rcon,n=this.invSubMix,i=n[0],l=n[1],o=n[2],e=n[3];for(p=0;p<T;p++)p<y?v=r[p]=S[p]:(s=v,p%y==0?(s=d[(s=s<<8|s>>>24)>>>24]<<24|d[s>>>16&255]<<16|d[s>>>8&255]<<8|d[255&s],s^=c[p/y|0]<<24):y>6&&p%y==4&&(s=d[s>>>24]<<24|d[s>>>16&255]<<16|d[s>>>8&255]<<8|d[255&s]),r[p]=v=(r[p-y]^s)>>>0);for(f=0;f<T;f++)p=T-f,s=3&f?r[p]:r[p-4],t[f]=f<4||p<=4?s:i[d[s>>>24]]^l[d[s>>>16&255]]^o[d[s>>>8&255]]^e[d[255&s]],t[f]=t[f]>>>0}},I.networkToHostOrderSwap=function(x){return x<<24|(65280&x)<<8|(16711680&x)>>8|x>>>24},I.decrypt=function(x,S,g){for(var h,u,a,m,E,O,M,C,F,U,k,N,w,L=this.keySize+6,y=this.invKeySchedule,T=this.invSBox,p=this.invSubMix,f=p[0],r=p[1],t=p[2],d=p[3],c=this.uint8ArrayToUint32Array_(g),n=c[0],i=c[1],l=c[2],o=c[3],e=new Int32Array(x),v=new Int32Array(e.length),K=this.networkToHostOrderSwap;S<e.length;){for(C=K(e[S]),F=K(e[S+1]),U=K(e[S+2]),k=K(e[S+3]),m=C^y[0],E=k^y[1],O=U^y[2],M=F^y[3],N=4,w=1;w<L;w++)h=f[E>>>24]^r[O>>16&255]^t[M>>8&255]^d[255&m]^y[N+1],u=f[O>>>24]^r[M>>16&255]^t[m>>8&255]^d[255&E]^y[N+2],a=f[M>>>24]^r[m>>16&255]^t[E>>8&255]^d[255&O]^y[N+3],m=f[m>>>24]^r[E>>16&255]^t[O>>8&255]^d[255&M]^y[N],E=h,O=u,M=a,N+=4;h=T[E>>>24]<<24^T[O>>16&255]<<16^T[M>>8&255]<<8^T[255&m]^y[N+1],u=T[O>>>24]<<24^T[M>>16&255]<<16^T[m>>8&255]<<8^T[255&E]^y[N+2],a=T[M>>>24]<<24^T[m>>16&255]<<16^T[E>>8&255]<<8^T[255&O]^y[N+3],v[S]=K(T[m>>>24]<<24^T[E>>16&255]<<16^T[O>>8&255]<<8^T[255&M]^y[N]^n),v[S+1]=K(a^i),v[S+2]=K(u^l),v[S+3]=K(h^o),n=C,i=F,l=U,o=k,S+=4}return v.buffer},_}()},"./src/crypt/decrypter.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>S});var b=A("./src/crypt/aes-crypto.ts"),R=A("./src/crypt/fast-aes-key.ts"),D=A("./src/crypt/aes-decryptor.ts"),_=A("./src/utils/logger.ts"),I=A("./src/utils/mp4-tools.ts"),P=A("./src/utils/typed-array.ts"),S=function(){function g(y,T,p){var r=(void 0===p?{}:p).removePKCS7Padding,t=void 0===r||r;if(this.logEnabled=!0,this.observer=void 0,this.config=void 0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.observer=y,this.config=T,this.removePKCS7Padding=t,t)try{var d=self.crypto;d&&(this.subtle=d.subtle||d.webkitSubtle)}catch(c){}null===this.subtle&&(this.config.enableSoftwareAES=!0)}var L=g.prototype;return L.destroy=function(){this.observer=null},L.isSync=function(){return this.config.enableSoftwareAES},L.flush=function(){var T=this.currentResult;if(T){var p=new Uint8Array(T);return this.reset(),this.removePKCS7Padding?(0,D.removePadding)(p):p}this.reset()},L.reset=function(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)},L.decrypt=function(T,p,f,r){if(this.config.enableSoftwareAES){this.softwareDecrypt(new Uint8Array(T),p,f);var t=this.flush();t&&r(t.buffer)}else this.webCryptoDecrypt(new Uint8Array(T),p,f).then(r)},L.softwareDecrypt=function(T,p,f){var r=this.currentIV,t=this.currentResult,d=this.remainderData;this.logOnce("JS AES decrypt"),d&&(T=(0,I.appendUint8Array)(d,T),this.remainderData=null);var c=this.getValidChunk(T);if(!c.length)return null;r&&(f=r);var n=this.softwareDecrypter;n||(n=this.softwareDecrypter=new D.default),n.expandKey(p);var i=t;return this.currentResult=n.decrypt(c.buffer,0,f),this.currentIV=(0,P.sliceUint8)(c,-16).buffer,i||null},L.webCryptoDecrypt=function(T,p,f){var r=this,t=this.subtle;return(this.key!==p||!this.fastAesKey)&&(this.key=p,this.fastAesKey=new R.default(t,p)),this.fastAesKey.expandKey().then(function(d){return t?new b.default(t,f).decrypt(T.buffer,d):Promise.reject(new Error("web crypto not initialized"))}).catch(function(d){return r.onWebCryptoError(d,T,p,f)})},L.onWebCryptoError=function(T,p,f,r){return _.logger.warn("[decrypter.ts]: WebCrypto Error, disable WebCrypto API:",T),this.config.enableSoftwareAES=!0,this.logEnabled=!0,this.softwareDecrypt(p,f,r)},L.getValidChunk=function(T){var p=T,f=T.length-T.length%16;return f!==T.length&&(p=(0,P.sliceUint8)(T,0,f),this.remainderData=(0,P.sliceUint8)(T,f)),p},L.logOnce=function(T){!this.logEnabled||(_.logger.log("[decrypter.ts]: "+T),this.logEnabled=!1)},g}()},"./src/crypt/fast-aes-key.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>b});var b=function(){function R(_,I){this.subtle=void 0,this.key=void 0,this.subtle=_,this.key=I}return R.prototype.expandKey=function(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])},R}()},"./src/demux/aacdemuxer.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>S});var b=A("./src/demux/base-audio-demuxer.ts"),R=A("./src/demux/adts.ts"),D=A("./src/utils/logger.ts"),_=A("./src/demux/id3.ts");function P(g,L){return(P=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(T,p){return T.__proto__=p,T})(g,L)}const S=function(g){function L(T,p){var f;return(f=g.call(this)||this).observer=void 0,f.config=void 0,f.observer=T,f.config=p,f}!function I(g,L){g.prototype=Object.create(L.prototype),g.prototype.constructor=g,P(g,L)}(L,g);var y=L.prototype;return y.resetInitSegment=function(p,f,r,t){g.prototype.resetInitSegment.call(this,p,f,r,t),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:f,duration:t,inputTimeScale:9e4,dropped:0}},L.probe=function(p){if(!p)return!1;for(var r=(_.getID3Data(p,0)||[]).length,t=p.length;r<t;r++)if(R.probe(p,r))return D.logger.log("ADTS sync word found !"),!0;return!1},y.canParse=function(p,f){return R.canParse(p,f)},y.appendFrame=function(p,f,r){R.initTrackConfig(p,this.observer,f,r,p.manifestCodec);var t=R.appendFrame(p,f,r,this.basePTS,this.frameIndex);if(t&&0===t.missing)return t},L}(b.default)},"./src/demux/adts.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{appendFrame:()=>r,canGetFrameLength:()=>S,canParse:()=>L,getAudioConfig:()=>_,getFrameDuration:()=>p,getFullFrameLength:()=>x,getHeaderLength:()=>P,initTrackConfig:()=>T,isHeader:()=>g,isHeaderPattern:()=>I,parseFrameHeader:()=>f,probe:()=>y});var b=A("./src/utils/logger.ts"),R=A("./src/errors.ts"),D=A("./src/events.ts");function _(t,d,c,n){var i,l,o,e,v=navigator.userAgent.toLowerCase(),s=n,h=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];i=1+((192&d[c+2])>>>6);var u=(60&d[c+2])>>>2;if(!(u>h.length-1))return o=(1&d[c+2])<<2,o|=(192&d[c+3])>>>6,b.logger.log("manifest codec:"+n+", ADTS type:"+i+", samplingIndex:"+u),/firefox/i.test(v)?u>=6?(i=5,e=new Array(4),l=u-3):(i=2,e=new Array(2),l=u):-1!==v.indexOf("android")?(i=2,e=new Array(2),l=u):(i=5,e=new Array(4),n&&(-1!==n.indexOf("mp4a.40.29")||-1!==n.indexOf("mp4a.40.5"))||!n&&u>=6?l=u-3:((n&&-1!==n.indexOf("mp4a.40.2")&&(u>=6&&1===o||/vivaldi/i.test(v))||!n&&1===o)&&(i=2,e=new Array(2)),l=u)),e[0]=i<<3,e[0]|=(14&u)>>1,e[1]|=(1&u)<<7,e[1]|=o<<3,5===i&&(e[1]|=(14&l)>>1,e[2]=(1&l)<<7,e[2]|=8,e[3]=0),{config:e,samplerate:h[u],channelCount:o,codec:"mp4a.40."+i,manifestCodec:s};t.trigger(D.Events.ERROR,{type:R.ErrorTypes.MEDIA_ERROR,details:R.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ADTS sampling index:"+u})}function I(t,d){return 255===t[d]&&240==(246&t[d+1])}function P(t,d){return 1&t[d+1]?7:9}function x(t,d){return(3&t[d+3])<<11|t[d+4]<<3|(224&t[d+5])>>>5}function S(t,d){return d+5<t.length}function g(t,d){return d+1<t.length&&I(t,d)}function L(t,d){return S(t,d)&&I(t,d)&&x(t,d)<=t.length-d}function y(t,d){if(g(t,d)){var c=P(t,d);if(d+c>=t.length)return!1;var n=x(t,d);if(n<=c)return!1;var i=d+n;return i===t.length||g(t,i)}return!1}function T(t,d,c,n,i){if(!t.samplerate){var l=_(d,c,n,i);if(!l)return;t.config=l.config,t.samplerate=l.samplerate,t.channelCount=l.channelCount,t.codec=l.codec,t.manifestCodec=l.manifestCodec,b.logger.log("parsed codec:"+t.codec+", rate:"+l.samplerate+", channels:"+l.channelCount)}}function p(t){return 9216e4/t}function f(t,d){var c=P(t,d);if(d+c<=t.length){var n=x(t,d)-c;if(n>0)return{headerLength:c,frameLength:n}}}function r(t,d,c,n,i){var v,o=n+i*p(t.samplerate),e=f(d,c);if(e){var h=e.headerLength,u=h+e.frameLength,a=Math.max(0,c+u-d.length);a?(v=new Uint8Array(u-h)).set(d.subarray(c+h,d.length),0):v=d.subarray(c+h,c+u);var m={unit:v,pts:o};return a||t.samples.push(m),{sample:m,length:u,missing:a}}var E=d.length-c;return(v=new Uint8Array(E)).set(d.subarray(c,d.length),0),{sample:{unit:v,pts:o},length:E,missing:-1}}},"./src/demux/base-audio-demuxer.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>g,initPTSFn:()=>S});var b=A("./src/polyfills/number.ts"),R=A("./src/demux/id3.ts"),D=A("./src/types/demuxer.ts"),_=A("./src/demux/dummy-demuxed-track.ts"),I=A("./src/utils/mp4-tools.ts"),P=A("./src/utils/typed-array.ts"),x=function(){function L(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}var y=L.prototype;return y.resetInitSegment=function(p,f,r,t){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}},y.resetTimeStamp=function(p){this.initPTS=p,this.resetContiguity()},y.resetContiguity=function(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0},y.canParse=function(p,f){return!1},y.appendFrame=function(p,f,r){},y.demux=function(p,f){this.cachedData&&(p=(0,I.appendUint8Array)(this.cachedData,p),this.cachedData=null);var d,r=R.getID3Data(p,0),t=r?r.length:0,c=this._audioTrack,n=this._id3Track,i=r?R.getTimeStamp(r):void 0,l=p.length;for((null===this.basePTS||0===this.frameIndex&&(0,b.isFiniteNumber)(i))&&(this.basePTS=S(i,f,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),r&&r.length>0&&n.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:D.MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY});t<l;){if(this.canParse(p,t)){var o=this.appendFrame(c,p,t);o?(this.frameIndex++,this.lastPTS=o.sample.pts,d=t+=o.length):t=l}else R.canParse(p,t)?(r=R.getID3Data(p,t),n.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:D.MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY}),d=t+=r.length):t++;if(t===l&&d!==l){var e=(0,P.sliceUint8)(p,d);this.cachedData=this.cachedData?(0,I.appendUint8Array)(this.cachedData,e):e}}return{audioTrack:c,videoTrack:(0,_.dummyTrack)(),id3Track:n,textTrack:(0,_.dummyTrack)()}},y.demuxSampleAes=function(p,f,r){return Promise.reject(new Error("["+this+"] This demuxer does not support Sample-AES decryption"))},y.flush=function(p){var f=this.cachedData;return f&&(this.cachedData=null,this.demux(f,0)),{audioTrack:this._audioTrack,videoTrack:(0,_.dummyTrack)(),id3Track:this._id3Track,textTrack:(0,_.dummyTrack)()}},y.destroy=function(){},L}(),S=function(y,T,p){return(0,b.isFiniteNumber)(y)?90*y:9e4*T+(p||0)};const g=x},"./src/demux/chunk-cache.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>b});var b=function(){function D(){this.chunks=[],this.dataLength=0}var _=D.prototype;return _.push=function(P){this.chunks.push(P),this.dataLength+=P.length},_.flush=function(){var S,P=this.chunks;return P.length?(S=1===P.length?P[0]:function R(D,_){for(var I=new Uint8Array(_),P=0,x=0;x<D.length;x++){var S=D[x];I.set(S,P),P+=S.length}return I}(P,this.dataLength),this.reset(),S):new Uint8Array(0)},_.reset=function(){this.chunks.length=0,this.dataLength=0},D}()},"./src/demux/dummy-demuxed-track.ts":(W,B,A)=>{"use strict";function b(R,D){return void 0===R&&(R=""),void 0===D&&(D=9e4),{type:R,id:-1,pid:-1,inputTimeScale:D,sequenceNumber:-1,samples:[],dropped:0}}A.r(B),A.d(B,{dummyTrack:()=>b})},"./src/demux/exp-golomb.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>D});var b=A("./src/utils/logger.ts");const D=function(){function _(P){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=P,this.bytesAvailable=P.byteLength,this.word=0,this.bitsAvailable=0}var I=_.prototype;return I.loadWord=function(){var x=this.data,S=this.bytesAvailable,g=x.byteLength-S,L=new Uint8Array(4),y=Math.min(4,S);if(0===y)throw new Error("no bytes available");L.set(x.subarray(g,g+y)),this.word=new DataView(L.buffer).getUint32(0),this.bitsAvailable=8*y,this.bytesAvailable-=y},I.skipBits=function(x){var S;this.bitsAvailable>x?(this.word<<=x,this.bitsAvailable-=x):(x-=this.bitsAvailable,x-=(S=x>>3)>>3,this.bytesAvailable-=S,this.loadWord(),this.word<<=x,this.bitsAvailable-=x)},I.readBits=function(x){var S=Math.min(this.bitsAvailable,x),g=this.word>>>32-S;return x>32&&b.logger.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=S,this.bitsAvailable>0?this.word<<=S:this.bytesAvailable>0&&this.loadWord(),(S=x-S)>0&&this.bitsAvailable?g<<S|this.readBits(S):g},I.skipLZ=function(){var x;for(x=0;x<this.bitsAvailable;++x)if(0!=(this.word&2147483648>>>x))return this.word<<=x,this.bitsAvailable-=x,x;return this.loadWord(),x+this.skipLZ()},I.skipUEG=function(){this.skipBits(1+this.skipLZ())},I.skipEG=function(){this.skipBits(1+this.skipLZ())},I.readUEG=function(){var x=this.skipLZ();return this.readBits(x+1)-1},I.readEG=function(){var x=this.readUEG();return 1&x?1+x>>>1:-1*(x>>>1)},I.readBoolean=function(){return 1===this.readBits(1)},I.readUByte=function(){return this.readBits(8)},I.readUShort=function(){return this.readBits(16)},I.readUInt=function(){return this.readBits(32)},I.skipScalingList=function(x){for(var S=8,g=8,y=0;y<x;y++)0!==g&&(g=(S+this.readEG()+256)%256),S=0===g?S:g},I.readSPS=function(){var y,T,p,x=0,S=0,g=0,L=0,f=this.readUByte.bind(this),r=this.readBits.bind(this),t=this.readUEG.bind(this),d=this.readBoolean.bind(this),c=this.skipBits.bind(this),n=this.skipEG.bind(this),i=this.skipUEG.bind(this),l=this.skipScalingList.bind(this);f();var o=f();if(r(5),c(3),f(),i(),100===o||110===o||122===o||244===o||44===o||83===o||86===o||118===o||128===o){var e=t();if(3===e&&c(1),i(),i(),c(1),d())for(T=3!==e?8:12,p=0;p<T;p++)d()&&l(p<6?16:64)}i();var v=t();if(0===v)t();else if(1===v)for(c(1),n(),n(),y=t(),p=0;p<y;p++)n();i(),c(1);var s=t(),h=t(),u=r(1);0===u&&c(1),c(1),d()&&(x=t(),S=t(),g=t(),L=t());var a=[1,1];if(d()&&d())switch(f()){case 1:a=[1,1];break;case 2:a=[12,11];break;case 3:a=[10,11];break;case 4:a=[16,11];break;case 5:a=[40,33];break;case 6:a=[24,11];break;case 7:a=[20,11];break;case 8:a=[32,11];break;case 9:a=[80,33];break;case 10:a=[18,11];break;case 11:a=[15,11];break;case 12:a=[64,33];break;case 13:a=[160,99];break;case 14:a=[4,3];break;case 15:a=[3,2];break;case 16:a=[2,1];break;case 255:a=[f()<<8|f(),f()<<8|f()]}return{width:Math.ceil(16*(s+1)-2*x-2*S),height:(2-u)*(h+1)*16-(u?2:4)*(g+L),pixelRatio:a}},I.readSliceType=function(){return this.readUByte(),this.readUEG(),this.readUEG()},_}()},"./src/demux/id3.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{canParse:()=>I,decodeFrame:()=>L,getID3Data:()=>D,getID3Frames:()=>g,getTimeStamp:()=>P,isFooter:()=>R,isHeader:()=>b,isTimeStampFrame:()=>x,testables:()=>t,utf8ArrayToStr:()=>r});var d,b=function(i,l){return l+10<=i.length&&73===i[l]&&68===i[l+1]&&51===i[l+2]&&i[l+3]<255&&i[l+4]<255&&i[l+6]<128&&i[l+7]<128&&i[l+8]<128&&i[l+9]<128},R=function(i,l){return l+10<=i.length&&51===i[l]&&68===i[l+1]&&73===i[l+2]&&i[l+3]<255&&i[l+4]<255&&i[l+6]<128&&i[l+7]<128&&i[l+8]<128&&i[l+9]<128},D=function(i,l){for(var o=l,e=0;b(i,l);)e+=10,e+=_(i,l+6),R(i,l+10)&&(e+=10),l+=e;if(e>0)return i.subarray(o,o+e)},_=function(i,l){var o=0;return o=(127&i[l])<<21,o|=(127&i[l+1])<<14,(o|=(127&i[l+2])<<7)|127&i[l+3]},I=function(i,l){return b(i,l)&&_(i,l+6)+10<=i.length-l},P=function(i){for(var l=g(i),o=0;o<l.length;o++){var e=l[o];if(x(e))return f(e)}},x=function(i){return i&&"PRIV"===i.key&&"com.apple.streaming.transportStreamTimestamp"===i.info},S=function(i){var l=String.fromCharCode(i[0],i[1],i[2],i[3]),o=_(i,4);return{type:l,size:o,data:i.subarray(10,10+o)}},g=function(i){for(var l=0,o=[];b(i,l);){for(var e=_(i,l+6),v=(l+=10)+e;l+8<v;){var s=S(i.subarray(l)),h=L(s);h&&o.push(h),l+=s.size+10}R(i,l)&&(l+=10)}return o},L=function(i){return"PRIV"===i.type?y(i):"W"===i.type[0]?p(i):T(i)},y=function(i){if(!(i.size<2)){var l=r(i.data,!0),o=new Uint8Array(i.data.subarray(l.length+1));return{key:i.type,info:l,data:o.buffer}}},T=function(i){if(!(i.size<2)){if("TXXX"===i.type){var l=1,o=r(i.data.subarray(l),!0),e=r(i.data.subarray(l+=o.length+1));return{key:i.type,info:o,data:e}}var v=r(i.data.subarray(1));return{key:i.type,data:v}}},p=function(i){if("WXXX"===i.type){if(i.size<2)return;var l=1,o=r(i.data.subarray(l),!0),e=r(i.data.subarray(l+=o.length+1));return{key:i.type,info:o,data:e}}var v=r(i.data);return{key:i.type,data:v}},f=function(i){if(8===i.data.byteLength){var l=new Uint8Array(i.data),e=(l[4]<<23)+(l[5]<<15)+(l[6]<<7)+l[7];return e/=45,1&l[3]&&(e+=47721858.84),Math.round(e)}},r=function(i,l){void 0===l&&(l=!1);var o=function c(){return!d&&void 0!==self.TextDecoder&&(d=new self.TextDecoder("utf-8")),d}();if(o){var e=o.decode(i);if(l){var v=e.indexOf("\0");return-1!==v?e.substring(0,v):e}return e.replace(/\0/g,"")}for(var h,u,a,s=i.length,m="",E=0;E<s;){if(0===(h=i[E++])&&l)return m;if(0!==h&&3!==h)switch(h>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:m+=String.fromCharCode(h);break;case 12:case 13:u=i[E++],m+=String.fromCharCode((31&h)<<6|63&u);break;case 14:u=i[E++],a=i[E++],m+=String.fromCharCode((15&h)<<12|(63&u)<<6|(63&a)<<0)}}return m},t={decodeTextFrame:T}},"./src/demux/mp3demuxer.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>S});var b=A("./src/demux/base-audio-demuxer.ts"),R=A("./src/demux/id3.ts"),D=A("./src/utils/logger.ts"),_=A("./src/demux/mpegaudio.ts");function P(g,L){return(P=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(T,p){return T.__proto__=p,T})(g,L)}var x=function(g){function L(){return g.apply(this,arguments)||this}!function I(g,L){g.prototype=Object.create(L.prototype),g.prototype.constructor=g,P(g,L)}(L,g);var y=L.prototype;return y.resetInitSegment=function(p,f,r,t){g.prototype.resetInitSegment.call(this,p,f,r,t),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:f,duration:t,inputTimeScale:9e4,dropped:0}},L.probe=function(p){if(!p)return!1;for(var r=(R.getID3Data(p,0)||[]).length,t=p.length;r<t;r++)if(_.probe(p,r))return D.logger.log("MPEG Audio sync word found !"),!0;return!1},y.canParse=function(p,f){return _.canParse(p,f)},y.appendFrame=function(p,f,r){if(null!==this.basePTS)return _.appendFrame(p,f,r,this.basePTS,this.frameIndex)},L}(b.default);const S=x},"./src/demux/mp4demuxer.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>x});var b=A("./src/polyfills/number.ts"),R=A("./src/types/demuxer.ts"),D=A("./src/utils/mp4-tools.ts"),_=A("./src/demux/dummy-demuxed-track.ts"),I=/\/emsg[-/]ID3/i;const x=function(){function S(L,y){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=y}var g=S.prototype;return g.resetTimeStamp=function(){},g.resetInitSegment=function(y,T,p,f){var r=(0,D.parseInitSegment)(y),t=this.videoTrack=(0,_.dummyTrack)("video",1),d=this.audioTrack=(0,_.dummyTrack)("audio",1),c=this.txtTrack=(0,_.dummyTrack)("text",1);if(this.id3Track=(0,_.dummyTrack)("id3",1),this.timeOffset=0,r.video){var n=r.video,l=n.timescale,o=n.codec;t.id=n.id,t.timescale=c.timescale=l,t.codec=o}if(r.audio){var e=r.audio,s=e.timescale,h=e.codec;d.id=e.id,d.timescale=s,d.codec=h}c.id=D.RemuxerTrackIdConfig.text,t.sampleDuration=0,t.duration=d.duration=f},g.resetContiguity=function(){},S.probe=function(y){return y=y.length>16384?y.subarray(0,16384):y,(0,D.findBox)(y,["moof"]).length>0},g.demux=function(y,T){this.timeOffset=T;var p=y,f=this.videoTrack,r=this.txtTrack;if(this.config.progressive){this.remainderData&&(p=(0,D.appendUint8Array)(this.remainderData,y));var t=(0,D.segmentValidRange)(p);this.remainderData=t.remainder,f.samples=t.valid||new Uint8Array}else f.samples=p;var d=this.extractID3Track(f,T);return r.samples=(0,D.parseSamples)(T,f),{videoTrack:f,audioTrack:this.audioTrack,id3Track:d,textTrack:this.txtTrack}},g.flush=function(){var y=this.timeOffset,T=this.videoTrack,p=this.txtTrack;T.samples=this.remainderData||new Uint8Array,this.remainderData=null;var f=this.extractID3Track(T,this.timeOffset);return p.samples=(0,D.parseSamples)(y,T),{videoTrack:T,audioTrack:(0,_.dummyTrack)(),id3Track:f,textTrack:(0,_.dummyTrack)()}},g.extractID3Track=function(y,T){var p=this.id3Track;if(y.samples.length){var f=(0,D.findBox)(y.samples,["emsg"]);f&&f.forEach(function(r){var t=(0,D.parseEmsg)(r);if(I.test(t.schemeIdUri)){var d=(0,b.isFiniteNumber)(t.presentationTime)?t.presentationTime/t.timeScale:T+t.presentationTimeDelta/t.timeScale,c=4294967295===t.eventDuration?Number.POSITIVE_INFINITY:t.eventDuration/t.timeScale;c<=.001&&(c=Number.POSITIVE_INFINITY);var n=t.payload;p.samples.push({data:n,len:n.byteLength,dts:d,pts:d,type:R.MetadataSchema.emsg,duration:c})}})}return p},g.demuxSampleAes=function(y,T,p){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))},g.destroy=function(){},S}()},"./src/demux/mpegaudio.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{appendFrame:()=>P,canParse:()=>L,isHeader:()=>g,isHeaderPattern:()=>S,parseHeader:()=>x,probe:()=>y});var b=null,R=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],D=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],_=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],I=[0,1,1,4];function P(T,p,f,r,t){if(!(f+24>p.length)){var d=x(p,f);if(d&&f+d.frameLength<=p.length){var n=r+t*(9e4*d.samplesPerFrame/d.sampleRate),i={unit:p.subarray(f,f+d.frameLength),pts:n,dts:n};return T.config=[],T.channelCount=d.channelCount,T.samplerate=d.sampleRate,T.samples.push(i),{sample:i,length:d.frameLength,missing:0}}}}function x(T,p){var f=T[p+1]>>3&3,r=T[p+1]>>1&3,t=T[p+2]>>4&15,d=T[p+2]>>2&3;if(1!==f&&0!==t&&15!==t&&3!==d){var n=T[p+3]>>6,l=1e3*R[14*(3===f?3-r:3===r?3:4)+t-1],e=D[3*(3===f?0:2===f?1:2)+d],v=3===n?1:2,s=_[f][r],h=I[r],u=8*s*h,a=Math.floor(s*l/e+(T[p+2]>>1&1))*h;if(null===b){var E=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);b=E?parseInt(E[1]):0}return!!b&&b<=87&&2===r&&l>=224e3&&0===n&&(T[p+3]=128|T[p+3]),{sampleRate:e,channelCount:v,frameLength:a,samplesPerFrame:u}}}function S(T,p){return 255===T[p]&&224==(224&T[p+1])&&0!=(6&T[p+1])}function g(T,p){return p+1<T.length&&S(T,p)}function L(T,p){return S(T,p)&&4<=T.length-p}function y(T,p){if(p+1<T.length&&S(T,p)){var r=x(T,p),t=4;null!=r&&r.frameLength&&(t=r.frameLength);var d=p+t;return d===T.length||g(T,d)}return!1}},"./src/demux/sample-aes.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>_});var b=A("./src/crypt/decrypter.ts"),R=A("./src/utils/mp4-tools.ts");const _=function(){function I(x,S,g){this.keyData=void 0,this.decrypter=void 0,this.keyData=g,this.decrypter=new b.default(x,S,{removePKCS7Padding:!1})}var P=I.prototype;return P.decryptBuffer=function(S,g){this.decrypter.decrypt(S,this.keyData.key.buffer,this.keyData.iv.buffer,g)},P.decryptAacSample=function(S,g,L,y){var T=S[g].unit;if(!(T.length<=16)){var p=T.subarray(16,T.length-T.length%16),f=p.buffer.slice(p.byteOffset,p.byteOffset+p.length),r=this;this.decryptBuffer(f,function(t){var d=new Uint8Array(t);T.set(d,16),y||r.decryptAacSamples(S,g+1,L)})}},P.decryptAacSamples=function(S,g,L){for(;;g++){if(g>=S.length)return void L();if(!(S[g].unit.length<32)){var y=this.decrypter.isSync();if(this.decryptAacSample(S,g,L,y),!y)return}}},P.getAvcEncryptedData=function(S){for(var g=16*Math.floor((S.length-48)/160)+16,L=new Int8Array(g),y=0,T=32;T<S.length-16;T+=160,y+=16)L.set(S.subarray(T,T+16),y);return L},P.getAvcDecryptedUnit=function(S,g){for(var L=new Uint8Array(g),y=0,T=32;T<S.length-16;T+=160,y+=16)S.set(L.subarray(y,y+16),T);return S},P.decryptAvcSample=function(S,g,L,y,T,p){var f=(0,R.discardEPB)(T.data),r=this.getAvcEncryptedData(f),t=this;this.decryptBuffer(r.buffer,function(d){T.data=t.getAvcDecryptedUnit(f,d),p||t.decryptAvcSamples(S,g,L+1,y)})},P.decryptAvcSamples=function(S,g,L,y){if(S instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;g++,L=0){if(g>=S.length)return void y();for(var T=S[g].units;!(L>=T.length);L++){var p=T[L];if(!(p.data.length<=48||1!==p.type&&5!==p.type)){var f=this.decrypter.isSync();if(this.decryptAvcSample(S,g,L,y,p,f),!f)return}}}},I}()},"./src/demux/transmuxer-interface.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>L});var b=A("./src/demux/webworkify-webpack.js"),R=A("./src/events.ts"),D=A("./src/demux/transmuxer.ts"),_=A("./src/utils/logger.ts"),I=A("./src/errors.ts"),P=A("./src/utils/mediasource-helper.ts"),x=A("./node_modules/eventemitter3/index.js"),g=(0,P.getMediaSource)()||{isTypeSupported:function(){return!1}},L=function(){function y(p,f,r,t){var d=this;this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.worker=void 0,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;var c=p.config;this.hls=p,this.id=f,this.useWorker=!!c.enableWorker,this.onTransmuxComplete=r,this.onFlush=t;var n=function(v,s){(s=s||{}).frag=d.frag,s.id=d.id,d.hls.trigger(v,s)};this.observer=new x.EventEmitter,this.observer.on(R.Events.FRAG_DECRYPTED,n),this.observer.on(R.Events.ERROR,n);var i={mp4:g.isTypeSupported("video/mp4"),mpeg:g.isTypeSupported("audio/mpeg"),mp3:g.isTypeSupported('audio/mp4; codecs="mp3"')},l=navigator.vendor;if(this.useWorker&&"undefined"!=typeof Worker){var o;_.logger.log("demuxing in webworker");try{o=this.worker=(0,b.default)("./src/demux/transmuxer-worker.ts"),this.onwmsg=this.onWorkerMessage.bind(this),o.addEventListener("message",this.onwmsg),o.onerror=function(e){d.useWorker=!1,_.logger.warn("Exception in webworker, fallback to inline"),d.hls.trigger(R.Events.ERROR,{type:I.ErrorTypes.OTHER_ERROR,details:I.ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:new Error(e.message+"  ("+e.filename+":"+e.lineno+")")})},o.postMessage({cmd:"init",typeSupported:i,vendor:l,id:f,config:JSON.stringify(c)})}catch(e){_.logger.warn("Error in worker:",e),_.logger.error("Error while initializing DemuxerWorker, fallback to inline"),o&&self.URL.revokeObjectURL(o.objectURL),this.transmuxer=new D.default(this.observer,i,c,l,f),this.worker=null}}else this.transmuxer=new D.default(this.observer,i,c,l,f)}var T=y.prototype;return T.destroy=function(){var f=this.worker;if(f)f.removeEventListener("message",this.onwmsg),f.terminate(),this.worker=null,this.onwmsg=void 0;else{var r=this.transmuxer;r&&(r.destroy(),this.transmuxer=null)}var t=this.observer;t&&t.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null},T.push=function(f,r,t,d,c,n,i,l,o,e){var v,s,h=this;o.transmuxing.start=self.performance.now();var u=this.transmuxer,a=this.worker,m=n?n.start:c.start,E=c.decryptdata,O=this.frag,M=!(O&&c.cc===O.cc),C=!(O&&o.level===O.level),F=O?o.sn-O.sn:-1,U=this.part?o.part-this.part.index:-1,N=!C&&(1===F||0===F&&(1===U||0===F&&o.id>1&&o.id===(null==O?void 0:O.stats.chunkCount)&&U<=0)),w=self.performance.now();(C||F||0===c.stats.parsing.start)&&(c.stats.parsing.start=w),n&&(U||!N)&&(n.stats.parsing.start=w);var K=!(O&&(null===(v=c.initSegment)||void 0===v?void 0:v.url)===(null===(s=O.initSegment)||void 0===s?void 0:s.url)),G=new D.TransmuxState(M,N,l,C,m,K);if(!N||M||K){_.logger.log("[transmuxer-interface, "+c.type+"]: Starting new transmux session for sn: "+o.sn+" p: "+o.part+" level: "+o.level+" id: "+o.id+"\n        discontinuity: "+M+"\n        trackSwitch: "+C+"\n        contiguous: "+N+"\n        accurateTimeOffset: "+l+"\n        timeOffset: "+m+"\n        initSegmentChange: "+K);var H=new D.TransmuxConfig(t,d,r,i,e);this.configureTransmuxer(H)}if(this.frag=c,this.part=n,a)a.postMessage({cmd:"demux",data:f,decryptdata:E,chunkMeta:o,state:G},f instanceof ArrayBuffer?[f]:[]);else if(u){var V=u.push(f,E,o,G);(0,D.isPromise)(V)?V.then(function(X){h.handleTransmuxComplete(X)}):this.handleTransmuxComplete(V)}},T.flush=function(f){var r=this;f.transmuxing.start=self.performance.now();var t=this.transmuxer,d=this.worker;if(d)d.postMessage({cmd:"flush",chunkMeta:f});else if(t){var c=t.flush(f);(0,D.isPromise)(c)?c.then(function(n){r.handleFlushResult(n,f)}):this.handleFlushResult(c,f)}},T.handleFlushResult=function(f,r){var t=this;f.forEach(function(d){t.handleTransmuxComplete(d)}),this.onFlush(r)},T.onWorkerMessage=function(f){var r=f.data,t=this.hls;switch(r.event){case"init":self.URL.revokeObjectURL(this.worker.objectURL);break;case"transmuxComplete":this.handleTransmuxComplete(r.data);break;case"flush":this.onFlush(r.data);break;case"workerLog":_.logger[r.data.logType]&&_.logger[r.data.logType](r.data.message);break;default:r.data=r.data||{},r.data.frag=this.frag,r.data.id=this.id,t.trigger(r.event,r.data)}},T.configureTransmuxer=function(f){var r=this.worker,t=this.transmuxer;r?r.postMessage({cmd:"configure",config:f}):t&&t.configure(f)},T.handleTransmuxComplete=function(f){f.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(f)},y}()},"./src/demux/transmuxer-worker.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>P});var b=A("./src/demux/transmuxer.ts"),R=A("./src/events.ts"),D=A("./src/utils/logger.ts"),_=A("./node_modules/eventemitter3/index.js");function P(y){var T=new _.EventEmitter,p=function(t,d){y.postMessage({event:t,data:d})};T.on(R.Events.FRAG_DECRYPTED,p),T.on(R.Events.ERROR,p),y.addEventListener("message",function(r){var t=r.data;switch(t.cmd){case"init":var d=JSON.parse(t.config);y.transmuxer=new b.default(T,t.typeSupported,d,t.vendor,t.id),(0,D.enableLogs)(d.debug,t.id),function(){var t=function(n){D.logger[n]=function(o){p("workerLog",{logType:n,message:o})}};for(var d in D.logger)t(d)}(),p("init",null);break;case"configure":y.transmuxer.configure(t.config);break;case"demux":var c=y.transmuxer.push(t.data,t.decryptdata,t.chunkMeta,t.state);(0,b.isPromise)(c)?c.then(function(l){x(y,l)}):x(y,c);break;case"flush":var n=t.chunkMeta,i=y.transmuxer.flush(n);(0,b.isPromise)(i)?i.then(function(l){g(y,l,n)}):g(y,i,n)}})}function x(y,T){if(function L(y){return!(y.audio||y.video||y.text||y.id3||y.initSegment)}(T.remuxResult))return!1;var p=[],f=T.remuxResult,r=f.audio,t=f.video;return r&&S(p,r),t&&S(p,t),y.postMessage({event:"transmuxComplete",data:T},p),!0}function S(y,T){T.data1&&y.push(T.data1.buffer),T.data2&&y.push(T.data2.buffer)}function g(y,T,p){T.reduce(function(r,t){return x(y,t)||r},!1)||y.postMessage({event:"transmuxComplete",data:T[0]}),y.postMessage({event:"flush",data:p})}},"./src/demux/transmuxer.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{TransmuxConfig:()=>d,TransmuxState:()=>c,default:()=>p,isPromise:()=>t});var y,b=A("./src/events.ts"),R=A("./src/errors.ts"),D=A("./src/crypt/decrypter.ts"),_=A("./src/demux/aacdemuxer.ts"),I=A("./src/demux/mp4demuxer.ts"),P=A("./src/demux/tsdemuxer.ts"),x=A("./src/demux/mp3demuxer.ts"),S=A("./src/remux/mp4-remuxer.ts"),g=A("./src/remux/passthrough-remuxer.ts"),L=A("./src/utils/logger.ts");try{y=self.performance.now.bind(self.performance)}catch(n){L.logger.debug("Unable to use Performance API on this environment"),y=self.Date.now}var T=[{demux:P.default,remux:S.default},{demux:I.default,remux:g.default},{demux:_.default,remux:S.default},{demux:x.default,remux:S.default}],p=function(){function n(l,o,e,v,s){this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=l,this.typeSupported=o,this.config=e,this.vendor=v,this.id=s}var i=n.prototype;return i.configure=function(o){this.transmuxConfig=o,this.decrypter&&this.decrypter.reset()},i.push=function(o,e,v,s){var h=this,u=v.transmuxing;u.executeStart=y();var a=new Uint8Array(o),m=this.config,E=this.currentTransmuxState,O=this.transmuxConfig;s&&(this.currentTransmuxState=s);var M=s||E,C=M.contiguous,F=M.discontinuity,U=M.trackSwitch,k=M.accurateTimeOffset,N=M.timeOffset,w=M.initSegmentChange,H=O.defaultInitPts;(F||U||w)&&this.resetInitSegment(O.initSegmentData,O.audioCodec,O.videoCodec,O.duration),(F||w)&&this.resetInitialTimestamp(H),C||this.resetContiguity();var Y=function f(n,i){var l=null;return n.byteLength>0&&null!=i&&null!=i.key&&null!==i.iv&&null!=i.method&&(l=i),l}(a,e);if(Y&&"AES-128"===Y.method){var $=this.getDecrypter();if(!m.enableSoftwareAES)return this.decryptionPromise=$.webCryptoDecrypt(a,Y.key.buffer,Y.iv.buffer).then(function(q){var J=h.push(q,null,v);return h.decryptionPromise=null,J}),this.decryptionPromise;var Q=$.softwareDecrypt(a,Y.key.buffer,Y.iv.buffer);if(!Q)return u.executeEnd=y(),r(v);a=new Uint8Array(Q)}this.needsProbing(a,F,U)&&this.configureTransmuxer(a,O);var z=this.transmux(a,Y,N,k,v),j=this.currentTransmuxState;return j.contiguous=!0,j.discontinuity=!1,j.trackSwitch=!1,u.executeEnd=y(),z},i.flush=function(o){var e=this,v=o.transmuxing;v.executeStart=y();var s=this.decrypter,h=this.currentTransmuxState,u=this.decryptionPromise;if(u)return u.then(function(){return e.flush(o)});var a=[],m=h.timeOffset;if(s){var E=s.flush();E&&a.push(this.push(E,null,o))}var O=this.demuxer;if(!O||!this.remuxer)return this.observer.emit(b.Events.ERROR,b.Events.ERROR,{type:R.ErrorTypes.MEDIA_ERROR,details:R.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"no demux matching with content found"}),v.executeEnd=y(),[r(o)];var C=O.flush(m);return t(C)?C.then(function(F){return e.flushRemux(a,F,o),a}):(this.flushRemux(a,C,o),a)},i.flushRemux=function(o,e,v){var s=e.audioTrack,h=e.videoTrack,u=e.id3Track,a=e.textTrack,m=this.currentTransmuxState,E=m.accurateTimeOffset,O=m.timeOffset;L.logger.log("[transmuxer.ts]: Flushed fragment "+v.sn+(v.part>-1?" p: "+v.part:"")+" of level "+v.level);var M=this.remuxer.remux(s,h,u,a,O,E,!0,this.id);o.push({remuxResult:M,chunkMeta:v}),v.transmuxing.executeEnd=y()},i.resetInitialTimestamp=function(o){var e=this.demuxer,v=this.remuxer;!e||!v||(e.resetTimeStamp(o),v.resetTimeStamp(o))},i.resetContiguity=function(){var o=this.demuxer,e=this.remuxer;!o||!e||(o.resetContiguity(),e.resetNextTimestamp())},i.resetInitSegment=function(o,e,v,s){var h=this.demuxer,u=this.remuxer;!h||!u||(h.resetInitSegment(o,e,v,s),u.resetInitSegment(o,e,v))},i.destroy=function(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)},i.transmux=function(o,e,v,s,h){return e&&"SAMPLE-AES"===e.method?this.transmuxSampleAes(o,e,v,s,h):this.transmuxUnencrypted(o,v,s,h)},i.transmuxUnencrypted=function(o,e,v,s){var h=this.demuxer.demux(o,e,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(h.audioTrack,h.videoTrack,h.id3Track,h.textTrack,e,v,!1,this.id),chunkMeta:s}},i.transmuxSampleAes=function(o,e,v,s,h){var u=this;return this.demuxer.demuxSampleAes(o,e,v).then(function(a){return{remuxResult:u.remuxer.remux(a.audioTrack,a.videoTrack,a.id3Track,a.textTrack,v,s,!1,u.id),chunkMeta:h}})},i.configureTransmuxer=function(o,e){for(var C,v=this.config,s=this.observer,h=this.typeSupported,u=this.vendor,a=e.audioCodec,m=e.defaultInitPts,E=e.duration,O=e.initSegmentData,M=e.videoCodec,F=0,U=T.length;F<U;F++)if(T[F].demux.probe(o)){C=T[F];break}C||(L.logger.warn("Failed to find demuxer by probing frag, treating as mp4 passthrough"),C={demux:I.default,remux:g.default});var k=this.demuxer,N=this.remuxer,w=C.remux,K=C.demux;(!N||!(N instanceof w))&&(this.remuxer=new w(s,v,h,u)),(!k||!(k instanceof K))&&(this.demuxer=new K(s,v,h),this.probe=K.probe),this.resetInitSegment(O,a,M,E),this.resetInitialTimestamp(m)},i.needsProbing=function(o,e,v){return!this.demuxer||!this.remuxer||e||v},i.getDecrypter=function(){var o=this.decrypter;return o||(o=this.decrypter=new D.default(this.observer,this.config)),o},n}(),r=function(i){return{remuxResult:{},chunkMeta:i}};function t(n){return"then"in n&&n.then instanceof Function}var d=function(i,l,o,e,v){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=i,this.videoCodec=l,this.initSegmentData=o,this.duration=e,this.defaultInitPts=v},c=function(i,l,o,e,v,s){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=i,this.contiguous=l,this.accurateTimeOffset=o,this.trackSwitch=e,this.timeOffset=v,this.initSegmentChange=s}},"./src/demux/tsdemuxer.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>c});var b=A("./src/demux/adts.ts"),R=A("./src/demux/mpegaudio.ts"),D=A("./src/demux/exp-golomb.ts"),_=A("./src/demux/sample-aes.ts"),I=A("./src/events.ts"),P=A("./src/utils/mp4-tools.ts"),x=A("./src/utils/logger.ts"),S=A("./src/errors.ts"),g=A("./src/types/demuxer.ts");function L(){return L=Object.assign?Object.assign.bind():function(n){for(var i=1;i<arguments.length;i++){var l=arguments[i];for(var o in l)Object.prototype.hasOwnProperty.call(l,o)&&(n[o]=l[o])}return n},L.apply(this,arguments)}var y=188;function p(n,i,l,o){return{key:n,frame:!1,pts:i,dts:l,units:[],debug:o,length:0}}function f(n,i){return(31&n[i+10])<<8|n[i+11]}function r(n,i,l,o){var e={audio:-1,avc:-1,id3:-1,segmentCodec:"aac"},s=i+3+((15&n[i+1])<<8|n[i+2])-4;for(i+=12+((15&n[i+10])<<8|n[i+11]);i<s;){var u=(31&n[i+1])<<8|n[i+2];switch(n[i]){case 207:if(!o){x.logger.log("ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:-1===e.audio&&(e.audio=u);break;case 21:-1===e.id3&&(e.id3=u);break;case 219:if(!o){x.logger.log("H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:-1===e.avc&&(e.avc=u);break;case 3:case 4:!0!==l.mpeg&&!0!==l.mp3?x.logger.log("MPEG audio found, not supported in this browser"):-1===e.audio&&(e.audio=u,e.segmentCodec="mp3");break;case 36:x.logger.warn("Unsupported HEVC stream type found")}i+=5+((15&n[i+3])<<8|n[i+4])}return e}function t(n){var l,o,e,v,s,i=0,h=n.data;if(!n||0===n.size)return null;for(;h[0].length<19&&h.length>1;){var u=new Uint8Array(h[0].length+h[1].length);u.set(h[0]),u.set(h[1],h[0].length),h[0]=u,h.splice(1,1)}if(1===((l=h[0])[0]<<16)+(l[1]<<8)+l[2]){if((o=(l[4]<<8)+l[5])&&o>n.size-6)return null;var m=l[7];192&m&&(v=536870912*(14&l[9])+4194304*(255&l[10])+16384*(254&l[11])+128*(255&l[12])+(254&l[13])/2,64&m?v-(s=536870912*(14&l[14])+4194304*(255&l[15])+16384*(254&l[16])+128*(255&l[17])+(254&l[18])/2)>54e5&&(x.logger.warn(Math.round((v-s)/9e4)+"s delta between PTS and DTS, align them"),v=s):s=v);var E=(e=l[8])+9;if(n.size<=E)return null;n.size-=E;for(var O=new Uint8Array(n.size),M=0,C=h.length;M<C;M++){var F=(l=h[M]).byteLength;if(E){if(E>F){E-=F;continue}l=l.subarray(E),F-=E,E=0}O.set(l,i),i+=F}return o&&(o-=e+3),{data:O,pts:v,dts:s,len:o}}return null}function d(n,i){if(n.units.length&&n.frame){if(void 0===n.pts){var l=i.samples,o=l.length;if(!o)return void i.dropped++;var e=l[o-1];n.pts=e.pts,n.dts=e.dts}i.samples.push(n)}n.debug.length&&x.logger.log(n.pts+"/"+n.dts+":"+n.debug)}const c=function(){function n(l,o,e){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._avcTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.observer=l,this.config=o,this.typeSupported=e}n.probe=function(o){var e=n.syncOffset(o);return e>0&&x.logger.warn("MPEG2-TS detected but first sync word found @ offset "+e),-1!==e},n.syncOffset=function(o){for(var e=Math.min(940,o.length-376)+1,v=0;v<e;){if(71===o[v]&&71===o[v+y])return v;v++}return-1},n.createTrack=function(o,e){return{container:"video"===o||"audio"===o?"video/mp2t":void 0,type:o,id:P.RemuxerTrackIdConfig[o],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===o?e:void 0}};var i=n.prototype;return i.resetInitSegment=function(o,e,v,s){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack=n.createTrack("video"),this._audioTrack=n.createTrack("audio",s),this._id3Track=n.createTrack("id3"),this._txtTrack=n.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.audioCodec=e,this.videoCodec=v,this._duration=s},i.resetTimeStamp=function(){},i.resetContiguity=function(){var o=this._audioTrack,e=this._avcTrack,v=this._id3Track;o&&(o.pesData=null),e&&(e.pesData=null),v&&(v.pesData=null),this.aacOverFlow=null,this.avcSample=null,this.remainderData=null},i.demux=function(o,e,v,s){void 0===v&&(v=!1),void 0===s&&(s=!1),v||(this.sampleAes=null);var h,u=this._avcTrack,a=this._audioTrack,m=this._id3Track,E=this._txtTrack,O=u.pid,M=u.pesData,C=a.pid,F=m.pid,U=a.pesData,k=m.pesData,N=null,w=this.pmtParsed,K=this._pmtId,G=o.length;if(this.remainderData&&(G=(o=(0,P.appendUint8Array)(this.remainderData,o)).length,this.remainderData=null),G<y&&!s)return this.remainderData=o,{audioTrack:a,videoTrack:u,id3Track:m,textTrack:E};var H=Math.max(0,n.syncOffset(o));(G-=(G-H)%y)<o.byteLength&&!s&&(this.remainderData=new Uint8Array(o.buffer,G,o.buffer.byteLength-G));for(var V=0,X=H;X<G;X+=y)if(71===o[X]){var Y=!!(64&o[X+1]),$=((31&o[X+1])<<8)+o[X+2],z=void 0;if((48&o[X+3])>>4>1){if((z=X+5+o[X+4])===X+y)continue}else z=X+4;switch($){case O:Y&&(M&&(h=t(M))&&this.parseAVCPES(u,E,h,!1),M={data:[],size:0}),M&&(M.data.push(o.subarray(z,X+y)),M.size+=X+y-z);break;case C:if(Y){if(U&&(h=t(U)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,h);break;case"mp3":this.parseMPEGPES(a,h)}U={data:[],size:0}}U&&(U.data.push(o.subarray(z,X+y)),U.size+=X+y-z);break;case F:Y&&(k&&(h=t(k))&&this.parseID3PES(m,h),k={data:[],size:0}),k&&(k.data.push(o.subarray(z,X+y)),k.size+=X+y-z);break;case 0:Y&&(z+=o[z]+1),K=this._pmtId=f(o,z);break;case K:Y&&(z+=o[z]+1);var j=r(o,z,this.typeSupported,v);(O=j.avc)>0&&(u.pid=O),(C=j.audio)>0&&(a.pid=C,a.segmentCodec=j.segmentCodec),(F=j.id3)>0&&(m.pid=F),null!==N&&!w&&(x.logger.log("unknown PID '"+N+"' in TS found"),N=null,X=H-188),w=this.pmtParsed=!0;break;case 17:case 8191:break;default:N=$}}else V++;V>0&&this.observer.emit(I.Events.ERROR,I.Events.ERROR,{type:S.ErrorTypes.MEDIA_ERROR,details:S.ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,reason:"Found "+V+" TS packet/s that do not start with 0x47"}),u.pesData=M,a.pesData=U,m.pesData=k;var q={audioTrack:a,videoTrack:u,id3Track:m,textTrack:E};return s&&this.extractRemainingSamples(q),q},i.flush=function(){var e,o=this.remainderData;return this.remainderData=null,e=o?this.demux(o,-1,!1,!0):{videoTrack:this._avcTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(e),this.sampleAes?this.decrypt(e,this.sampleAes):e},i.extractRemainingSamples=function(o){var E,e=o.audioTrack,v=o.videoTrack,s=o.id3Track,h=o.textTrack,u=v.pesData,a=e.pesData,m=s.pesData;if(u&&(E=t(u))?(this.parseAVCPES(v,h,E,!0),v.pesData=null):v.pesData=u,a&&(E=t(a))){switch(e.segmentCodec){case"aac":this.parseAACPES(e,E);break;case"mp3":this.parseMPEGPES(e,E)}e.pesData=null}else null!=a&&a.size&&x.logger.log("last AAC PES packet truncated,might overlap between fragments"),e.pesData=a;m&&(E=t(m))?(this.parseID3PES(s,E),s.pesData=null):s.pesData=m},i.demuxSampleAes=function(o,e,v){var s=this.demux(o,v,!0,!this.config.progressive),h=this.sampleAes=new _.default(this.observer,this.config,e);return this.decrypt(s,h)},i.decrypt=function(o,e){return new Promise(function(v){var s=o.audioTrack,h=o.videoTrack;s.samples&&"aac"===s.segmentCodec?e.decryptAacSamples(s.samples,0,function(){h.samples?e.decryptAvcSamples(h.samples,0,0,function(){v(o)}):v(o)}):h.samples&&e.decryptAvcSamples(h.samples,0,0,function(){v(o)})})},i.destroy=function(){this._duration=0},i.parseAVCPES=function(o,e,v,s){var E,h=this,u=this.parseAVCNALu(o,v.data),m=this.avcSample,O=!1;v.data=null,m&&u.length&&!o.audFound&&(d(m,o),m=this.avcSample=p(!1,v.pts,v.dts,"")),u.forEach(function(M){switch(M.type){case 1:E=!0,m||(m=h.avcSample=p(!0,v.pts,v.dts,"")),m.frame=!0;var C=M.data;if(O&&C.length>4){var F=new D.default(C).readSliceType();(2===F||4===F||7===F||9===F)&&(m.key=!0)}break;case 5:E=!0,m||(m=h.avcSample=p(!0,v.pts,v.dts,"")),m.key=!0,m.frame=!0;break;case 6:E=!0,(0,P.parseSEIMessageFromNALu)(M.data,1,v.pts,e.samples);break;case 7:if(E=!0,O=!0,!o.sps){var k=new D.default(M.data).readSPS();o.width=k.width,o.height=k.height,o.pixelRatio=k.pixelRatio,o.sps=[M.data],o.duration=h._duration;for(var N=M.data.subarray(1,4),w="avc1.",K=0;K<3;K++){var G=N[K].toString(16);G.length<2&&(G="0"+G),w+=G}o.codec=w}break;case 8:E=!0,o.pps||(o.pps=[M.data]);break;case 9:E=!1,o.audFound=!0,m&&d(m,o),m=h.avcSample=p(!1,v.pts,v.dts,"");break;case 12:E=!0;break;default:E=!1,m&&(m.debug+="unknown NAL "+M.type+" ")}m&&E&&m.units.push(M)}),s&&m&&(d(m,o),this.avcSample=null)},i.getLastNalUnit=function(o){var e,s,v=this.avcSample;if((!v||0===v.units.length)&&(v=o[o.length-1]),null!==(e=v)&&void 0!==e&&e.units){var h=v.units;s=h[h.length-1]}return s},i.parseAVCNALu=function(o,e){var m,E,v=e.byteLength,s=o.naluState||0,h=s,u=[],a=0,M=-1,C=0;for(-1===s&&(M=0,C=31&e[0],s=0,a=1);a<v;)if(m=e[a++],s)if(1!==s)if(m)if(1===m){if(M>=0){var F={data:e.subarray(M,a-s-1),type:C};u.push(F)}else{var U=this.getLastNalUnit(o.samples);if(U&&(h&&a<=4-h&&U.state&&(U.data=U.data.subarray(0,U.data.byteLength-h)),(E=a-s-1)>0)){var k=new Uint8Array(U.data.byteLength+E);k.set(U.data,0),k.set(e.subarray(0,E),U.data.byteLength),U.data=k,U.state=0}}a<v?(M=a,C=31&e[a],s=0):s=-1}else s=0;else s=3;else s=m?0:2;else s=m?0:1;if(M>=0&&s>=0){var N={data:e.subarray(M,v),type:C,state:s};u.push(N)}if(0===u.length){var w=this.getLastNalUnit(o.samples);if(w){var K=new Uint8Array(w.data.byteLength+e.byteLength);K.set(w.data,0),K.set(e,w.data.byteLength),w.data=K}}return o.naluState=s,u},i.parseAACPES=function(o,e){var O,M,C,F,U,v=0,s=this.aacOverFlow,h=e.data;if(s){this.aacOverFlow=null;var u=s.missing,a=s.sample.unit.byteLength;if(-1===u){var m=new Uint8Array(a+h.byteLength);m.set(s.sample.unit,0),m.set(h,a),h=m}else{var E=a-u;s.sample.unit.set(h.subarray(0,u),E),o.samples.push(s.sample),v=s.missing}}for(O=v,M=h.length;O<M-1&&!b.isHeader(h,O);O++);if(O===v||(O<M-1?(C="AAC PES did not start with ADTS header,offset:"+O,F=!1):(C="no ADTS header found in AAC PES",F=!0),x.logger.warn("parsing error:"+C),this.observer.emit(I.Events.ERROR,I.Events.ERROR,{type:S.ErrorTypes.MEDIA_ERROR,details:S.ErrorDetails.FRAG_PARSING_ERROR,fatal:F,reason:C}),!F)){if(b.initTrackConfig(o,this.observer,h,O,this.audioCodec),void 0!==e.pts)U=e.pts;else{if(!s)return void x.logger.warn("[tsdemuxer]: AAC PES unknown PTS");var k=b.getFrameDuration(o.samplerate);U=s.sample.pts+k}for(var w,N=0;O<M;){if(O+=(w=b.appendFrame(o,h,O,U,N)).length,w.missing){this.aacOverFlow=w;break}for(N++;O<M-1&&!b.isHeader(h,O);O++);}}},i.parseMPEGPES=function(o,e){var v=e.data,s=v.length,h=0,u=0,a=e.pts;if(void 0!==a)for(;u<s;)if(R.isHeader(v,u)){var m=R.appendFrame(o,v,u,a,h);if(!m)break;u+=m.length,h++}else u++;else x.logger.warn("[tsdemuxer]: MPEG PES unknown PTS")},i.parseID3PES=function(o,e){if(void 0!==e.pts){var v=L({},e,{type:this._avcTrack?g.MetadataSchema.emsg:g.MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY});o.samples.push(v)}else x.logger.warn("[tsdemuxer]: ID3 PES unknown PTS")},n}()},"./src/demux/webworkify-webpack.js":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>y});var R=function(){var p=ENTRY_MODULE,f={},r=function d(c){var n=f[c];if(void 0!==n)return n.exports;var i=f[c]={exports:{}};return p[c].call(i.exports,i,i.exports,d),i.exports};r.m=p,r.n=function(d){var c=d&&d.__esModule?function(){return d.default}:function(){return d};return r.d(c,{a:c}),c},r.d=function(d,c){for(var n in c)r.o(c,n)&&!r.o(d,n)&&Object.defineProperty(d,n,{enumerable:!0,get:c[n]})},r.o=function(d,c){return Object.prototype.hasOwnProperty.call(d,c)},r.r=function(d){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(d,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(d,"__esModule",{value:!0})};var t=r(ENTRY_MODULE);return t.default||t}.toString().split("ENTRY_MODULE"),D="[\\.|\\-|\\+|\\w|/|@]+",_="\\(\\s*(/\\*.*?\\*/)?\\s*.*?("+D+").*?\\)";function I(T){return(T+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function P(T){return!isNaN(1*T)}function x(T,p,f){var r={};r[f]=[];var t=p.toString().replace(/^"[^"]+"/,"function"),d=t.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/)||t.match(/^\(\w+,\s*\w+,\s*(\w+)\)\s?\=\s?\>/);if(!d)return r;for(var i,c=d[1],n=new RegExp("(\\\\n|\\W)"+I(c)+_,"g");i=n.exec(t);)"dll-reference"!==i[3]&&r[f].push(i[3]);for(n=new RegExp("\\("+I(c)+'\\("(dll-reference\\s('+D+'))"\\)\\)'+_,"g");i=n.exec(t);)T[i[2]]||(r[f].push(i[1]),T[i[2]]=A(i[1]).m),r[i[2]]=r[i[2]]||[],r[i[2]].push(i[4]);for(var l=Object.keys(r),o=0;o<l.length;o++)for(var e=0;e<r[l[o]].length;e++)P(r[l[o]][e])&&(r[l[o]][e]=1*r[l[o]][e]);return r}function S(T){return Object.keys(T).reduce(function(f,r){return f||T[r].length>0},!1)}function L(T,p,f,r){var t=T[r].map(function(d){return'"'+d+'": '+p[r][d].toString().replace(/^"[^"]+"/,"function")}).join(",");return R[0]+"{"+t+"}"+R[1]+'"'+f+'"'+R[2]}function y(T,p){var f={main:A.m},r=(p=p||{}).all?{main:Object.keys(f.main)}:function g(T,p){for(var f={main:[p]},r={main:[]},t={main:{}};S(f);)for(var d=Object.keys(f),c=0;c<d.length;c++){var n=d[c],l=f[n].pop();if(t[n]=t[n]||{},!t[n][l]&&T[n][l]){t[n][l]=!0,r[n]=r[n]||[],r[n].push(l);for(var o=x(T,T[n][l],n),e=Object.keys(o),v=0;v<e.length;v++)f[e[v]]=f[e[v]]||[],f[e[v]]=f[e[v]].concat(o[e[v]])}}return r}(f,T),t="";Object.keys(r).filter(function(l){return"main"!==l}).forEach(function(l){for(var o=0;r[l][o];)o++;r[l].push(o),f[l][o]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",t=t+"var "+l+" = ("+L(r,f,o,modules)+")();\n"}),t=t+"new (("+L(r,f,T,"main")+")())(self);";var d=new window.Blob([t],{type:"text/javascript"}),n=(window.URL||window.webkitURL||window.mozURL||window.msURL).createObjectURL(d),i=new window.Worker(n);return i.objectURL=n,i}},"./src/errors.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{ErrorDetails:()=>R,ErrorTypes:()=>b});var b=(()=>{return(D=b||(b={})).NETWORK_ERROR="networkError",D.MEDIA_ERROR="mediaError",D.KEY_SYSTEM_ERROR="keySystemError",D.MUX_ERROR="muxError",D.OTHER_ERROR="otherError",b;var D})(),R=(()=>{return(D=R||(R={})).KEY_SYSTEM_NO_KEYS="keySystemNoKeys",D.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",D.KEY_SYSTEM_NO_SESSION="keySystemNoSession",D.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",D.KEY_SYSTEM_NO_INIT_DATA="keySystemNoInitData",D.MANIFEST_LOAD_ERROR="manifestLoadError",D.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",D.MANIFEST_PARSING_ERROR="manifestParsingError",D.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",D.LEVEL_EMPTY_ERROR="levelEmptyError",D.LEVEL_LOAD_ERROR="levelLoadError",D.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",D.LEVEL_SWITCH_ERROR="levelSwitchError",D.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",D.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",D.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",D.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",D.FRAG_LOAD_ERROR="fragLoadError",D.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",D.FRAG_DECRYPT_ERROR="fragDecryptError",D.FRAG_PARSING_ERROR="fragParsingError",D.REMUX_ALLOC_ERROR="remuxAllocError",D.KEY_LOAD_ERROR="keyLoadError",D.KEY_LOAD_TIMEOUT="keyLoadTimeOut",D.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",D.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",D.BUFFER_APPEND_ERROR="bufferAppendError",D.BUFFER_APPENDING_ERROR="bufferAppendingError",D.BUFFER_STALLED_ERROR="bufferStalledError",D.BUFFER_FULL_ERROR="bufferFullError",D.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",D.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",D.INTERNAL_EXCEPTION="internalException",D.INTERNAL_ABORTED="aborted",D.UNKNOWN="unknown",R;var D})()},"./src/events.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{Events:()=>b});var b=(()=>{return(R=b||(b={})).MEDIA_ATTACHING="hlsMediaAttaching",R.MEDIA_ATTACHED="hlsMediaAttached",R.MEDIA_DETACHING="hlsMediaDetaching",R.MEDIA_DETACHED="hlsMediaDetached",R.BUFFER_RESET="hlsBufferReset",R.BUFFER_CODECS="hlsBufferCodecs",R.BUFFER_CREATED="hlsBufferCreated",R.BUFFER_APPENDING="hlsBufferAppending",R.BUFFER_APPENDED="hlsBufferAppended",R.BUFFER_EOS="hlsBufferEos",R.BUFFER_FLUSHING="hlsBufferFlushing",R.BUFFER_FLUSHED="hlsBufferFlushed",R.MANIFEST_LOADING="hlsManifestLoading",R.MANIFEST_LOADED="hlsManifestLoaded",R.MANIFEST_PARSED="hlsManifestParsed",R.LEVEL_SWITCHING="hlsLevelSwitching",R.LEVEL_SWITCHED="hlsLevelSwitched",R.LEVEL_LOADING="hlsLevelLoading",R.LEVEL_LOADED="hlsLevelLoaded",R.LEVEL_UPDATED="hlsLevelUpdated",R.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",R.LEVELS_UPDATED="hlsLevelsUpdated",R.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",R.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",R.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",R.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",R.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",R.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",R.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",R.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",R.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",R.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",R.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",R.CUES_PARSED="hlsCuesParsed",R.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",R.INIT_PTS_FOUND="hlsInitPtsFound",R.FRAG_LOADING="hlsFragLoading",R.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",R.FRAG_LOADED="hlsFragLoaded",R.FRAG_DECRYPTED="hlsFragDecrypted",R.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",R.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",R.FRAG_PARSING_METADATA="hlsFragParsingMetadata",R.FRAG_PARSED="hlsFragParsed",R.FRAG_BUFFERED="hlsFragBuffered",R.FRAG_CHANGED="hlsFragChanged",R.FPS_DROP="hlsFpsDrop",R.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",R.ERROR="hlsError",R.DESTROYING="hlsDestroying",R.KEY_LOADING="hlsKeyLoading",R.KEY_LOADED="hlsKeyLoaded",R.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",R.BACK_BUFFER_REACHED="hlsBackBufferReached",b;var R})()},"./src/hls.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>n});var b=A("./node_modules/url-toolkit/src/url-toolkit.js"),D=A("./src/loader/playlist-loader.ts"),_=A("./src/loader/key-loader.ts"),I=A("./src/controller/id3-track-controller.ts"),P=A("./src/controller/latency-controller.ts"),x=A("./src/controller/level-controller.ts"),S=A("./src/controller/fragment-tracker.ts"),g=A("./src/controller/stream-controller.ts"),L=A("./src/is-supported.ts"),y=A("./src/utils/logger.ts"),T=A("./src/config.ts"),p=A("./node_modules/eventemitter3/index.js"),r=A("./src/events.ts"),t=A("./src/errors.ts");function d(i,l){for(var o=0;o<l.length;o++){var e=l[o];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(i,e.key,e)}}var n=function(){function i(o){void 0===o&&(o={}),this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new p.EventEmitter,this._autoLevelCapping=void 0,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null;var e=this.config=(0,T.mergeConfig)(i.DefaultConfig,o);this.userConfig=o,(0,y.enableLogs)(e.debug,"Hls instance"),this._autoLevelCapping=-1,e.progressive&&(0,T.enableStreamingMode)(e);var s=e.bufferController,h=e.capLevelController,u=e.fpsController,a=this.abrController=new(0,e.abrController)(this),m=this.bufferController=new s(this),E=this.capLevelController=new h(this),O=new u(this),M=new D.default(this),C=new _.default(this),F=new I.default(this),U=this.levelController=new x.default(this),k=new S.FragmentTracker(this),N=this.streamController=new g.default(this,k);E.setStreamController(N),O.setStreamController(N);var w=[M,C,U,N];this.networkControllers=w;var K=[a,m,E,O,F,k];this.audioTrackController=this.createController(e.audioTrackController,null,w),this.createController(e.audioStreamController,k,w),this.subtitleTrackController=this.createController(e.subtitleTrackController,null,w),this.createController(e.subtitleStreamController,k,w),this.createController(e.timelineController,null,K),this.emeController=this.createController(e.emeController,null,K),this.cmcdController=this.createController(e.cmcdController,null,K),this.latencyController=this.createController(P.default,null,K),this.coreComponents=K}i.isSupported=function(){return(0,L.isSupported)()};var l=i.prototype;return l.createController=function(e,v,s){if(e){var h=v?new e(this,v):new e(this);return s&&s.push(h),h}return null},l.on=function(e,v,s){void 0===s&&(s=this),this._emitter.on(e,v,s)},l.once=function(e,v,s){void 0===s&&(s=this),this._emitter.once(e,v,s)},l.removeAllListeners=function(e){this._emitter.removeAllListeners(e)},l.off=function(e,v,s,h){void 0===s&&(s=this),this._emitter.off(e,v,s,h)},l.listeners=function(e){return this._emitter.listeners(e)},l.emit=function(e,v,s){return this._emitter.emit(e,v,s)},l.trigger=function(e,v){if(this.config.debug)return this.emit(e,e,v);try{return this.emit(e,e,v)}catch(s){y.logger.error("An internal error happened while handling event "+e+'. Error message: "'+s.message+'". Here is a stacktrace:',s),this.trigger(r.Events.ERROR,{type:t.ErrorTypes.OTHER_ERROR,details:t.ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:e,error:s})}return!1},l.listenerCount=function(e){return this._emitter.listenerCount(e)},l.destroy=function(){y.logger.log("destroy"),this.trigger(r.Events.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(function(e){return e.destroy()}),this.networkControllers.length=0,this.coreComponents.forEach(function(e){return e.destroy()}),this.coreComponents.length=0},l.attachMedia=function(e){y.logger.log("attachMedia"),this._media=e,this.trigger(r.Events.MEDIA_ATTACHING,{media:e})},l.detachMedia=function(){y.logger.log("detachMedia"),this.trigger(r.Events.MEDIA_DETACHING,void 0),this._media=null},l.loadSource=function(e){this.stopLoad();var v=this.media,s=this.url,h=this.url=b.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});y.logger.log("loadSource:"+h),v&&s&&s!==h&&this.bufferController.hasSourceTypes()&&(this.detachMedia(),this.attachMedia(v)),this.trigger(r.Events.MANIFEST_LOADING,{url:e})},l.startLoad=function(e){void 0===e&&(e=-1),y.logger.log("startLoad("+e+")"),this.networkControllers.forEach(function(v){v.startLoad(e)})},l.stopLoad=function(){y.logger.log("stopLoad"),this.networkControllers.forEach(function(e){e.stopLoad()})},l.swapAudioCodec=function(){y.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()},l.recoverMediaError=function(){y.logger.log("recoverMediaError");var e=this._media;this.detachMedia(),e&&this.attachMedia(e)},l.removeLevel=function(e,v){void 0===v&&(v=0),this.levelController.removeLevel(e,v)},function c(i,l,o){l&&d(i.prototype,l),o&&d(i,o),Object.defineProperty(i,"prototype",{writable:!1})}(i,[{key:"levels",get:function(){return this.levelController.levels||[]}},{key:"currentLevel",get:function(){return this.streamController.currentLevel},set:function(e){y.logger.log("set currentLevel:"+e),this.loadLevel=e,this.abrController.clearTimer(),this.streamController.immediateLevelSwitch()}},{key:"nextLevel",get:function(){return this.streamController.nextLevel},set:function(e){y.logger.log("set nextLevel:"+e),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}},{key:"loadLevel",get:function(){return this.levelController.level},set:function(e){y.logger.log("set loadLevel:"+e),this.levelController.manualLevel=e}},{key:"nextLoadLevel",get:function(){return this.levelController.nextLoadLevel},set:function(e){this.levelController.nextLoadLevel=e}},{key:"firstLevel",get:function(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)},set:function(e){y.logger.log("set firstLevel:"+e),this.levelController.firstLevel=e}},{key:"startLevel",get:function(){return this.levelController.startLevel},set:function(e){y.logger.log("set startLevel:"+e),-1!==e&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}},{key:"capLevelToPlayerSize",get:function(){return this.config.capLevelToPlayerSize},set:function(e){var v=!!e;v!==this.config.capLevelToPlayerSize&&(v?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=v)}},{key:"autoLevelCapping",get:function(){return this._autoLevelCapping},set:function(e){this._autoLevelCapping!==e&&(y.logger.log("set autoLevelCapping:"+e),this._autoLevelCapping=e)}},{key:"bandwidthEstimate",get:function(){var e=this.abrController.bwEstimator;return e?e.getEstimate():NaN}},{key:"autoLevelEnabled",get:function(){return-1===this.levelController.manualLevel}},{key:"manualLevel",get:function(){return this.levelController.manualLevel}},{key:"minAutoLevel",get:function(){var e=this.levels,v=this.config.minAutoBitrate;if(!e)return 0;for(var s=e.length,h=0;h<s;h++)if(e[h].maxBitrate>=v)return h;return 0}},{key:"maxAutoLevel",get:function(){var e=this.levels,v=this.autoLevelCapping;return-1===v&&e&&e.length?e.length-1:v}},{key:"nextAutoLevel",get:function(){return Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.maxAutoLevel)},set:function(e){this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,e)}},{key:"playingDate",get:function(){return this.streamController.currentProgramDateTime}},{key:"mainForwardBufferInfo",get:function(){return this.streamController.getMainFwdBufferInfo()}},{key:"audioTracks",get:function(){var e=this.audioTrackController;return e?e.audioTracks:[]}},{key:"audioTrack",get:function(){var e=this.audioTrackController;return e?e.audioTrack:-1},set:function(e){var v=this.audioTrackController;v&&(v.audioTrack=e)}},{key:"subtitleTracks",get:function(){var e=this.subtitleTrackController;return e?e.subtitleTracks:[]}},{key:"subtitleTrack",get:function(){var e=this.subtitleTrackController;return e?e.subtitleTrack:-1},set:function(e){var v=this.subtitleTrackController;v&&(v.subtitleTrack=e)}},{key:"media",get:function(){return this._media}},{key:"subtitleDisplay",get:function(){var e=this.subtitleTrackController;return!!e&&e.subtitleDisplay},set:function(e){var v=this.subtitleTrackController;v&&(v.subtitleDisplay=e)}},{key:"lowLatencyMode",get:function(){return this.config.lowLatencyMode},set:function(e){this.config.lowLatencyMode=e}},{key:"liveSyncPosition",get:function(){return this.latencyController.liveSyncPosition}},{key:"latency",get:function(){return this.latencyController.latency}},{key:"maxLatency",get:function(){return this.latencyController.maxLatency}},{key:"targetLatency",get:function(){return this.latencyController.targetLatency}},{key:"drift",get:function(){return this.latencyController.drift}},{key:"forceStartLoad",get:function(){return this.streamController.forceStartLoad}}],[{key:"version",get:function(){return"1.2.9"}},{key:"Events",get:function(){return r.Events}},{key:"ErrorTypes",get:function(){return t.ErrorTypes}},{key:"ErrorDetails",get:function(){return t.ErrorDetails}},{key:"DefaultConfig",get:function(){return i.defaultConfig?i.defaultConfig:T.hlsDefaultConfig},set:function(e){i.defaultConfig=e}}]),i}();n.defaultConfig=void 0},"./src/is-supported.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{changeTypeSupported:()=>_,isSupported:()=>D});var b=A("./src/utils/mediasource-helper.ts");function R(){return self.SourceBuffer||self.WebKitSourceBuffer}function D(){var I=(0,b.getMediaSource)();if(!I)return!1;var P=R();return!(!I||"function"!=typeof I.isTypeSupported||!I.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')||P&&(!P.prototype||"function"!=typeof P.prototype.appendBuffer||"function"!=typeof P.prototype.remove))}function _(){var I,P=R();return"function"==typeof(null==P||null===(I=P.prototype)||void 0===I?void 0:I.changeType)}},"./src/loader/date-range.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{DateRange:()=>S,DateRangeAttribute:()=>x});var b=A("./src/polyfills/number.ts"),R=A("./src/utils/attr-list.ts"),D=A("./src/utils/logger.ts");function _(){return _=Object.assign?Object.assign.bind():function(g){for(var L=1;L<arguments.length;L++){var y=arguments[L];for(var T in y)Object.prototype.hasOwnProperty.call(y,T)&&(g[T]=y[T])}return g},_.apply(this,arguments)}function I(g,L){for(var y=0;y<L.length;y++){var T=L[y];T.enumerable=T.enumerable||!1,T.configurable=!0,"value"in T&&(T.writable=!0),Object.defineProperty(g,T.key,T)}}var x=(()=>{return(g=x||(x={})).ID="ID",g.CLASS="CLASS",g.START_DATE="START-DATE",g.DURATION="DURATION",g.END_DATE="END-DATE",g.END_ON_NEXT="END-ON-NEXT",g.PLANNED_DURATION="PLANNED-DURATION",g.SCTE35_OUT="SCTE35-OUT",g.SCTE35_IN="SCTE35-IN",x;var g})(),S=function(){function g(L,y){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,y){var T=y.attr;for(var p in T)if(Object.prototype.hasOwnProperty.call(L,p)&&L[p]!==T[p]){D.logger.warn('DATERANGE tag attribute: "'+p+'" does not match for tags with ID: "'+L.ID+'"'),this._badValueForSameId=p;break}L=_(new R.AttrList({}),T,L)}if(this.attr=L,this._startDate=new Date(L[x.START_DATE]),x.END_DATE in this.attr){var f=new Date(this.attr[x.END_DATE]);(0,b.isFiniteNumber)(f.getTime())&&(this._endDate=f)}}return function P(g,L,y){L&&I(g.prototype,L),y&&I(g,y),Object.defineProperty(g,"prototype",{writable:!1})}(g,[{key:"id",get:function(){return this.attr.ID}},{key:"class",get:function(){return this.attr.CLASS}},{key:"startDate",get:function(){return this._startDate}},{key:"endDate",get:function(){if(this._endDate)return this._endDate;var y=this.duration;return null!==y?new Date(this._startDate.getTime()+1e3*y):null}},{key:"duration",get:function(){if(x.DURATION in this.attr){var y=this.attr.decimalFloatingPoint(x.DURATION);if((0,b.isFiniteNumber)(y))return y}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}},{key:"plannedDuration",get:function(){return x.PLANNED_DURATION in this.attr?this.attr.decimalFloatingPoint(x.PLANNED_DURATION):null}},{key:"endOnNext",get:function(){return this.attr.bool(x.END_ON_NEXT)}},{key:"isValid",get:function(){return!!this.id&&!this._badValueForSameId&&(0,b.isFiniteNumber)(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)}}]),g}()},"./src/loader/fragment-loader.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{LoadError:()=>p,default:()=>y});var b=A("./src/polyfills/number.ts"),R=A("./src/errors.ts");function _(f){var r="function"==typeof Map?new Map:void 0;return _=function(d){if(null===d||!function x(f){return-1!==Function.toString.call(f).indexOf("[native code]")}(d))return d;if("function"!=typeof d)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(d))return r.get(d);r.set(d,c)}function c(){return I(d,arguments,g(this).constructor)}return c.prototype=Object.create(d.prototype,{constructor:{value:c,enumerable:!1,writable:!0,configurable:!0}}),S(c,d)},_(f)}function I(f,r,t){return(I=P()?Reflect.construct.bind():function(c,n,i){var l=[null];l.push.apply(l,n);var e=new(Function.bind.apply(c,l));return i&&S(e,i.prototype),e}).apply(null,arguments)}function P(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(f){return!1}}function S(f,r){return(S=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(d,c){return d.__proto__=c,d})(f,r)}function g(f){return(g=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(f)}var L=Math.pow(2,17),y=function(){function f(t){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=t}var r=f.prototype;return r.destroy=function(){this.loader&&(this.loader.destroy(),this.loader=null)},r.abort=function(){this.loader&&this.loader.abort()},r.load=function(d,c){var n=this,i=d.url;if(!i)return Promise.reject(new p({type:R.ErrorTypes.NETWORK_ERROR,details:R.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:d,networkDetails:null},"Fragment does not have a "+(i?"part list":"url")));this.abort();var l=this.config,o=l.fLoader,e=l.loader;return new Promise(function(v,s){n.loader&&n.loader.destroy();var h=n.loader=d.loader=o?new o(l):new e(l),u=T(d),a={timeout:l.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:l.fragLoadingMaxRetryTimeout,highWaterMark:"initSegment"===d.sn?1/0:L};d.stats=h.stats,h.load(u,a,{onSuccess:function(E,O,M,C){n.resetLoader(d,h),v({frag:d,part:null,payload:E.data,networkDetails:C})},onError:function(E,O,M){n.resetLoader(d,h),s(new p({type:R.ErrorTypes.NETWORK_ERROR,details:R.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:d,response:E,networkDetails:M}))},onAbort:function(E,O,M){n.resetLoader(d,h),s(new p({type:R.ErrorTypes.NETWORK_ERROR,details:R.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:d,networkDetails:M}))},onTimeout:function(E,O,M){n.resetLoader(d,h),s(new p({type:R.ErrorTypes.NETWORK_ERROR,details:R.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:d,networkDetails:M}))},onProgress:function(E,O,M,C){c&&c({frag:d,part:null,payload:M,networkDetails:C})}})})},r.loadPart=function(d,c,n){var i=this;this.abort();var l=this.config,o=l.fLoader,e=l.loader;return new Promise(function(v,s){i.loader&&i.loader.destroy();var h=i.loader=d.loader=o?new o(l):new e(l),u=T(d,c),a={timeout:l.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:l.fragLoadingMaxRetryTimeout,highWaterMark:L};c.stats=h.stats,h.load(u,a,{onSuccess:function(E,O,M,C){i.resetLoader(d,h),i.updateStatsFromPart(d,c);var F={frag:d,part:c,payload:E.data,networkDetails:C};n(F),v(F)},onError:function(E,O,M){i.resetLoader(d,h),s(new p({type:R.ErrorTypes.NETWORK_ERROR,details:R.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:d,part:c,response:E,networkDetails:M}))},onAbort:function(E,O,M){d.stats.aborted=c.stats.aborted,i.resetLoader(d,h),s(new p({type:R.ErrorTypes.NETWORK_ERROR,details:R.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:d,part:c,networkDetails:M}))},onTimeout:function(E,O,M){i.resetLoader(d,h),s(new p({type:R.ErrorTypes.NETWORK_ERROR,details:R.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:d,part:c,networkDetails:M}))}})})},r.updateStatsFromPart=function(d,c){var n=d.stats,i=c.stats,l=i.total;if(n.loaded+=i.loaded,l){var o=Math.round(d.duration/c.duration),e=Math.min(Math.round(n.loaded/l),o),s=(o-e)*Math.round(n.loaded/e);n.total=n.loaded+s}else n.total=Math.max(n.loaded,n.total);var h=n.loading,u=i.loading;h.start?h.first+=u.first-u.start:(h.start=u.start,h.first=u.first),h.end=u.end},r.resetLoader=function(d,c){d.loader=null,this.loader===c&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),c.destroy()},f}();function T(f,r){void 0===r&&(r=null);var t=r||f,d={frag:f,part:r,responseType:"arraybuffer",url:t.url,headers:{},rangeStart:0,rangeEnd:0},c=t.byteRangeStartOffset,n=t.byteRangeEndOffset;return(0,b.isFiniteNumber)(c)&&(0,b.isFiniteNumber)(n)&&(d.rangeStart=c,d.rangeEnd=n),d}var p=function(f){function r(t){for(var d,c=arguments.length,n=new Array(c>1?c-1:0),i=1;i<c;i++)n[i-1]=arguments[i];return(d=f.call.apply(f,[this].concat(n))||this).data=void 0,d.data=t,d}return function D(f,r){f.prototype=Object.create(r.prototype),f.prototype.constructor=f,S(f,r)}(r,f),r}(_(Error))},"./src/loader/fragment.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{BaseSegment:()=>T,ElementaryStreamTypes:()=>y,Fragment:()=>p,Part:()=>f});var b=A("./src/polyfills/number.ts"),R=A("./node_modules/url-toolkit/src/url-toolkit.js"),_=A("./src/utils/logger.ts"),I=A("./src/loader/level-key.ts"),P=A("./src/loader/load-stats.ts");function x(r,t){r.prototype=Object.create(t.prototype),r.prototype.constructor=r,S(r,t)}function S(r,t){return(S=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(c,n){return c.__proto__=n,c})(r,t)}function g(r,t){for(var d=0;d<t.length;d++){var c=t[d];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(r,c.key,c)}}function L(r,t,d){return t&&g(r.prototype,t),d&&g(r,d),Object.defineProperty(r,"prototype",{writable:!1}),r}var y=(()=>{return(r=y||(y={})).AUDIO="audio",r.VIDEO="video",r.AUDIOVIDEO="audiovideo",y;var r})(),T=function(){function r(d){var c;this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams=((c={})[y.AUDIO]=null,c[y.VIDEO]=null,c[y.AUDIOVIDEO]=null,c),this.baseurl=d}return r.prototype.setByteRange=function(c,n){var i=c.split("@",2),l=[];l[0]=1===i.length?n?n.byteRangeEndOffset:0:parseInt(i[1]),l[1]=parseInt(i[0])+l[0],this._byteRange=l},L(r,[{key:"byteRange",get:function(){return this._byteRange?this._byteRange:[]}},{key:"byteRangeStartOffset",get:function(){return this.byteRange[0]}},{key:"byteRangeEndOffset",get:function(){return this.byteRange[1]}},{key:"url",get:function(){return!this._url&&this.baseurl&&this.relurl&&(this._url=(0,R.buildAbsoluteURL)(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""},set:function(c){this._url=c}}]),r}(),p=function(r){function t(c,n){var i;return(i=r.call(this,n)||this)._decryptdata=null,i.rawProgramDateTime=null,i.programDateTime=null,i.tagList=[],i.duration=0,i.sn=0,i.levelkey=void 0,i.type=void 0,i.loader=null,i.level=-1,i.cc=0,i.startPTS=void 0,i.endPTS=void 0,i.appendedPTS=void 0,i.startDTS=void 0,i.endDTS=void 0,i.start=0,i.deltaPTS=void 0,i.maxStartPTS=void 0,i.minEndPTS=void 0,i.stats=new P.LoadStats,i.urlId=0,i.data=void 0,i.bitrateTest=!1,i.title=null,i.initSegment=null,i.type=c,i}x(t,r);var d=t.prototype;return d.createInitializationVector=function(n){for(var i=new Uint8Array(16),l=12;l<16;l++)i[l]=n>>8*(15-l)&255;return i},d.setDecryptDataFromLevelKey=function(n,i){var l=n;return"AES-128"===(null==n?void 0:n.method)&&n.uri&&!n.iv&&((l=I.LevelKey.fromURI(n.uri)).method=n.method,l.iv=this.createInitializationVector(i),l.keyFormat="identity"),l},d.setElementaryStreamInfo=function(n,i,l,o,e,v){void 0===v&&(v=!1);var s=this.elementaryStreams,h=s[n];h?(h.startPTS=Math.min(h.startPTS,i),h.endPTS=Math.max(h.endPTS,l),h.startDTS=Math.min(h.startDTS,o),h.endDTS=Math.max(h.endDTS,e)):s[n]={startPTS:i,endPTS:l,startDTS:o,endDTS:e,partial:v}},d.clearElementaryStreamInfo=function(){var n=this.elementaryStreams;n[y.AUDIO]=null,n[y.VIDEO]=null,n[y.AUDIOVIDEO]=null},L(t,[{key:"decryptdata",get:function(){if(!this.levelkey&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkey){var n=this.sn;"number"!=typeof n&&(this.levelkey&&"AES-128"===this.levelkey.method&&!this.levelkey.iv&&_.logger.warn('missing IV for initialization segment with method="'+this.levelkey.method+'" - compliance issue'),n=0),this._decryptdata=this.setDecryptDataFromLevelKey(this.levelkey,n)}return this._decryptdata}},{key:"end",get:function(){return this.start+this.duration}},{key:"endProgramDateTime",get:function(){if(null===this.programDateTime||!(0,b.isFiniteNumber)(this.programDateTime))return null;var n=(0,b.isFiniteNumber)(this.duration)?this.duration:0;return this.programDateTime+1e3*n}},{key:"encrypted",get:function(){var n;return!(null===(n=this.decryptdata)||void 0===n||!n.keyFormat||!this.decryptdata.uri)}}]),t}(T),f=function(r){function t(d,c,n,i,l){var o;(o=r.call(this,n)||this).fragOffset=0,o.duration=0,o.gap=!1,o.independent=!1,o.relurl=void 0,o.fragment=void 0,o.index=void 0,o.stats=new P.LoadStats,o.duration=d.decimalFloatingPoint("DURATION"),o.gap=d.bool("GAP"),o.independent=d.bool("INDEPENDENT"),o.relurl=d.enumeratedString("URI"),o.fragment=c,o.index=i;var e=d.enumeratedString("BYTERANGE");return e&&o.setByteRange(e,l),l&&(o.fragOffset=l.fragOffset+l.duration),o}return x(t,r),L(t,[{key:"start",get:function(){return this.fragment.start+this.fragOffset}},{key:"end",get:function(){return this.start+this.duration}},{key:"loaded",get:function(){var c=this.elementaryStreams;return!!(c.audio||c.video||c.audiovideo)}}]),t}(T)},"./src/loader/key-loader.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>_});var b=A("./src/events.ts"),R=A("./src/errors.ts"),D=A("./src/utils/logger.ts"),_=function(){function I(x){this.hls=void 0,this.loaders={},this.decryptkey=null,this.decrypturl=null,this.hls=x,this.registerListeners()}var P=I.prototype;return P.startLoad=function(S){},P.stopLoad=function(){this.destroyInternalLoaders()},P.registerListeners=function(){this.hls.on(b.Events.KEY_LOADING,this.onKeyLoading,this)},P.unregisterListeners=function(){this.hls.off(b.Events.KEY_LOADING,this.onKeyLoading)},P.destroyInternalLoaders=function(){for(var S in this.loaders){var g=this.loaders[S];g&&g.destroy()}this.loaders={}},P.destroy=function(){this.unregisterListeners(),this.destroyInternalLoaders()},P.onKeyLoading=function(S,g){var L=g.frag,y=L.type,T=this.loaders[y];if(L.decryptdata){var p=L.decryptdata.uri;if(p!==this.decrypturl||null===this.decryptkey){var f=this.hls.config;if(T&&(D.logger.warn("abort previous key loader for type:"+y),T.abort()),!p)return void D.logger.warn("key uri is falsy");var t=L.loader=this.loaders[y]=new(0,f.loader)(f);this.decrypturl=p,this.decryptkey=null;var d={url:p,frag:L,responseType:"arraybuffer"},c={timeout:f.fragLoadingTimeOut,maxRetry:0,retryDelay:f.fragLoadingRetryDelay,maxRetryDelay:f.fragLoadingMaxRetryTimeout,highWaterMark:0},n={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};t.load(d,c,n)}else this.decryptkey&&(L.decryptdata.key=this.decryptkey,this.hls.trigger(b.Events.KEY_LOADED,{frag:L}))}else D.logger.warn("Missing decryption data on fragment in onKeyLoading")},P.loadsuccess=function(S,g,L){var y=L.frag;y.decryptdata?(this.decryptkey=y.decryptdata.key=new Uint8Array(S.data),y.loader=null,delete this.loaders[y.type],this.hls.trigger(b.Events.KEY_LOADED,{frag:y})):D.logger.error("after key load, decryptdata unset")},P.loaderror=function(S,g){var L=g.frag,y=L.loader;y&&y.abort(),delete this.loaders[L.type],this.hls.trigger(b.Events.ERROR,{type:R.ErrorTypes.NETWORK_ERROR,details:R.ErrorDetails.KEY_LOAD_ERROR,fatal:!1,frag:L,response:S})},P.loadtimeout=function(S,g){var L=g.frag,y=L.loader;y&&y.abort(),delete this.loaders[L.type],this.hls.trigger(b.Events.ERROR,{type:R.ErrorTypes.NETWORK_ERROR,details:R.ErrorDetails.KEY_LOAD_TIMEOUT,fatal:!1,frag:L})},I}()},"./src/loader/level-details.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{LevelDetails:()=>I});var b=A("./src/polyfills/number.ts");function R(P,x){for(var S=0;S<x.length;S++){var g=x[S];g.enumerable=g.enumerable||!1,g.configurable=!0,"value"in g&&(g.writable=!0),Object.defineProperty(P,g.key,g)}}var I=function(){function P(S){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.needSidxRanges=!1,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.fragments=[],this.dateRanges={},this.url=S}return P.prototype.reloaded=function(g){if(!g)return this.advanced=!0,void(this.updated=!0);var L=this.lastPartSn-g.lastPartSn,y=this.lastPartIndex-g.lastPartIndex;this.updated=this.endSN!==g.endSN||!!y||!!L,this.advanced=this.endSN>g.endSN||L>0||0===L&&y>0,this.misses=this.updated||this.advanced?Math.floor(.6*g.misses):g.misses+1,this.availabilityDelay=g.availabilityDelay},function D(P,x,S){x&&R(P.prototype,x),S&&R(P,S),Object.defineProperty(P,"prototype",{writable:!1})}(P,[{key:"hasProgramDateTime",get:function(){return!!this.fragments.length&&(0,b.isFiniteNumber)(this.fragments[this.fragments.length-1].programDateTime)}},{key:"levelTargetDuration",get:function(){return this.averagetargetduration||this.targetduration||10}},{key:"drift",get:function(){var g=this.driftEndTime-this.driftStartTime;return g>0?1e3*(this.driftEnd-this.driftStart)/g:1}},{key:"edge",get:function(){return this.partEnd||this.fragmentEnd}},{key:"partEnd",get:function(){var g;return null!==(g=this.partList)&&void 0!==g&&g.length?this.partList[this.partList.length-1].end:this.fragmentEnd}},{key:"fragmentEnd",get:function(){var g;return null!==(g=this.fragments)&&void 0!==g&&g.length?this.fragments[this.fragments.length-1].end:0}},{key:"age",get:function(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}},{key:"lastPartIndex",get:function(){var g;return null!==(g=this.partList)&&void 0!==g&&g.length?this.partList[this.partList.length-1].index:-1}},{key:"lastPartSn",get:function(){var g;return null!==(g=this.partList)&&void 0!==g&&g.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}]),P}()},"./src/loader/level-key.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{LevelKey:()=>I});var b=A("./node_modules/url-toolkit/src/url-toolkit.js");function D(P,x){for(var S=0;S<x.length;S++){var g=x[S];g.enumerable=g.enumerable||!1,g.configurable=!0,"value"in g&&(g.writable=!0),Object.defineProperty(P,g.key,g)}}var I=function(){function P(x,S){this._uri=null,this.method=null,this.keyFormat=null,this.keyFormatVersions=null,this.keyID=null,this.key=null,this.iv=null,this._uri=S?(0,b.buildAbsoluteURL)(x,S,{alwaysNormalize:!0}):x}return P.fromURL=function(S,g){return new P(S,g)},P.fromURI=function(S){return new P(S)},function _(P,x,S){x&&D(P.prototype,x),S&&D(P,S),Object.defineProperty(P,"prototype",{writable:!1})}(P,[{key:"uri",get:function(){return this._uri}}]),P}()},"./src/loader/load-stats.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{LoadStats:()=>b});var b=function(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}},"./src/loader/m3u8-parser.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>d});var b=A("./src/polyfills/number.ts"),R=A("./node_modules/url-toolkit/src/url-toolkit.js"),_=A("./src/loader/date-range.ts"),I=A("./src/loader/fragment.ts"),P=A("./src/loader/level-details.ts"),x=A("./src/loader/level-key.ts"),S=A("./src/utils/attr-list.ts"),g=A("./src/utils/logger.ts"),L=A("./src/utils/codecs.ts"),y=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-SESSION-DATA:([^\r\n]*)[\r\n]+/g,T=/#EXT-X-MEDIA:(.*)/g,p=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),f=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|")),r=/\.(mp4|m4s|m4v|m4a)$/i,d=function(){function e(){}return e.findGroup=function(s,h){for(var u=0;u<s.length;u++){var a=s[u];if(a.id===h)return a}},e.convertAVC1ToAVCOTI=function(s){var h=s.split(".");if(h.length>2){var u=h.shift()+".";return(u+=parseInt(h.shift()).toString(16))+("000"+parseInt(h.shift()).toString(16)).slice(-4)}return s},e.resolve=function(s,h){return R.buildAbsoluteURL(h,s,{alwaysNormalize:!0})},e.parseMasterPlaylist=function(s,h){var O,u=[],a=[],m={},E=!1;for(y.lastIndex=0;null!=(O=y.exec(s));)if(O[1]){var M,C=new S.AttrList(O[1]),F={attrs:C,bitrate:C.decimalInteger("AVERAGE-BANDWIDTH")||C.decimalInteger("BANDWIDTH"),name:C.NAME,url:e.resolve(O[2],h)},U=C.decimalResolution("RESOLUTION");U&&(F.width=U.width,F.height=U.height),c((C.CODECS||"").split(/[ ,]+/).filter(function(w){return w}),F),F.videoCodec&&-1!==F.videoCodec.indexOf("avc1")&&(F.videoCodec=e.convertAVC1ToAVCOTI(F.videoCodec)),null!==(M=F.unknownCodecs)&&void 0!==M&&M.length||a.push(F),u.push(F)}else if(O[3]){var k=new S.AttrList(O[3]);k["DATA-ID"]&&(E=!0,m[k["DATA-ID"]]=k)}return{levels:a.length>0&&a.length<u.length?a:u,sessionData:E?m:null}},e.parseMasterPlaylistMedia=function(s,h,u,a){void 0===a&&(a=[]);var m,E=[],O=0;for(T.lastIndex=0;null!==(m=T.exec(s));){var M=new S.AttrList(m[1]);if(M.TYPE===u){var C={attrs:M,bitrate:0,id:O++,groupId:M["GROUP-ID"],instreamId:M["INSTREAM-ID"],name:M.NAME||M.LANGUAGE||"",type:u,default:M.bool("DEFAULT"),autoselect:M.bool("AUTOSELECT"),forced:M.bool("FORCED"),lang:M.LANGUAGE,url:M.URI?e.resolve(M.URI,h):""};if(a.length){var F=e.findGroup(a,C.groupId)||a[0];n(C,F,"audioCodec"),n(C,F,"textCodec")}E.push(C)}}return E},e.parseLevelPlaylist=function(s,h,u,a,m){var K,G,H,E=new P.LevelDetails(h),O=E.fragments,M=null,C=0,F=0,U=0,k=0,N=null,w=new I.Fragment(a,h),V=-1,X=!1;for(p.lastIndex=0,E.m3u8=s;null!==(K=p.exec(s));){X&&(X=!1,(w=new I.Fragment(a,h)).start=U,w.sn=C,w.cc=k,w.level=u,M&&(w.initSegment=M,w.rawProgramDateTime=M.rawProgramDateTime,M.rawProgramDateTime=null));var Y=K[1];if(Y){w.duration=parseFloat(Y);var $=(" "+K[2]).slice(1);w.title=$||null,w.tagList.push($?["INF",Y,$]:["INF",Y])}else if(K[3])(0,b.isFiniteNumber)(w.duration)&&(w.start=U,H&&(w.levelkey=H),w.sn=C,w.level=u,w.cc=k,w.urlId=m,O.push(w),w.relurl=(" "+K[3]).slice(1),l(w,N),N=w,U+=w.duration,C++,F=0,X=!0);else if(K[4]){var Q=(" "+K[4]).slice(1);N?w.setByteRange(Q,N):w.setByteRange(Q)}else if(K[5])w.rawProgramDateTime=(" "+K[5]).slice(1),w.tagList.push(["PROGRAM-DATE-TIME",w.rawProgramDateTime]),-1===V&&(V=O.length);else{if(!(K=K[0].match(f))){g.logger.warn("No matches on slow regex match for level playlist!");continue}for(G=1;G<K.length&&void 0===K[G];G++);var z=(" "+K[G]).slice(1),j=(" "+K[G+1]).slice(1),q=K[G+2]?(" "+K[G+2]).slice(1):"";switch(z){case"PLAYLIST-TYPE":E.type=j.toUpperCase();break;case"MEDIA-SEQUENCE":C=E.startSN=parseInt(j);break;case"SKIP":var J=new S.AttrList(j),ee=J.decimalInteger("SKIPPED-SEGMENTS");if((0,b.isFiniteNumber)(ee)){E.skippedSegments=ee;for(var le=ee;le--;)O.unshift(null);C+=ee}var te=J.enumeratedString("RECENTLY-REMOVED-DATERANGES");te&&(E.recentlyRemovedDateranges=te.split("\t"));break;case"TARGETDURATION":E.targetduration=parseFloat(j);break;case"VERSION":E.version=parseInt(j);break;case"EXTM3U":break;case"ENDLIST":E.live=!1;break;case"#":(j||q)&&w.tagList.push(q?[j,q]:[j]);break;case"DISCONTINUITY":k++,w.tagList.push(["DIS"]);break;case"GAP":w.tagList.push([z]);break;case"BITRATE":w.tagList.push([z,j]);break;case"DATERANGE":var fe=new S.AttrList(j),ae=new _.DateRange(fe,E.dateRanges[fe.ID]);ae.isValid||E.skippedSegments?E.dateRanges[ae.id]=ae:g.logger.warn('Ignoring invalid DATERANGE tag: "'+j+'"'),w.tagList.push(["EXT-X-DATERANGE",j]);break;case"DISCONTINUITY-SEQUENCE":k=parseInt(j);break;case"KEY":var de,ie=new S.AttrList(j),he=ie.enumeratedString("METHOD"),ve=ie.URI,ge=ie.hexadecimalInteger("IV"),ce=ie.enumeratedString("KEYFORMATVERSIONS"),xe=ie.enumeratedString("KEYID"),ue=null!=(de=ie.enumeratedString("KEYFORMAT"))?de:"identity";if(["com.apple.streamingkeydelivery","com.microsoft.playready","urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed","com.widevine"].indexOf(ue)>-1){g.logger.warn("Keyformat "+ue+" is not supported from the manifest");continue}if("identity"!==ue)continue;he&&(H=x.LevelKey.fromURL(h,ve),ve&&["AES-128","SAMPLE-AES","SAMPLE-AES-CENC"].indexOf(he)>=0&&(H.method=he,H.keyFormat=ue,xe&&(H.keyID=xe),ce&&(H.keyFormatVersions=ce),H.iv=ge));break;case"START":var oe=new S.AttrList(j).decimalFloatingPoint("TIME-OFFSET");(0,b.isFiniteNumber)(oe)&&(E.startTimeOffset=oe);break;case"MAP":var me=new S.AttrList(j);if(w.duration){var se=new I.Fragment(a,h);o(se,me,u,H),w.initSegment=M=se,M.rawProgramDateTime&&!w.rawProgramDateTime&&(w.rawProgramDateTime=M.rawProgramDateTime)}else o(w,me,u,H),M=w,X=!0;break;case"SERVER-CONTROL":var re=new S.AttrList(j);E.canBlockReload=re.bool("CAN-BLOCK-RELOAD"),E.canSkipUntil=re.optionalFloat("CAN-SKIP-UNTIL",0),E.canSkipDateRanges=E.canSkipUntil>0&&re.bool("CAN-SKIP-DATERANGES"),E.partHoldBack=re.optionalFloat("PART-HOLD-BACK",0),E.holdBack=re.optionalFloat("HOLD-BACK",0);break;case"PART-INF":var Le=new S.AttrList(j);E.partTarget=Le.decimalFloatingPoint("PART-TARGET");break;case"PART":var pe=E.partList;pe||(pe=E.partList=[]);var _e=F>0?pe[pe.length-1]:void 0,Ce=F++,Ee=new I.Part(new S.AttrList(j),w,h,Ce,_e);pe.push(Ee),w.duration+=Ee.duration;break;case"PRELOAD-HINT":var Fe=new S.AttrList(j);E.preloadHint=Fe;break;case"RENDITION-REPORT":var Me=new S.AttrList(j);E.renditionReports=E.renditionReports||[],E.renditionReports.push(Me);break;default:g.logger.warn("line parsed but not handled: "+K)}}}N&&!N.relurl?(O.pop(),U-=N.duration,E.partList&&(E.fragmentHint=N)):E.partList&&(l(w,N),w.cc=k,E.fragmentHint=w);var De=O.length,Pe=O[0],Ae=O[De-1];if((U+=E.skippedSegments*E.targetduration)>0&&De&&Ae){E.averagetargetduration=U/De;var be=Ae.sn;E.endSN="initSegment"!==be?be:0,Pe&&(E.startCC=Pe.cc,Pe.initSegment||E.fragments.every(function(Re){return Re.relurl&&function t(e){var v,s;return r.test(null!=(v=null===(s=R.parseURL(e))||void 0===s?void 0:s.path)?v:"")}(Re.relurl)})&&(g.logger.warn("MP4 fragments found but no init segment (probably no MAP, incomplete M3U8), trying to fetch SIDX"),(w=new I.Fragment(a,h)).relurl=Ae.relurl,w.level=u,w.sn="initSegment",Pe.initSegment=w,E.needSidxRanges=!0))}else E.endSN=0,E.startCC=0;return E.fragmentHint&&(U+=E.fragmentHint.duration),E.totalduration=U,E.endCC=k,V>0&&function i(e,v){for(var s=e[v],h=v;h--;){var u=e[h];if(!u)return;u.programDateTime=s.programDateTime-1e3*u.duration,s=u}}(O,V),E},e}();function c(e,v){["video","audio","text"].forEach(function(s){var h=e.filter(function(a){return(0,L.isCodecType)(a,s)});if(h.length){var u=h.filter(function(a){return 0===a.lastIndexOf("avc1",0)||0===a.lastIndexOf("mp4a",0)});v[s+"Codec"]=u.length>0?u[0]:h[0],e=e.filter(function(a){return-1===h.indexOf(a)})}}),v.unknownCodecs=e}function n(e,v,s){var h=v[s];h&&(e[s]=h)}function l(e,v){e.rawProgramDateTime?e.programDateTime=Date.parse(e.rawProgramDateTime):null!=v&&v.programDateTime&&(e.programDateTime=v.endProgramDateTime),(0,b.isFiniteNumber)(e.programDateTime)||(e.programDateTime=null,e.rawProgramDateTime=null)}function o(e,v,s,h){e.relurl=v.URI,v.BYTERANGE&&e.setByteRange(v.BYTERANGE),e.level=s,e.sn="initSegment",h&&(e.levelkey=h),e.initSegment=null}},"./src/loader/playlist-loader.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>T});var b=A("./src/polyfills/number.ts"),R=A("./src/events.ts"),D=A("./src/errors.ts"),_=A("./src/utils/logger.ts"),I=A("./src/utils/mp4-tools.ts"),P=A("./src/loader/m3u8-parser.ts"),x=A("./src/types/loader.ts"),S=A("./src/utils/attr-list.ts");function L(p,f){var r=p.url;return(void 0===r||0===r.indexOf("data:"))&&(r=f.url),r}const T=function(){function p(r){this.hls=void 0,this.loaders=Object.create(null),this.hls=r,this.registerListeners()}var f=p.prototype;return f.startLoad=function(t){},f.stopLoad=function(){this.destroyInternalLoaders()},f.registerListeners=function(){var t=this.hls;t.on(R.Events.MANIFEST_LOADING,this.onManifestLoading,this),t.on(R.Events.LEVEL_LOADING,this.onLevelLoading,this),t.on(R.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.on(R.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},f.unregisterListeners=function(){var t=this.hls;t.off(R.Events.MANIFEST_LOADING,this.onManifestLoading,this),t.off(R.Events.LEVEL_LOADING,this.onLevelLoading,this),t.off(R.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.off(R.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},f.createInternalLoader=function(t){var d=this.hls.config,l=new(d.pLoader||d.loader)(d);return t.loader=l,this.loaders[t.type]=l,l},f.getInternalLoader=function(t){return this.loaders[t.type]},f.resetInternalLoader=function(t){this.loaders[t]&&delete this.loaders[t]},f.destroyInternalLoaders=function(){for(var t in this.loaders){var d=this.loaders[t];d&&d.destroy(),this.resetInternalLoader(t)}},f.destroy=function(){this.unregisterListeners(),this.destroyInternalLoaders()},f.onManifestLoading=function(t,d){this.load({id:null,groupId:null,level:0,responseType:"text",type:x.PlaylistContextType.MANIFEST,url:d.url,deliveryDirectives:null})},f.onLevelLoading=function(t,d){this.load({id:d.id,groupId:null,level:d.level,responseType:"text",type:x.PlaylistContextType.LEVEL,url:d.url,deliveryDirectives:d.deliveryDirectives})},f.onAudioTrackLoading=function(t,d){this.load({id:d.id,groupId:d.groupId,level:null,responseType:"text",type:x.PlaylistContextType.AUDIO_TRACK,url:d.url,deliveryDirectives:d.deliveryDirectives})},f.onSubtitleTrackLoading=function(t,d){this.load({id:d.id,groupId:d.groupId,level:null,responseType:"text",type:x.PlaylistContextType.SUBTITLE_TRACK,url:d.url,deliveryDirectives:d.deliveryDirectives})},f.load=function(t){var d,l,o,e,v,s,c=this.hls.config,n=this.getInternalLoader(t);if(n){var i=n.context;if(i&&i.url===t.url)return void _.logger.trace("[playlist-loader]: playlist request ongoing");_.logger.log("[playlist-loader]: aborting previous loader for type: "+t.type),n.abort()}switch(t.type){case x.PlaylistContextType.MANIFEST:l=c.manifestLoadingMaxRetry,o=c.manifestLoadingTimeOut,e=c.manifestLoadingRetryDelay,v=c.manifestLoadingMaxRetryTimeout;break;case x.PlaylistContextType.LEVEL:case x.PlaylistContextType.AUDIO_TRACK:case x.PlaylistContextType.SUBTITLE_TRACK:l=0,o=c.levelLoadingTimeOut;break;default:l=c.levelLoadingMaxRetry,o=c.levelLoadingTimeOut,e=c.levelLoadingRetryDelay,v=c.levelLoadingMaxRetryTimeout}if(n=this.createInternalLoader(t),null!==(d=t.deliveryDirectives)&&void 0!==d&&d.part&&(t.type===x.PlaylistContextType.LEVEL&&null!==t.level?s=this.hls.levels[t.level].details:t.type===x.PlaylistContextType.AUDIO_TRACK&&null!==t.id?s=this.hls.audioTracks[t.id].details:t.type===x.PlaylistContextType.SUBTITLE_TRACK&&null!==t.id&&(s=this.hls.subtitleTracks[t.id].details),s)){var h=s.partTarget,u=s.targetduration;h&&u&&(o=Math.min(1e3*Math.max(3*h,.8*u),o))}var a={timeout:o,maxRetry:l,retryDelay:e,maxRetryDelay:v,highWaterMark:0},m={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};n.load(t,a,m)},f.loadsuccess=function(t,d,c,n){if(void 0===n&&(n=null),c.isSidxRequest)return this.handleSidxRequest(t,c),void this.handlePlaylistLoaded(t,d,c,n);this.resetInternalLoader(c.type);var i=t.data;0===i.indexOf("#EXTM3U")?(d.parsing.start=performance.now(),i.indexOf("#EXTINF:")>0||i.indexOf("#EXT-X-TARGETDURATION:")>0?this.handleTrackOrLevelPlaylist(t,d,c,n):this.handleMasterPlaylist(t,d,c,n)):this.handleManifestParsingError(t,c,"no EXTM3U delimiter",n)},f.loaderror=function(t,d,c){void 0===c&&(c=null),this.handleNetworkError(d,c,!1,t)},f.loadtimeout=function(t,d,c){void 0===c&&(c=null),this.handleNetworkError(d,c,!0)},f.handleMasterPlaylist=function(t,d,c,n){var i=this.hls,l=t.data,o=L(t,c),e=P.default.parseMasterPlaylist(l,o),v=e.levels,s=e.sessionData;if(v.length){var h=v.map(function(M){return{id:M.attrs.AUDIO,audioCodec:M.audioCodec}}),u=v.map(function(M){return{id:M.attrs.SUBTITLES,textCodec:M.textCodec}}),a=P.default.parseMasterPlaylistMedia(l,o,"AUDIO",h),m=P.default.parseMasterPlaylistMedia(l,o,"SUBTITLES",u),E=P.default.parseMasterPlaylistMedia(l,o,"CLOSED-CAPTIONS");a.length&&!a.some(function(M){return!M.url})&&v[0].audioCodec&&!v[0].attrs.AUDIO&&(_.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),a.unshift({type:"main",name:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new S.AttrList({}),bitrate:0,url:""})),i.trigger(R.Events.MANIFEST_LOADED,{levels:v,audioTracks:a,subtitles:m,captions:E,url:o,stats:d,networkDetails:n,sessionData:s})}else this.handleManifestParsingError(t,c,"no level found in manifest",n)},f.handleTrackOrLevelPlaylist=function(t,d,c,n){var i=this.hls,l=c.id,o=c.level,e=c.type,v=L(t,c),s=(0,b.isFiniteNumber)(l)?l:0,h=(0,b.isFiniteNumber)(o)?o:s,u=function g(p){switch(p.type){case x.PlaylistContextType.AUDIO_TRACK:return x.PlaylistLevelType.AUDIO;case x.PlaylistContextType.SUBTITLE_TRACK:return x.PlaylistLevelType.SUBTITLE;default:return x.PlaylistLevelType.MAIN}}(c),a=P.default.parseLevelPlaylist(t.data,v,h,u,s);if(a.fragments.length){if(e===x.PlaylistContextType.MANIFEST){var m={attrs:new S.AttrList({}),bitrate:0,details:a,name:"",url:v};i.trigger(R.Events.MANIFEST_LOADED,{levels:[m],audioTracks:[],url:v,stats:d,networkDetails:n,sessionData:null})}if(d.parsing.end=performance.now(),a.needSidxRanges){var E,O=null===(E=a.fragments[0].initSegment)||void 0===E?void 0:E.url;this.load({url:O,isSidxRequest:!0,type:e,level:o,levelDetails:a,id:l,groupId:null,rangeStart:0,rangeEnd:2048,responseType:"arraybuffer",deliveryDirectives:null})}else c.levelDetails=a,this.handlePlaylistLoaded(t,d,c,n)}else i.trigger(R.Events.ERROR,{type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.LEVEL_EMPTY_ERROR,fatal:!1,url:v,reason:"no fragments found in level",level:"number"==typeof c.level?c.level:void 0})},f.handleSidxRequest=function(t,d){var c=new Uint8Array(t.data),n=(0,I.findBox)(c,["sidx"])[0];if(n){var i=(0,I.parseSegmentIndex)(n);if(i){var o=d.levelDetails;i.references.forEach(function(e,v){var s=e.info,h=o.fragments[v];if(0===h.byteRange.length&&h.setByteRange(String(1+s.end-s.start)+"@"+String(s.start)),h.initSegment){var u=(0,I.findBox)(c,["moov"])[0];h.initSegment.setByteRange(String(u?u.length:null)+"@0")}})}}},f.handleManifestParsingError=function(t,d,c,n){this.hls.trigger(R.Events.ERROR,{type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.MANIFEST_PARSING_ERROR,fatal:d.type===x.PlaylistContextType.MANIFEST,url:t.url,reason:c,response:t,context:d,networkDetails:n})},f.handleNetworkError=function(t,d,c,n){void 0===c&&(c=!1),_.logger.warn("[playlist-loader]: A network "+(c?"timeout":"error")+" occurred while loading "+t.type+" level: "+t.level+" id: "+t.id+' group-id: "'+t.groupId+'"');var i=D.ErrorDetails.UNKNOWN,l=!1,o=this.getInternalLoader(t);switch(t.type){case x.PlaylistContextType.MANIFEST:i=c?D.ErrorDetails.MANIFEST_LOAD_TIMEOUT:D.ErrorDetails.MANIFEST_LOAD_ERROR,l=!0;break;case x.PlaylistContextType.LEVEL:i=c?D.ErrorDetails.LEVEL_LOAD_TIMEOUT:D.ErrorDetails.LEVEL_LOAD_ERROR,l=!1;break;case x.PlaylistContextType.AUDIO_TRACK:i=c?D.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:D.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case x.PlaylistContextType.SUBTITLE_TRACK:i=c?D.ErrorDetails.SUBTITLE_TRACK_LOAD_TIMEOUT:D.ErrorDetails.SUBTITLE_LOAD_ERROR,l=!1}o&&this.resetInternalLoader(t.type);var e={type:D.ErrorTypes.NETWORK_ERROR,details:i,fatal:l,url:t.url,loader:o,context:t,networkDetails:d};n&&(e.response=n),this.hls.trigger(R.Events.ERROR,e)},f.handlePlaylistLoaded=function(t,d,c,n){var i=c.type,l=c.level,o=c.id,e=c.groupId,v=c.loader,s=c.levelDetails,h=c.deliveryDirectives;if(null!=s&&s.targetduration){if(v)switch(s.live&&(v.getCacheAge&&(s.ageHeader=v.getCacheAge()||0),(!v.getCacheAge||isNaN(s.ageHeader))&&(s.ageHeader=0)),i){case x.PlaylistContextType.MANIFEST:case x.PlaylistContextType.LEVEL:this.hls.trigger(R.Events.LEVEL_LOADED,{details:s,level:l||0,id:o||0,stats:d,networkDetails:n,deliveryDirectives:h});break;case x.PlaylistContextType.AUDIO_TRACK:this.hls.trigger(R.Events.AUDIO_TRACK_LOADED,{details:s,id:o||0,groupId:e||"",stats:d,networkDetails:n,deliveryDirectives:h});break;case x.PlaylistContextType.SUBTITLE_TRACK:this.hls.trigger(R.Events.SUBTITLE_TRACK_LOADED,{details:s,id:o||0,groupId:e||"",stats:d,networkDetails:n,deliveryDirectives:h})}}else this.handleManifestParsingError(t,c,"invalid target duration",n)},p}()},"./src/polyfills/number.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{MAX_SAFE_INTEGER:()=>R,isFiniteNumber:()=>b});var b=Number.isFinite||function(D){return"number"==typeof D&&isFinite(D)},R=Number.MAX_SAFE_INTEGER||9007199254740991},"./src/remux/aac-helper.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>R});const R=function(){function D(){}return D.getSilentFrame=function(I,P){if("mp4a.40.2"===I){if(1===P)return new Uint8Array([0,200,0,128,35,128]);if(2===P)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===P)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===P)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===P)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===P)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===P)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===P)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===P)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}},D}()},"./src/remux/mp4-generator.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>D});var b=Math.pow(2,32)-1,R=function(){function _(){}return _.init=function(){var P;for(P in _.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]})_.types.hasOwnProperty(P)&&(_.types[P]=[P.charCodeAt(0),P.charCodeAt(1),P.charCodeAt(2),P.charCodeAt(3)]);var x=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),S=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);_.HDLR_TYPES={video:x,audio:S};var g=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),L=new Uint8Array([0,0,0,0,0,0,0,0]);_.STTS=_.STSC=_.STCO=L,_.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),_.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),_.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),_.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var y=new Uint8Array([105,115,111,109]),T=new Uint8Array([97,118,99,49]),p=new Uint8Array([0,0,0,1]);_.FTYP=_.box(_.types.ftyp,y,p,y,T),_.DINF=_.box(_.types.dinf,_.box(_.types.dref,g))},_.box=function(P){for(var x=8,S=arguments.length,g=new Array(S>1?S-1:0),L=1;L<S;L++)g[L-1]=arguments[L];for(var y=g.length,T=y;y--;)x+=g[y].byteLength;var p=new Uint8Array(x);for(p[0]=x>>24&255,p[1]=x>>16&255,p[2]=x>>8&255,p[3]=255&x,p.set(P,4),y=0,x=8;y<T;y++)p.set(g[y],x),x+=g[y].byteLength;return p},_.hdlr=function(P){return _.box(_.types.hdlr,_.HDLR_TYPES[P])},_.mdat=function(P){return _.box(_.types.mdat,P)},_.mdhd=function(P,x){x*=P;var S=Math.floor(x/(b+1)),g=Math.floor(x%(b+1));return _.box(_.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,P>>24&255,P>>16&255,P>>8&255,255&P,S>>24,S>>16&255,S>>8&255,255&S,g>>24,g>>16&255,g>>8&255,255&g,85,196,0,0]))},_.mdia=function(P){return _.box(_.types.mdia,_.mdhd(P.timescale,P.duration),_.hdlr(P.type),_.minf(P))},_.mfhd=function(P){return _.box(_.types.mfhd,new Uint8Array([0,0,0,0,P>>24,P>>16&255,P>>8&255,255&P]))},_.minf=function(P){return _.box(_.types.minf,"audio"===P.type?_.box(_.types.smhd,_.SMHD):_.box(_.types.vmhd,_.VMHD),_.DINF,_.stbl(P))},_.moof=function(P,x,S){return _.box(_.types.moof,_.mfhd(P),_.traf(S,x))},_.moov=function(P){for(var x=P.length,S=[];x--;)S[x]=_.trak(P[x]);return _.box.apply(null,[_.types.moov,_.mvhd(P[0].timescale,P[0].duration)].concat(S).concat(_.mvex(P)))},_.mvex=function(P){for(var x=P.length,S=[];x--;)S[x]=_.trex(P[x]);return _.box.apply(null,[_.types.mvex].concat(S))},_.mvhd=function(P,x){x*=P;var S=Math.floor(x/(b+1)),g=Math.floor(x%(b+1)),L=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,P>>24&255,P>>16&255,P>>8&255,255&P,S>>24,S>>16&255,S>>8&255,255&S,g>>24,g>>16&255,g>>8&255,255&g,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return _.box(_.types.mvhd,L)},_.sdtp=function(P){var g,L,x=P.samples||[],S=new Uint8Array(4+x.length);for(g=0;g<x.length;g++)S[g+4]=(L=x[g].flags).dependsOn<<4|L.isDependedOn<<2|L.hasRedundancy;return _.box(_.types.sdtp,S)},_.stbl=function(P){return _.box(_.types.stbl,_.stsd(P),_.box(_.types.stts,_.STTS),_.box(_.types.stsc,_.STSC),_.box(_.types.stsz,_.STSZ),_.box(_.types.stco,_.STCO))},_.avc1=function(P){var g,L,y,x=[],S=[];for(g=0;g<P.sps.length;g++)x.push((y=(L=P.sps[g]).byteLength)>>>8&255),x.push(255&y),x=x.concat(Array.prototype.slice.call(L));for(g=0;g<P.pps.length;g++)S.push((y=(L=P.pps[g]).byteLength)>>>8&255),S.push(255&y),S=S.concat(Array.prototype.slice.call(L));var T=_.box(_.types.avcC,new Uint8Array([1,x[3],x[4],x[5],255,224|P.sps.length].concat(x).concat([P.pps.length]).concat(S))),p=P.width,f=P.height,r=P.pixelRatio[0],t=P.pixelRatio[1];return _.box(_.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,p>>8&255,255&p,f>>8&255,255&f,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),T,_.box(_.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),_.box(_.types.pasp,new Uint8Array([r>>24,r>>16&255,r>>8&255,255&r,t>>24,t>>16&255,t>>8&255,255&t])))},_.esds=function(P){var x=P.config.length;return new Uint8Array([0,0,0,0,3,23+x,0,1,0,4,15+x,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([x]).concat(P.config).concat([6,1,2]))},_.mp4a=function(P){var x=P.samplerate;return _.box(_.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,P.channelCount,0,16,0,0,0,0,x>>8&255,255&x,0,0]),_.box(_.types.esds,_.esds(P)))},_.mp3=function(P){var x=P.samplerate;return _.box(_.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,P.channelCount,0,16,0,0,0,0,x>>8&255,255&x,0,0]))},_.stsd=function(P){return _.box(_.types.stsd,_.STSD,"audio"===P.type?"mp3"===P.segmentCodec&&"mp3"===P.codec?_.mp3(P):_.mp4a(P):_.avc1(P))},_.tkhd=function(P){var x=P.id,S=P.duration*P.timescale,g=P.width,L=P.height,y=Math.floor(S/(b+1)),T=Math.floor(S%(b+1));return _.box(_.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,x>>24&255,x>>16&255,x>>8&255,255&x,0,0,0,0,y>>24,y>>16&255,y>>8&255,255&y,T>>24,T>>16&255,T>>8&255,255&T,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,g>>8&255,255&g,0,0,L>>8&255,255&L,0,0]))},_.traf=function(P,x){var S=_.sdtp(P),g=P.id,L=Math.floor(x/(b+1)),y=Math.floor(x%(b+1));return _.box(_.types.traf,_.box(_.types.tfhd,new Uint8Array([0,0,0,0,g>>24,g>>16&255,g>>8&255,255&g])),_.box(_.types.tfdt,new Uint8Array([1,0,0,0,L>>24,L>>16&255,L>>8&255,255&L,y>>24,y>>16&255,y>>8&255,255&y])),_.trun(P,S.length+16+20+8+16+8+8),S)},_.trak=function(P){return P.duration=P.duration||4294967295,_.box(_.types.trak,_.tkhd(P),_.mdia(P))},_.trex=function(P){var x=P.id;return _.box(_.types.trex,new Uint8Array([0,0,0,0,x>>24,x>>16&255,x>>8&255,255&x,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))},_.trun=function(P,x){var T,p,f,r,t,d,S=P.samples||[],g=S.length,L=12+16*g,y=new Uint8Array(L);for(y.set(["video"===P.type?1:0,0,15,1,g>>>24&255,g>>>16&255,g>>>8&255,255&g,(x+=8+L)>>>24&255,x>>>16&255,x>>>8&255,255&x],0),T=0;T<g;T++)y.set([(f=(p=S[T]).duration)>>>24&255,f>>>16&255,f>>>8&255,255&f,(r=p.size)>>>24&255,r>>>16&255,r>>>8&255,255&r,(t=p.flags).isLeading<<2|t.dependsOn,t.isDependedOn<<6|t.hasRedundancy<<4|t.paddingValue<<1|t.isNonSync,61440&t.degradPrio,15&t.degradPrio,(d=p.cts)>>>24&255,d>>>16&255,d>>>8&255,255&d],12+16*T);return _.box(_.types.trun,y)},_.initSegment=function(P){_.types||_.init();var x=_.moov(P),S=new Uint8Array(_.FTYP.byteLength+x.byteLength);return S.set(_.FTYP),S.set(x,_.FTYP.byteLength),S},_}();R.types=void 0,R.HDLR_TYPES=void 0,R.STTS=void 0,R.STSC=void 0,R.STCO=void 0,R.STSZ=void 0,R.VMHD=void 0,R.SMHD=void 0,R.STSD=void 0,R.FTYP=void 0,R.DINF=void 0;const D=R},"./src/remux/mp4-remuxer.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>r,flushTextTrackMetadataCueSamples:()=>c,flushTextTrackUserdataCueSamples:()=>n,normalizePts:()=>t});var b=A("./src/polyfills/number.ts"),R=A("./src/remux/aac-helper.ts"),D=A("./src/remux/mp4-generator.ts"),_=A("./src/events.ts"),I=A("./src/errors.ts"),P=A("./src/utils/logger.ts"),x=A("./src/types/loader.ts"),S=A("./src/utils/timescale-conversion.ts");function g(){return g=Object.assign?Object.assign.bind():function(o){for(var e=1;e<arguments.length;e++){var v=arguments[e];for(var s in v)Object.prototype.hasOwnProperty.call(v,s)&&(o[s]=v[s])}return o},g.apply(this,arguments)}var p=null,f=null,r=function(){function o(v,s,h,u){if(void 0===u&&(u=""),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=void 0,this._initDTS=void 0,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.observer=v,this.config=s,this.typeSupported=h,this.ISGenerated=!1,null===p){var m=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);p=m?parseInt(m[1]):0}if(null===f){var E=navigator.userAgent.match(/Safari\/(\d+)/i);f=E?parseInt(E[1]):0}}var e=o.prototype;return e.destroy=function(){},e.resetTimeStamp=function(s){P.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=s},e.resetNextTimestamp=function(){P.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1},e.resetInitSegment=function(){P.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1},e.getVideoStartPts=function(s){var h=!1,u=s.reduce(function(a,m){var E=m.pts-a;return E<-4294967296?(h=!0,t(a,m.pts)):E>0?a:m.pts},s[0].pts);return h&&P.logger.debug("PTS rollover detected"),u},e.remux=function(s,h,u,a,m,E,O,M){var C,F,U,k,N,w,K=m,G=m,V=h.pid>-1,X=h.samples.length,Y=s.samples.length>0,$=O&&X>0||X>1;if((!(s.pid>-1)||Y)&&(!V||$)||this.ISGenerated||O){this.ISGenerated||(U=this.generateIS(s,h,m));var q,z=this.isVideoContiguous,j=-1;if($&&(j=function d(o){for(var e=0;e<o.length;e++)if(o[e].key)return e;return-1}(h.samples),!z&&this.config.forceKeyFrameOnDiscontinuity))if(w=!0,j>0){P.logger.warn("[mp4-remuxer]: Dropped "+j+" out of "+X+" video samples due to a missing keyframe");var J=this.getVideoStartPts(h.samples);h.samples=h.samples.slice(j),h.dropped+=j,q=G+=(h.samples[0].pts-J)/h.inputTimeScale}else-1===j&&(P.logger.warn("[mp4-remuxer]: No keyframe found out of "+X+" video samples"),w=!1);if(this.ISGenerated){if(Y&&$){var ee=this.getVideoStartPts(h.samples),te=(t(s.samples[0].pts,ee)-ee)/h.inputTimeScale;K+=Math.max(0,te),G+=Math.max(0,-te)}if(Y){if(s.samplerate||(P.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),U=this.generateIS(s,h,m)),F=this.remuxAudio(s,K,this.isAudioContiguous,E,V||$||M===x.PlaylistLevelType.AUDIO?G:void 0),$){var fe=F?F.endPTS-F.startPTS:0;h.inputTimeScale||(P.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),U=this.generateIS(s,h,m)),C=this.remuxVideo(h,G,z,fe)}}else $&&(C=this.remuxVideo(h,G,z,0));C&&(C.firstKeyFrame=j,C.independent=-1!==j,C.firstKeyFramePTS=q)}}return this.ISGenerated&&(u.samples.length&&(N=c(u,m,this._initPTS,this._initDTS)),a.samples.length&&(k=n(a,m,this._initPTS))),{audio:F,video:C,initSegment:U,independent:w,text:k,id3:N}},e.generateIS=function(s,h,u){var F,U,k,a=s.samples,m=h.samples,E=this.typeSupported,O={},M=!(0,b.isFiniteNumber)(this._initPTS),C="audio/mp4";if(M&&(F=U=1/0),s.config&&a.length&&("mp3"===(s.timescale=s.samplerate,s.segmentCodec)&&(E.mpeg?(C="audio/mpeg",s.codec=""):E.mp3&&(s.codec="mp3")),O.audio={id:"audio",container:C,codec:s.codec,initSegment:"mp3"===s.segmentCodec&&E.mpeg?new Uint8Array(0):D.default.initSegment([s]),metadata:{channelCount:s.channelCount}},M&&(k=s.inputTimeScale,F=U=a[0].pts-Math.round(k*u))),h.sps&&h.pps&&m.length&&(h.timescale=h.inputTimeScale,O.video={id:"main",container:"video/mp4",codec:h.codec,initSegment:D.default.initSegment([h]),metadata:{width:h.width,height:h.height}},M)){k=h.inputTimeScale;var N=this.getVideoStartPts(m),w=Math.round(k*u);U=Math.min(U,t(m[0].dts,N)-w),F=Math.min(F,N-w)}if(Object.keys(O).length)return this.ISGenerated=!0,M&&(this._initPTS=F,this._initDTS=U),{tracks:O,initPTS:F,timescale:k}},e.remuxVideo=function(s,h,u,a){var N,w,m=s.inputTimeScale,E=s.samples,O=[],M=E.length,C=this._initPTS,F=this.nextAvcDts,U=8,k=this.videoSampleDuration,K=Number.POSITIVE_INFINITY,G=Number.NEGATIVE_INFINITY,H=!1;u&&null!==F||(F=h*m-(E[0].pts-t(E[0].dts,E[0].pts)));for(var Y=0;Y<M;Y++){var $=E[Y];$.pts=t($.pts-C,F),$.dts=t($.dts-C,F),$.dts<E[Y>0?Y-1:Y].dts&&(H=!0)}H&&E.sort(function(Ue,We){return Ue.dts-We.dts||Ue.pts-We.pts});var Q=E[E.length-1].dts-(N=E[0].dts),z=Q?Math.round(Q/(M-1)):k||s.inputTimeScale/30;if(u){var j=N-F,q=j>z,J=j<-1;if((q||J)&&(P.logger.warn(q?"AVC: "+(0,S.toMsFromMpegTsClock)(j,!0)+" ms ("+j+"dts) hole between fragments detected, filling it":"AVC: "+(0,S.toMsFromMpegTsClock)(-j,!0)+" ms ("+j+"dts) overlapping between fragments detected"),!J||F>E[0].pts)){var ee=E[0].pts-j;E[0].dts=N=F,E[0].pts=ee,P.logger.log("Video: First PTS/DTS adjusted: "+(0,S.toMsFromMpegTsClock)(ee,!0)+"/"+(0,S.toMsFromMpegTsClock)(N,!0)+", delta: "+(0,S.toMsFromMpegTsClock)(j,!0)+" ms")}}N=Math.max(0,N);for(var le=0,te=0,fe=0;fe<M;fe++){for(var ae=E[fe],de=ae.units,ie=de.length,he=0,ve=0;ve<ie;ve++)he+=de[ve].data.length;te+=he,le+=ie,ae.length=he,ae.dts=Math.max(ae.dts,N),K=Math.min(ae.pts,K),G=Math.max(ae.pts,G)}w=E[M-1].dts;var ce,ge=te+4*le+8;try{ce=new Uint8Array(ge)}catch(Ue){return void this.observer.emit(_.Events.ERROR,_.Events.ERROR,{type:I.ErrorTypes.MUX_ERROR,details:I.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:ge,reason:"fail allocating video mdat "+ge})}var xe=new DataView(ce.buffer);xe.setUint32(0,ge),ce.set(D.default.types.mdat,4);for(var ue=!1,Se=Number.POSITIVE_INFINITY,ne=Number.POSITIVE_INFINITY,oe=Number.NEGATIVE_INFINITY,me=Number.NEGATIVE_INFINITY,se=0;se<M;se++){for(var re=E[se],Le=re.units,pe=0,_e=0,Ce=Le.length;_e<Ce;_e++){var Ee=Le[_e],Fe=Ee.data,Me=Ee.data.byteLength;xe.setUint32(U,Me),ce.set(Fe,U+=4),U+=Me,pe+=4+Me}var De=void 0;if(se<M-1)k=E[se+1].dts-re.dts,De=E[se+1].pts-re.pts;else{var Pe=this.config,Ae=se>0?re.dts-E[se-1].dts:z;if(De=se>0?re.pts-E[se-1].pts:z,Pe.stretchShortVideoTrack&&null!==this.nextAudioPts){var be=Math.floor(Pe.maxBufferHole*m),Re=(a?K+a*m:this.nextAudioPts)-re.pts;Re>be?((k=Re-Ae)<0?k=Ae:ue=!0,P.logger.log("[mp4-remuxer]: It is approximately "+Re/90+" ms to the next segment; using duration "+k/90+" ms for the last video frame.")):k=Ae}else k=Ae}var Ge=Math.round(re.pts-re.dts);Se=Math.min(Se,k),oe=Math.max(oe,k),ne=Math.min(ne,De),me=Math.max(me,De),O.push(new i(re.key,k,pe,Ge))}if(O.length)if(p){if(p<70){var we=O[0].flags;we.dependsOn=2,we.isNonSync=0}}else if(f&&me-ne<oe-Se&&z/oe<.025&&0===O[0].cts){P.logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");for(var Be=N,ye=0,Ne=O.length;ye<Ne;ye++){var Ke=Be+O[ye].duration;O[ye].duration=ye<Ne-1?Ke+O[ye+1].cts-(Be+O[ye].cts):ye?O[ye-1].duration:z,O[ye].cts=0,Be=Ke}}console.assert(null!==k,"mp4SampleDuration must be computed"),this.nextAvcDts=F=w+(k=ue||!k?z:k),this.videoSampleDuration=k,this.isVideoContiguous=!0;var Xe={data1:D.default.moof(s.sequenceNumber++,N,g({},s,{samples:O})),data2:ce,startPTS:K/m,endPTS:(G+k)/m,startDTS:N/m,endDTS:F/m,type:"video",hasAudio:!1,hasVideo:!0,nb:O.length,dropped:s.dropped};return s.samples=[],s.dropped=0,console.assert(ce.length,"MDAT length must not be zero"),Xe},e.remuxAudio=function(s,h,u,a,m){var E=s.inputTimeScale,M=E/(s.samplerate?s.samplerate:E),C="aac"===s.segmentCodec?1024:1152,F=C*M,U=this._initPTS,k="mp3"===s.segmentCodec&&this.typeSupported.mpeg,N=[],w=void 0!==m,K=s.samples,G=k?0:8,H=this.nextAudioPts||-1,V=h*E;if(this.isAudioContiguous=u=u||K.length&&H>0&&(a&&Math.abs(V-H)<9e3||Math.abs(t(K[0].pts-U,V)-H)<20*F),K.forEach(function(Ee){Ee.pts=t(Ee.pts-U,V)}),!u||H<0){if(!(K=K.filter(function(Ee){return Ee.pts>=0})).length)return;H=0===m?0:a&&!w?Math.max(0,V):K[0].pts}if("aac"===s.segmentCodec)for(var X=this.config.maxAudioFramesDrift,Y=0,$=H;Y<K.length;Y++){var Q=K[Y],z=Q.pts,j=z-$,q=Math.abs(1e3*j/E);if(j<=-X*F&&w)0===Y&&(P.logger.warn("Audio frame @ "+(z/E).toFixed(3)+"s overlaps nextAudioPts by "+Math.round(1e3*j/E)+" ms."),this.nextAudioPts=H=$=z);else if(j>=X*F&&q<1e4&&w){var J=Math.round(j/F);($=z-J*F)<0&&(J--,$+=F),0===Y&&(this.nextAudioPts=H=$),P.logger.warn("[mp4-remuxer]: Injecting "+J+" audio frame @ "+($/E).toFixed(3)+"s due to "+Math.round(1e3*j/E)+" ms gap.");for(var ee=0;ee<J;ee++){var le=Math.max($,0),te=R.default.getSilentFrame(s.manifestCodec||s.codec,s.channelCount);te||(P.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),te=Q.unit.subarray()),K.splice(Y,0,{unit:te,pts:le}),$+=F,Y++}}Q.pts=$,$+=F}for(var de,fe=null,ae=null,ie=0,he=K.length;he--;)ie+=K[he].unit.byteLength;for(var ve=0,ge=K.length;ve<ge;ve++){var ce=K[ve],xe=ce.unit,ue=ce.pts;if(null!==ae)N[ve-1].duration=Math.round((ue-ae)/M);else{if(u&&"aac"===s.segmentCodec&&(ue=H),fe=ue,!(ie>0))return;ie+=G;try{de=new Uint8Array(ie)}catch(Ee){return void this.observer.emit(_.Events.ERROR,_.Events.ERROR,{type:I.ErrorTypes.MUX_ERROR,details:I.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:ie,reason:"fail allocating audio mdat "+ie})}k||(new DataView(de.buffer).setUint32(0,ie),de.set(D.default.types.mdat,4))}de.set(xe,G);var oe=xe.byteLength;G+=oe,N.push(new i(!0,C,oe,0)),ae=ue}var me=N.length;if(me){this.nextAudioPts=H=ae+M*N[N.length-1].duration;var re=k?new Uint8Array(0):D.default.moof(s.sequenceNumber++,fe/M,g({},s,{samples:N}));s.samples=[];var Le=fe/E,pe=H/E,Ce={data1:re,data2:de,startPTS:Le,endPTS:pe,startDTS:Le,endDTS:pe,type:"audio",hasAudio:!0,hasVideo:!1,nb:me};return this.isAudioContiguous=!0,console.assert(de.length,"MDAT length must not be zero"),Ce}},e.remuxEmptyAudio=function(s,h,u,a){var m=s.inputTimeScale,M=this.nextAudioPts,C=(null!==M?M:a.startDTS*m)+this._initDTS,U=m/(s.samplerate?s.samplerate:m)*1024,k=Math.ceil((a.endDTS*m+this._initDTS-C)/U),N=R.default.getSilentFrame(s.manifestCodec||s.codec,s.channelCount);if(P.logger.warn("[mp4-remuxer]: remux empty Audio"),N){for(var w=[],K=0;K<k;K++){var G=C+K*U;w.push({unit:N,pts:G,dts:G})}return s.samples=w,this.remuxAudio(s,h,u,!1)}P.logger.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec")},o}();function t(o,e){var v;if(null===e)return o;for(v=e<o?-8589934592:8589934592;Math.abs(o-e)>4294967296;)o+=v;return o}function c(o,e,v,s){var h=o.samples.length;if(h){for(var u=o.inputTimeScale,a=0;a<h;a++){var m=o.samples[a];m.pts=t(m.pts-v,e*u)/u,m.dts=t(m.dts-s,e*u)/u}var E=o.samples;return o.samples=[],{samples:E}}}function n(o,e,v){var s=o.samples.length;if(s){for(var h=o.inputTimeScale,u=0;u<s;u++){var a=o.samples[u];a.pts=t(a.pts-v,e*h)/h}o.samples.sort(function(E,O){return E.pts-O.pts});var m=o.samples;return o.samples=[],{samples:m}}}var i=function(e,v,s,h){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=v,this.size=s,this.cts=h,this.flags=new l(e)},l=function(e){this.isLeading=0,this.isDependedOn=0,this.hasRedundancy=0,this.degradPrio=0,this.dependsOn=1,this.isNonSync=1,this.dependsOn=e?2:1,this.isNonSync=e?0:1}},"./src/remux/passthrough-remuxer.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>S});var b=A("./src/polyfills/number.ts"),R=A("./src/remux/mp4-remuxer.ts"),D=A("./src/utils/mp4-tools.ts"),_=A("./src/loader/fragment.ts"),I=A("./src/utils/logger.ts");function x(g,L){var y=null==g?void 0:g.codec;return y&&y.length>4?y:"hvc1"===y||"hev1"===y?"hvc1.1.c.L120.90":"av01"===y?"av01.0.04M.08":"avc1"===y||L===_.ElementaryStreamTypes.VIDEO?"avc1.42e01e":"mp4a.40.5"}const S=function(){function g(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=void 0,this.initTracks=void 0,this.lastEndTime=null}var L=g.prototype;return L.destroy=function(){},L.resetTimeStamp=function(T){this.initPTS=T,this.lastEndTime=null},L.resetNextTimestamp=function(){this.lastEndTime=null},L.resetInitSegment=function(T,p,f){this.audioCodec=p,this.videoCodec=f,this.generateInitSegment(T),this.emitInitSegment=!0},L.generateInitSegment=function(T){var p=this.audioCodec,f=this.videoCodec;if(!T||!T.byteLength)return this.initTracks=void 0,void(this.initData=void 0);var r=this.initData=(0,D.parseInitSegment)(T);p||(p=x(r.audio,_.ElementaryStreamTypes.AUDIO)),f||(f=x(r.video,_.ElementaryStreamTypes.VIDEO));var t={};r.audio&&r.video?t.audiovideo={container:"video/mp4",codec:p+","+f,initSegment:T,id:"main"}:r.audio?t.audio={container:"audio/mp4",codec:p,initSegment:T,id:"audio"}:r.video?t.video={container:"video/mp4",codec:f,initSegment:T,id:"main"}:I.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=t},L.remux=function(T,p,f,r,t){var d,c=this.initPTS,n=this.lastEndTime,i={audio:void 0,video:void 0,text:r,id3:f,initSegment:void 0};(0,b.isFiniteNumber)(n)||(n=this.lastEndTime=t||0);var l=p.samples;if(!l||!l.length)return i;var o={initPTS:void 0,timescale:1},e=this.initData;if((!e||!e.length)&&(this.generateInitSegment(l),e=this.initData),!e||!e.length)return I.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),i;this.emitInitSegment&&(o.tracks=this.initTracks,this.emitInitSegment=!1);var v=(0,D.getStartDTS)(e,l);(0,b.isFiniteNumber)(c)||(this.initPTS=o.initPTS=c=v-t);var s=(0,D.getDuration)(l,e),h=T?v-c:n,u=h+s;(0,D.offsetStartDTS)(e,l,c),s>0?this.lastEndTime=u:(I.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());var a=!!e.audio,m=!!e.video,E="";a&&(E+="audio"),m&&(E+="video");var O={data1:l,startPTS:h,startDTS:h,endPTS:u,endDTS:u,type:E,hasAudio:a,hasVideo:m,nb:1,dropped:0};i.audio="audio"===O.type?O:void 0,i.video="audio"!==O.type?O:void 0,i.initSegment=o;var M=null!=(d=this.initPTS)?d:0;return i.id3=(0,R.flushTextTrackMetadataCueSamples)(f,t,M,M),r.samples.length&&(i.text=(0,R.flushTextTrackUserdataCueSamples)(r,t,M)),i},g}()},"./src/task-loop.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>b});var b=function(){function R(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}var D=R.prototype;return D.destroy=function(){this.onHandlerDestroying(),this.onHandlerDestroyed()},D.onHandlerDestroying=function(){this.clearNextTick(),this.clearInterval()},D.onHandlerDestroyed=function(){},D.hasInterval=function(){return!!this._tickInterval},D.hasNextTick=function(){return!!this._tickTimer},D.setInterval=function(I){return!this._tickInterval&&(this._tickInterval=self.setInterval(this._boundTick,I),!0)},D.clearInterval=function(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)},D.clearNextTick=function(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)},D.tick=function(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)},D.tickImmediate=function(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)},D.doTick=function(){},R}()},"./src/types/cmcd.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{CMCDObjectType:()=>R,CMCDStreamType:()=>_,CMCDStreamingFormat:()=>D,CMCDVersion:()=>b});var b=1,R=(()=>{return(I=R||(R={})).MANIFEST="m",I.AUDIO="a",I.VIDEO="v",I.MUXED="av",I.INIT="i",I.CAPTION="c",I.TIMED_TEXT="tt",I.KEY="k",I.OTHER="o",R;var I})(),D=(()=>{return(I=D||(D={})).DASH="d",I.HLS="h",I.SMOOTH="s",I.OTHER="o",D;var I})(),_=(()=>{return(I=_||(_={})).VOD="v",I.LIVE="l",_;var I})()},"./src/types/demuxer.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{MetadataSchema:()=>b});var b=(()=>{return(R=b||(b={})).audioId3="org.id3",R.dateRange="com.apple.quicktime.HLS",R.emsg="https://aomedia.org/emsg/ID3",b;var R})()},"./src/types/level.ts":(W,B,A)=>{"use strict";function b(x,S){for(var g=0;g<S.length;g++){var L=S[g];L.enumerable=L.enumerable||!1,L.configurable=!0,"value"in L&&(L.writable=!0),Object.defineProperty(x,L.key,L)}}A.r(B),A.d(B,{HlsSkip:()=>D,HlsUrlParameters:()=>I,Level:()=>P,getSkipValue:()=>_});var D=(()=>{return(x=D||(D={})).No="",x.Yes="YES",x.v2="v2",D;var x})();function _(x,S){var g=x.canSkipUntil;return g&&(void 0!==S?S-x.endSN:0)<g?x.canSkipDateRanges?D.v2:D.Yes:D.No}var I=function(){function x(g,L,y){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=g,this.part=L,this.skip=y}return x.prototype.addDirectives=function(L){var y=new self.URL(L);return void 0!==this.msn&&y.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&y.searchParams.set("_HLS_part",this.part.toString()),this.skip&&y.searchParams.set("_HLS_skip",this.skip),y.toString()},x}(),P=function(){function x(S){this.attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.unknownCodecs=void 0,this.audioGroupIds=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.textGroupIds=void 0,this.url=void 0,this._urlId=0,this.url=[S.url],this.attrs=S.attrs,this.bitrate=S.bitrate,S.details&&(this.details=S.details),this.id=S.id||0,this.name=S.name,this.width=S.width||0,this.height=S.height||0,this.audioCodec=S.audioCodec,this.videoCodec=S.videoCodec,this.unknownCodecs=S.unknownCodecs,this.codecSet=[S.videoCodec,S.audioCodec].filter(function(g){return g}).join(",").replace(/\.[^.,]+/g,"")}return function R(x,S,g){S&&b(x.prototype,S),g&&b(x,g),Object.defineProperty(x,"prototype",{writable:!1})}(x,[{key:"maxBitrate",get:function(){return Math.max(this.realBitrate,this.bitrate)}},{key:"uri",get:function(){return this.url[this._urlId]||""}},{key:"urlId",get:function(){return this._urlId},set:function(g){var L=g%this.url.length;this._urlId!==L&&(this.details=void 0,this._urlId=L)}}]),x}()},"./src/types/loader.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{PlaylistContextType:()=>b,PlaylistLevelType:()=>R});var b=(()=>{return(D=b||(b={})).MANIFEST="manifest",D.LEVEL="level",D.AUDIO_TRACK="audioTrack",D.SUBTITLE_TRACK="subtitleTrack",b;var D})(),R=(()=>{return(D=R||(R={})).MAIN="main",D.AUDIO="audio",D.SUBTITLE="subtitle",R;var D})()},"./src/types/transmuxer.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{ChunkMetadata:()=>b});var b=function(_,I,P,x,S,g){void 0===x&&(x=0),void 0===S&&(S=-1),void 0===g&&(g=!1),this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing={start:0,executeStart:0,executeEnd:0,end:0},this.buffering={audio:{start:0,executeStart:0,executeEnd:0,end:0},video:{start:0,executeStart:0,executeEnd:0,end:0},audiovideo:{start:0,executeStart:0,executeEnd:0,end:0}},this.level=_,this.sn=I,this.id=P,this.size=x,this.part=S,this.partial=g}},"./src/utils/attr-list.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{AttrList:()=>D});var b=/^(\d+)x(\d+)$/,R=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g,D=function(){function _(P){for(var x in"string"==typeof P&&(P=_.parseAttrList(P)),P)P.hasOwnProperty(x)&&(this[x]=P[x])}var I=_.prototype;return I.decimalInteger=function(x){var S=parseInt(this[x],10);return S>Number.MAX_SAFE_INTEGER?1/0:S},I.hexadecimalInteger=function(x){if(this[x]){var S=(this[x]||"0x").slice(2);S=(1&S.length?"0":"")+S;for(var g=new Uint8Array(S.length/2),L=0;L<S.length/2;L++)g[L]=parseInt(S.slice(2*L,2*L+2),16);return g}return null},I.hexadecimalIntegerAsNumber=function(x){var S=parseInt(this[x],16);return S>Number.MAX_SAFE_INTEGER?1/0:S},I.decimalFloatingPoint=function(x){return parseFloat(this[x])},I.optionalFloat=function(x,S){var g=this[x];return g?parseFloat(g):S},I.enumeratedString=function(x){return this[x]},I.bool=function(x){return"YES"===this[x]},I.decimalResolution=function(x){var S=b.exec(this[x]);if(null!==S)return{width:parseInt(S[1],10),height:parseInt(S[2],10)}},_.parseAttrList=function(x){var S,g={};for(R.lastIndex=0;null!==(S=R.exec(x));){var y=S[2];0===y.indexOf('"')&&y.lastIndexOf('"')===y.length-1&&(y=y.slice(1,-1)),g[S[1]]=y}return g},_}()},"./src/utils/binary-search.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>R});const R={search:function(_,I){for(var P=0,x=_.length-1,S=null,g=null;P<=x;){var L=I(g=_[S=(P+x)/2|0]);if(L>0)P=S+1;else{if(!(L<0))return g;x=S-1}}return null}}},"./src/utils/buffer-helper.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{BufferHelper:()=>D});var b=A("./src/utils/logger.ts"),R={length:0,start:function(){return 0},end:function(){return 0}},D=function(){function _(){}return _.isBuffered=function(P,x){try{if(P)for(var S=_.getBuffered(P),g=0;g<S.length;g++)if(x>=S.start(g)&&x<=S.end(g))return!0}catch(L){}return!1},_.bufferInfo=function(P,x,S){try{if(P){var y,g=_.getBuffered(P),L=[];for(y=0;y<g.length;y++)L.push({start:g.start(y),end:g.end(y)});return this.bufferedInfo(L,x,S)}}catch(T){}return{len:0,start:x,end:x,nextStart:void 0}},_.bufferedInfo=function(P,x,S){x=Math.max(0,x),P.sort(function(i,l){return i.start-l.start||l.end-i.end});var g=[];if(S)for(var L=0;L<P.length;L++){var y=g.length;if(y){var T=g[y-1].end;P[L].start-T<S?P[L].end>T&&(g[y-1].end=P[L].end):g.push(P[L])}else g.push(P[L])}else g=P;for(var f,p=0,r=x,t=x,d=0;d<g.length;d++){var c=g[d].start,n=g[d].end;if(x+S>=c&&x<n)r=c,p=(t=n)-x;else if(x+S<c){f=c;break}}return{len:p,start:r||0,end:t||0,nextStart:f}},_.getBuffered=function(P){try{return P.buffered}catch(x){return b.logger.log("failed to get media.buffered",x),R}},_}()},"./src/utils/cea-608-parser.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{CaptionScreen:()=>d,Row:()=>t,default:()=>e});var b=A("./src/utils/logger.ts"),R={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},D=function(s){var h=s;return R.hasOwnProperty(s)&&(h=R[s]),String.fromCharCode(h)},_=15,I=100,P={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},x={17:2,18:4,21:6,22:8,23:10,19:13,20:15},S={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},g={25:2,26:4,29:6,30:8,31:10,27:13,28:15},L=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],y=(()=>{return(v=y||(y={}))[v.ERROR=0]="ERROR",v[v.TEXT=1]="TEXT",v[v.WARNING=2]="WARNING",v[v.INFO=2]="INFO",v[v.DEBUG=3]="DEBUG",v[v.DATA=3]="DATA",y;var v})(),T=function(){function v(){this.time=null,this.verboseLevel=y.ERROR}return v.prototype.log=function(u,a){this.verboseLevel>=u&&b.logger.log(this.time+" ["+u+"] "+a)},v}(),p=function(s){for(var h=[],u=0;u<s.length;u++)h.push(s[u].toString(16));return h},f=function(){function v(h,u,a,m,E){this.foreground=void 0,this.underline=void 0,this.italics=void 0,this.background=void 0,this.flash=void 0,this.foreground=h||"white",this.underline=u||!1,this.italics=a||!1,this.background=m||"black",this.flash=E||!1}var s=v.prototype;return s.reset=function(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1},s.setStyles=function(u){for(var a=["foreground","underline","italics","background","flash"],m=0;m<a.length;m++){var E=a[m];u.hasOwnProperty(E)&&(this[E]=u[E])}},s.isDefault=function(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash},s.equals=function(u){return this.foreground===u.foreground&&this.underline===u.underline&&this.italics===u.italics&&this.background===u.background&&this.flash===u.flash},s.copy=function(u){this.foreground=u.foreground,this.underline=u.underline,this.italics=u.italics,this.background=u.background,this.flash=u.flash},s.toString=function(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash},v}(),r=function(){function v(h,u,a,m,E,O){this.uchar=void 0,this.penState=void 0,this.uchar=h||" ",this.penState=new f(u,a,m,E,O)}var s=v.prototype;return s.reset=function(){this.uchar=" ",this.penState.reset()},s.setChar=function(u,a){this.uchar=u,this.penState.copy(a)},s.setPenState=function(u){this.penState.copy(u)},s.equals=function(u){return this.uchar===u.uchar&&this.penState.equals(u.penState)},s.copy=function(u){this.uchar=u.uchar,this.penState.copy(u.penState)},s.isEmpty=function(){return" "===this.uchar&&this.penState.isDefault()},v}(),t=function(){function v(h){this.chars=void 0,this.pos=void 0,this.currPenState=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chars=[];for(var u=0;u<I;u++)this.chars.push(new r);this.logger=h,this.pos=0,this.currPenState=new f}var s=v.prototype;return s.equals=function(u){for(var a=!0,m=0;m<I;m++)if(!this.chars[m].equals(u.chars[m])){a=!1;break}return a},s.copy=function(u){for(var a=0;a<I;a++)this.chars[a].copy(u.chars[a])},s.isEmpty=function(){for(var u=!0,a=0;a<I;a++)if(!this.chars[a].isEmpty()){u=!1;break}return u},s.setCursor=function(u){this.pos!==u&&(this.pos=u),this.pos<0?(this.logger.log(y.DEBUG,"Negative cursor position "+this.pos),this.pos=0):this.pos>I&&(this.logger.log(y.DEBUG,"Too large cursor position "+this.pos),this.pos=I)},s.moveCursor=function(u){var a=this.pos+u;if(u>1)for(var m=this.pos+1;m<a+1;m++)this.chars[m].setPenState(this.currPenState);this.setCursor(a)},s.backSpace=function(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)},s.insertChar=function(u){u>=144&&this.backSpace();var a=D(u);this.pos>=I?this.logger.log(y.ERROR,"Cannot insert "+u.toString(16)+" ("+a+") at position "+this.pos+". Skipping it!"):(this.chars[this.pos].setChar(a,this.currPenState),this.moveCursor(1))},s.clearFromPos=function(u){var a;for(a=u;a<I;a++)this.chars[a].reset()},s.clear=function(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()},s.clearToEndOfRow=function(){this.clearFromPos(this.pos)},s.getTextString=function(){for(var u=[],a=!0,m=0;m<I;m++){var E=this.chars[m].uchar;" "!==E&&(a=!1),u.push(E)}return a?"":u.join("")},s.setPenStyles=function(u){this.currPenState.setStyles(u),this.chars[this.pos].setPenState(this.currPenState)},v}(),d=function(){function v(h){this.rows=void 0,this.currRow=void 0,this.nrRollUpRows=void 0,this.lastOutputScreen=void 0,this.logger=void 0,this.rows=[];for(var u=0;u<_;u++)this.rows.push(new t(h));this.logger=h,this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.reset()}var s=v.prototype;return s.reset=function(){for(var u=0;u<_;u++)this.rows[u].clear();this.currRow=14},s.equals=function(u){for(var a=!0,m=0;m<_;m++)if(!this.rows[m].equals(u.rows[m])){a=!1;break}return a},s.copy=function(u){for(var a=0;a<_;a++)this.rows[a].copy(u.rows[a])},s.isEmpty=function(){for(var u=!0,a=0;a<_;a++)if(!this.rows[a].isEmpty()){u=!1;break}return u},s.backSpace=function(){this.rows[this.currRow].backSpace()},s.clearToEndOfRow=function(){this.rows[this.currRow].clearToEndOfRow()},s.insertChar=function(u){this.rows[this.currRow].insertChar(u)},s.setPen=function(u){this.rows[this.currRow].setPenStyles(u)},s.moveCursor=function(u){this.rows[this.currRow].moveCursor(u)},s.setCursor=function(u){this.logger.log(y.INFO,"setCursor: "+u),this.rows[this.currRow].setCursor(u)},s.setPAC=function(u){this.logger.log(y.INFO,"pacData = "+JSON.stringify(u));var a=u.row-1;if(this.nrRollUpRows&&a<this.nrRollUpRows-1&&(a=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==a){for(var m=0;m<_;m++)this.rows[m].clear();var E=this.currRow+1-this.nrRollUpRows,O=this.lastOutputScreen;if(O){var M=O.rows[E].cueStartTime,C=this.logger.time;if(M&&null!==C&&M<C)for(var F=0;F<this.nrRollUpRows;F++)this.rows[a-this.nrRollUpRows+F+1].copy(O.rows[E+F])}}this.currRow=a;var U=this.rows[this.currRow];if(null!==u.indent){var N=Math.max(u.indent-1,0);U.setCursor(u.indent),u.color=U.chars[N].penState.foreground}this.setPen({foreground:u.color,underline:u.underline,italics:u.italics,background:"black",flash:!1})},s.setBkgData=function(u){this.logger.log(y.INFO,"bkgData = "+JSON.stringify(u)),this.backSpace(),this.setPen(u),this.insertChar(32)},s.setRollUpRows=function(u){this.nrRollUpRows=u},s.rollUp=function(){if(null!==this.nrRollUpRows){this.logger.log(y.TEXT,this.getDisplayText());var a=this.rows.splice(this.currRow+1-this.nrRollUpRows,1)[0];a.clear(),this.rows.splice(this.currRow,0,a),this.logger.log(y.INFO,"Rolling up")}else this.logger.log(y.DEBUG,"roll_up but nrRollUpRows not set yet")},s.getDisplayText=function(u){u=u||!1;for(var a=[],m="",O=0;O<_;O++){var M=this.rows[O].getTextString();M&&a.push(u?"Row "+(O+1)+": '"+M+"'":M.trim())}return a.length>0&&(m=u?"["+a.join(" | ")+"]":a.join("\n")),m},s.getTextAndFormat=function(){return this.rows},v}(),c=function(){function v(h,u,a){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=h,this.outputFilter=u,this.mode=null,this.verbose=0,this.displayedMemory=new d(a),this.nonDisplayedMemory=new d(a),this.lastOutputScreen=new d(a),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=a}var s=v.prototype;return s.reset=function(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null},s.getHandler=function(){return this.outputFilter},s.setHandler=function(u){this.outputFilter=u},s.setPAC=function(u){this.writeScreen.setPAC(u)},s.setBkgData=function(u){this.writeScreen.setBkgData(u)},s.setMode=function(u){u!==this.mode&&(this.mode=u,this.logger.log(y.INFO,"MODE="+u),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=u)},s.insertChars=function(u){for(var a=0;a<u.length;a++)this.writeScreen.insertChar(u[a]);this.logger.log(y.INFO,(this.writeScreen===this.displayedMemory?"DISP":"NON_DISP")+": "+this.writeScreen.getDisplayText(!0)),("MODE_PAINT-ON"===this.mode||"MODE_ROLL-UP"===this.mode)&&(this.logger.log(y.TEXT,"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())},s.ccRCL=function(){this.logger.log(y.INFO,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")},s.ccBS=function(){this.logger.log(y.INFO,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())},s.ccAOF=function(){},s.ccAON=function(){},s.ccDER=function(){this.logger.log(y.INFO,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()},s.ccRU=function(u){this.logger.log(y.INFO,"RU("+u+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(u)},s.ccFON=function(){this.logger.log(y.INFO,"FON - Flash On"),this.writeScreen.setPen({flash:!0})},s.ccRDC=function(){this.logger.log(y.INFO,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")},s.ccTR=function(){this.logger.log(y.INFO,"TR"),this.setMode("MODE_TEXT")},s.ccRTD=function(){this.logger.log(y.INFO,"RTD"),this.setMode("MODE_TEXT")},s.ccEDM=function(){this.logger.log(y.INFO,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)},s.ccCR=function(){this.logger.log(y.INFO,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)},s.ccENM=function(){this.logger.log(y.INFO,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()},s.ccEOC=function(){if(this.logger.log(y.INFO,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){var u=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=u,this.writeScreen=this.nonDisplayedMemory,this.logger.log(y.TEXT,"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)},s.ccTO=function(u){this.logger.log(y.INFO,"TO("+u+") - Tab Offset"),this.writeScreen.moveCursor(u)},s.ccMIDROW=function(u){var a={flash:!1};if(a.underline=u%2==1,a.italics=u>=46,a.italics)a.foreground="white";else{var m=Math.floor(u/2)-16;a.foreground=["white","green","blue","cyan","red","yellow","magenta"][m]}this.logger.log(y.INFO,"MIDROW: "+JSON.stringify(a)),this.writeScreen.setPen(a)},s.outputDataUpdate=function(u){void 0===u&&(u=!1);var a=this.logger.time;null!==a&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,a,this.lastOutputScreen),u&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:a):this.cueStartTime=a,this.lastOutputScreen.copy(this.displayedMemory))},s.cueSplitAtTime=function(u){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,u,this.displayedMemory),this.cueStartTime=u))},v}();function i(v,s,h){h.a=v,h.b=s}function l(v,s,h){return h.a===v&&h.b===s}const e=function(){function v(h,u,a){this.channels=void 0,this.currentChannel=0,this.cmdHistory=void 0,this.logger=void 0;var m=new T;this.channels=[null,new c(h,u,m),new c(h+1,a,m)],this.cmdHistory={a:null,b:null},this.logger=m}var s=v.prototype;return s.getHandler=function(u){return this.channels[u].getHandler()},s.setHandler=function(u,a){this.channels[u].setHandler(a)},s.addData=function(u,a){var m,E,O,M=!1;this.logger.time=u;for(var C=0;C<a.length;C+=2)if(O=127&a[C+1],0!=(E=127&a[C])||0!==O){if(this.logger.log(y.DATA,"["+p([a[C],a[C+1]])+"] -> ("+p([E,O])+")"),(m=this.parseCmd(E,O))||(m=this.parseMidrow(E,O)),m||(m=this.parsePAC(E,O)),m||(m=this.parseBackgroundAttributes(E,O)),!m&&(M=this.parseChars(E,O))){var F=this.currentChannel;F&&F>0?this.channels[F].insertChars(M):this.logger.log(y.WARNING,"No channel found yet. TEXT-MODE?")}!m&&!M&&this.logger.log(y.WARNING,"Couldn't parse cleaned data "+p([E,O])+" orig: "+p([a[C],a[C+1]]))}},s.parseCmd=function(u,a){var m=this.cmdHistory;if(!((20===u||28===u||21===u||29===u)&&a>=32&&a<=47||(23===u||31===u)&&a>=33&&a<=35))return!1;if(l(u,a,m))return i(null,null,m),this.logger.log(y.DEBUG,"Repeated command ("+p([u,a])+") is dropped"),!0;var M=20===u||21===u||23===u?1:2,C=this.channels[M];return 20===u||21===u||28===u||29===u?32===a?C.ccRCL():33===a?C.ccBS():34===a?C.ccAOF():35===a?C.ccAON():36===a?C.ccDER():37===a?C.ccRU(2):38===a?C.ccRU(3):39===a?C.ccRU(4):40===a?C.ccFON():41===a?C.ccRDC():42===a?C.ccTR():43===a?C.ccRTD():44===a?C.ccEDM():45===a?C.ccCR():46===a?C.ccENM():47===a&&C.ccEOC():C.ccTO(a-32),i(u,a,m),this.currentChannel=M,!0},s.parseMidrow=function(u,a){var m=0;if((17===u||25===u)&&a>=32&&a<=47){if((m=17===u?1:2)!==this.currentChannel)return this.logger.log(y.ERROR,"Mismatch channel in midrow parsing"),!1;var E=this.channels[m];return!!E&&(E.ccMIDROW(a),this.logger.log(y.DEBUG,"MIDROW ("+p([u,a])+")"),!0)}return!1},s.parsePAC=function(u,a){var E=this.cmdHistory;if(!((u>=17&&u<=23||u>=25&&u<=31)&&a>=64&&a<=127||(16===u||24===u)&&a>=64&&a<=95))return!1;if(l(u,a,E))return i(null,null,E),!0;var C=u<=23?1:2,F=this.channels[C];return!!F&&(F.setPAC(this.interpretPAC(a>=64&&a<=95?1===C?P[u]:S[u]:1===C?x[u]:g[u],a)),i(u,a,E),this.currentChannel=C,!0)},s.interpretPAC=function(u,a){var m,E={color:null,italics:!1,indent:null,underline:!1,row:u};return E.underline=1==(1&(m=a>95?a-96:a-64)),m<=13?E.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(m/2)]:m<=15?(E.italics=!0,E.color="white"):E.indent=4*Math.floor((m-16)/2),E},s.parseChars=function(u,a){var m,M,E=null,O=null;if(u>=25?(m=2,O=u-8):(m=1,O=u),O>=17&&O<=19?(this.logger.log(y.INFO,"Special char '"+D(M=17===O?a+80:18===O?a+112:a+144)+"' in channel "+m),E=[M]):u>=32&&u<=127&&(E=0===a?[u]:[u,a]),E){var C=p(E);this.logger.log(y.DEBUG,"Char codes =  "+C.join(",")),i(u,a,this.cmdHistory)}return E},s.parseBackgroundAttributes=function(u,a){if(!((16===u||24===u)&&a>=32&&a<=47||(23===u||31===u)&&a>=45&&a<=47))return!1;var O,M={};return 16===u||24===u?(O=Math.floor((a-32)/2),M.background=L[O],a%2==1&&(M.background=M.background+"_semi")):45===a?M.background="transparent":(M.foreground="black",47===a&&(M.underline=!0)),this.channels[u<=23?1:2].setBkgData(M),i(u,a,this.cmdHistory),!0},s.reset=function(){for(var u=0;u<Object.keys(this.channels).length;u++){var a=this.channels[u];a&&a.reset()}this.cmdHistory={a:null,b:null}},s.cueSplitAtTime=function(u){for(var a=0;a<this.channels.length;a++){var m=this.channels[a];m&&m.cueSplitAtTime(u)}},v}()},"./src/utils/codecs.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{isCodecSupportedInMp4:()=>D,isCodecType:()=>R});var b={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,av01:!0,drac:!0,dva1:!0,dvav:!0,dvh1:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0},text:{stpp:!0,wvtt:!0}};function R(_,I){var P=b[I];return!!P&&!0===P[_.slice(0,4)]}function D(_,I){return MediaSource.isTypeSupported((I||"video")+'/mp4;codecs="'+_+'"')}},"./src/utils/cues.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>P});var b=A("./src/utils/vttparser.ts"),R=A("./src/utils/webvtt-parser.ts"),D=A("./src/utils/texttrack-utils.ts"),_=/\s/;const P={newCue:function(S,g,L,y){for(var p,f,r,t,d,T=[],c=self.VTTCue||self.TextTrackCue,n=0;n<y.rows.length;n++)if(r=!0,t=0,d="",!(p=y.rows[n]).isEmpty()){for(var i=0;i<p.chars.length;i++)_.test(p.chars[i].uchar)&&r?t++:(d+=p.chars[i].uchar,r=!1);p.cueStartTime=g,g===L&&(L+=1e-4),t>=16?t--:t++;var l=(0,b.fixLineBreaks)(d.trim()),o=(0,R.generateCueId)(g,L,l);(!S||!S.cues||!S.cues.getCueById(o))&&((f=new c(g,L,l)).id=o,f.line=n+1,f.align="left",f.position=10+Math.min(80,10*Math.floor(8*t/32)),T.push(f))}return S&&T.length&&(T.sort(function(e,v){return"auto"===e.line||"auto"===v.line?0:e.line>8&&v.line>8?v.line-e.line:e.line-v.line}),T.forEach(function(e){return(0,D.addCueToTrack)(S,e)})),T}}},"./src/utils/discontinuities.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{adjustSlidingStart:()=>S,alignMediaPlaylistByPDT:()=>T,alignPDT:()=>y,alignStream:()=>g,findDiscontinuousReferenceFrag:()=>P,findFirstFragWithCC:()=>_,shouldAlignOnDiscontinuities:()=>I});var b=A("./src/polyfills/number.ts"),R=A("./src/utils/logger.ts"),D=A("./src/controller/level-helper.ts");function _(p,f){for(var r=null,t=0,d=p.length;t<d;t++){var c=p[t];if(c&&c.cc===f){r=c;break}}return r}function I(p,f,r){return!(!f.details||!(r.endCC>r.startCC||p&&p.cc<r.startCC))}function P(p,f,r){void 0===r&&(r=0);var t=p.fragments,d=f.fragments;if(d.length&&t.length){var c=_(t,d[0].cc);if(c&&(!c||c.startPTS))return c;R.logger.log("No frag in previous level to align on")}else R.logger.log("No fragments to align")}function x(p,f){if(p){var r=p.start+f;p.start=p.startPTS=r,p.endPTS=r+p.duration}}function S(p,f){for(var r=f.fragments,t=0,d=r.length;t<d;t++)x(r[t],p);f.fragmentHint&&x(f.fragmentHint,p),f.alignedSliding=!0}function g(p,f,r){!f||(function L(p,f,r){if(I(p,r,f)){var t=P(r.details,f);t&&(0,b.isFiniteNumber)(t.start)&&(R.logger.log("Adjusting PTS using last level due to CC increase within current level "+f.url),S(t.start,f))}}(p,r,f),!r.alignedSliding&&f.details&&y(r,f.details),!r.alignedSliding&&f.details&&!r.skippedSegments&&(0,D.adjustSliding)(f.details,r))}function y(p,f){if(f.fragments.length&&p.hasProgramDateTime&&f.hasProgramDateTime){var r=f.fragments[0].programDateTime,t=p.fragments[0].programDateTime,d=(t-r)/1e3+f.fragments[0].start;d&&(0,b.isFiniteNumber)(d)&&(R.logger.log("Adjusting PTS using programDateTime delta "+(t-r)+"ms, sliding:"+d.toFixed(3)+" "+p.url+" "),S(d,p))}}function T(p,f){if(p.hasProgramDateTime&&f.hasProgramDateTime){var r=p.fragments,t=f.fragments;if(r.length&&t.length){var c=t[Math.round(t.length/2)-1],n=_(r,c.cc)||r[Math.round(r.length/2)-1],i=c.programDateTime,l=n.programDateTime;null!==i&&null!==l&&S((l-i)/1e3-(n.start-c.start),p)}}}},"./src/utils/ewma-bandwidth-estimator.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>D});var b=A("./src/utils/ewma.ts");const D=function(){function _(P,x,S){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultEstimate_=S,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new b.default(P),this.fast_=new b.default(x)}var I=_.prototype;return I.update=function(x,S){var g=this.slow_,L=this.fast_;this.slow_.halfLife!==x&&(this.slow_=new b.default(x,g.getEstimate(),g.getTotalWeight())),this.fast_.halfLife!==S&&(this.fast_=new b.default(S,L.getEstimate(),L.getTotalWeight()))},I.sample=function(x,S){var L=(x=Math.max(x,this.minDelayMs_))/1e3,y=8*S/L;this.fast_.sample(L,y),this.slow_.sample(L,y)},I.canEstimate=function(){var x=this.fast_;return x&&x.getTotalWeight()>=this.minWeight_},I.getEstimate=function(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_},I.destroy=function(){},_}()},"./src/utils/ewma.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>R});const R=function(){function D(I,P,x){void 0===P&&(P=0),void 0===x&&(x=0),this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=I,this.alpha_=I?Math.exp(Math.log(.5)/I):0,this.estimate_=P,this.totalWeight_=x}var _=D.prototype;return _.sample=function(P,x){var S=Math.pow(this.alpha_,P);this.estimate_=x*(1-S)+S*this.estimate_,this.totalWeight_+=P},_.getTotalWeight=function(){return this.totalWeight_},_.getEstimate=function(){if(this.alpha_){var P=1-Math.pow(this.alpha_,this.totalWeight_);if(P)return this.estimate_/P}return this.estimate_},D}()},"./src/utils/fetch-loader.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>d,fetchSupported:()=>T});var b=A("./src/polyfills/number.ts"),R=A("./src/loader/load-stats.ts"),D=A("./src/demux/chunk-cache.ts");function I(c){var n="function"==typeof Map?new Map:void 0;return I=function(l){if(null===l||!function S(c){return-1!==Function.toString.call(c).indexOf("[native code]")}(l))return l;if("function"!=typeof l)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(l))return n.get(l);n.set(l,o)}function o(){return P(l,arguments,L(this).constructor)}return o.prototype=Object.create(l.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}),g(o,l)},I(c)}function P(c,n,i){return(P=x()?Reflect.construct.bind():function(o,e,v){var s=[null];s.push.apply(s,e);var u=new(Function.bind.apply(o,s));return v&&g(u,v.prototype),u}).apply(null,arguments)}function x(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(c){return!1}}function g(c,n){return(g=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(l,o){return l.__proto__=o,l})(c,n)}function L(c){return(L=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(i){return i.__proto__||Object.getPrototypeOf(i)})(c)}function y(){return y=Object.assign?Object.assign.bind():function(c){for(var n=1;n<arguments.length;n++){var i=arguments[n];for(var l in i)Object.prototype.hasOwnProperty.call(i,l)&&(c[l]=i[l])}return c},y.apply(this,arguments)}function T(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(c){}return!1}var p=function(){function c(i){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=void 0,this.response=void 0,this.controller=void 0,this.context=void 0,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=i.fetchSetup||r,this.controller=new self.AbortController,this.stats=new R.LoadStats}var n=c.prototype;return n.destroy=function(){this.loader=this.callbacks=null,this.abortInternal()},n.abortInternal=function(){var l=this.response;(!l||!l.ok)&&(this.stats.aborted=!0,this.controller.abort())},n.abort=function(){var l;this.abortInternal(),null!==(l=this.callbacks)&&void 0!==l&&l.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)},n.load=function(l,o,e){var v=this,s=this.stats;if(s.loading.start)throw new Error("Loader can only be used once.");s.loading.start=self.performance.now();var h=function f(c,n){var i={method:"GET",mode:"cors",credentials:"same-origin",signal:n,headers:new self.Headers(y({},c.headers))};return c.rangeEnd&&i.headers.set("Range","bytes="+c.rangeStart+"-"+String(c.rangeEnd-1)),i}(l,this.controller.signal),u=e.onProgress,a="arraybuffer"===l.responseType,m=a?"byteLength":"length";this.context=l,this.config=o,this.callbacks=e,this.request=this.fetchSetup(l,h),self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(function(){v.abortInternal(),e.onTimeout(s,l,v.response)},o.timeout),self.fetch(this.request).then(function(E){if(v.response=v.loader=E,!E.ok)throw new t(E.statusText||"fetch, bad network response",E.status,E);return s.loading.first=Math.max(self.performance.now(),s.loading.start),s.total=parseInt(E.headers.get("Content-Length")||"0"),u&&(0,b.isFiniteNumber)(o.highWaterMark)?v.loadProgressively(E,s,l,o.highWaterMark,u):a?E.arrayBuffer():E.text()}).then(function(E){var O=v.response;self.clearTimeout(v.requestTimeout),s.loading.end=Math.max(self.performance.now(),s.loading.first);var M=E[m];M&&(s.loaded=s.total=M);var C={url:O.url,data:E};u&&!(0,b.isFiniteNumber)(o.highWaterMark)&&u(s,l,E,O),e.onSuccess(C,s,l,O)}).catch(function(E){self.clearTimeout(v.requestTimeout),s.aborted||e.onError({code:E&&E.code||0,text:E?E.message:null},l,E?E.details:null)})},n.getCacheAge=function(){var l=null;if(this.response){var o=this.response.headers.get("age");l=o?parseFloat(o):null}return l},n.loadProgressively=function(l,o,e,v,s){void 0===v&&(v=0);var h=new D.default,u=l.body.getReader();return function m(){return u.read().then(function(E){if(E.done)return h.dataLength&&s(o,e,h.flush(),l),Promise.resolve(new ArrayBuffer(0));var O=E.value,M=O.length;return o.loaded+=M,M<v||h.dataLength?(h.push(O),h.dataLength>=v&&s(o,e,h.flush(),l)):s(o,e,O,l),m()}).catch(function(){return Promise.reject()})}()},c}();function r(c,n){return new self.Request(c.url,n)}var t=function(c){function n(i,l,o){var e;return(e=c.call(this,i)||this).code=void 0,e.details=void 0,e.code=l,e.details=o,e}return function _(c,n){c.prototype=Object.create(n.prototype),c.prototype.constructor=c,g(c,n)}(n,c),n}(I(Error));const d=p},"./src/utils/imsc1-ttml-parser.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{IMSC1_CODEC:()=>S,parseIMSC1:()=>T});var b=A("./src/utils/mp4-tools.ts"),R=A("./src/utils/vttparser.ts"),D=A("./src/utils/vttcue.ts"),_=A("./src/demux/id3.ts"),I=A("./src/utils/timescale-conversion.ts"),P=A("./src/utils/webvtt-parser.ts");function x(){return x=Object.assign?Object.assign.bind():function(e){for(var v=1;v<arguments.length;v++){var s=arguments[v];for(var h in s)Object.prototype.hasOwnProperty.call(s,h)&&(e[h]=s[h])}return e},x.apply(this,arguments)}var S="stpp.ttml.im1t",g=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,L=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,y={left:"start",center:"center",right:"end",start:"start",end:"end"};function T(e,v,s,h,u){var a=(0,b.findBox)(new Uint8Array(e),["mdat"]);if(0!==a.length){var m=a.map(function(O){return(0,_.utf8ArrayToStr)(O)}),E=(0,I.toTimescaleFromScale)(v,1,s);try{m.forEach(function(O){return h(function p(e,v){var u=(new DOMParser).parseFromString(e,"text/xml").getElementsByTagName("tt")[0];if(!u)throw new Error("Invalid ttml");var a={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},m=Object.keys(a).reduce(function(F,U){return F[U]=u.getAttribute("ttp:"+U)||a[U],F},{}),E="preserve"!==u.getAttribute("xml:space"),O=r(f(u,"styling","style")),M=r(f(u,"layout","region")),C=f(u,"body","[begin]");return[].map.call(C,function(F){var U=t(F,E);if(!U||!F.hasAttribute("begin"))return null;var k=i(F.getAttribute("begin"),m),N=i(F.getAttribute("dur"),m),w=i(F.getAttribute("end"),m);if(null===k)throw n(F);if(null===w){if(null===N)throw n(F);w=k+N}var K=new D.default(k-v,w-v,U);K.id=(0,P.generateCueId)(K.startTime,K.endTime,K.text);var G=M[F.getAttribute("region")],H=O[F.getAttribute("style")];K.position=10,K.size=80;var V=function d(e,v,s){var h="http://www.w3.org/ns/ttml#styling",u=null,m=null!=e&&e.hasAttribute("style")?e.getAttribute("style"):null;return m&&s.hasOwnProperty(m)&&(u=s[m]),["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"].reduce(function(E,O){var M=c(v,h,O)||c(e,h,O)||c(u,h,O);return M&&(E[O]=M),E},{})}(G,H,O),X=V.textAlign;if(X){var Y=y[X];Y&&(K.lineAlign=Y),K.align=X}return x(K,V),K}).filter(function(F){return null!==F})}(O,E))})}catch(O){u(O)}}else u(new Error("Could not parse IMSC1 mdat"))}function f(e,v,s){var h=e.getElementsByTagName(v)[0];return h?[].slice.call(h.querySelectorAll(s)):[]}function r(e){return e.reduce(function(v,s){var h=s.getAttribute("xml:id");return h&&(v[h]=s),v},{})}function t(e,v){return[].slice.call(e.childNodes).reduce(function(s,h,u){var a;return"br"===h.nodeName&&u?s+"\n":null!==(a=h.childNodes)&&void 0!==a&&a.length?t(h,v):v?s+h.textContent.trim().replace(/\s+/g," "):s+h.textContent},"")}function c(e,v,s){return e&&e.hasAttributeNS(v,s)?e.getAttributeNS(v,s):null}function n(e){return new Error("Could not parse ttml timestamp "+e)}function i(e,v){if(!e)return null;var s=(0,R.parseTimeStamp)(e);return null===s&&(g.test(e)?s=function l(e,v){var s=g.exec(e);return 3600*(0|s[1])+60*(0|s[2])+(0|s[3])+((0|s[4])+(0|s[5])/v.subFrameRate)/v.frameRate}(e,v):L.test(e)&&(s=function o(e,v){var s=L.exec(e),h=Number(s[1]);switch(s[2]){case"h":return 3600*h;case"m":return 60*h;case"ms":return 1e3*h;case"f":return h/v.frameRate;case"t":return h/v.tickRate}return h}(e,v))),s}},"./src/utils/logger.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{enableLogs:()=>P,logger:()=>x});var b=function(){},R={trace:b,debug:b,log:b,warn:b,info:b,error:b},D=R;function _(S){var g=self.console[S];return g?g.bind(self.console,"["+S+"] >"):b}function P(S,g){if(self.console&&!0===S||"object"==typeof S){!function I(S){for(var g=arguments.length,L=new Array(g>1?g-1:0),y=1;y<g;y++)L[y-1]=arguments[y];L.forEach(function(T){D[T]=S[T]?S[T].bind(S):_(T)})}(S,"debug","log","info","warn","error");try{D.log('Debug logs enabled for "'+g+'"')}catch(L){D=R}}else D=R}var x=R},"./src/utils/mediakeys-helper.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{KeySystems:()=>b,requestMediaKeySystemAccess:()=>R});var b=(()=>{return(D=b||(b={})).WIDEVINE="com.widevine.alpha",D.PLAYREADY="com.microsoft.playready",b;var D})(),R="undefined"!=typeof self&&self.navigator&&self.navigator.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null},"./src/utils/mediasource-helper.ts":(W,B,A)=>{"use strict";function b(){return self.MediaSource||self.WebKitMediaSource}A.r(B),A.d(B,{getMediaSource:()=>b})},"./src/utils/mp4-tools.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{RemuxerTrackIdConfig:()=>P,appendUint8Array:()=>i,bin2str:()=>x,computeRawDurationFromSamples:()=>d,discardEPB:()=>s,findBox:()=>T,getDuration:()=>t,getStartDTS:()=>r,offsetStartDTS:()=>c,parseEmsg:()=>h,parseInitSegment:()=>f,parseSEIMessageFromNALu:()=>v,parseSamples:()=>l,parseSegmentIndex:()=>p,readSint32:()=>L,readUint16:()=>S,readUint32:()=>g,segmentValidRange:()=>n,writeUint32:()=>y});var b=A("./src/utils/typed-array.ts"),R=A("./src/loader/fragment.ts"),D=A("./src/demux/id3.ts"),_=Math.pow(2,32)-1,I=[].push,P={video:1,audio:2,id3:3,text:4};function x(u){return String.fromCharCode.apply(null,u)}function S(u,a){var m=u[a]<<8|u[a+1];return m<0?65536+m:m}function g(u,a){var m=L(u,a);return m<0?4294967296+m:m}function L(u,a){return u[a]<<24|u[a+1]<<16|u[a+2]<<8|u[a+3]}function y(u,a,m){u[a]=m>>24,u[a+1]=m>>16&255,u[a+2]=m>>8&255,u[a+3]=255&m}function T(u,a){var m=[];if(!a.length)return m;for(var E=u.byteLength,O=0;O<E;){var M=g(u,O),F=M>1?O+M:E;if(x(u.subarray(O+4,O+8))===a[0])if(1===a.length)m.push(u.subarray(O+8,F));else{var U=T(u.subarray(O+8,F),a.slice(1));U.length&&I.apply(m,U)}O=F}return m}function p(u){var a=[],m=u[0],E=8,O=g(u,E);E+=4,E+=0===m?8:16;var F=u.length+0,U=S(u,E+=2);E+=2;for(var k=0;k<U;k++){var N=E,w=g(u,N);N+=4;var K=2147483647&w;if(1==(2147483648&w)>>>31)return console.warn("SIDX has hierarchical references (not supported)"),null;var H=g(u,N);N+=4,a.push({referenceSize:K,subsegmentDuration:H,info:{duration:H/O,start:F,end:F+K-1}}),F+=K,E=N+=4}return{earliestPresentationTime:0,timescale:O,version:m,referencesCount:U,references:a}}function f(u){for(var a=[],m=T(u,["moov","trak"]),E=0;E<m.length;E++){var O=m[E],M=T(O,["tkhd"])[0];if(M){var C=M[0],F=0===C?12:20,U=g(M,F),k=T(O,["mdia","mdhd"])[0];if(k){var N=g(k,F=0===(C=k[0])?12:20),w=T(O,["mdia","hdlr"])[0];if(w){var K=x(w.subarray(8,12)),G={soun:R.ElementaryStreamTypes.AUDIO,vide:R.ElementaryStreamTypes.VIDEO}[K];if(G){var H=T(O,["mdia","minf","stbl","stsd"])[0],V=void 0;H&&(V=x(H.subarray(12,16))),a[U]={timescale:N,type:G},a[G]={timescale:N,id:U,codec:V}}}}}}return T(u,["moov","mvex","trex"]).forEach(function(Y){var $=g(Y,4),Q=a[$];Q&&(Q.default={duration:g(Y,12),flags:g(Y,20)})}),a}function r(u,a){return T(a,["moof","traf"]).reduce(function(m,E){var O=T(E,["tfdt"])[0],M=O[0],C=T(E,["tfhd"]).reduce(function(F,U){var k=g(U,4),N=u[k];if(N){var w=g(O,4);1===M&&(w*=Math.pow(2,32),w+=g(O,8));var G=w/(N.timescale||9e4);if(isFinite(G)&&(null===F||G<F))return G}return F},null);return null!==C&&isFinite(C)&&(null===m||C<m)?C:m},null)||0}function t(u,a){for(var m=0,E=0,O=0,M=T(u,["moof","traf"]),C=0;C<M.length;C++){var F=M[C],U=T(F,["tfhd"])[0],N=a[g(U,4)];if(N){var w=N.default,K=g(U,0)|(null==w?void 0:w.flags),G=null==w?void 0:w.duration;8&K&&(G=g(U,2&K?12:8));for(var H=N.timescale||9e4,V=T(F,["trun"]),X=0;X<V.length;X++)!(m=d(V[X]))&&G&&(m=G*g(V[X],4)),N.type===R.ElementaryStreamTypes.VIDEO?E+=m/H:N.type===R.ElementaryStreamTypes.AUDIO&&(O+=m/H)}}if(0===E&&0===O){for(var $=0,Q=T(u,["sidx"]),z=0;z<Q.length;z++){var j=p(Q[z]);null!=j&&j.references&&($+=j.references.reduce(function(q,J){return q+J.info.duration||0},0))}return $}return E||O}function d(u){var a=g(u,0),m=8;1&a&&(m+=4),4&a&&(m+=4);for(var E=0,O=g(u,4),M=0;M<O;M++)256&a&&(E+=g(u,m),m+=4),512&a&&(m+=4),1024&a&&(m+=4),2048&a&&(m+=4);return E}function c(u,a,m){T(a,["moof","traf"]).forEach(function(E){T(E,["tfhd"]).forEach(function(O){var M=g(O,4),C=u[M];if(C){var F=C.timescale||9e4;T(E,["tfdt"]).forEach(function(U){var k=U[0],N=g(U,4);if(0===k)N-=m*F,y(U,4,N=Math.max(N,0));else{N*=Math.pow(2,32),N+=g(U,8),N-=m*F,N=Math.max(N,0);var w=Math.floor(N/(_+1)),K=Math.floor(N%(_+1));y(U,4,w),y(U,8,K)}})}})})}function n(u){var a={valid:null,remainder:null},m=T(u,["moof"]);if(!m)return a;if(m.length<2)return a.remainder=u,a;var E=m[m.length-1];return a.valid=(0,b.sliceUint8)(u,0,E.byteOffset-8),a.remainder=(0,b.sliceUint8)(u,E.byteOffset-8),a}function i(u,a){var m=new Uint8Array(u.length+a.length);return m.set(u),m.set(a,u.length),m}function l(u,a){var m=[],E=a.samples,O=a.timescale,M=a.id,C=!1;return T(E,["moof"]).map(function(U){var k=U.byteOffset-8;T(U,["traf"]).map(function(w){var K=T(w,["tfdt"]).map(function(G){var H=G[0],V=g(G,4);return 1===H&&(V*=Math.pow(2,32),V+=g(G,8)),V/O})[0];return void 0!==K&&(u=K),T(w,["tfhd"]).map(function(G){var H=g(G,4),V=16777215&g(G,0),Q=0,z=0!=(16&V),j=0,q=0!=(32&V),J=8;H===M&&(0!=(1&V)&&(J+=8),0!=(2&V)&&(J+=4),0!=(8&V)&&(Q=g(G,J),J+=4),z&&(j=g(G,J),J+=4),q&&(J+=4),"video"===a.type&&(C=function o(u){if(!u)return!1;var a=u.indexOf("."),m=a<0?u:u.substring(0,a);return"hvc1"===m||"hev1"===m||"dvh1"===m||"dvhe"===m}(a.codec)),T(w,["trun"]).map(function(ee){var le=ee[0],te=16777215&g(ee,0),fe=0!=(1&te),ae=0,de=0!=(4&te),ie=0!=(256&te),he=0,ve=0!=(512&te),ge=0,ce=0!=(1024&te),xe=0!=(2048&te),ue=0,Se=g(ee,4),ne=8;fe&&(ae=g(ee,ne),ne+=4),de&&(ne+=4);for(var oe=ae+k,me=0;me<Se;me++){if(ie?(he=g(ee,ne),ne+=4):he=Q,ve?(ge=g(ee,ne),ne+=4):ge=j,ce&&(ne+=4),xe&&(ue=0===le?g(ee,ne):L(ee,ne),ne+=4),a.type===R.ElementaryStreamTypes.VIDEO)for(var se=0;se<ge;){var re=g(E,oe);e(C,E[oe+=4])&&v(E.subarray(oe,oe+re),C?2:1,u+ue/O,m),oe+=re,se+=re+4}u+=he/O}}))})})}),m}function e(u,a){if(u){var m=a>>1&63;return 39===m||40===m}return 6==(31&a)}function v(u,a,m,E){var O=s(u),M=0;M+=a;for(var C=0,F=0,U=!1,k=0;M<O.length;){C=0;do{if(M>=O.length)break;C+=k=O[M++]}while(255===k);F=0;do{if(M>=O.length)break;F+=k=O[M++]}while(255===k);var N=O.length-M;if(!U&&4===C&&M<O.length){if(U=!0,181===O[M++]){var K=S(O,M);if(M+=2,49===K){var G=g(O,M);if(M+=4,1195456820===G){var H=O[M++];if(3===H){var V=O[M++],Y=64&V,$=Y?2+3*(31&V):0,Q=new Uint8Array($);if(Y){Q[0]=V;for(var z=1;z<$;z++)Q[z]=O[M++]}E.push({type:H,payloadType:C,pts:m,bytes:Q})}}}}}else if(5===C&&F<N){if(U=!0,F>16){for(var j=[],q=0;q<16;q++){var J=O[M++].toString(16);j.push(1==J.length?"0"+J:J),(3===q||5===q||7===q||9===q)&&j.push("-")}for(var ee=F-16,le=new Uint8Array(ee),te=0;te<ee;te++)le[te]=O[M++];E.push({payloadType:C,pts:m,uuid:j.join(""),userData:(0,D.utf8ArrayToStr)(le),userDataBytes:le})}}else if(F<N)M+=F;else if(F>N)break}}function s(u){for(var a=u.byteLength,m=[],E=1;E<a-2;)0===u[E]&&0===u[E+1]&&3===u[E+2]?(m.push(E+2),E+=2):E++;if(0===m.length)return u;var O=a-m.length,M=new Uint8Array(O),C=0;for(E=0;E<O;C++,E++)C===m[0]&&(C++,m.shift()),M[E]=u[C];return M}function h(u){var a=u[0],m="",E="",O=0,M=0,C=0,F=0,U=0,k=0;if(0===a){for(;"\0"!==x(u.subarray(k,k+1));)m+=x(u.subarray(k,k+1)),k+=1;for(m+=x(u.subarray(k,k+1)),k+=1;"\0"!==x(u.subarray(k,k+1));)E+=x(u.subarray(k,k+1)),k+=1;E+=x(u.subarray(k,k+1)),k+=1,O=g(u,12),M=g(u,16),F=g(u,20),U=g(u,24),k=28}else if(1===a){O=g(u,k+=4);var N=g(u,k+=4),w=g(u,k+=4);for(k+=4,C=Math.pow(2,32)*N+w,Number.isSafeInteger(C)||(C=Number.MAX_SAFE_INTEGER,console.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),F=g(u,k),U=g(u,k+=4),k+=4;"\0"!==x(u.subarray(k,k+1));)m+=x(u.subarray(k,k+1)),k+=1;for(m+=x(u.subarray(k,k+1)),k+=1;"\0"!==x(u.subarray(k,k+1));)E+=x(u.subarray(k,k+1)),k+=1;E+=x(u.subarray(k,k+1)),k+=1}return{schemeIdUri:m,value:E,timeScale:O,presentationTime:C,presentationTimeDelta:M,eventDuration:F,id:U,payload:u.subarray(k,u.byteLength)}}},"./src/utils/output-filter.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>b});var b=function(){function R(_,I){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=_,this.trackName=I}var D=R.prototype;return D.dispatchCue=function(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)},D.newCue=function(I,P,x){(null===this.startTime||this.startTime>I)&&(this.startTime=I),this.endTime=P,this.screen=x,this.timelineController.createCaptionsTrack(this.trackName)},D.reset=function(){this.cueRanges=[],this.startTime=null},R}()},"./src/utils/texttrack-utils.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{addCueToTrack:()=>D,clearCurrentCues:()=>_,getCuesInRange:()=>x,removeCuesInRange:()=>I,sendAddTrackEvent:()=>R});var b=A("./src/utils/logger.ts");function R(S,g){var L;try{L=new Event("addtrack")}catch(y){(L=document.createEvent("Event")).initEvent("addtrack",!1,!1)}L.track=S,g.dispatchEvent(L)}function D(S,g){var L=S.mode;if("disabled"===L&&(S.mode="hidden"),S.cues&&!S.cues.getCueById(g.id))try{if(S.addCue(g),!S.cues.getCueById(g.id))throw new Error("addCue is failed for: "+g)}catch(T){b.logger.debug("[texttrack-utils]: "+T);var y=new self.TextTrackCue(g.startTime,g.endTime,g.text);y.id=g.id,S.addCue(y)}"disabled"===L&&(S.mode=L)}function _(S){var g=S.mode;if("disabled"===g&&(S.mode="hidden"),S.cues)for(var L=S.cues.length;L--;)S.removeCue(S.cues[L]);"disabled"===g&&(S.mode=g)}function I(S,g,L,y){var T=S.mode;if("disabled"===T&&(S.mode="hidden"),S.cues&&S.cues.length>0)for(var p=x(S.cues,g,L),f=0;f<p.length;f++)(!y||y(p[f]))&&S.removeCue(p[f]);"disabled"===T&&(S.mode=T)}function x(S,g,L){var y=[],T=function P(S,g){if(g<S[0].startTime)return 0;var L=S.length-1;if(g>S[L].endTime)return-1;for(var y=0,T=L;y<=T;){var p=Math.floor((T+y)/2);if(g<S[p].startTime)T=p-1;else{if(!(g>S[p].startTime&&y<L))return p;y=p+1}}return S[y].startTime-g<g-S[T].startTime?y:T}(S,g);if(T>-1)for(var p=T,f=S.length;p<f;p++){var r=S[p];if(r.startTime>=g&&r.endTime<=L)y.push(r);else if(r.startTime>L)return y}return y}},"./src/utils/time-ranges.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>R});const R={toString:function(_){for(var I="",P=_.length,x=0;x<P;x++)I+="["+_.start(x).toFixed(3)+","+_.end(x).toFixed(3)+"]";return I}}},"./src/utils/timescale-conversion.ts":(W,B,A)=>{"use strict";function R(P,x,S,g){void 0===S&&(S=1),void 0===g&&(g=!1);var L=P*x*S;return g?Math.round(L):L}function D(P,x,S,g){return void 0===S&&(S=1),void 0===g&&(g=!1),R(P,x,1/S,g)}function _(P,x){return void 0===x&&(x=!1),R(P,1e3,1/9e4,x)}function I(P,x){return void 0===x&&(x=1),R(P,9e4,1/x)}A.r(B),A.d(B,{toMpegTsClockFromTimescale:()=>I,toMsFromMpegTsClock:()=>_,toTimescaleFromBase:()=>R,toTimescaleFromScale:()=>D})},"./src/utils/typed-array.ts":(W,B,A)=>{"use strict";function b(R,D,_){return Uint8Array.prototype.slice?R.slice(D,_):new Uint8Array(Array.prototype.slice.call(R,D,_))}A.r(B),A.d(B,{sliceUint8:()=>b})},"./src/utils/vttcue.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>b});const b=function(){if("undefined"!=typeof self&&self.VTTCue)return self.VTTCue;var R=["","lr","rl"],D=["start","middle","end","left","right"];function _(g,L){if("string"!=typeof L||!Array.isArray(g))return!1;var y=L.toLowerCase();return!!~g.indexOf(y)&&y}function P(g){return _(D,g)}function x(g){for(var L=arguments.length,y=new Array(L>1?L-1:0),T=1;T<L;T++)y[T-1]=arguments[T];for(var p=1;p<arguments.length;p++){var f=arguments[p];for(var r in f)g[r]=f[r]}return g}function S(g,L,y){var T=this,p={enumerable:!0};T.hasBeenReset=!1;var f="",r=!1,t=g,d=L,c=y,n=null,i="",l=!0,o="auto",e="start",v=50,s="middle",h=50,u="middle";Object.defineProperty(T,"id",x({},p,{get:function(){return f},set:function(m){f=""+m}})),Object.defineProperty(T,"pauseOnExit",x({},p,{get:function(){return r},set:function(m){r=!!m}})),Object.defineProperty(T,"startTime",x({},p,{get:function(){return t},set:function(m){if("number"!=typeof m)throw new TypeError("Start time must be set to a number.");t=m,this.hasBeenReset=!0}})),Object.defineProperty(T,"endTime",x({},p,{get:function(){return d},set:function(m){if("number"!=typeof m)throw new TypeError("End time must be set to a number.");d=m,this.hasBeenReset=!0}})),Object.defineProperty(T,"text",x({},p,{get:function(){return c},set:function(m){c=""+m,this.hasBeenReset=!0}})),Object.defineProperty(T,"region",x({},p,{get:function(){return n},set:function(m){n=m,this.hasBeenReset=!0}})),Object.defineProperty(T,"vertical",x({},p,{get:function(){return i},set:function(m){var E=function I(g){return _(R,g)}(m);if(!1===E)throw new SyntaxError("An invalid or illegal string was specified.");i=E,this.hasBeenReset=!0}})),Object.defineProperty(T,"snapToLines",x({},p,{get:function(){return l},set:function(m){l=!!m,this.hasBeenReset=!0}})),Object.defineProperty(T,"line",x({},p,{get:function(){return o},set:function(m){if("number"!=typeof m&&"auto"!==m)throw new SyntaxError("An invalid number or illegal string was specified.");o=m,this.hasBeenReset=!0}})),Object.defineProperty(T,"lineAlign",x({},p,{get:function(){return e},set:function(m){var E=P(m);if(!E)throw new SyntaxError("An invalid or illegal string was specified.");e=E,this.hasBeenReset=!0}})),Object.defineProperty(T,"position",x({},p,{get:function(){return v},set:function(m){if(m<0||m>100)throw new Error("Position must be between 0 and 100.");v=m,this.hasBeenReset=!0}})),Object.defineProperty(T,"positionAlign",x({},p,{get:function(){return s},set:function(m){var E=P(m);if(!E)throw new SyntaxError("An invalid or illegal string was specified.");s=E,this.hasBeenReset=!0}})),Object.defineProperty(T,"size",x({},p,{get:function(){return h},set:function(m){if(m<0||m>100)throw new Error("Size must be between 0 and 100.");h=m,this.hasBeenReset=!0}})),Object.defineProperty(T,"align",x({},p,{get:function(){return u},set:function(m){var E=P(m);if(!E)throw new SyntaxError("An invalid or illegal string was specified.");u=E,this.hasBeenReset=!0}})),T.displayState=void 0}return S.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},S}()},"./src/utils/vttparser.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{VTTParser:()=>L,fixLineBreaks:()=>g,parseTimeStamp:()=>D});var b=A("./src/utils/vttcue.ts"),R=function(){function y(){}return y.prototype.decode=function(f,r){if(!f)return"";if("string"!=typeof f)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(f))},y}();function D(y){function T(f,r,t,d){return 3600*(0|f)+60*(0|r)+(0|t)+parseFloat(d||0)}var p=y.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return p?parseFloat(p[2])>59?T(p[2],p[3],0,p[4]):T(p[1],p[2],p[3],p[4]):null}var _=function(){function y(){this.values=Object.create(null)}var T=y.prototype;return T.set=function(f,r){!this.get(f)&&""!==r&&(this.values[f]=r)},T.get=function(f,r,t){return t?this.has(f)?this.values[f]:r[t]:this.has(f)?this.values[f]:r},T.has=function(f){return f in this.values},T.alt=function(f,r,t){for(var d=0;d<t.length;++d)if(r===t[d]){this.set(f,r);break}},T.integer=function(f,r){/^-?\d+$/.test(r)&&this.set(f,parseInt(r,10))},T.percent=function(f,r){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(r)){var t=parseFloat(r);if(t>=0&&t<=100)return this.set(f,t),!0}return!1},y}();function I(y,T,p,f){var r=f?y.split(f):[y];for(var t in r)if("string"==typeof r[t]){var d=r[t].split(p);2===d.length&&T(d[0],d[1])}}var P=new b.default(0,0,""),x="middle"===P.align?"middle":"center";function S(y,T,p){var f=y;function r(){var c=D(y);if(null===c)throw new Error("Malformed timestamp: "+f);return y=y.replace(/^[^\sa-zA-Z-]+/,""),c}function d(){y=y.replace(/^\s+/,"")}if(d(),T.startTime=r(),d(),"--\x3e"!==y.slice(0,3))throw new Error("Malformed time stamp (time stamps must be separated by '--\x3e'): "+f);y=y.slice(3),d(),T.endTime=r(),d(),function t(c,n){var i=new _;I(c,function(e,v){var s;switch(e){case"region":for(var h=p.length-1;h>=0;h--)if(p[h].id===v){i.set(e,p[h].region);break}break;case"vertical":i.alt(e,v,["rl","lr"]);break;case"line":s=v.split(","),i.integer(e,s[0]),i.percent(e,s[0])&&i.set("snapToLines",!1),i.alt(e,s[0],["auto"]),2===s.length&&i.alt("lineAlign",s[1],["start",x,"end"]);break;case"position":s=v.split(","),i.percent(e,s[0]),2===s.length&&i.alt("positionAlign",s[1],["start",x,"end","line-left","line-right","auto"]);break;case"size":i.percent(e,v);break;case"align":i.alt(e,v,["start",x,"end","left","right"])}},/:/,/\s/),n.region=i.get("region",null),n.vertical=i.get("vertical","");var l=i.get("line","auto");"auto"===l&&-1===P.line&&(l=-1),n.line=l,n.lineAlign=i.get("lineAlign","start"),n.snapToLines=i.get("snapToLines",!0),n.size=i.get("size",100),n.align=i.get("align",x);var o=i.get("position","auto");"auto"===o&&50===P.position&&(o="start"===n.align||"left"===n.align?0:"end"===n.align||"right"===n.align?100:50),n.position=o}(y,T)}function g(y){return y.replace(/<br(?: \/)?>/gi,"\n")}var L=function(){function y(){this.state="INITIAL",this.buffer="",this.decoder=new R,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}var T=y.prototype;return T.parse=function(f){var r=this;function t(){var o=r.buffer,e=0;for(o=g(o);e<o.length&&"\r"!==o[e]&&"\n"!==o[e];)++e;var v=o.slice(0,e);return"\r"===o[e]&&++e,"\n"===o[e]&&++e,r.buffer=o.slice(e),v}f&&(r.buffer+=r.decoder.decode(f,{stream:!0}));try{var c="";if("INITIAL"===r.state){if(!/\r\n|\n/.test(r.buffer))return this;var n=(c=t()).match(/^(\xef\xbb\xbf)?WEBVTT([ \t].*)?$/);if(!n||!n[0])throw new Error("Malformed WebVTT signature.");r.state="HEADER"}for(var i=!1;r.buffer;){if(!/\r\n|\n/.test(r.buffer))return this;switch(i?i=!1:c=t(),r.state){case"HEADER":/:/.test(c)?I(c,function(e,v){},/:/):c||(r.state="ID");continue;case"NOTE":c||(r.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(c)){r.state="NOTE";break}if(!c)continue;if(r.cue=new b.default(0,0,""),r.state="CUE",-1===c.indexOf("--\x3e")){r.cue.id=c;continue}case"CUE":if(!r.cue){r.state="BADCUE";continue}try{S(c,r.cue,r.regionList)}catch(o){r.cue=null,r.state="BADCUE";continue}r.state="CUETEXT";continue;case"CUETEXT":var l=-1!==c.indexOf("--\x3e");if(!c||l&&(i=!0)){r.oncue&&r.cue&&r.oncue(r.cue),r.cue=null,r.state="ID";continue}if(null===r.cue)continue;r.cue.text&&(r.cue.text+="\n"),r.cue.text+=c;continue;case"BADCUE":c||(r.state="ID")}}}catch(o){"CUETEXT"===r.state&&r.cue&&r.oncue&&r.oncue(r.cue),r.cue=null,r.state="INITIAL"===r.state?"BADWEBVTT":"BADCUE"}return this},T.flush=function(){var f=this;try{if((f.cue||"HEADER"===f.state)&&(f.buffer+="\n\n",f.parse()),"INITIAL"===f.state||"BADWEBVTT"===f.state)throw new Error("Malformed WebVTT signature.")}catch(r){f.onparsingerror&&f.onparsingerror(r)}return f.onflush&&f.onflush(),this},y}()},"./src/utils/webvtt-parser.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{generateCueId:()=>L,parseWebVTT:()=>T});var b=A("./src/polyfills/number.ts"),R=A("./src/utils/vttparser.ts"),D=A("./src/demux/id3.ts"),_=A("./src/utils/timescale-conversion.ts"),I=A("./src/remux/mp4-remuxer.ts"),P=/\r\n|\n\r|\n|\r/g,x=function(f,r,t){return void 0===t&&(t=0),f.slice(t,t+r.length)===r},g=function(f){for(var r=5381,t=f.length;t;)r=33*r^f.charCodeAt(--t);return(r>>>0).toString()};function L(p,f,r){return g(p.toString())+g(f.toString())+g(r)}function T(p,f,r,t,d,c,n,i){var a,l=new R.VTTParser,o=(0,D.utf8ArrayToStr)(new Uint8Array(p)).trim().replace(P,"\n").split("\n"),e=[],v=(0,_.toMpegTsClockFromTimescale)(f,r),s="00:00.000",h=0,u=0,m=!0;l.oncue=function(E){var O=t[d],M=t.ccOffset,C=(h-v)/9e4;null!=O&&O.new&&(void 0!==u?M=t.ccOffset=O.start:function(f,r,t){var d=f[r],c=f[d.prevCC];if(!c||!c.new&&d.new)return f.ccOffset=f.presentationOffset=d.start,void(d.new=!1);for(;null!==(n=c)&&void 0!==n&&n.new;){var n;f.ccOffset+=d.start-c.start,d.new=!1,c=f[(d=c).prevCC]}f.presentationOffset=t}(t,d,C)),C&&(M=C-t.presentationOffset);var F=E.endTime-E.startTime,U=(0,I.normalizePts)(9e4*(E.startTime+M-u),9e4*c)/9e4;E.startTime=Math.max(U,0),E.endTime=Math.max(U+F,0);var k=E.text.trim();E.text=decodeURIComponent(encodeURIComponent(k)),E.id||(E.id=L(E.startTime,E.endTime,k)),E.endTime>0&&e.push(E)},l.onparsingerror=function(E){a=E},l.onflush=function(){a?i(a):n(e)},o.forEach(function(E){if(m){if(x(E,"X-TIMESTAMP-MAP=")){m=!1,E.slice(16).split(",").forEach(function(O){x(O,"LOCAL:")?s=O.slice(6):x(O,"MPEGTS:")&&(h=parseInt(O.slice(7)))});try{u=function(f){var r=parseInt(f.slice(-3)),t=parseInt(f.slice(-6,-4)),d=parseInt(f.slice(-9,-7)),c=f.length>9?parseInt(f.substring(0,f.indexOf(":"))):0;if(!((0,b.isFiniteNumber)(r)&&(0,b.isFiniteNumber)(t)&&(0,b.isFiniteNumber)(d)&&(0,b.isFiniteNumber)(c)))throw Error("Malformed X-TIMESTAMP-MAP: Local:"+f);return r+=1e3*t,(r+=6e4*d)+36e5*c}(s)/1e3}catch(O){a=O}return}""===E&&(m=!1)}l.parse(E+"\n")}),l.flush()}},"./src/utils/xhr-loader.ts":(W,B,A)=>{"use strict";A.r(B),A.d(B,{default:()=>I});var b=A("./src/utils/logger.ts"),R=A("./src/loader/load-stats.ts"),D=/^age:\s*[\d.]+\s*$/m;const I=function(){function P(S){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=void 0,this.loader=null,this.stats=void 0,this.xhrSetup=S?S.xhrSetup:null,this.stats=new R.LoadStats,this.retryDelay=0}var x=P.prototype;return x.destroy=function(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null},x.abortInternal=function(){var g=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),g&&(g.onreadystatechange=null,g.onprogress=null,4!==g.readyState&&(this.stats.aborted=!0,g.abort()))},x.abort=function(){var g;this.abortInternal(),null!==(g=this.callbacks)&&void 0!==g&&g.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)},x.load=function(g,L,y){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=g,this.config=L,this.callbacks=y,this.retryDelay=L.retryDelay,this.loadInternal()},x.loadInternal=function(){var g=this.config,L=this.context;if(g){var y=this.loader=new self.XMLHttpRequest,T=this.stats;T.loading.first=0,T.loaded=0;var p=this.xhrSetup;try{if(p)try{p(y,L.url)}catch(t){y.open("GET",L.url,!0),p(y,L.url)}y.readyState||y.open("GET",L.url,!0);var f=this.context.headers;if(f)for(var r in f)y.setRequestHeader(r,f[r])}catch(t){return void this.callbacks.onError({code:y.status,text:t.message},L,y)}L.rangeEnd&&y.setRequestHeader("Range","bytes="+L.rangeStart+"-"+(L.rangeEnd-1)),y.onreadystatechange=this.readystatechange.bind(this),y.onprogress=this.loadprogress.bind(this),y.responseType=L.responseType,self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),g.timeout),y.send()}},x.readystatechange=function(){var g=this.context,L=this.loader,y=this.stats;if(g&&L){var T=L.readyState,p=this.config;if(!y.aborted&&T>=2)if(self.clearTimeout(this.requestTimeout),0===y.loading.first&&(y.loading.first=Math.max(self.performance.now(),y.loading.start)),4===T){L.onreadystatechange=null,L.onprogress=null;var f=L.status,r="arraybuffer"===L.responseType;if(f>=200&&f<300&&(r&&L.response||null!==L.responseText)){var t,d;if(y.loading.end=Math.max(self.performance.now(),y.loading.first),d=r?(t=L.response).byteLength:(t=L.responseText).length,y.loaded=y.total=d,!this.callbacks)return;var c=this.callbacks.onProgress;if(c&&c(y,g,t,L),!this.callbacks)return;this.callbacks.onSuccess({url:L.responseURL,data:t},y,g,L)}else y.retry>=p.maxRetry||f>=400&&f<499?(b.logger.error(f+" while loading "+g.url),this.callbacks.onError({code:f,text:L.statusText},g,L)):(b.logger.warn(f+" while loading "+g.url+", retrying in "+this.retryDelay+"..."),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,p.maxRetryDelay),y.retry++)}else self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),p.timeout)}},x.loadtimeout=function(){b.logger.warn("timeout while loading "+this.context.url);var g=this.callbacks;g&&(this.abortInternal(),g.onTimeout(this.stats,this.context,this.loader))},x.loadprogress=function(g){var L=this.stats;L.loaded=g.loaded,g.lengthComputable&&(L.total=g.total)},x.getCacheAge=function(){var g=null;if(this.loader&&D.test(this.loader.getAllResponseHeaders())){var L=this.loader.getResponseHeader("age");g=L?parseFloat(L):null}return g},P}()},"./node_modules/eventemitter3/index.js":W=>{"use strict";var B=Object.prototype.hasOwnProperty,A="~";function b(){}function R(P,x,S){this.fn=P,this.context=x,this.once=S||!1}function D(P,x,S,g,L){if("function"!=typeof S)throw new TypeError("The listener must be a function");var y=new R(S,g||P,L),T=A?A+x:x;return P._events[T]?P._events[T].fn?P._events[T]=[P._events[T],y]:P._events[T].push(y):(P._events[T]=y,P._eventsCount++),P}function _(P,x){0==--P._eventsCount?P._events=new b:delete P._events[x]}function I(){this._events=new b,this._eventsCount=0}Object.create&&(b.prototype=Object.create(null),(new b).__proto__||(A=!1)),I.prototype.eventNames=function(){var S,g,x=[];if(0===this._eventsCount)return x;for(g in S=this._events)B.call(S,g)&&x.push(A?g.slice(1):g);return Object.getOwnPropertySymbols?x.concat(Object.getOwnPropertySymbols(S)):x},I.prototype.listeners=function(x){var g=this._events[A?A+x:x];if(!g)return[];if(g.fn)return[g.fn];for(var L=0,y=g.length,T=new Array(y);L<y;L++)T[L]=g[L].fn;return T},I.prototype.listenerCount=function(x){var g=this._events[A?A+x:x];return g?g.fn?1:g.length:0},I.prototype.emit=function(x,S,g,L,y,T){var p=A?A+x:x;if(!this._events[p])return!1;var t,d,f=this._events[p],r=arguments.length;if(f.fn){switch(f.once&&this.removeListener(x,f.fn,void 0,!0),r){case 1:return f.fn.call(f.context),!0;case 2:return f.fn.call(f.context,S),!0;case 3:return f.fn.call(f.context,S,g),!0;case 4:return f.fn.call(f.context,S,g,L),!0;case 5:return f.fn.call(f.context,S,g,L,y),!0;case 6:return f.fn.call(f.context,S,g,L,y,T),!0}for(d=1,t=new Array(r-1);d<r;d++)t[d-1]=arguments[d];f.fn.apply(f.context,t)}else{var n,c=f.length;for(d=0;d<c;d++)switch(f[d].once&&this.removeListener(x,f[d].fn,void 0,!0),r){case 1:f[d].fn.call(f[d].context);break;case 2:f[d].fn.call(f[d].context,S);break;case 3:f[d].fn.call(f[d].context,S,g);break;case 4:f[d].fn.call(f[d].context,S,g,L);break;default:if(!t)for(n=1,t=new Array(r-1);n<r;n++)t[n-1]=arguments[n];f[d].fn.apply(f[d].context,t)}}return!0},I.prototype.on=function(x,S,g){return D(this,x,S,g,!1)},I.prototype.once=function(x,S,g){return D(this,x,S,g,!0)},I.prototype.removeListener=function(x,S,g,L){var y=A?A+x:x;if(!this._events[y])return this;if(!S)return _(this,y),this;var T=this._events[y];if(T.fn)T.fn===S&&(!L||T.once)&&(!g||T.context===g)&&_(this,y);else{for(var p=0,f=[],r=T.length;p<r;p++)(T[p].fn!==S||L&&!T[p].once||g&&T[p].context!==g)&&f.push(T[p]);f.length?this._events[y]=1===f.length?f[0]:f:_(this,y)}return this},I.prototype.removeAllListeners=function(x){var S;return x?this._events[S=A?A+x:x]&&_(this,S):(this._events=new b,this._eventsCount=0),this},I.prototype.off=I.prototype.removeListener,I.prototype.addListener=I.prototype.on,I.prefixed=A,I.EventEmitter=I,W.exports=I},"./node_modules/url-toolkit/src/url-toolkit.js":function(W){var A,b,R,D,_;A=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,b=/^(?=([^\/?#]*))\1([^]*)$/,R=/(?:\/|^)\.(?=\/)/g,D=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,W.exports=_={buildAbsoluteURL:function(I,P,x){if(x=x||{},I=I.trim(),!(P=P.trim())){if(!x.alwaysNormalize)return I;var S=_.parseURL(I);if(!S)throw new Error("Error trying to parse base URL.");return S.path=_.normalizePath(S.path),_.buildURLFromParts(S)}var g=_.parseURL(P);if(!g)throw new Error("Error trying to parse relative URL.");if(g.scheme)return x.alwaysNormalize?(g.path=_.normalizePath(g.path),_.buildURLFromParts(g)):P;var L=_.parseURL(I);if(!L)throw new Error("Error trying to parse base URL.");if(!L.netLoc&&L.path&&"/"!==L.path[0]){var y=b.exec(L.path);L.netLoc=y[1],L.path=y[2]}L.netLoc&&!L.path&&(L.path="/");var T={scheme:L.scheme,netLoc:g.netLoc,path:null,params:g.params,query:g.query,fragment:g.fragment};if(!g.netLoc&&(T.netLoc=L.netLoc,"/"!==g.path[0]))if(g.path){var p=L.path,f=p.substring(0,p.lastIndexOf("/")+1)+g.path;T.path=_.normalizePath(f)}else T.path=L.path,g.params||(T.params=L.params,g.query||(T.query=L.query));return null===T.path&&(T.path=x.alwaysNormalize?_.normalizePath(g.path):g.path),_.buildURLFromParts(T)},parseURL:function(I){var P=A.exec(I);return P?{scheme:P[1]||"",netLoc:P[2]||"",path:P[3]||"",params:P[4]||"",query:P[5]||"",fragment:P[6]||""}:null},normalizePath:function(I){for(I=I.split("").reverse().join("").replace(R,"");I.length!==(I=I.replace(D,"")).length;);return I.split("").reverse().join("")},buildURLFromParts:function(I){return I.scheme+I.netLoc+I.path+I.params+I.query+I.fragment}}}},Te={};function Z(W){var B=Te[W];if(void 0!==B)return B.exports;var A=Te[W]={exports:{}};return Ie[W].call(A.exports,A,A.exports,Z),A.exports}Z.m=Ie,Z.n=W=>{var B=W&&W.__esModule?()=>W.default:()=>W;return Z.d(B,{a:B}),B},Z.d=(W,B)=>{for(var A in B)Z.o(B,A)&&!Z.o(W,A)&&Object.defineProperty(W,A,{enumerable:!0,get:B[A]})},Z.o=(W,B)=>Object.prototype.hasOwnProperty.call(W,B),Z.r=W=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(W,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(W,"__esModule",{value:!0})};var Oe=Z("./src/hls.ts");return Oe.default})(),ke.exports=Z())}}]);